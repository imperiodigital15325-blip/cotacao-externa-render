<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detalhes da Cotação - {{ cotacao.codigo }}</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        :root {
            --bg-color: #f0f2f5;
            --card-bg: #ffffff;
            --primary-blue: #0d6efd;
            --text-primary: #1a1a2e;
            --text-secondary: #6c757d;
            --border-color: #e9ecef;
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.08);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.08);
            --radius-md: 10px;
            --transition: all 0.25s ease;
        }

        body {
            background-color: var(--bg-color);
            font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, 'Roboto', sans-serif;
            font-size: 0.875rem;
        }

        .wrapper { display: flex; }
        
        .sidebar {
            min-width: 250px;
            max-width: 250px;
            background: linear-gradient(180deg, #1a1d21 0%, #212529 100%);
            color: #fff;
            min-height: 100vh;
            position: fixed;
            top: 0;
            left: 0;
            z-index: 1000;
            overflow-y: auto;
            transition: var(--transition);
        }
        
        .sidebar.collapsed {
            margin-left: -250px;
        }
        
        .sidebar .sidebar-header {
            padding: 24px 20px;
            background: rgba(0,0,0,0.2);
        }
        
        .sidebar .sidebar-header h4 { font-weight: 700; letter-spacing: -0.5px; }
        
        .sidebar ul li a {
            color: rgba(255,255,255,0.7);
            padding: 14px 20px;
            display: flex;
            align-items: center;
            text-decoration: none;
            transition: var(--transition);
        }
        
        .sidebar ul li a i { width: 20px; margin-right: 12px; }
        .sidebar ul li a:hover { color: #fff; background: rgba(255,255,255,0.08); }
        .sidebar ul li.active > a { color: #fff; background: var(--primary-blue); }

        .content {
            width: 100%;
            padding: 24px 28px;
            margin-left: 250px;
            min-height: 100vh;
            transition: var(--transition);
        }
        
        .content.expanded { margin-left: 0; }

        .page-header { margin-bottom: 24px; padding-bottom: 16px; border-bottom: 1px solid var(--border-color); }

        .card-section {
            background: var(--card-bg);
            border-radius: var(--radius-md);
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
        }
        
        .card-section h5 {
            font-weight: 600;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border-color);
        }

        .info-grid { 
            display: grid; 
            grid-template-columns: repeat(4, 1fr); 
            gap: 20px; 
        }
        
        @media (max-width: 992px) { .info-grid { grid-template-columns: repeat(2, 1fr); } }
        @media (max-width: 576px) { .info-grid { grid-template-columns: 1fr; } }
        
        .info-item { 
            padding: 12px 16px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 3px solid var(--primary-blue);
        }
        .info-item label { font-size: 0.75rem; color: var(--text-secondary); text-transform: uppercase; display: block; margin-bottom: 4px; }
        .info-item span { font-weight: 600; font-size: 0.95rem; }

        .badge-aberta { background-color: #0d6efd; }
        .badge-respondida { background-color: #198754; }
        .badge-encerrada { background-color: #6c757d; }
        .badge-pendente { background-color: #ffc107; color: #000; }
        .badge-cancelada { background-color: #dc3545; }
        
        /* Badge de preço antigo (> 2 anos) - ícone de relógio */
        .badge-preco-antigo {
            background-color: rgba(255, 193, 7, 0.2);
            color: #856404;
            font-size: 0.65rem;
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: 4px;
            display: inline-block;
        }

        .table { font-size: 0.85rem; }
        .table thead th {
            background: #f8f9fa;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            font-size: 0.75rem;
        }

        /* Destaques - Verde forte para melhor preço, Amarelo para melhor prazo (SEM degradê) */
        .melhor-preco { background-color: #198754 !important; color: white !important; font-weight: 700; }
        .melhor-prazo { background-color: #ffc107 !important; color: #000 !important; font-weight: 700; }
        
        /* Indicador de variação percentual vs Último Preço Pago */
        .variacao-preco {
            display: block;
            font-size: 0.68rem;
            font-weight: 700;
            margin-top: 3px;
            padding: 2px 5px;
            border-radius: 4px;
            line-height: 1.2;
            box-shadow: 0 1px 3px rgba(0,0,0,0.15);
        }
        /* Preço ACIMA do último (VERMELHO - pior para comprador) */
        .variacao-preco.acima {
            color: #ffffff;
            background-color: #dc3545;
        }
        /* Preço ABAIXO do último (VERDE - melhor para comprador) */
        .variacao-preco.abaixo {
            color: #ffffff;
            background-color: #198754;
        }
        /* Preço IGUAL ao último (NEUTRO) */
        .variacao-preco.igual {
            color: #6c757d;
            background-color: rgba(108, 117, 125, 0.15);
        }
        /* IMPORTANTE: Cores devem ser independentes do status de "melhor fornecedor" */
        .melhor-preco .variacao-preco.acima {
            color: #ffffff !important;
            background-color: #dc3545 !important;
        }
        .melhor-preco .variacao-preco.abaixo {
            color: #ffffff !important;
            background-color: #198754 !important;
        }
        
        /* Células com observação - indicador visual sutil */
        .tem-observacao { cursor: help; position: relative; }
        .tem-observacao::after {
            content: '';
            position: absolute;
            top: 2px;
            right: 2px;
            width: 6px;
            height: 6px;
            background-color: #0dcaf0;
            border-radius: 50%;
        }
        /* Quando tem observação E é melhor preço, manter ícone visível */
        .melhor-preco.tem-observacao i.fa-comment-alt { color: white !important; }
        
        .matriz-respostas { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        .matriz-respostas th, .matriz-respostas td {
            padding: 10px 12px;
            text-align: center;
            border: 1px solid #dee2e6;
            vertical-align: middle;
        }
        .matriz-respostas thead th {
            background: #f8f9fa;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            font-size: 0.7rem;
        }
        .matriz-respostas .col-item { text-align: left; background: #fafbfc; min-width: 200px; font-weight: 500; }
        .matriz-respostas .col-codigo { font-weight: 600; color: var(--primary-blue); white-space: nowrap; }
        .matriz-respostas .col-qtd { white-space: nowrap; font-weight: 500; }
        
        /* Cabeçalhos dos fornecedores - TEXTO BRANCO em fundo escuro para legibilidade */
        .matriz-respostas .header-fornecedor { 
            color: #FFFFFF !important; 
            font-weight: 700; 
            font-size: 0.85rem; 
            padding: 14px 12px;
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }
        
        .matriz-respostas .sub-header { background: #f8f9fa; font-size: 0.7rem; font-weight: 600; color: #495057; }
        .matriz-respostas .celula-preco { font-weight: 600; background: white; }
        .matriz-respostas .celula-subtotal { font-weight: 500; color: #495057; background: white; }
        .matriz-respostas .celula-prazo { background: white; }
        .matriz-respostas .celula-total-fornecedor { font-weight: 700; font-size: 1.05rem; }
        .matriz-respostas .sem-resposta { color: #ccc; font-style: italic; background: white; }
        .matriz-respostas .linha-frete { background: #f8f9fa; }
        .matriz-respostas .linha-total-fornecedor { background: #e9ecef; }
        .matriz-wrapper { overflow-x: auto; border-radius: var(--radius-md); box-shadow: 0 2px 4px rgba(0,0,0,0.08); }
        
        /* Cores dos fornecedores - TODOS com fundo PRETO */
        .forn-0 { background: #000000 !important; }  /* Preto */
        .forn-1 { background: #000000 !important; }  /* Preto */
        .forn-2 { background: #000000 !important; }  /* Preto */
        .forn-3 { background: #000000 !important; }  /* Preto */
        .forn-4 { background: #000000 !important; }  /* Preto */
        .forn-5 { background: #000000 !important; }  /* Preto */
        .forn-6 { background: #000000 !important; }  /* Preto */
        .forn-7 { background: #000000 !important; }  /* Preto */
        
        /* Blocos de fornecedor - Fundos MAIS VISÍVEIS para separação clara */
        .grupo-forn-0 { background: rgba(44, 62, 80, 0.08); }    /* Azul */
        .grupo-forn-1 { background: rgba(39, 174, 96, 0.08); }   /* Verde */
        .grupo-forn-2 { background: rgba(142, 68, 173, 0.08); }  /* Roxo */
        .grupo-forn-3 { background: rgba(211, 84, 0, 0.08); }    /* Laranja */
        .grupo-forn-4 { background: rgba(22, 160, 133, 0.08); }  /* Turquesa */
        .grupo-forn-5 { background: rgba(41, 128, 185, 0.08); }  /* Azul médio */
        .grupo-forn-6 { background: rgba(192, 57, 43, 0.08); }   /* Vermelho */
        .grupo-forn-7 { background: rgba(127, 140, 141, 0.08); } /* Cinza */
        
        .btn-imprimir {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 10px 24px;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .btn-imprimir:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
            color: white;
        }
        
        /* Estilos de impressão */
        @media print {
            body { background: white !important; }
            .page-header, .btn, .btn-imprimir, .navbar, .sidebar, .no-print { display: none !important; }
            .card-section { box-shadow: none !important; border: 1px solid #dee2e6 !important; page-break-inside: avoid; }
            .matriz-wrapper { box-shadow: none !important; border: 1px solid #000 !important; }
            .matriz-respostas { font-size: 0.75rem; }
            .matriz-respostas th, .matriz-respostas td { padding: 6px 8px; border: 1px solid #000 !important; }
            .melhor-preco { background-color: #198754 !important; color: white !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            .melhor-prazo { background-color: #ffc107 !important; color: #000 !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            .header-fornecedor { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            .linha-total-fornecedor { background: #e9ecef !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            h5 { font-size: 1.2rem; margin-bottom: 12px; }
            .legenda { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            /* Variação percentual - cores mantidas independente do contexto */
            .variacao-preco { -webkit-print-color-adjust: exact; print-color-adjust: exact; font-size: 0.6rem; box-shadow: none; }
            .variacao-preco.acima { color: #ffffff !important; background-color: #dc3545 !important; }
            .variacao-preco.abaixo { color: #ffffff !important; background-color: #198754 !important; }
        }

        .timeline { position: relative; padding-left: 30px; }
        .timeline::before { content: ''; position: absolute; left: 10px; top: 0; bottom: 0; width: 2px; background: var(--border-color); }
        .timeline-item { position: relative; margin-bottom: 16px; padding-bottom: 16px; border-bottom: 1px dashed var(--border-color); }
        .timeline-item::before { content: ''; position: absolute; left: -24px; top: 4px; width: 10px; height: 10px; background: var(--primary-blue); border-radius: 50%; }
        .timeline-item .time { font-size: 0.75rem; color: var(--text-secondary); }
        .timeline-item .action { font-weight: 600; }

        .btn-toggle-modo { background-color: #f8f9fa; border: 2px solid #dee2e6; color: #495057; transition: all 0.2s ease; }
        .btn-toggle-modo:hover { background-color: #e9ecef; border-color: #adb5bd; }
        .btn-toggle-modo.active { background-color: #198754; border-color: #198754; color: white; }
        
        .lista-fornecedor-item { padding: 10px 15px; border-bottom: 1px solid #eee; cursor: pointer; transition: background 0.15s ease; }
        .lista-fornecedor-item:hover { background-color: #e8f5e9; }
        .lista-fornecedor-item:last-child { border-bottom: none; }
        
        .legenda { display: flex; gap: 16px; flex-wrap: wrap; padding: 12px 16px; background: #f8f9fa; border-radius: var(--radius-md); margin-bottom: 16px; }
        .legenda-item { display: flex; align-items: center; gap: 6px; font-size: 0.8rem; }
        .legenda-cor { width: 16px; height: 16px; border-radius: 4px; }
        
        /* Modal Alterar Status - Botões Organizados */
        .status-btn {
            transition: all 0.3s ease;
            border-width: 2px;
            position: relative;
            overflow: hidden;
        }
        
        .status-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .status-btn.active {
            border-width: 3px;
            box-shadow: 0 0 0 3px rgba(13, 110, 253, 0.25);
        }
        
        .status-btn.btn-outline-primary.active {
            background-color: #0d6efd;
            color: white;
        }
        
        .status-btn.btn-outline-success.active {
            background-color: #198754;
            color: white;
        }
        
        .status-btn.btn-outline-secondary.active {
            background-color: #6c757d;
            color: white;
        }
        
        .status-btn.btn-outline-danger.active {
            background-color: #dc3545;
            color: white;
        }
        
        /* ========================================
           BOTÃO TOGGLE SIDEBAR (Ultra Discreto)
        ======================================== */
        .sidebar-toggle {
            position: fixed;
            top: 72px;
            left: 254px;
            z-index: 1001;
            background: transparent;
            color: rgba(108, 117, 125, 0.4);
            border: none;
            border-radius: 4px;
            width: 24px;
            height: 24px;
            cursor: pointer;
            box-shadow: none;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            opacity: 0.5;
        }
        
        .sidebar-toggle:hover { 
            background: rgba(108, 117, 125, 0.15);
            color: var(--text-secondary);
            opacity: 1;
            transform: scale(1.1);
        }
        
        .sidebar-toggle.collapsed { 
            left: 8px; 
            top: 12px;
            opacity: 0.7;
            background: rgba(108, 117, 125, 0.1);
        }
    </style>
</head>
<body>
    <!-- Botão de Toggle da Sidebar -->
    <button class="sidebar-toggle" id="sidebarToggle" onclick="toggleSidebar()">
        <i class="fas fa-bars"></i>
    </button>

    <div class="wrapper">
        <!-- SIDEBAR -->
        <nav class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h4 class="mb-0"><i class="fas fa-cubes me-2"></i>Polimaquinas</h4>
                <small class="text-muted" style="font-size: 0.75rem;">Portal de Compras</small>
            </div>
            <ul class="list-unstyled components">
                <li><a href="{{ url_for('dashboard') }}"><i class="fas fa-chart-line"></i> Dashboard Financeiro</a></li>
                <li><a href="{{ url_for('status_pedidos') }}"><i class="fas fa-tasks"></i> Status de Pedidos</a></li>
                <li><a href="{{ url_for('performance') }}"><i class="fas fa-tachometer-alt"></i> OTD & Performance</a></li>
                <li><a href="{{ url_for('variacao_preco') }}"><i class="fas fa-balance-scale"></i> Variação de Preço</a></li>
                <li><a href="{{ url_for('terceiros') }}"><i class="fas fa-industry"></i> Terceiros</a></li>
                <li><a href="{{ url_for('solicitacoes') }}"><i class="fas fa-file-alt"></i> Solicitações em Aberto</a></li>
                <li class="active"><a href="{{ url_for('cotacoes') }}"><i class="fas fa-file-invoice-dollar"></i> Cotações e Orçamentos</a></li>
                <li><a href="{{ url_for('avaliacao_iso') }}"><i class="fas fa-certificate"></i> Avaliação ISO (PQ021)</a></li>
            </ul>
        </nav>

        <!-- CONTEÚDO -->
        <div class="content" id="content">
            <!-- HEADER -->
            <div class="page-header d-flex justify-content-between align-items-center">
                <div>
                    <a href="{{ url_for('cotacoes') }}" class="btn btn-outline-secondary btn-sm mb-2">
                        <i class="fas fa-arrow-left me-1"></i> Voltar
                    </a>
                    <h4 id="tituloCotacao"><i class="fas fa-file-invoice-dollar me-2 text-primary"></i>{{ cotacao.codigo }}</h4>
                </div>
                <div>
                    <span class="badge badge-{{ cotacao.status|lower }} px-3 py-2 fs-6" id="badgeStatus">{{ cotacao.status }}</span>
                </div>
            </div>

            <!-- INFORMAÇÕES GERAIS -->
            <div class="card-section">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0" style="border: none; padding: 0;"><i class="fas fa-info-circle me-2"></i>Informações Gerais</h5>
                    <div class="btn-group">
                        <button class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#modalEditarNome">
                            <i class="fas fa-edit me-1"></i> Editar
                        </button>
                        <button class="btn btn-outline-secondary btn-sm" data-bs-toggle="modal" data-bs-target="#modalAlterarStatus">
                            <i class="fas fa-exchange-alt me-1"></i> Alterar Status
                        </button>
                    </div>
                </div>
                <div class="info-grid">
                    <div class="info-item">
                        <label>Código</label>
                        <span id="displayCodigo">{{ cotacao.codigo }}</span>
                    </div>
                    <div class="info-item">
                        <label>Comprador</label>
                        <span>{{ cotacao.comprador_responsavel or 'Não definido' }}</span>
                    </div>
                    <div class="info-item">
                        <label>Data de Criação</label>
                        <span>{{ cotacao.data_criacao[:16] if cotacao.data_criacao else 'N/A' }}</span>
                    </div>
                    <div class="info-item">
                        <label>Status Atual</label>
                        <span class="badge badge-{{ cotacao.status|lower }}">{{ cotacao.status }}</span>
                    </div>
                </div>
                {% if cotacao.observacoes %}
                <div class="mt-3 p-3 bg-light rounded">
                    <label class="small text-muted d-block mb-1"><i class="fas fa-sticky-note me-1"></i>Observações:</label>
                    <p class="mb-0">{{ cotacao.observacoes }}</p>
                </div>
                {% endif %}
            </div>

            <!-- ITENS DA COTAÇÃO -->
            <div class="card-section">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0" style="border: none; padding: 0;"><i class="fas fa-box me-2"></i>Itens da Cotação ({{ cotacao.itens|length }})</h5>
                    <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#modalAdicionarItem">
                        <i class="fas fa-plus me-1"></i> Adicionar Item
                    </button>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>SC</th>
                                <th>Produto</th>
                                <th>Descrição</th>
                                <th>Qtd</th>
                                <th>UN</th>
                                <th>Data Necessidade</th>
                                <th style="width: 100px;">Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in cotacao.itens %}
                            <tr id="row-item-{{ item.id }}">
                                <td class="fw-bold text-primary">{{ item.numero_sc }}</td>
                                <td>{{ item.cod_produto }}</td>
                                <td>{{ item.descricao_produto }}</td>
                                <td>{{ item.quantidade }}</td>
                                <td>{{ item.unidade }}</td>
                                <td>{{ item.data_necessidade[:10] if item.data_necessidade else 'N/A' }}</td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <button class="btn btn-outline-primary btn-editar-item" 
                                                data-id="{{ item.id }}"
                                                data-sc="{{ item.numero_sc }}"
                                                data-produto="{{ item.cod_produto }}"
                                                data-descricao="{{ item.descricao_produto }}"
                                                data-quantidade="{{ item.quantidade }}"
                                                data-unidade="{{ item.unidade }}"
                                                data-necessidade="{{ item.data_necessidade[:10] if item.data_necessidade else '' }}"
                                                title="Editar item">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn btn-outline-danger btn-excluir-item" 
                                                data-id="{{ item.id }}"
                                                data-descricao="{{ item.descricao_produto }}"
                                                title="Excluir item">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% else %}
                            <tr><td colspan="6" class="text-center text-muted">Nenhum item</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- FORNECEDORES -->
            <div class="card-section">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0"><i class="fas fa-building me-2"></i>Fornecedores Cotados ({{ cotacao.fornecedores|length }})</h5>
                    <div class="btn-group">
                        <button class="btn btn-outline-warning btn-sm" data-bs-toggle="modal" data-bs-target="#modalInformacaoFornecedor">
                            <i class="fas fa-exclamation-triangle me-1"></i> Informação ao Fornecedor
                        </button>
                        <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#modalFornecedor">
                            <i class="fas fa-plus me-1"></i> Adicionar Fornecedor
                        </button>
                    </div>
                </div>
                
                {% if cotacao.informacao_fornecedor %}
                <div class="alert alert-warning py-2 px-3 mb-3" style="font-size: 0.85rem; border-left: 4px solid #dc3545;">
                    <i class="fas fa-exclamation-triangle me-2 text-danger"></i>
                    <strong>Informação para fornecedores:</strong> {{ cotacao.informacao_fornecedor }}
                </div>
                {% endif %}
                
                <div class="alert alert-info alert-sm py-2 px-3 mb-3" style="font-size: 0.85rem;">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>Cotação Manual:</strong> Preencha os valores diretamente no sistema. Para enviar ao fornecedor externamente, use <strong>"Enviar Cotação"</strong>.
                </div>
                
                {% if cotacao.fornecedores %}
                <div class="table-responsive">
                    <table class="table table-hover align-middle">
                        <thead class="table-light">
                            <tr>
                                <th>Fornecedor</th>
                                <th>Email</th>
                                <th>Status</th>
                                <th>Cotar Manualmente</th>
                                <th>Cotação Externa</th>
                                <th style="width: 80px;">Anexo</th>
                                <th style="width: 140px;">Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for forn in cotacao.fornecedores %}
                            <tr id="row-forn-{{ forn.id }}">
                                <td class="fw-bold">
                                    <i class="fas fa-building text-muted me-2"></i>
                                    {%- if forn.cod_fornecedor and forn.cod_fornecedor.strip() -%}
                                        <span class="text-primary me-1">{{ forn.cod_fornecedor.strip() }}</span> - 
                                    {%- endif -%}
                                    {{ forn.nome_fornecedor }}
                                </td>
                                <td>
                                    {% if forn.email_fornecedor %}
                                    <a href="mailto:{{ forn.email_fornecedor }}" class="text-decoration-none">
                                        <i class="fas fa-envelope me-1"></i>{{ forn.email_fornecedor }}
                                    </a>
                                    {% else %}
                                    <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if forn.status == 'Respondido' %}
                                    <span class="badge bg-success"><i class="fas fa-check me-1"></i>Respondido</span>
                                    {% elif forn.status == 'Encerrado' %}
                                    <span class="badge bg-secondary"><i class="fas fa-lock me-1"></i>Encerrado</span>
                                    {% else %}
                                    <span class="badge bg-warning text-dark"><i class="fas fa-clock me-1"></i>Pendente</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-outline-primary btn-responder-cotacao"
                                            data-fornecedor-id="{{ forn.id }}"
                                            data-fornecedor-nome="{{ forn.nome_fornecedor }}"
                                            data-token="{{ forn.token_acesso }}"
                                            data-status="{{ forn.status }}"
                                            title="Preencher manualmente os valores da cotação">
                                        {% if forn.status == 'Respondido' %}
                                        <i class="fas fa-edit me-1"></i>Editar Cotação
                                        {% else %}
                                        <i class="fas fa-keyboard me-1"></i>Preencher Cotação
                                        {% endif %}
                                    </button>
                                </td>
                                <td>
                                    <!-- Botões de Cotação Externa -->
                                    <div class="btn-group btn-group-sm">
                                        <button class="btn btn-success btn-gerar-link-externo"
                                                data-fornecedor-id="{{ forn.id }}"
                                                data-fornecedor-nome="{{ forn.nome_fornecedor }}"
                                                title="Gerar link de cotação externa para o fornecedor">
                                            <i class="fas fa-link me-1"></i>Gerar Link
                                        </button>
                                        <button class="btn btn-outline-primary btn-importar-render"
                                                data-fornecedor-id="{{ forn.id }}"
                                                data-fornecedor-nome="{{ forn.nome_fornecedor }}"
                                                title="Verificar/importar resposta do Render">
                                            <i class="fas fa-download"></i>
                                        </button>
                                    </div>
                                </td>
                                <td class="text-center">
                                    {% if forn.tem_anexo and forn.tem_anexo > 0 %}
                                    <div class="btn-group btn-group-sm">
                                        <button class="btn btn-outline-success btn-visualizar-anexo" 
                                                data-fornecedor-id="{{ forn.id }}"
                                                data-fornecedor-nome="{{ forn.nome_fornecedor }}"
                                                title="Visualizar orçamento anexado">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <a href="/cotacao/anexo/{{ forn.id }}/download" class="btn btn-outline-secondary" title="Baixar anexo">
                                            <i class="fas fa-download"></i>
                                        </a>
                                    </div>
                                    {% else %}
                                    <span class="text-muted small">-</span>
                                    {% endif %}
                                </td>
                                <td class="text-center">
                                    <div class="btn-group btn-group-sm">
                                        <button class="btn btn-outline-info btn-editar-forn" 
                                                data-id="{{ forn.id }}" 
                                                data-nome="{{ forn.nome_fornecedor }}"
                                                data-email="{{ forn.email_fornecedor or '' }}"
                                                data-telefone="{{ forn.telefone_fornecedor or '' }}"
                                                title="Editar informações do fornecedor">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn btn-outline-secondary btn-anexar-forn" 
                                                data-id="{{ forn.id }}" 
                                                data-nome="{{ forn.nome_fornecedor }}"
                                                title="Anexar orçamento do fornecedor">
                                            <i class="fas fa-paperclip"></i>
                                        </button>
                                        <button class="btn btn-outline-danger btn-excluir-forn" 
                                                data-id="{{ forn.id }}" 
                                                data-nome="{{ forn.nome_fornecedor }}"
                                                title="Excluir fornecedor da cotação">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-4 text-muted">
                    <i class="fas fa-users fa-2x mb-2 opacity-50"></i>
                    <p class="mb-0">Nenhum fornecedor adicionado a esta cotação</p>
                    <small>Clique em "Adicionar Fornecedor" para começar</small>
                </div>
                {% endif %}
            </div>

            <!-- COMPARATIVO DE PROPOSTAS -->
            {% if cotacao.respostas %}
            <div class="card-section">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0"><i class="fas fa-th me-2"></i>Comparativo de Propostas</h5>
                </div>
                
                <div class="legenda no-print">
                    <div class="legenda-item">
                        <div class="legenda-cor" style="background: #198754;"></div>
                        <span><strong>Melhor Preço Unitário</strong> (por item)</span>
                    </div>
                    <div class="legenda-item">
                        <div class="legenda-cor" style="background: #198754;"></div>
                        <span><strong>Melhor Total</strong> (por fornecedor)</span>
                    </div>
                    <div class="legenda-item">
                        <div class="legenda-cor" style="background: #ffc107;"></div>
                        <span><strong>Menor Prazo</strong> (por item)</span>
                    </div>
                    <div class="legenda-item">
                        <span class="variacao-preco acima" style="font-size: 0.72rem; padding: 2px 6px;">+X%</span>
                        <span><strong>Variação</strong> vs Últ. Preço Pago</span>
                    </div>
                </div>
                
                {% set fornecedores_unicos = [] %}
                {% set forn_data_map = {} %}
                {% for resp in cotacao.respostas %}
                    {% if resp.nome_fornecedor not in fornecedores_unicos %}
                        {% set _ = fornecedores_unicos.append(resp.nome_fornecedor) %}
                        {% set _ = forn_data_map.update({resp.nome_fornecedor: {
                            'id': resp.fornecedor_id,
                            'frete': resp.frete_fornecedor or 0,
                            'condicao': resp.condicao_fornecedor or '',
                            'obs': resp.obs_fornecedor or ''
                        }}) %}
                    {% endif %}
                {% endfor %}
                
                {# Usar lista ordenada do backend se disponível #}
                {% if fornecedores_ordenados %}
                    {% set fornecedores_unicos = fornecedores_ordenados %}
                {% endif %}
                
                <div class="matriz-wrapper">
                    <table class="matriz-respostas" id="tabelaMatriz">
                        <thead>
                            <tr>
                                <th rowspan="2" class="col-codigo">CÓDIGO</th>
                                <th rowspan="2" class="col-item">DESCRIÇÃO DO ITEM</th>
                                <th rowspan="2" class="col-qtd">QTD</th>
                                <th rowspan="2" class="col-ultimo-preco" style="min-width: 100px;" title="Último preço pago conforme histórico de notas fiscais">ÚLT. PREÇO PAGO</th>
                                {% for forn in fornecedores_unicos %}
                                <th colspan="4" class="header-fornecedor forn-{{ loop.index0 % 8 }}">{{ forn }}</th>
                                {% endfor %}
                            </tr>
                            <tr>
                                {% for forn in fornecedores_unicos %}
                                <th class="sub-header">Preço Unit.</th>
                                <th class="sub-header">Total Item</th>
                                <th class="sub-header">Prazo</th>
                                <th class="sub-header">Cond.</th>
                                {% endfor %}
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in cotacao.itens %}
                            <tr data-item-id="{{ item.id }}" data-ultimo-preco="{{ item.ultimo_preco_pago or 0 }}">
                                <td class="col-codigo">{{ item.cod_produto }}</td>
                                <td class="col-item">{{ item.descricao_produto }}</td>
                                <td class="col-qtd">{{ item.quantidade }} {{ item.unidade or 'UN' }}</td>
                                <td class="col-ultimo-preco" style="text-align: center; font-weight: 500;" 
                                    {% if item.ultimo_preco_pago %}
                                    data-bs-toggle="tooltip"
                                    data-bs-placement="top"
                                    title="{% if item.ultimo_preco_fornecedor_cod %}{{ item.ultimo_preco_fornecedor_cod }} - {% endif %}{{ item.ultimo_preco_fornecedor or 'N/A' }} | {{ item.ultimo_preco_data or 'N/A' }}"
                                    {% endif %}>
                                    {% if item.ultimo_preco_pago %}
                                    <span style="color: #1565c0;">R$ {{ "{:,.2f}".format(item.ultimo_preco_pago).replace(',', 'X').replace('.', ',').replace('X', '.') }}</span>
                                    {% if item.ultimo_preco_antigo %}
                                    <span class="badge-preco-antigo" title="Última compra há mais de 2 anos"><i class="fas fa-clock"></i></span>
                                    {% endif %}
                                    {% if item.ultimo_preco_nota %}
                                    <br><small class="text-muted" style="font-size: 0.7rem;">NF {{ item.ultimo_preco_nota }}</small>
                                    {% endif %}
                                    {% else %}
                                    <span class="text-muted">—</span>
                                    {% endif %}
                                </td>
                                {% for forn in fornecedores_unicos %}
                                    {% set resp_data = namespace(found=false, preco=0, prazo=0, subtotal=0, obs='') %}
                                    {% for resp in cotacao.respostas %}
                                        {% if resp.nome_fornecedor == forn and resp.item_id == item.id %}
                                            {% set resp_data.found = true %}
                                            {% set resp_data.preco = resp.preco_unitario or 0 %}
                                            {% set resp_data.prazo = resp.prazo_entrega or 0 %}
                                            {% set resp_data.subtotal = resp_data.preco * item.quantidade %}
                                            {% set resp_data.obs = resp.observacao or '' %}
                                        {% endif %}
                                    {% endfor %}
                                    {% if resp_data.found %}
                                <td class="celula-preco grupo-forn-{{ loop.index0 % 8 }}{% if resp_data.obs %} tem-observacao{% endif %}" data-preco="{{ resp_data.preco }}" data-forn="{{ forn }}"
                                    {% if resp_data.obs %}data-bs-toggle="tooltip" data-bs-placement="top" data-bs-html="true" title="<i class='fas fa-comment-alt me-1'></i>{{ resp_data.obs|e }}"{% endif %}>
                                    <span class="valor-preco-principal">R$ {{ "{:,.2f}".format(resp_data.preco).replace(',', 'X').replace('.', ',').replace('X', '.') }}</span>{% if resp_data.obs %}<i class="fas fa-comment-alt ms-1 text-info" style="font-size: 0.7rem;"></i>{% endif %}
                                    <span class="variacao-preco" data-variacao-calculada="false"></span>
                                </td>
                                <td class="celula-subtotal grupo-forn-{{ loop.index0 % 8 }}" data-subtotal="{{ resp_data.subtotal }}" data-forn="{{ forn }}">R$ {{ "{:,.2f}".format(resp_data.subtotal).replace(',', 'X').replace('.', ',').replace('X', '.') }}</td>
                                <td class="celula-prazo grupo-forn-{{ loop.index0 % 8 }}" data-prazo="{{ resp_data.prazo }}" data-forn="{{ forn }}">{{ resp_data.prazo }} dias</td>
                                <td class="grupo-forn-{{ loop.index0 % 8 }}">{{ forn_data_map[forn].condicao or '-' }}</td>
                                    {% else %}
                                <td class="sem-resposta">-</td>
                                <td class="sem-resposta">-</td>
                                <td class="sem-resposta">-</td>
                                <td class="sem-resposta">-</td>
                                    {% endif %}
                                {% endfor %}
                            </tr>
                            {% endfor %}
                            
                            <!-- LINHA DE FRETE (única por fornecedor) -->
                            <tr class="linha-frete">
                                <td colspan="4" class="text-end fw-bold">FRETE</td>
                                {% for forn in fornecedores_unicos %}
                                <td colspan="4" class="text-center fw-semibold celula-frete" data-frete="{{ forn_data_map[forn].frete }}" data-forn="{{ forn }}">
                                    {% if forn_data_map[forn].frete > 0 %}
                                    R$ {{ "{:,.2f}".format(forn_data_map[forn].frete).replace(',', 'X').replace('.', ',').replace('X', '.') }}
                                    {% else %}
                                    -
                                    {% endif %}
                                </td>
                                {% endfor %}
                            </tr>
                            
                            <!-- LINHA DE TOTAL DO FORNECEDOR -->
                            <tr class="linha-total-fornecedor">
                                <td colspan="4" class="text-end fw-bold">TOTAL FORNECEDOR</td>
                                {% for forn in fornecedores_unicos %}
                                    {% set total_ns = namespace(soma=0) %}
                                    {% for resp in cotacao.respostas %}
                                        {% if resp.nome_fornecedor == forn %}
                                            {% for item in cotacao.itens %}
                                                {% if item.id == resp.item_id %}
                                                    {% set total_ns.soma = total_ns.soma + ((resp.preco_unitario or 0) * item.quantidade) %}
                                                {% endif %}
                                            {% endfor %}
                                        {% endif %}
                                    {% endfor %}
                                    {% set total_ns.soma = total_ns.soma + (forn_data_map[forn].frete or 0) %}
                                <td colspan="4" class="text-center celula-total-fornecedor" data-total="{{ total_ns.soma }}" data-forn="{{ forn }}">
                                    R$ {{ "{:,.2f}".format(total_ns.soma).replace(',', 'X').replace('.', ',').replace('X', '.') }}
                                </td>
                                {% endfor %}
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            {% endif %}

            <!-- ============================================================
                 RODADAS DE NEGOCIAÇÃO - MÚLTIPLOS FORNECEDORES
                 ============================================================ -->
            {% if cotacao.rodadas_agrupadas and cotacao.rodadas_agrupadas.fornecedores|length > 0 %}
            <div class="card-section mt-4" id="secaoRodadaNegociacao">
                <!-- Cabeçalho - Padrão igual ao Comparativo de Propostas -->
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0"><i class="fas fa-handshake me-2"></i>Segunda Rodada de Negociação</h5>
                    <div class="d-flex gap-2">
                        <button class="btn btn-sm btn-dark" data-bs-toggle="modal" data-bs-target="#modalIniciarNegociacao">
                            <i class="fas fa-plus me-1"></i> Adicionar Fornecedor
                        </button>
                        <button class="btn btn-sm btn-outline-secondary" onclick="excluirTodasRodadas({{ cotacao.id }})">
                            <i class="fas fa-trash me-1"></i> Limpar
                        </button>
                    </div>
                </div>
                
                <!-- KPIs - Fundo preto, texto branco -->
                <div class="row mb-4 g-2">
                    <div class="col-md-3">
                        <div class="card border-0 h-100" style="background: #000;">
                            <div class="card-body text-center py-3">
                                <small class="text-white-50 d-block mb-1"><i class="fas fa-users me-1"></i>Fornecedores</small>
                                <h3 class="mb-0 text-white fw-bold">{{ cotacao.rodadas_agrupadas.total_fornecedores }}</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card border-0 h-100" style="background: #000;">
                            <div class="card-body text-center py-3">
                                <small class="text-white-50 d-block mb-1"><i class="fas fa-tag me-1"></i>Melhor Proposta</small>
                                {% if cotacao.rodadas_agrupadas.melhor_proposta %}
                                <h4 class="mb-0 text-white fw-bold">R$ {{ "{:,.2f}".format(cotacao.rodadas_agrupadas.melhor_proposta.total_negociado_com_frete).replace(',', 'X').replace('.', ',').replace('X', '.') }}</h4>
                                {% else %}
                                <h4 class="mb-0 text-white fw-bold">-</h4>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card border-0 h-100" style="background: #000;">
                            <div class="card-body text-center py-3">
                                <small class="text-white-50 d-block mb-1"><i class="fas fa-piggy-bank me-1"></i>Economia Total</small>
                                <h4 class="mb-0 text-white fw-bold">R$ {{ "{:,.2f}".format(cotacao.rodadas_agrupadas.total_economia).replace(',', 'X').replace('.', ',').replace('X', '.') }}</h4>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card border-0 h-100" style="background: #000;">
                            <div class="card-body text-center py-3">
                                <small class="text-white-50 d-block mb-1"><i class="fas fa-trophy me-1"></i>Vencedor</small>
                                {% if cotacao.rodadas_agrupadas.melhor_proposta %}
                                <h6 class="mb-0 text-white fw-bold text-truncate" title="{{ cotacao.rodadas_agrupadas.melhor_proposta.nome_fornecedor }}">
                                    {{ cotacao.rodadas_agrupadas.melhor_proposta.nome_fornecedor[:25] }}{% if cotacao.rodadas_agrupadas.melhor_proposta.nome_fornecedor|length > 25 %}...{% endif %}
                                </h6>
                                {% else %}
                                <h6 class="mb-0 text-white fw-bold">-</h6>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Tabela Comparativa de Fornecedores - Simples, sem accordion -->
                <div class="table-responsive">
                    <table class="table table-bordered table-hover mb-0">
                        <thead style="background: #000; color: white;">
                            <tr>
                                <th>Fornecedor</th>
                                <th class="text-center">Itens</th>
                                <th class="text-center">Total R1</th>
                                <th class="text-center">Frete R2</th>
                                <th class="text-center">Total R2</th>
                                <th class="text-center">Economia</th>
                                <th class="text-center">%</th>
                                <th class="text-center">Status</th>
                                <th class="text-center" style="width: 90px;">Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for forn in cotacao.rodadas_agrupadas.fornecedores %}
                            <tr style="{{ 'background: #f8f9fa;' if forn.is_melhor else '' }}">
                                <td class="fw-bold">
                                    {{ forn.nome_fornecedor }}
                                    {% if forn.desconto_medio > 0 %}
                                    <small class="text-muted ms-1">({{ "%.1f"|format(forn.desconto_medio) }}% desc.)</small>
                                    {% endif %}
                                </td>
                                <td class="text-center">{{ forn.itens|length }}</td>
                                <td class="text-center text-muted">
                                    R$ {{ "{:,.2f}".format(forn.total_original_com_frete).replace(',', 'X').replace('.', ',').replace('X', '.') }}
                                </td>
                                <td class="text-center">
                                    R$ {{ "{:,.2f}".format(forn.frete_negociado).replace(',', 'X').replace('.', ',').replace('X', '.') }}
                                </td>
                                <td class="text-center fw-bold" style="{{ 'background: #198754; color: white;' if forn.is_melhor else '' }}">
                                    R$ {{ "{:,.2f}".format(forn.total_negociado_com_frete).replace(',', 'X').replace('.', ',').replace('X', '.') }}
                                </td>
                                <td class="text-center fw-bold text-success">
                                    {% if forn.economia_absoluta > 0 %}
                                    -R$ {{ "{:,.2f}".format(forn.economia_absoluta).replace(',', 'X').replace('.', ',').replace('X', '.') }}
                                    {% else %}
                                    R$ 0,00
                                    {% endif %}
                                </td>
                                <td class="text-center">
                                    {% if forn.economia_percentual > 0 %}
                                    <span class="badge bg-warning text-dark">{{ "%.1f"|format(forn.economia_percentual) }}%</span>
                                    {% else %}
                                    <span class="badge bg-secondary">0%</span>
                                    {% endif %}
                                </td>
                                <td class="text-center">
                                    {% if forn.is_melhor %}
                                    <span class="badge bg-success">Melhor</span>
                                    {% else %}
                                    <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td class="text-center">
                                    <button class="btn btn-sm btn-outline-dark" 
                                            onclick="abrirModalEditarFornecedorR2Completo({{ forn.fornecedor_id }}, '{{ forn.nome_fornecedor }}', {{ forn.frete_negociado }})"
                                            title="Editar">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-secondary" 
                                            onclick="excluirFornecedorRodada2({{ cotacao.id }}, {{ forn.fornecedor_id }}, '{{ forn.nome_fornecedor }}')" 
                                            title="Excluir">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
            </div>
            {% else %}
            <!-- Botão para iniciar negociação quando não houver rodadas -->
            {% if cotacao.respostas %}
            <div class="card-section mt-4">
                <div class="text-center py-4">
                    <i class="fas fa-handshake fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted mb-3">Nenhuma rodada de negociação iniciada</h5>
                    <p class="text-muted mb-3">Inicie a segunda rodada para negociar melhores condições com os fornecedores.</p>
                    <button class="btn btn-dark btn-lg" data-bs-toggle="modal" data-bs-target="#modalIniciarNegociacao">
                        <i class="fas fa-plus me-2"></i>Iniciar Segunda Rodada de Negociação
                    </button>
                </div>
            </div>
            {% endif %}
            {% endif %}
            
            <!-- Modal: Editar Fornecedor Rodada 2 - COMPLETO (com itens) -->
            <div class="modal fade" id="modalEditarFornecedorR2Completo" tabindex="-1">
                <div class="modal-dialog modal-xl">
                    <div class="modal-content">
                        <div class="modal-header" style="background: #000; color: white;">
                            <h5 class="modal-title"><i class="fas fa-edit me-2"></i>Editar Negociação - Rodada 2</h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <input type="hidden" id="editR2CompletoFornecedorId">
                            
                            <!-- Cabeçalho Fornecedor -->
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <label class="form-label fw-bold">Fornecedor</label>
                                    <input type="text" class="form-control bg-light" id="editR2CompletoFornecedorNome" readonly>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label fw-bold"><i class="fas fa-truck me-1"></i>Frete R2 (R$)</label>
                                    <input type="text" class="form-control" id="editR2CompletoFreteNegociado" 
                                           placeholder="0,00" oninput="formatarMoedaModal(this); recalcularTotaisModalCompleto();">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label fw-bold"><i class="fas fa-percent me-1"></i>Desconto Global</label>
                                    <div class="input-group">
                                        <input type="number" class="form-control" id="editR2CompletoDescontoGlobal" 
                                               min="0" max="100" step="0.5" placeholder="0">
                                        <span class="input-group-text">%</span>
                                        <button class="btn btn-outline-dark" type="button" onclick="aplicarDescontoGlobalCompleto()">
                                            Aplicar
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Tabela de Itens Editável -->
                            <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                                <table class="table table-sm table-bordered table-hover" id="tabelaItensEditR2">
                                    <thead style="background: #343a40; color: white; position: sticky; top: 0;">
                                        <tr>
                                            <th style="width: 40%;">Item / Descrição</th>
                                            <th class="text-center" style="width: 10%;">Qtd</th>
                                            <th class="text-end" style="width: 15%;">Preço R1 (Unit.)</th>
                                            <th class="text-end" style="width: 15%;">Preço R2 (Unit.)</th>
                                            <th class="text-center" style="width: 10%;">Desc. %</th>
                                            <th class="text-end" style="width: 10%;">Total R2</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tbodyItensEditR2">
                                        <!-- Preenchido via JS -->
                                    </tbody>
                                    <tfoot style="background: #f8f9fa; font-weight: bold;">
                                        <tr>
                                            <td colspan="3" class="text-end">Subtotal Itens:</td>
                                            <td colspan="3" class="text-end" id="editR2SubtotalItens">R$ 0,00</td>
                                        </tr>
                                        <tr>
                                            <td colspan="3" class="text-end">+ Frete:</td>
                                            <td colspan="3" class="text-end" id="editR2ValorFrete">R$ 0,00</td>
                                        </tr>
                                        <tr style="background: #000; color: white;">
                                            <td colspan="3" class="text-end">TOTAL GERAL R2:</td>
                                            <td colspan="3" class="text-end" id="editR2TotalGeral">R$ 0,00</td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                            
                            <!-- Resumo da Economia -->
                            <div class="alert alert-success mt-3 mb-0" id="alertEconomiaEditR2" style="display: none;">
                                <div class="row text-center">
                                    <div class="col-md-4">
                                        <small class="text-muted">Total R1</small>
                                        <div class="fw-bold" id="editR2TotalR1">R$ 0,00</div>
                                    </div>
                                    <div class="col-md-4">
                                        <small class="text-muted">Economia</small>
                                        <div class="fw-bold text-success" id="editR2Economia">-R$ 0,00</div>
                                    </div>
                                    <div class="col-md-4">
                                        <small class="text-muted">Percentual</small>
                                        <div class="fw-bold"><span class="badge bg-warning text-dark" id="editR2EconomiaPercent">0%</span></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                            <button type="button" class="btn btn-dark" onclick="salvarEdicaoFornecedorR2Completo()">
                                <i class="fas fa-save me-1"></i>Salvar Todas as Alterações
                            </button>
                        </div>
                    </div>
                </div>
            </div>


        </div>
    </div>

    <!-- MODAL ADICIONAR ITEM À COTAÇÃO -->
    <div class="modal fade" id="modalAdicionarItem" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title"><i class="fas fa-plus-circle me-2"></i>Adicionar Item à Cotação</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info" id="alertAddItemInfo">
                        <i class="fas fa-info-circle me-2"></i>
                        Adicione um novo item à cotação. Informe o <strong>Número da SC</strong> e o <strong>Código do Produto</strong> para preencher automaticamente os dados da solicitação.
                    </div>
                    
                    <!-- Alerta de sucesso quando dados são preenchidos automaticamente -->
                    <div class="alert alert-success d-none" id="alertAddItemSucesso">
                        <i class="fas fa-check-circle me-2"></i>
                        <span id="alertAddItemSucessoMsg">Dados preenchidos automaticamente da solicitação!</span>
                    </div>
                    
                    <!-- Alerta de aviso quando SC existe mas produto não -->
                    <div class="alert alert-warning d-none" id="alertAddItemAviso">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <span id="alertAddItemAvisoMsg"></span>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label class="form-label fw-bold">Número SC</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="addItemSC" placeholder="Ex: 000123">
                                <button class="btn btn-outline-primary" type="button" id="btnBuscarSolicitacao" title="Buscar dados da solicitação">
                                    <i class="fas fa-search"></i>
                                </button>
                            </div>
                            <small class="text-muted">Deixe vazio para item manual</small>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label fw-bold">Código Produto *</label>
                            <input type="text" class="form-control" id="addItemCodProduto" placeholder="Ex: MAT-001" required>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label fw-bold">Unidade</label>
                            <input type="text" class="form-control" id="addItemUnidade" placeholder="UN" value="UN">
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold">Descrição do Produto *</label>
                        <input type="text" class="form-control" id="addItemDescricao" placeholder="Descrição completa do produto" required>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">Quantidade *</label>
                            <input type="number" class="form-control" id="addItemQuantidade" placeholder="0" min="0.01" step="0.01" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">Data Necessidade</label>
                            <input type="date" class="form-control" id="addItemDataNecessidade">
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Observação (opcional)</label>
                        <textarea class="form-control" id="addItemObs" rows="2" placeholder="Informações adicionais sobre o item..."></textarea>
                    </div>
                    
                    <!-- Campo oculto para indicar se dados vieram da solicitação -->
                    <input type="hidden" id="addItemOrigemSolicitacao" value="0">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>Cancelar
                    </button>
                    <button type="button" class="btn btn-primary" id="btnAdicionarItem">
                        <i class="fas fa-plus me-1"></i>Adicionar Item
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL EDITAR ITEM DA COTAÇÃO -->
    <div class="modal fade" id="modalEditarItem" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-warning text-dark">
                    <h5 class="modal-title"><i class="fas fa-edit me-2"></i>Editar Item da Cotação</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="editItemId">
                    
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label class="form-label fw-bold">Número SC</label>
                            <input type="text" class="form-control" id="editItemSC" placeholder="Ex: 000123">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label fw-bold">Código Produto *</label>
                            <input type="text" class="form-control" id="editItemCodProduto" required>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label fw-bold">Unidade</label>
                            <input type="text" class="form-control" id="editItemUnidade" value="UN">
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold">Descrição do Produto *</label>
                        <input type="text" class="form-control" id="editItemDescricao" required>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">Quantidade *</label>
                            <input type="number" class="form-control" id="editItemQuantidade" min="0.01" step="0.01" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">Data Necessidade</label>
                            <input type="date" class="form-control" id="editItemDataNecessidade">
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>Cancelar
                    </button>
                    <button type="button" class="btn btn-warning" id="btnSalvarEditarItem">
                        <i class="fas fa-save me-1"></i>Salvar Alterações
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL ADICIONAR FORNECEDOR -->
    <div class="modal fade" id="modalFornecedor" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title"><i class="fas fa-user-plus me-2"></i>Adicionar Fornecedor</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="d-flex mb-4 gap-2">
                        <button type="button" class="btn flex-fill btn-toggle-modo active" id="btnModoCadastrado">
                            <i class="fas fa-database me-2"></i>Selecionar Cadastrado
                        </button>
                        <button type="button" class="btn flex-fill btn-toggle-modo" id="btnModoManual">
                            <i class="fas fa-edit me-2"></i>Fornecedor Não Cadastrado
                        </button>
                    </div>
                    
                    <!-- MODO CADASTRADO -->
                    <div id="modoCadastrado">
                        <div class="mb-3">
                            <label class="form-label fw-bold">Buscar Fornecedor</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-search"></i></span>
                                <input type="text" class="form-control" id="buscaFornecedor" 
                                       placeholder="Digite o nome ou código do fornecedor...">
                                <button class="btn btn-outline-secondary" type="button" id="btnLimparBusca">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <div class="d-flex justify-content-between align-items-center mt-1">
                                <small class="text-muted">Mínimo 2 caracteres para buscar</small>
                                <button type="button" class="btn btn-link btn-sm p-0 text-decoration-none" id="btnTestarConexao">
                                    <i class="fas fa-plug me-1"></i>Testar conexão
                                </button>
                            </div>
                            <div id="statusConexaoTOTVS" class="mt-2" style="display: none;"></div>
                        </div>
                        
                        <div id="listaFornecedores" class="border rounded" style="max-height: 250px; overflow-y: auto; display: none;"></div>
                        
                        <!-- Área para mostrar múltiplos fornecedores selecionados -->
                        <div id="fornecedoresSelecionadosArea" class="mt-3 d-none">
                            <label class="form-label fw-bold text-success">
                                <i class="fas fa-check-circle me-1"></i>
                                Fornecedores Selecionados (<span id="contadorSelecionados">0</span>):
                            </label>
                            <div id="tagsSelecionados" class="d-flex flex-wrap gap-2 p-2 border rounded bg-light" style="min-height: 50px;">
                                <!-- Tags inseridas via JavaScript -->
                            </div>
                            <div class="d-flex justify-content-end mt-2">
                                <button type="button" class="btn btn-sm btn-outline-danger" id="btnLimparTodosSelecionados">
                                    <i class="fas fa-times me-1"></i>Limpar Todos
                                </button>
                            </div>
                        </div>
                        <input type="hidden" id="fornCodigo">
                    </div>
                    
                    <!-- MODO MANUAL -->
                    <div id="modoManual" style="display: none;">
                        <div class="alert alert-warning mb-3">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <small>Use esta opção apenas para fornecedores que <strong>não estão cadastrados</strong> no sistema TOTVS.</small>
                        </div>
                        <div class="row">
                            <div class="col-12 mb-3">
                                <label class="form-label fw-bold">Nome do Fornecedor *</label>
                                <input type="text" class="form-control" id="fornNome" placeholder="Digite o nome completo">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Email</label>
                                <input type="email" class="form-control" id="fornEmail" placeholder="email@empresa.com">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Telefone</label>
                                <input type="text" class="form-control" id="fornTelefone" placeholder="(00) 00000-0000">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>Cancelar
                    </button>
                    <button type="button" class="btn btn-success" id="btnAdicionarForn">
                        <i class="fas fa-plus me-1"></i>Adicionar Fornecedor(es)
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL EDITAR NOME -->
    <div class="modal fade" id="modalEditarNome" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title"><i class="fas fa-edit me-2"></i>Editar Nome da Cotação</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body py-4">
                    <div class="mb-3">
                        <label class="form-label fw-bold">Nome / Código da Cotação</label>
                        <input type="text" class="form-control form-control-lg" id="inputNomeCotacao" 
                               value="{{ cotacao.codigo }}" placeholder="Ex: Cotação Prateleiras 2026/01">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="btnSalvarNome"><i class="fas fa-save me-1"></i> Salvar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL INFORMAÇÃO FORNECEDOR -->
    <div class="modal fade" id="modalInformacaoFornecedor" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow">
                <div class="modal-header bg-warning text-dark">
                    <h5 class="modal-title"><i class="fas fa-exclamation-triangle me-2"></i>Informação ao Fornecedor</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body py-4">
                    <div class="alert alert-info mb-3">
                        <i class="fas fa-info-circle me-2"></i>
                        <small>Esta mensagem será exibida para <strong>todos os fornecedores</strong>.</small>
                    </div>
                    <textarea class="form-control" id="inputInformacaoFornecedor" rows="4" 
                              placeholder="Ex: Não cotar produtos da marca X.">{{ cotacao.informacao_fornecedor or '' }}</textarea>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-warning" id="btnSalvarInfoForn"><i class="fas fa-save me-1"></i> Salvar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL ALTERAR STATUS -->
    <div class="modal fade" id="modalAlterarStatus" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg">
                <div class="modal-header bg-primary text-white border-0">
                    <h5 class="modal-title fw-bold"><i class="fas fa-exchange-alt me-2"></i>Alterar Status</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <p class="text-center text-muted mb-4">Selecione o novo status:</p>
                    
                    <!-- Grid de Status Organizado -->
                    <div class="row g-3" id="botoesStatus">
                        <!-- Aberta -->
                        <div class="col-6">
                            <button type="button" class="btn btn-outline-primary status-btn w-100 py-3 {{ 'active' if cotacao.status == 'Aberta' else '' }}" data-status="Aberta">
                                <i class="fas fa-folder-open d-block mb-2" style="font-size: 1.5rem;"></i>
                                <span class="fw-semibold">Aberta</span>
                            </button>
                        </div>
                        
                        <!-- Respondida -->
                        <div class="col-6">
                            <button type="button" class="btn btn-outline-success status-btn w-100 py-3 {{ 'active' if cotacao.status == 'Respondida' else '' }}" data-status="Respondida">
                                <i class="fas fa-check-circle d-block mb-2" style="font-size: 1.5rem;"></i>
                                <span class="fw-semibold">Respondida</span>
                            </button>
                        </div>
                        
                        <!-- Encerrada -->
                        <div class="col-6">
                            <button type="button" class="btn btn-outline-secondary status-btn w-100 py-3 {{ 'active' if cotacao.status == 'Encerrada' else '' }}" data-status="Encerrada">
                                <i class="fas fa-lock d-block mb-2" style="font-size: 1.5rem;"></i>
                                <span class="fw-semibold">Encerrada</span>
                            </button>
                        </div>
                        
                        <!-- Cancelada -->
                        <div class="col-6">
                            <button type="button" class="btn btn-outline-danger status-btn w-100 py-3 {{ 'active' if cotacao.status == 'Cancelada' else '' }}" data-status="Cancelada">
                                <i class="fas fa-times-circle d-block mb-2" style="font-size: 1.5rem;"></i>
                                <span class="fw-semibold">Cancelada</span>
                            </button>
                        </div>
                    </div>
                    
                    <input type="hidden" id="novoStatusSelecionado" value="{{ cotacao.status }}">
                </div>
                <div class="modal-footer border-0 pt-0 justify-content-center">
                    <button type="button" class="btn btn-secondary px-4" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i> Cancelar
                    </button>
                    <button type="button" class="btn btn-primary px-4" id="btnConfirmarStatus">
                        <i class="fas fa-check me-1"></i> Confirmar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL EDITAR RESPOSTA -->
    <div class="modal fade" id="modalEditarResposta" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content border-0 shadow">
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title"><i class="fas fa-edit me-2"></i>Editar Resposta do Fornecedor</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body py-4">
                    <input type="hidden" id="editRespostaId">
                    <div class="alert alert-light border mb-4">
                        <div class="row">
                            <div class="col-md-6">
                                <small class="text-muted d-block">Item</small>
                                <strong id="editItemDescricao">-</strong>
                            </div>
                            <div class="col-md-6">
                                <small class="text-muted d-block">Fornecedor</small>
                                <strong id="editRespostaFornecedorNome" class="text-primary">-</strong>
                            </div>
                        </div>
                    </div>
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label class="form-label fw-bold">Preço Unitário (R$)</label>
                            <input type="text" class="form-control form-control-lg" id="editPrecoUnitario" placeholder="Ex: 1.250,50">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label fw-bold">Prazo de Entrega (dias)</label>
                            <input type="number" class="form-control form-control-lg" id="editPrazoEntrega" placeholder="Ex: 15">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label fw-bold">Frete (R$)</label>
                            <input type="text" class="form-control form-control-lg" id="editFrete" placeholder="Ex: 150,00">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Condição de Pagamento</label>
                            <input type="text" class="form-control" id="editCondicaoPagamento" placeholder="Ex: 30 DDL">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Observação</label>
                            <input type="text" class="form-control" id="editObservacao" placeholder="Informações adicionais">
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-info text-white" id="btnSalvarResposta"><i class="fas fa-save me-1"></i> Salvar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL EDITAR FORNECEDOR -->
    <div class="modal fade" id="modalEditarFornecedor" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content border-0 shadow">
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title"><i class="fas fa-user-edit me-2"></i>Editar Informações do Fornecedor</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body py-4">
                    <input type="hidden" id="editFornecedorId">
                    <input type="hidden" id="editFornecedorCotacaoId" value="{{ cotacao.id }}">
                    
                    <!-- Dados Básicos do Fornecedor -->
                    <h6 class="fw-bold text-info mb-3"><i class="fas fa-user me-2"></i>Dados do Fornecedor</h6>
                    <div class="row g-3 mb-4">
                        <div class="col-12">
                            <label class="form-label fw-bold">Nome do Fornecedor *</label>
                            <input type="text" class="form-control form-control-lg" id="inputEditFornecedorNome" placeholder="Digite o nome do fornecedor" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Email</label>
                            <input type="email" class="form-control" id="inputEditFornecedorEmail" placeholder="email@empresa.com">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Telefone</label>
                            <input type="text" class="form-control" id="inputEditFornecedorTelefone" placeholder="(00) 00000-0000">
                        </div>
                    </div>
                    
                    <hr>
                    
                    <!-- Proposta Segunda Rodada -->
                    <div class="p-3 rounded" style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); border: 1px dashed #1976d2;">
                        <h6 class="fw-bold text-primary mb-3">
                            <i class="fas fa-handshake me-2"></i>Proposta da Segunda Rodada (opcional)
                        </h6>
                        <p class="small text-muted mb-3">
                            <i class="fas fa-info-circle me-1"></i>
                            Preencha os campos abaixo para inserir ou atualizar a proposta da segunda rodada deste fornecedor.
                        </p>
                        
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label fw-bold"><i class="fas fa-percent text-warning me-1"></i>Desconto Global (%)</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="inputEditFornecedorDescontoR2" 
                                           min="0" max="100" step="0.5" value="" placeholder="0">
                                    <span class="input-group-text">%</span>
                                </div>
                                <small class="text-muted">Aplicado a todos os itens da proposta original</small>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold"><i class="fas fa-truck me-1"></i>Frete Negociado (R$)</label>
                                <input type="text" class="form-control" id="inputEditFornecedorFreteR2" 
                                       placeholder="0,00" oninput="formatarMoedaModal(this)">
                            </div>
                        </div>
                        
                        <div class="row g-3 mt-2">
                            <div class="col-md-6">
                                <label class="form-label fw-bold"><i class="fas fa-calendar me-1"></i>Prazo Negociado (dias)</label>
                                <input type="number" class="form-control" id="inputEditFornecedorPrazoR2" 
                                       min="0" placeholder="Ex: 15">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold"><i class="fas fa-file-alt me-1"></i>Condição de Pagamento</label>
                                <input type="text" class="form-control" id="inputEditFornecedorCondicaoR2" 
                                       placeholder="Ex: 30/60/90 DDL">
                            </div>
                        </div>
                        
                        <div class="mt-3">
                            <label class="form-label fw-bold"><i class="fas fa-paperclip text-success me-1"></i>Anexar Orçamento/Proposta R2</label>
                            <input type="file" class="form-control" id="inputEditFornecedorAnexoR2" 
                                   accept=".pdf,.jpg,.jpeg,.png,.doc,.docx,.xls,.xlsx">
                            <small class="text-muted">PDF, imagens, Word ou Excel (máx. 10MB)</small>
                            <div id="previewAnexoEditR2" class="mt-2" style="display: none;">
                                <span class="badge bg-success"><i class="fas fa-check me-1"></i><span id="nomeAnexoEditR2"></span></span>
                                <button type="button" class="btn btn-sm btn-outline-danger ms-2" onclick="removerAnexoEditR2()">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div class="mt-3">
                            <label class="form-label fw-bold">Observação da Negociação</label>
                            <textarea class="form-control" id="inputEditFornecedorObsR2" rows="2" 
                                      placeholder="Ex: Valores negociados via telefone em DD/MM/AAAA"></textarea>
                        </div>
                        
                        <!-- Indicador de R2 existente -->
                        <div id="indicadorR2Existente" class="alert alert-success mt-3 py-2" style="display: none;">
                            <i class="fas fa-check-circle me-2"></i>
                            <span id="textoR2Existente">Este fornecedor já possui proposta na segunda rodada.</span>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-info text-white" id="btnSalvarFornecedor">
                        <i class="fas fa-save me-1"></i> Salvar Alterações
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL ANEXAR ORÇAMENTO -->
    <div class="modal fade" id="modalAnexarOrcamento" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow">
                <div class="modal-header bg-secondary text-white">
                    <h5 class="modal-title"><i class="fas fa-paperclip me-2"></i>Anexar Orçamento</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body py-4">
                    <input type="hidden" id="anexoFornecedorId">
                    <div class="alert alert-light border mb-3">
                        <small class="text-muted d-block">Fornecedor</small>
                        <strong id="anexoFornecedorNome" class="text-primary">-</strong>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">Selecione o arquivo do orçamento</label>
                        <input type="file" class="form-control form-control-lg" id="inputAnexoArquivo" 
                               accept=".pdf,.jpg,.jpeg,.png,.doc,.docx,.xls,.xlsx">
                        <small class="text-muted mt-1 d-block">
                            <i class="fas fa-info-circle me-1"></i>
                            Formatos aceitos: PDF, imagens (JPG, PNG), Word, Excel
                        </small>
                    </div>
                    <div id="previewAnexo" class="d-none">
                        <div class="alert alert-success py-2">
                            <i class="fas fa-file me-2"></i>
                            <span id="nomeArquivoAnexo"></span>
                            <button type="button" class="btn btn-sm btn-link text-danger float-end p-0" id="btnRemoverAnexo">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="btnEnviarAnexo">
                        <i class="fas fa-upload me-1"></i> Enviar Anexo
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL COTAÇÃO EXTERNA (LINK OU ARQUIVO) -->
    <div class="modal fade" id="modalGerarJson" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content border-0 shadow">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title"><i class="fas fa-link me-2"></i>Gerar Link Externo</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body py-4">
                    <input type="hidden" id="linkExternoFornecedorId">
                    
                    <!-- Info do Fornecedor -->
                    <div class="alert alert-light border mb-4">
                        <small class="text-muted d-block">Fornecedor</small>
                        <strong id="linkExternoFornecedorNome" class="text-primary fs-5">-</strong>
                    </div>
                    
                    <!-- Estado: Aguardando Gerar -->
                    <div id="estadoAguardandoGerar">
                        <div class="text-center py-4">
                            <i class="fas fa-link fa-3x text-primary mb-3"></i>
                            <p class="text-muted mb-4">Clique no botão abaixo para gerar um link de cotação para este fornecedor.</p>
                            <button type="button" class="btn btn-success btn-lg" id="btnGerarLinkExterno" onclick="gerarLinkExternoSimplificado()">
                                <i class="fas fa-magic me-2"></i> Gerar Link Externo
                            </button>
                            <p class="text-muted small mt-3 mb-0">O link será válido por 72 horas</p>
                        </div>
                    </div>
                    
                    <!-- Estado: Gerando -->
                    <div id="estadoGerandoLink" style="display: none;">
                        <div class="text-center py-4">
                            <div class="spinner-border text-primary mb-3" role="status" style="width: 3rem; height: 3rem;">
                                <span class="visually-hidden">Gerando...</span>
                            </div>
                            <p class="text-muted mb-0">Gerando link externo...</p>
                        </div>
                    </div>
                    
                    <!-- Estado: Link Gerado -->
                    <div id="estadoLinkGerado" style="display: none;">
                        <div class="alert alert-success mb-4">
                            <i class="fas fa-check-circle me-2"></i>
                            <strong>Link gerado com sucesso!</strong>
                        </div>
                        
                        <!-- Link para copiar -->
                        <div class="mb-4">
                            <label class="form-label fw-bold">Link para o Fornecedor:</label>
                            <div class="input-group input-group-lg">
                                <input type="text" class="form-control bg-light" id="linkExternoGerado" readonly>
                                <button class="btn btn-primary" type="button" onclick="copiarLinkExternoSimplificado()">
                                    <i class="fas fa-copy me-1"></i> Copiar
                                </button>
                            </div>
                            <small class="text-success"><i class="fas fa-clock me-1"></i>Válido por 72 horas</small>
                        </div>
                        
                        <!-- Botão de Sincronizar (aparece quando respondido) -->
                        <div class="mb-4 text-center" id="btnSincronizarContainer" style="display: none;">
                            <button type="button" class="btn btn-warning btn-lg" id="btnSincronizarResposta" onclick="sincronizarRespostaDoModal()">
                                <i class="fas fa-sync me-2"></i> Sincronizar Resposta do Fornecedor
                            </button>
                        </div>
                        
                        <!-- Texto pronto para enviar -->
                        <div class="card border-success">
                            <div class="card-header bg-success text-white py-2 d-flex justify-content-between align-items-center">
                                <small class="fw-bold"><i class="fas fa-envelope me-1"></i>Texto pronto para enviar:</small>
                                <button class="btn btn-sm btn-light py-0" onclick="copiarTextoCompleto()">
                                    <i class="fas fa-copy me-1"></i>Copiar Tudo
                                </button>
                            </div>
                            <div class="card-body py-3" style="font-size: 13px; background: #f8f9fa;" id="textoParaEnviar">
                                <p class="mb-2">Prezado fornecedor,</p>
                                <p class="mb-2">Solicitamos cotação de preços. Por favor, acesse o link abaixo e preencha os valores:</p>
                                <p class="mb-2 text-success fw-bold" id="linkNoTextoSimplificado">[LINK]</p>
                                <p class="mb-2"><strong>Instruções:</strong> Preencha os preços e prazos de cada item e clique em "Enviar Cotação".</p>
                                <p class="mb-0">Atenciosamente,<br>Setor de Compras</p>
                            </div>
                        </div>
                        
                        <!-- Botão para gerar novo link -->
                        <div class="mt-3 text-center">
                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="forcarNovoLink()">
                                <i class="fas fa-redo me-1"></i> Gerar Novo Link (invalida o anterior)
                            </button>
                        </div>
                    </div>
                    
                    <!-- Estado: Erro -->
                    <div id="estadoErroLink" style="display: none;">
                        <div class="alert alert-danger mb-3">
                            <i class="fas fa-exclamation-circle me-2"></i>
                            <strong>Erro ao gerar link</strong>
                            <p class="mb-0 mt-2" id="mensagemErroLink"></p>
                        </div>
                        <div class="text-center">
                            <button type="button" class="btn btn-primary me-2" onclick="resetarModalLink()">
                                <i class="fas fa-redo me-1"></i> Tentar Novamente
                            </button>
                            <button type="button" class="btn btn-warning" onclick="forcarNovoLink()">
                                <i class="fas fa-plus me-1"></i> Gerar Novo Link
                            </button>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL RESPONDER COTAÇÃO (POPUP PARA EDITAR/CRIAR RESPOSTAS) -->
    <div class="modal fade" id="modalResponderCotacao" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-xl">
            <div class="modal-content border-0 shadow">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title"><i class="fas fa-file-invoice-dollar me-2"></i>Cotação - <span id="modalFornecedorNome"></span></h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body py-4">
                    <input type="hidden" id="modalFornecedorId">
                    <input type="hidden" id="modalToken">
                    
                    <!-- Status -->
                    <div id="modalStatusBadge" class="mb-3"></div>
                    
                    <!-- Tabela de Itens (somente preço e prazo por item) -->
                    <h6 class="mb-2"><i class="fas fa-list me-2"></i>Itens da Cotação</h6>
                    <div class="table-responsive mb-4">
                        <table class="table table-bordered table-hover mb-0" id="tabelaItensModal">
                            <thead class="table-light">
                                <tr>
                                    <th style="width: 100px;">Código</th>
                                    <th>Descrição</th>
                                    <th style="width: 80px;">Qtd</th>
                                    <th style="width: 140px;">Preço Unit. (R$)</th>
                                    <th style="width: 100px;">Prazo (dias)</th>
                                    <th style="width: 200px;">Observação</th>
                                </tr>
                            </thead>
                            <tbody id="tbodyItensModal">
                                <!-- Preenchido via JavaScript -->
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Campos únicos do fornecedor -->
                    <div class="card border-primary mb-3">
                        <div class="card-header bg-light py-2">
                            <h6 class="mb-0"><i class="fas fa-truck me-2"></i>Informações Gerais do Fornecedor</h6>
                        </div>
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <label class="form-label fw-semibold">Frete (R$)</label>
                                    <input type="text" class="form-control" id="inputFreteFornecedor" 
                                           placeholder="0,00" oninput="formatarMoedaInput(this)">
                                    <small class="text-muted">Valor único para todos os itens</small>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label fw-semibold">Condição de Pagamento</label>
                                    <input type="text" class="form-control" id="inputCondicaoFornecedor" 
                                           placeholder="Ex: 30 DDL, À vista, etc.">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label fw-semibold">Observação</label>
                                    <input type="text" class="form-control" id="inputObsFornecedor" 
                                           placeholder="Observações gerais...">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Anexo de Orçamento PDF -->
                    <div class="card border-primary mb-3">
                        <div class="card-header bg-light py-2">
                            <h6 class="mb-0"><i class="fas fa-paperclip me-2"></i>Anexar Orçamento (PDF)</h6>
                        </div>
                        <div class="card-body">
                            <div class="row align-items-center">
                                <div class="col-md-8">
                                    <input type="file" class="form-control" id="inputAnexoOrcamento" 
                                           accept=".pdf,.doc,.docx,.xls,.xlsx,.jpg,.jpeg,.png">
                                    <small class="text-muted">Formatos aceitos: PDF, Word, Excel, Imagens (máx. 16MB)</small>
                                </div>
                                <div class="col-md-4">
                                    <div id="anexoAtualInfo" class="d-none">
                                        <span class="badge bg-success me-2">
                                            <i class="fas fa-check-circle me-1"></i>
                                            <span id="nomeAnexoAtual">Anexo existente</span>
                                        </span>
                                        <small class="text-muted">(novo arquivo substitui)</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="loadingModal" class="text-center py-4 d-none">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Carregando...</span>
                        </div>
                        <p class="mt-2 text-muted">Carregando itens...</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-success" id="btnSalvarRespostasModal">
                        <i class="fas fa-save me-1"></i> Salvar Respostas
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL VISUALIZAR ANEXO -->
    <div class="modal fade" id="modalVisualizarAnexo" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-xl">
            <div class="modal-content border-0 shadow">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title"><i class="fas fa-file-alt me-2"></i>Anexo - <span id="anexoFornecedorNomeModal"></span></h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-0" style="min-height: 500px;">
                    <div id="loadingAnexo" class="text-center py-5">
                        <div class="spinner-border text-success" role="status">
                            <span class="visually-hidden">Carregando...</span>
                        </div>
                        <p class="mt-2 text-muted">Carregando anexo...</p>
                    </div>
                    <iframe id="iframeAnexo" src="" style="width: 100%; height: 70vh; border: none; display: none;"></iframe>
                    <div id="erroAnexo" class="text-center py-5 d-none">
                        <i class="fas fa-exclamation-triangle fa-3x text-warning mb-3"></i>
                        <p class="text-muted">Não foi possível carregar o anexo no navegador.</p>
                        <a id="linkAbrirAnexo" href="#" target="_blank" class="btn btn-outline-primary">
                            <i class="fas fa-external-link-alt me-1"></i>Abrir em nova aba
                        </a>
                    </div>
                </div>
                <div class="modal-footer">
                    <a id="linkDownloadAnexo" href="#" class="btn btn-outline-secondary">
                        <i class="fas fa-download me-1"></i> Baixar Arquivo
                    </a>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Iniciar Rodada de Negociação -->
    <div class="modal fade" id="modalIniciarNegociacao" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header" style="background: #000000; color: white;">
                    <h5 class="modal-title"><i class="fas fa-handshake me-2"></i>Iniciar Rodada de Negociação (Rodada 2)</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        Selecione o fornecedor para negociar e informe os novos preços/prazos negociados.
                    </div>
                    
                    <!-- Seleção de Fornecedor -->
                    <div class="mb-4">
                        <label class="form-label fw-bold">Fornecedor para Negociação *</label>
                        <select class="form-select" id="fornecedorNegociacao" onchange="carregarItensNegociacao()">
                            <option value="">Selecione o fornecedor...</option>
                            {% set fornecedores_unicos_modal = [] %}
                            {% for resp in cotacao.respostas %}
                                {% if resp.fornecedor_id not in fornecedores_unicos_modal %}
                                    <option value="{{ resp.fornecedor_id }}">{{ resp.nome_fornecedor }}</option>
                                    {% set _ = fornecedores_unicos_modal.append(resp.fornecedor_id) %}
                                {% endif %}
                            {% endfor %}
                        </select>
                    </div>
                    
                    <!-- Tabela de Itens para Negociação -->
                    <div id="containerItensNegociacao" style="display: none;">
                        <!-- Campo de Desconto Global -->
                        <div class="mb-3 p-3" style="background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%); border-radius: 8px;">
                            <div class="row align-items-center">
                                <div class="col-auto">
                                    <label class="form-label fw-bold mb-0">
                                        <i class="fas fa-percent text-warning me-2"></i>Aplicar Desconto Global:
                                    </label>
                                </div>
                                <div class="col-auto">
                                    <div class="input-group" style="width: 150px;">
                                        <input type="number" class="form-control" id="descontoGlobal" 
                                               min="0" max="100" step="0.5" value="0" placeholder="0">
                                        <span class="input-group-text">%</span>
                                    </div>
                                </div>
                                <div class="col-auto">
                                    <button type="button" class="btn btn-warning" onclick="aplicarDescontoGlobal()">
                                        <i class="fas fa-calculator me-1"></i>Aplicar aos Selecionados
                                    </button>
                                </div>
                                <div class="col">
                                    <small class="text-muted">O desconto será aplicado sobre o preço original dos itens selecionados</small>
                                </div>
                            </div>
                        </div>
                        
                        <h6 class="mb-3">Informe os valores negociados:</h6>
                        <div class="table-responsive">
                            <table class="table table-bordered">
                                <thead class="table-light">
                                    <tr>
                                        <th><input type="checkbox" id="selecionarTodos" onchange="selecionarTodosItens(this)"></th>
                                        <th>Item</th>
                                        <th>Qtd</th>
                                        <th style="background: #e3f2fd;">Preço Original</th>
                                        <th style="background: #e3f2fd;">Prazo Original</th>
                                        <th style="background: #fff3e0;">Desc.%</th>
                                        <th style="background: #e8f5e9;">Preço Negociado</th>
                                        <th style="background: #e8f5e9;">Prazo Negociado</th>
                                    </tr>
                                </thead>
                                <tbody id="tabelaItensNegociacao">
                                    <!-- Preenchido via JavaScript -->
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Observação Geral (opcional)</label>
                            <textarea class="form-control" id="observacaoNegociacao" rows="2" 
                                      placeholder="Ex: Valores negociados via telefone em DD/MM/AAAA"></textarea>
                        </div>
                        
                        <!-- Campo de Frete Negociado -->
                        <div class="mb-3 p-3" style="background: #f8f9fa; border-radius: 8px;">
                            <label class="form-label fw-bold"><i class="fas fa-truck me-2"></i>Frete Negociado (R$)</label>
                            <input type="text" class="form-control" id="freteNegociacao" 
                                   placeholder="0,00" oninput="formatarMoedaModal(this)" style="max-width: 200px;">
                            <small class="text-muted">Valor do frete negociado para esta segunda rodada</small>
                        </div>
                        
                        <!-- Campo de Anexo para Segunda Rodada -->
                        <div class="mb-3 p-3" style="background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); border-radius: 8px; border: 1px dashed #4caf50;">
                            <label class="form-label fw-bold"><i class="fas fa-paperclip me-2 text-success"></i>Anexar Orçamento da Segunda Rodada (opcional)</label>
                            <input type="file" class="form-control" id="inputAnexoRodada2" 
                                   accept=".pdf,.jpg,.jpeg,.png,.doc,.docx,.xls,.xlsx">
                            <small class="text-muted d-block mt-1">
                                <i class="fas fa-info-circle me-1"></i>Formatos aceitos: PDF, imagens, Word, Excel (máx. 10MB)
                            </small>
                            <div id="previewAnexoRodada2" class="mt-2" style="display: none;">
                                <span class="badge bg-success"><i class="fas fa-check me-1"></i><span id="nomeAnexoRodada2"></span></span>
                                <button type="button" class="btn btn-sm btn-outline-danger ms-2" onclick="removerAnexoRodada2()">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>Cancelar
                    </button>
                    <button type="button" class="btn btn-dark" onclick="salvarRodadaNegociacao()" id="btnSalvarNegociacao" disabled>
                        <i class="fas fa-save me-1"></i>Salvar Rodada de Negociação
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal: Editar Rodada Individual -->
    <div class="modal fade" id="modalEditarRodadaNegociacao" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title"><i class="fas fa-edit me-2"></i>Editar Valor Negociado</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="editRodadaId">
                    <input type="hidden" id="editPrecoOriginal">
                    
                    <div class="mb-3">
                        <label class="form-label">Preço Original (Rodada 1)</label>
                        <input type="text" class="form-control bg-light" id="editPrecoOriginalDisplay" readonly>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label"><i class="fas fa-percent text-warning me-1"></i>Desconto (%)</label>
                        <input type="number" class="form-control" id="editDescontoNegociado" 
                               min="0" max="100" step="0.1" value="0" placeholder="0"
                               onchange="recalcularPrecoComDesconto()" oninput="recalcularPrecoComDesconto()">
                        <small class="text-muted">Ao informar o desconto, o preço será recalculado automaticamente</small>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Preço Unitário Negociado</label>
                        <input type="text" class="form-control" id="editPrecoNegociado" 
                               placeholder="0,00" oninput="formatarMoedaModal(this)">
                        <small class="text-muted">Você pode editar manualmente ou usar o desconto acima</small>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Prazo de Entrega Negociado (dias)</label>
                        <input type="number" class="form-control" id="editPrazoNegociado" min="0">
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Observação</label>
                        <textarea class="form-control" id="editObservacaoNegociacao" rows="2"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="salvarEdicaoRodada()">
                        <i class="fas fa-save me-1"></i>Salvar Alterações
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- TOAST -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3">
        <div id="toastNotificacao" class="toast align-items-center border-0" role="alert">
            <div class="d-flex">
                <div class="toast-body" id="toastMensagem"></div>
                <button type="button" class="btn-close me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
    // ============================================================
    // MÓDULO DE COTAÇÃO - JAVASCRIPT REFATORADO
    // ============================================================
    
    const COTACAO_ID = {{ cotacao.id }};
    let modoFornecedor = 'cadastrado';
    // Map para armazenar múltiplos fornecedores selecionados (código => dados)
    let fornecedoresSelecionados = new Map();
    let timeoutBusca = null;
    
    // ============ UTILITÁRIOS ============
    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    function formatarMoeda(valor) {
        if (!valor) return '';
        return parseFloat(valor).toFixed(2).replace('.', ',').replace(/\B(?=(\d{3})+(?!\d))/g, '.');
    }
    
    /**
     * Formata input de moeda no padrão BR (1.250,50)
     */
    function formatarMoedaModal(input) {
        let valor = input.value;
        
        // Remove tudo exceto números, vírgula e ponto
        valor = valor.replace(/[^\d.,]/g, '');
        
        // Limita a 2 casas decimais após vírgula
        const partes = valor.split(',');
        if (partes.length > 2) {
            valor = partes[0] + ',' + partes.slice(1).join('').substring(0, 2);
        } else if (partes.length === 2) {
            valor = partes[0] + ',' + partes[1].substring(0, 2);
        }
        
        input.value = valor;
    }
    
    function converterParaDecimal(valorBR) {
        if (!valorBR || String(valorBR).trim() === '') return 0;
        
        let str = String(valorBR).trim();
        
        // Detectar se o valor está em formato decimal (ponto como separador) ou BR (vírgula)
        // Formato BR: "1.250,50" ou "11,20"
        // Formato decimal: "1250.50" ou "11.20"
        
        const temVirgula = str.includes(',');
        const temPonto = str.includes('.');
        
        if (temVirgula && temPonto) {
            // Formato BR com milhar: "1.250,50" -> remover pontos de milhar, converter vírgula
            return parseFloat(str.replace(/\./g, '').replace(',', '.')) || 0;
        } else if (temVirgula && !temPonto) {
            // Formato BR simples: "11,20" -> converter vírgula para ponto
            return parseFloat(str.replace(',', '.')) || 0;
        } else if (!temVirgula && temPonto) {
            // Formato decimal: "11.20" ou "1250.50" -> usar direto
            // CUIDADO: Se tiver mais de um ponto, é milhar BR: "1.250" (sem decimal)
            const partes = str.split('.');
            if (partes.length === 2 && partes[1].length <= 2) {
                // "11.20" -> decimal normal
                return parseFloat(str) || 0;
            } else if (partes.length > 2) {
                // "1.250.000" -> milhar BR sem decimal, remover pontos
                return parseFloat(str.replace(/\./g, '')) || 0;
            } else {
                // "11.20" ou "1250.5" -> decimal
                return parseFloat(str) || 0;
            }
        } else {
            // Sem separadores: "1120" -> número inteiro
            return parseFloat(str) || 0;
        }
    }
    
    function mostrarToast(mensagem, tipo = 'success') {
        const toast = document.getElementById('toastNotificacao');
        const body = document.getElementById('toastMensagem');
        toast.classList.remove('text-bg-success', 'text-bg-danger', 'text-bg-warning');
        toast.classList.add('text-bg-' + tipo);
        body.innerHTML = `<i class="fas fa-${tipo === 'success' ? 'check-circle' : 'exclamation-circle'} me-2"></i>${mensagem}`;
        new bootstrap.Toast(toast).show();
    }
    
    async function apiCall(url, method = 'GET', data = null) {
        try {
            const options = {
                method,
                headers: { 'Content-Type': 'application/json' }
            };
            if (data) options.body = JSON.stringify(data);
            
            const response = await fetch(url, options);
            const result = await response.json();
            
            if (!response.ok) {
                throw new Error(result.error || `HTTP ${response.status}`);
            }
            return result;
        } catch (error) {
            console.error('[API ERROR]', url, error);
            throw error;
        }
    }
    
    // ============ BUSCA AUTOMÁTICA DE SOLICITAÇÃO ============
    
    // Função para buscar dados da solicitação e preencher automaticamente
    async function buscarDadosSolicitacao() {
        const numeroSC = document.getElementById('addItemSC').value.trim();
        const codProduto = document.getElementById('addItemCodProduto').value.trim();
        
        // Limpa alertas anteriores
        document.getElementById('alertAddItemSucesso').classList.add('d-none');
        document.getElementById('alertAddItemAviso').classList.add('d-none');
        document.getElementById('alertAddItemInfo').classList.remove('d-none');
        document.getElementById('addItemOrigemSolicitacao').value = '0';
        
        // Reseta estilo dos campos
        ['addItemDescricao', 'addItemQuantidade', 'addItemUnidade', 'addItemDataNecessidade'].forEach(id => {
            const el = document.getElementById(id);
            if (el) {
                el.classList.remove('bg-success-subtle', 'border-success');
            }
        });
        
        // Se não tem número da SC, não busca
        if (!numeroSC) {
            return;
        }
        
        // Mostra indicador de loading no botão
        const btnBuscar = document.getElementById('btnBuscarSolicitacao');
        const iconOriginal = btnBuscar.innerHTML;
        btnBuscar.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        btnBuscar.disabled = true;
        
        try {
            // Monta URL com parâmetros
            let url = `/api/solicitacao/buscar?numero_sc=${encodeURIComponent(numeroSC)}`;
            if (codProduto) {
                url += `&cod_produto=${encodeURIComponent(codProduto)}`;
            }
            
            const response = await fetch(url);
            const result = await response.json();
            
            if (result.success && result.encontrada) {
                // Solicitação encontrada! Preenche os campos
                const sol = result.solicitacao;
                
                document.getElementById('addItemCodProduto').value = sol.cod_produto || '';
                document.getElementById('addItemDescricao').value = sol.descricao_produto || '';
                document.getElementById('addItemQuantidade').value = sol.quantidade || '';
                document.getElementById('addItemUnidade').value = sol.unidade || 'UN';
                document.getElementById('addItemDataNecessidade').value = sol.data_necessidade || '';
                document.getElementById('addItemObs').value = sol.observacao || '';
                document.getElementById('addItemOrigemSolicitacao').value = '1';
                
                // Destaca campos preenchidos automaticamente
                ['addItemDescricao', 'addItemQuantidade', 'addItemUnidade', 'addItemDataNecessidade'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el && el.value) {
                        el.classList.add('bg-success-subtle', 'border-success');
                    }
                });
                
                // Mostra alerta de sucesso
                document.getElementById('alertAddItemInfo').classList.add('d-none');
                document.getElementById('alertAddItemSucesso').classList.remove('d-none');
                document.getElementById('alertAddItemSucessoMsg').innerHTML = 
                    `<strong>Dados preenchidos automaticamente!</strong> SC ${sol.numero_sc}` +
                    (sol.solicitante ? ` - Solicitante: ${sol.solicitante}` : '') +
                    (result.total_itens > 1 ? ` (${result.total_itens} itens na SC)` : '');
                
                mostrarToast('Dados da solicitação carregados!', 'success');
                
            } else if (result.sc_existe) {
                // SC existe mas produto não corresponde
                document.getElementById('alertAddItemInfo').classList.add('d-none');
                document.getElementById('alertAddItemAviso').classList.remove('d-none');
                
                let msg = result.message;
                if (result.produtos_disponiveis && result.produtos_disponiveis.length > 0) {
                    msg += '<br><small>Produtos disponíveis nesta SC: ';
                    msg += result.produtos_disponiveis.map(p => 
                        `<strong>${p.CodProduto}</strong> (${p.DescricaoProduto?.substring(0, 30) || 'Sem descrição'}...)`
                    ).join(', ');
                    msg += '</small>';
                }
                document.getElementById('alertAddItemAvisoMsg').innerHTML = msg;
                
            } else {
                // Não encontrada
                if (numeroSC) {
                    document.getElementById('alertAddItemInfo').classList.add('d-none');
                    document.getElementById('alertAddItemAviso').classList.remove('d-none');
                    document.getElementById('alertAddItemAvisoMsg').textContent = 
                        result.message || `Solicitação ${numeroSC} não encontrada ou já possui pedido. Preencha os dados manualmente.`;
                }
            }
            
        } catch (error) {
            console.error('Erro ao buscar solicitação:', error);
            mostrarToast('Erro ao buscar solicitação: ' + error.message, 'danger');
        } finally {
            // Restaura botão
            btnBuscar.innerHTML = iconOriginal;
            btnBuscar.disabled = false;
        }
    }
    
    // Event listeners para busca automática
    document.getElementById('btnBuscarSolicitacao')?.addEventListener('click', buscarDadosSolicitacao);
    
    // Busca automática quando código do produto é alterado (se SC está preenchido)
    document.getElementById('addItemCodProduto')?.addEventListener('blur', function() {
        const numeroSC = document.getElementById('addItemSC').value.trim();
        if (numeroSC && this.value.trim()) {
            buscarDadosSolicitacao();
        }
    });
    
    // Busca automática quando SC é alterado (se código do produto está preenchido)
    document.getElementById('addItemSC')?.addEventListener('blur', function() {
        const codProduto = document.getElementById('addItemCodProduto').value.trim();
        if (this.value.trim() && codProduto) {
            buscarDadosSolicitacao();
        }
    });
    
    // Limpa o modal quando é aberto
    document.getElementById('modalAdicionarItem')?.addEventListener('show.bs.modal', function() {
        // Limpa todos os campos
        document.getElementById('addItemSC').value = '';
        document.getElementById('addItemCodProduto').value = '';
        document.getElementById('addItemDescricao').value = '';
        document.getElementById('addItemQuantidade').value = '';
        document.getElementById('addItemUnidade').value = 'UN';
        document.getElementById('addItemDataNecessidade').value = '';
        document.getElementById('addItemObs').value = '';
        document.getElementById('addItemOrigemSolicitacao').value = '0';
        
        // Reseta alertas
        document.getElementById('alertAddItemSucesso').classList.add('d-none');
        document.getElementById('alertAddItemAviso').classList.add('d-none');
        document.getElementById('alertAddItemInfo').classList.remove('d-none');
        
        // Reseta estilo dos campos
        ['addItemDescricao', 'addItemQuantidade', 'addItemUnidade', 'addItemDataNecessidade'].forEach(id => {
            const el = document.getElementById(id);
            if (el) {
                el.classList.remove('bg-success-subtle', 'border-success');
            }
        });
    });
    
    // ============ GERENCIAMENTO DE ITENS DA COTAÇÃO ============
    
    // Adicionar novo item
    document.getElementById('btnAdicionarItem')?.addEventListener('click', async function() {
        const sc = document.getElementById('addItemSC').value.trim();
        const codProduto = document.getElementById('addItemCodProduto').value.trim();
        const descricao = document.getElementById('addItemDescricao').value.trim();
        const quantidade = parseFloat(document.getElementById('addItemQuantidade').value) || 0;
        const unidade = document.getElementById('addItemUnidade').value.trim() || 'UN';
        const dataNecessidade = document.getElementById('addItemDataNecessidade').value;
        const observacao = document.getElementById('addItemObs').value.trim();
        
        // Validações
        if (!codProduto) {
            mostrarToast('Informe o código do produto', 'warning');
            return;
        }
        if (!descricao) {
            mostrarToast('Informe a descrição do produto', 'warning');
            return;
        }
        if (quantidade <= 0) {
            mostrarToast('Informe uma quantidade válida', 'warning');
            return;
        }
        
        try {
            const result = await apiCall(`/api/cotacao/${COTACAO_ID}/item`, 'POST', {
                numero_sc: sc || 'MANUAL',
                cod_produto: codProduto,
                descricao_produto: descricao,
                quantidade: quantidade,
                unidade: unidade,
                data_necessidade: dataNecessidade,
                observacao: observacao
            });
            
            if (result.success) {
                mostrarToast('Item adicionado com sucesso!', 'success');
                bootstrap.Modal.getInstance(document.getElementById('modalAdicionarItem')).hide();
                setTimeout(() => location.reload(), 800);
            } else {
                throw new Error(result.error || 'Erro ao adicionar item');
            }
        } catch (error) {
            mostrarToast('Erro: ' + error.message, 'danger');
        }
    });
    
    // Abrir modal de edição
    document.querySelectorAll('.btn-editar-item').forEach(btn => {
        btn.addEventListener('click', function() {
            document.getElementById('editItemId').value = this.dataset.id;
            document.getElementById('editItemSC').value = this.dataset.sc || '';
            document.getElementById('editItemCodProduto').value = this.dataset.produto || '';
            document.getElementById('editItemDescricao').value = this.dataset.descricao || '';
            document.getElementById('editItemQuantidade').value = this.dataset.quantidade || '';
            document.getElementById('editItemUnidade').value = this.dataset.unidade || 'UN';
            document.getElementById('editItemDataNecessidade').value = this.dataset.necessidade || '';
            
            new bootstrap.Modal(document.getElementById('modalEditarItem')).show();
        });
    });
    
    // Salvar edição do item
    document.getElementById('btnSalvarEditarItem')?.addEventListener('click', async function() {
        const itemId = document.getElementById('editItemId').value;
        const sc = document.getElementById('editItemSC').value.trim();
        const codProduto = document.getElementById('editItemCodProduto').value.trim();
        const descricao = document.getElementById('editItemDescricao').value.trim();
        const quantidade = parseFloat(document.getElementById('editItemQuantidade').value) || 0;
        const unidade = document.getElementById('editItemUnidade').value.trim() || 'UN';
        const dataNecessidade = document.getElementById('editItemDataNecessidade').value;
        
        // Validações
        if (!codProduto) {
            mostrarToast('Informe o código do produto', 'warning');
            return;
        }
        if (!descricao) {
            mostrarToast('Informe a descrição do produto', 'warning');
            return;
        }
        if (quantidade <= 0) {
            mostrarToast('Informe uma quantidade válida', 'warning');
            return;
        }
        
        try {
            const result = await apiCall(`/api/cotacao/${COTACAO_ID}/item/${itemId}`, 'POST', {
                numero_sc: sc || 'MANUAL',
                cod_produto: codProduto,
                descricao_produto: descricao,
                quantidade: quantidade,
                unidade: unidade,
                data_necessidade: dataNecessidade
            });
            
            if (result.success) {
                mostrarToast('Item atualizado com sucesso!', 'success');
                bootstrap.Modal.getInstance(document.getElementById('modalEditarItem')).hide();
                setTimeout(() => location.reload(), 800);
            } else {
                throw new Error(result.error || 'Erro ao atualizar item');
            }
        } catch (error) {
            mostrarToast('Erro: ' + error.message, 'danger');
        }
    });
    
    // Excluir item
    document.querySelectorAll('.btn-excluir-item').forEach(btn => {
        btn.addEventListener('click', async function() {
            const itemId = this.dataset.id;
            const descricao = this.dataset.descricao;
            
            if (!confirm(`Deseja realmente excluir o item "${descricao}"?\n\nAtenção: Se houver respostas de fornecedores associadas a este item, elas também serão removidas.`)) {
                return;
            }
            
            try {
                const result = await apiCall(`/api/cotacao/${COTACAO_ID}/item/${itemId}/excluir`, 'POST');
                
                if (result.success) {
                    mostrarToast('Item excluído com sucesso!', 'success');
                    // Remove a linha da tabela sem recarregar
                    document.getElementById(`row-item-${itemId}`)?.remove();
                } else {
                    throw new Error(result.error || 'Erro ao excluir item');
                }
            } catch (error) {
                mostrarToast('Erro: ' + error.message, 'danger');
            }
        });
    });
    
    // ============ BUSCA DE FORNECEDORES ============
    async function buscarFornecedores(termo) {
        const lista = document.getElementById('listaFornecedores');
        
        if (!termo || termo.length < 2) {
            lista.style.display = 'none';
            return;
        }
        
        lista.innerHTML = '<div class="text-center py-3"><i class="fas fa-spinner fa-spin me-2"></i>Buscando...</div>';
        lista.style.display = 'block';
        
        try {
            console.log('[BUSCA] Iniciando busca:', termo);
            const data = await apiCall(`/api/fornecedores/buscar?termo=${encodeURIComponent(termo)}`);
            
            if (data.success && data.fornecedores && data.fornecedores.length > 0) {
                console.log('[BUSCA] Encontrados:', data.fornecedores.length);
                lista.innerHTML = '';
                lista.className = 'list-group border rounded';
                lista.style.maxHeight = '250px';
                lista.style.overflowY = 'auto';
                
                data.fornecedores.forEach(f => {
                    const chave = f.codigo || f.nome;
                    const selecionado = fornecedoresSelecionados.has(chave);
                    
                    const item = document.createElement('div');
                    item.className = `list-group-item list-group-item-action ${selecionado ? 'active bg-success text-white' : ''}`;
                    item.dataset.codigo = chave;
                    item.dataset.fornecedor = JSON.stringify(f);
                    item.style.cursor = 'pointer';
                    item.innerHTML = `
                        <div class="fw-bold">
                            ${escapeHtml(f.nome)}
                            ${selecionado ? '<i class="fas fa-check-circle ms-2 text-white"></i>' : ''}
                        </div>
                        <small class="${selecionado ? 'text-white-50' : 'text-muted'}">
                            <i class="fas fa-barcode me-1"></i>${escapeHtml(f.codigo)}
                            ${f.email ? `<span class="ms-2"><i class="fas fa-envelope me-1"></i>${escapeHtml(f.email)}</span>` : ''}
                        </small>
                    `;
                    item.addEventListener('click', function() {
                        const fornecedor = JSON.parse(this.dataset.fornecedor);
                        selecionarFornecedor(fornecedor);
                    });
                    lista.appendChild(item);
                });
            } else {
                lista.innerHTML = '<div class="text-center py-3 text-muted"><i class="fas fa-search me-2"></i>Nenhum fornecedor encontrado</div>';
            }
        } catch (error) {
            lista.innerHTML = `<div class="text-center py-3 text-danger"><i class="fas fa-exclamation-circle me-2"></i>${escapeHtml(error.message)}</div>`;
        }
    }
    
    function selecionarFornecedor(f) {
        // Toggle: se já está selecionado, remove; senão, adiciona
        const chave = f.codigo || f.nome; // usa código se disponível, senão nome
        
        if (fornecedoresSelecionados.has(chave)) {
            fornecedoresSelecionados.delete(chave);
        } else {
            fornecedoresSelecionados.set(chave, f);
        }
        
        atualizarVisualizacaoSelecionados();
        atualizarEstatusListaFornecedores();
    }
    
    function atualizarVisualizacaoSelecionados() {
        const area = document.getElementById('fornecedoresSelecionadosArea');
        const container = document.getElementById('tagsSelecionados');
        const contador = document.getElementById('contadorSelecionados');
        
        if (fornecedoresSelecionados.size === 0) {
            area.classList.add('d-none');
            return;
        }
        
        area.classList.remove('d-none');
        contador.textContent = fornecedoresSelecionados.size;
        container.innerHTML = '';
        
        fornecedoresSelecionados.forEach((f, chave) => {
            const tag = document.createElement('span');
            tag.className = 'badge bg-success d-inline-flex align-items-center py-2 px-3';
            tag.style.fontSize = '0.9rem';
            tag.innerHTML = `
                <i class="fas fa-user me-2"></i>
                <span class="me-2">${escapeHtml(f.nome)}</span>
                <span class="text-white-50 me-2">(${escapeHtml(f.codigo || 'Sem código')})</span>
                <button type="button" class="btn-close btn-close-white ms-1" style="font-size: 0.7rem;" 
                        onclick="removerFornecedorSelecionado('${escapeHtml(chave)}')"></button>
            `;
            container.appendChild(tag);
        });
    }
    
    function atualizarEstatusListaFornecedores() {
        // Atualiza visualmente os itens da lista para mostrar quais estão selecionados
        const lista = document.getElementById('listaFornecedores');
        if (!lista) return;
        
        lista.querySelectorAll('.list-group-item').forEach(item => {
            const codigo = item.dataset.codigo;
            if (fornecedoresSelecionados.has(codigo)) {
                item.classList.add('active', 'bg-success', 'text-white');
                // Adiciona ícone de check se não existir
                if (!item.querySelector('.fa-check-circle')) {
                    const icon = document.createElement('i');
                    icon.className = 'fas fa-check-circle ms-2 text-white';
                    item.querySelector('.fw-bold')?.appendChild(icon);
                }
            } else {
                item.classList.remove('active', 'bg-success', 'text-white');
                item.querySelector('.fa-check-circle')?.remove();
            }
        });
    }
    
    function removerFornecedorSelecionado(chave) {
        fornecedoresSelecionados.delete(chave);
        atualizarVisualizacaoSelecionados();
        atualizarEstatusListaFornecedores();
    }
    
    function limparSelecao() {
        fornecedoresSelecionados.clear();
        document.getElementById('fornCodigo').value = '';
        document.getElementById('fornecedoresSelecionadosArea').classList.add('d-none');
        document.getElementById('tagsSelecionados').innerHTML = '';
        document.getElementById('buscaFornecedor').value = '';
        document.getElementById('listaFornecedores').style.display = 'none';
        atualizarEstatusListaFornecedores();
    }
    
    // ============ ADICIONAR FORNECEDOR ============
    async function adicionarFornecedor() {
        const btn = document.getElementById('btnAdicionarForn');
        
        if (modoFornecedor === 'cadastrado') {
            // Modo de fornecedores cadastrados - usa multi-select
            if (fornecedoresSelecionados.size === 0) {
                mostrarToast('Selecione pelo menos um fornecedor da lista', 'warning');
                return;
            }
            
            // Prepara array de fornecedores para a API bulk
            const fornecedores = [];
            fornecedoresSelecionados.forEach((f, chave) => {
                fornecedores.push({
                    nome: f.nome,
                    email: f.email || '',
                    telefone: f.telefone || '',
                    cod_fornecedor: f.codigo || ''
                });
            });
            
            btn.disabled = true;
            btn.innerHTML = `<i class="fas fa-spinner fa-spin me-1"></i>Adicionando ${fornecedores.length} fornecedor(es)...`;
            
            try {
                const result = await apiCall(`/api/cotacao/${COTACAO_ID}/fornecedores/bulk`, 'POST', {fornecedores});
                
                if (result.success) {
                    let msg = `✅ ${result.adicionados} fornecedor(es) adicionado(s)`;
                    if (result.ignorados > 0) {
                        msg += ` | ⚠️ ${result.ignorados} já existia(m)`;
                    }
                    if (result.erros > 0) {
                        msg += ` | ❌ ${result.erros} com erro`;
                    }
                    mostrarToast(msg, result.erros > 0 ? 'warning' : 'success');
                    setTimeout(() => location.reload(), 800);
                } else {
                    throw new Error(result.error || 'Erro desconhecido');
                }
            } catch (error) {
                mostrarToast('Erro: ' + error.message, 'danger');
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-plus me-1"></i>Adicionar Fornecedor(es)';
            }
        } else {
            // Modo manual - um fornecedor por vez
            const nome = document.getElementById('fornNome').value.trim();
            if (!nome) {
                mostrarToast('Nome do fornecedor é obrigatório', 'warning');
                return;
            }
            const dados = {
                nome: nome,
                email: document.getElementById('fornEmail').value.trim(),
                telefone: document.getElementById('fornTelefone').value.trim(),
                cod_fornecedor: ''
            };
            
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Adicionando...';
            
            try {
                const result = await apiCall(`/api/cotacao/${COTACAO_ID}/fornecedor`, 'POST', dados);
                if (result.success) {
                    mostrarToast('Fornecedor adicionado com sucesso!', 'success');
                    setTimeout(() => location.reload(), 500);
                } else {
                    throw new Error(result.error || 'Erro desconhecido');
                }
            } catch (error) {
                mostrarToast('Erro: ' + error.message, 'danger');
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-plus me-1"></i>Adicionar Fornecedor';
            }
        }
    }
    
    // ============ EXCLUIR FORNECEDOR ============
    async function excluirFornecedor(id, nome) {
        if (!confirm(`Excluir fornecedor "${nome}"?\n\nIsso removerá:\n- Vínculo com esta cotação\n- Todas as respostas enviadas\n- O link individual será invalidado`)) {
            return;
        }
        
        const btn = document.querySelector(`#row-forn-${id} .btn-excluir-forn`);
        if (btn) {
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        }
        
        try {
            const result = await apiCall(`/api/cotacao/fornecedor/${id}/excluir`, 'POST');
            if (result.success) {
                mostrarToast('Fornecedor excluído!', 'success');
                setTimeout(() => location.reload(), 500);
            } else {
                throw new Error(result.error);
            }
        } catch (error) {
            mostrarToast('Erro: ' + error.message, 'danger');
            if (btn) {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-trash"></i>';
            }
        }
    }
    
    // ============ EDITAR FORNECEDOR ============
    function abrirModalEditarFornecedor(btn) {
        const id = btn.dataset.id;
        const nome = btn.dataset.nome;
        const email = btn.dataset.email;
        const telefone = btn.dataset.telefone;
        
        console.log('[ABRIR MODAL EDITAR] ID:', id, 'Nome:', nome, 'Email:', email, 'Tel:', telefone);
        
        // Preencher dados básicos
        document.getElementById('editFornecedorId').value = id;
        document.getElementById('inputEditFornecedorNome').value = nome;
        document.getElementById('inputEditFornecedorEmail').value = email || '';
        document.getElementById('inputEditFornecedorTelefone').value = telefone || '';
        
        // Limpar campos da R2
        document.getElementById('inputEditFornecedorDescontoR2').value = '';
        document.getElementById('inputEditFornecedorFreteR2').value = '';
        document.getElementById('inputEditFornecedorPrazoR2').value = '';
        document.getElementById('inputEditFornecedorCondicaoR2').value = '';
        document.getElementById('inputEditFornecedorAnexoR2').value = '';
        document.getElementById('inputEditFornecedorObsR2').value = '';
        document.getElementById('previewAnexoEditR2').style.display = 'none';
        document.getElementById('indicadorR2Existente').style.display = 'none';
        
        // Verificar se já existe R2 para este fornecedor
        verificarR2Existente(id);
        
        new bootstrap.Modal(document.getElementById('modalEditarFornecedor')).show();
    }
    
    // Verificar se fornecedor já tem proposta R2
    function verificarR2Existente(fornecedorId) {
        const rodadasAgrupadas = {{ cotacao.rodadas_agrupadas|tojson|safe if cotacao.rodadas_agrupadas else '{"fornecedores":[]}' }};
        
        if (rodadasAgrupadas && rodadasAgrupadas.fornecedores) {
            const fornR2 = rodadasAgrupadas.fornecedores.find(f => f.fornecedor_id == fornecedorId);
            
            if (fornR2) {
                // Fornecedor já tem R2 - preencher dados existentes
                document.getElementById('indicadorR2Existente').style.display = 'block';
                document.getElementById('textoR2Existente').textContent = 
                    `Este fornecedor já possui proposta na segunda rodada (${fornR2.qtd_itens} itens, desconto médio: ${(fornR2.desconto_medio || 0).toFixed(1)}%).`;
                
                // Preencher desconto médio (se disponível)
                if (fornR2.desconto_medio) {
                    document.getElementById('inputEditFornecedorDescontoR2').value = fornR2.desconto_medio.toFixed(1);
                }
                
                // Preencher frete negociado
                if (fornR2.frete_negociado > 0) {
                    document.getElementById('inputEditFornecedorFreteR2').value = formatarMoeda(fornR2.frete_negociado);
                }
            }
        }
    }
    
    // Preview do arquivo anexado
    document.getElementById('inputEditFornecedorAnexoR2')?.addEventListener('change', function() {
        if (this.files && this.files[0]) {
            document.getElementById('nomeAnexoEditR2').textContent = this.files[0].name;
            document.getElementById('previewAnexoEditR2').style.display = 'block';
        }
    });
    
    // Remover anexo selecionado
    function removerAnexoEditR2() {
        document.getElementById('inputEditFornecedorAnexoR2').value = '';
        document.getElementById('previewAnexoEditR2').style.display = 'none';
    }
    
    async function salvarEdicaoFornecedor() {
        const id = document.getElementById('editFornecedorId').value;
        const cotacaoId = document.getElementById('editFornecedorCotacaoId').value;
        const nome = document.getElementById('inputEditFornecedorNome').value.trim();
        const email = document.getElementById('inputEditFornecedorEmail').value.trim();
        const telefone = document.getElementById('inputEditFornecedorTelefone').value.trim();
        
        // Dados da R2
        const descontoR2 = document.getElementById('inputEditFornecedorDescontoR2').value;
        const freteR2Input = document.getElementById('inputEditFornecedorFreteR2').value;
        const prazoR2 = document.getElementById('inputEditFornecedorPrazoR2').value;
        const condicaoR2 = document.getElementById('inputEditFornecedorCondicaoR2').value;
        const obsR2 = document.getElementById('inputEditFornecedorObsR2').value;
        const anexoR2 = document.getElementById('inputEditFornecedorAnexoR2').files[0];
        
        // Converter frete para número
        const freteR2 = freteR2Input ? converterParaDecimal(freteR2Input) : null;
        
        console.log('[EDITAR] ID:', id, 'Nome:', nome, 'Email:', email, 'Telefone:', telefone);
        console.log('[EDITAR R2] Desconto:', descontoR2, 'Frete:', freteR2, 'Prazo:', prazoR2);
        
        if (!nome) {
            mostrarToast('Nome do fornecedor é obrigatório', 'warning');
            return;
        }
        
        const btn = document.getElementById('btnSalvarFornecedor');
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Salvando...';
        
        try {
            // Verificar se tem dados R2 para criar/atualizar proposta
            const temDadosR2 = descontoR2 || freteR2 || prazoR2 || anexoR2;
            
            console.log('[EDITAR] Enviando requisição para:', `/api/cotacao/fornecedor/${id}/editar`);
            
            // 1. Primeiro salva dados básicos do fornecedor
            const result = await apiCall(`/api/cotacao/fornecedor/${id}/editar`, 'POST', {
                nome: nome,
                email: email,
                telefone: telefone
            });
            
            console.log('[EDITAR] Resposta recebida:', result);
            
            if (!result.success) {
                throw new Error(result.error);
            }
            
            // 2. Se tiver dados R2, criar/atualizar proposta da segunda rodada
            if (temDadosR2) {
                console.log('[EDITAR R2] Criando/atualizando proposta R2...');
                
                const resultR2 = await criarOuAtualizarPropostaR2(cotacaoId, id, {
                    desconto: descontoR2 ? parseFloat(descontoR2) : 0,
                    frete: freteR2 || 0,
                    prazo: prazoR2 ? parseInt(prazoR2) : null,
                    condicao: condicaoR2,
                    observacao: obsR2
                });
                
                // 3. Se tiver anexo, fazer upload
                if (anexoR2) {
                    console.log('[EDITAR R2] Fazendo upload do anexo...');
                    await uploadAnexoR2(cotacaoId, id, anexoR2);
                }
            }
            
            mostrarToast('Informações atualizadas com sucesso!', 'success');
            bootstrap.Modal.getInstance(document.getElementById('modalEditarFornecedor')).hide();
            
            console.log('[EDITAR] Recarregando página em 500ms...');
            setTimeout(() => {
                console.log('[EDITAR] Executando reload...');
                location.reload();
            }, 500);
            
        } catch (error) {
            console.error('[EDITAR] Erro:', error);
            mostrarToast('Erro: ' + error.message, 'danger');
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-save me-1"></i> Salvar Alterações';
        }
    }
    
    // Criar ou atualizar proposta R2 para um fornecedor
    async function criarOuAtualizarPropostaR2(cotacaoId, fornecedorId, dados) {
        // Buscar itens do fornecedor (respostas da R1) para criar R2
        const respostas = {{ cotacao.respostas|tojson|safe if cotacao.respostas else '[]' }};
        
        // Filtrar respostas deste fornecedor
        const respostasFornecedor = respostas.filter(r => r.fornecedor_id == fornecedorId);
        
        if (respostasFornecedor.length === 0) {
            console.log('[R2] Fornecedor não tem respostas na R1');
            return { success: true, message: 'Nenhum item para atualizar' };
        }
        
        // Criar array de itens com desconto aplicado
        const itens = respostasFornecedor.map(resp => {
            const precoOriginal = parseFloat(resp.preco_unitario) || 0;
            const desconto = dados.desconto || 0;
            const precoNegociado = precoOriginal * (1 - desconto / 100);
            
            return {
                item_id: resp.item_id,
                preco_original: precoOriginal,
                preco_negociado: precoNegociado,
                prazo_original: resp.prazo_entrega,
                prazo_negociado: dados.prazo || resp.prazo_entrega,
                desconto_percentual: desconto
            };
        });
        
        console.log('[R2] Enviando itens:', itens);
        
        const response = await fetch(`/api/cotacao/${cotacaoId}/rodada-negociacao`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                fornecedor_id: fornecedorId,
                itens: itens,
                observacao: dados.observacao || '',
                desconto_percentual: dados.desconto || 0,
                frete_negociado: dados.frete || 0
            })
        });
        
        const result = await response.json();
        
        if (!result.success) {
            throw new Error(result.error || 'Erro ao salvar proposta R2');
        }
        
        // Atualizar frete se informado
        if (dados.frete > 0) {
            await fetch(`/api/cotacao/${cotacaoId}/rodada-fornecedor/${fornecedorId}/frete`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ frete_negociado: dados.frete })
            });
        }
        
        return result;
    }
    
    // Upload do anexo R2
    async function uploadAnexoR2(cotacaoId, fornecedorId, arquivo) {
        const formData = new FormData();
        formData.append('arquivo', arquivo);
        formData.append('fornecedor_id', fornecedorId);
        
        const response = await fetch(`/api/cotacao/${cotacaoId}/rodada-negociacao/anexo`, {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        if (!result.success) {
            throw new Error(result.error || 'Erro ao fazer upload do anexo');
        }
        
        return result;
    }
    
    // ============ EDITAR RESPOSTA ============
    function abrirModalEditarResposta(btn) {
        const d = btn.dataset;
        console.log('[ABRIR MODAL RESPOSTA] Dados:', d);
        document.getElementById('editRespostaId').value = d.id;
        document.getElementById('editItemDescricao').textContent = d.item;
        document.getElementById('editRespostaFornecedorNome').textContent = d.forn;
        document.getElementById('editPrecoUnitario').value = formatarMoeda(d.preco);
        document.getElementById('editPrazoEntrega').value = d.prazo || '';
        document.getElementById('editCondicaoPagamento').value = d.cond || '';
        document.getElementById('editFrete').value = formatarMoeda(d.frete);
        document.getElementById('editObservacao').value = d.obs || '';
        new bootstrap.Modal(document.getElementById('modalEditarResposta')).show();
    }
    
    async function salvarEdicaoResposta() {
        const id = document.getElementById('editRespostaId').value;
        const preco = converterParaDecimal(document.getElementById('editPrecoUnitario').value);
        const prazo = parseInt(document.getElementById('editPrazoEntrega').value) || 0;
        const frete = converterParaDecimal(document.getElementById('editFrete').value);
        const condicao = document.getElementById('editCondicaoPagamento').value;
        const obs = document.getElementById('editObservacao').value;
        
        if (preco <= 0) {
            mostrarToast('Informe um preço válido', 'warning');
            return;
        }
        if (prazo <= 0) {
            mostrarToast('Informe um prazo válido', 'warning');
            return;
        }
        
        try {
            const result = await apiCall(`/api/cotacao/resposta/${id}/editar`, 'POST', {
                preco_unitario: preco,
                prazo_entrega: prazo,
                condicao_pagamento: condicao,
                frete_total: frete,
                observacao: obs
            });
            
            if (result.success) {
                mostrarToast('Resposta atualizada!', 'success');
                bootstrap.Modal.getInstance(document.getElementById('modalEditarResposta')).hide();
                setTimeout(() => location.reload(), 500);
            } else {
                throw new Error(result.error);
            }
        } catch (error) {
            mostrarToast('Erro: ' + error.message, 'danger');
        }
    }
    
    // ============ STATUS ============
    async function alterarStatus() {
        const novoStatus = document.getElementById('novoStatusSelecionado').value;
        
        try {
            const result = await apiCall(`/api/cotacao/${COTACAO_ID}/status`, 'POST', { status: novoStatus });
            if (result.success) {
                mostrarToast('Status alterado!', 'success');
                setTimeout(() => location.reload(), 500);
            } else {
                throw new Error(result.error);
            }
        } catch (error) {
            mostrarToast('Erro: ' + error.message, 'danger');
        }
    }
    
    // ============ NOME DA COTAÇÃO ============
    async function salvarNomeCotacao() {
        const nome = document.getElementById('inputNomeCotacao').value.trim();
        if (!nome) {
            mostrarToast('Nome não pode estar vazio', 'warning');
            return;
        }
        
        try {
            const result = await apiCall(`/api/cotacao/${COTACAO_ID}/editar-nome`, 'POST', { codigo: nome });
            if (result.success) {
                mostrarToast('Nome atualizado!', 'success');
                document.getElementById('displayCodigo').textContent = nome;
                document.getElementById('tituloCotacao').innerHTML = `<i class="fas fa-file-invoice-dollar me-2 text-primary"></i>${escapeHtml(nome)}`;
                bootstrap.Modal.getInstance(document.getElementById('modalEditarNome')).hide();
            } else {
                throw new Error(result.error);
            }
        } catch (error) {
            mostrarToast('Erro: ' + error.message, 'danger');
        }
    }
    
    // ============ IMPRESSÃO ============
    function imprimirComparativo() {
        // Adicionar título para impressão
        const titulo = document.getElementById('tituloCotacao').textContent;
        const dataHoje = new Date().toLocaleDateString('pt-BR');
        
        // Criar div temporária com cabeçalho de impressão
        const printHeader = document.createElement('div');
        printHeader.className = 'print-only';
        printHeader.style.display = 'none';
        printHeader.innerHTML = `
            <div style="text-align: center; margin-bottom: 30px; border-bottom: 2px solid #333; padding-bottom: 15px;">
                <h2 style="margin: 0; color: #333; font-size: 24px;">Comparativo de Cotação</h2>
                <h3 style="margin: 10px 0; color: #666; font-size: 18px;">${titulo}</h3>
                <p style="margin: 5px 0; color: #888; font-size: 14px;">Data: ${dataHoje}</p>
            </div>
        `;
        
        // Adicionar ao body temporariamente
        document.body.insertBefore(printHeader, document.body.firstChild);
        
        // Estilo temporário para impressão
        const style = document.createElement('style');
        style.textContent = `
            @media print {
                .print-only { display: block !important; }
            }
        `;
        document.head.appendChild(style);
        
        // Imprimir
        window.print();
        
        // Remover elementos temporários após impressão
        setTimeout(() => {
            document.body.removeChild(printHeader);
            document.head.removeChild(style);
        }, 1000);
    }
    
    // ============ INFORMAÇÃO FORNECEDOR ============
    async function salvarInfoFornecedor() {
        const info = document.getElementById('inputInformacaoFornecedor').value.trim();
        
        try {
            const result = await apiCall(`/api/cotacao/${COTACAO_ID}/informacao-fornecedor`, 'POST', { informacao: info });
            if (result.success) {
                mostrarToast('Informação salva!', 'success');
                bootstrap.Modal.getInstance(document.getElementById('modalInformacaoFornecedor')).hide();
                setTimeout(() => location.reload(), 500);
            } else {
                throw new Error(result.error);
            }
        } catch (error) {
            mostrarToast('Erro: ' + error.message, 'danger');
        }
    }
    
    // ============ TESTAR CONEXÃO TOTVS ============
    async function testarConexaoTOTVS() {
        const status = document.getElementById('statusConexaoTOTVS');
        status.style.display = 'block';
        status.innerHTML = '<div class="alert alert-info py-2 mb-0"><i class="fas fa-spinner fa-spin me-2"></i>Testando conexão...</div>';
        
        try {
            const result = await apiCall('/api/fornecedores/testar-conexao');
            if (result.success) {
                status.innerHTML = `<div class="alert alert-success py-2 mb-0"><i class="fas fa-check-circle me-2"></i>Conexão OK! ${result.total_fornecedores_ativos} fornecedores disponíveis.</div>`;
                setTimeout(() => { status.style.display = 'none'; }, 5000);
            } else {
                throw new Error(result.detalhe || result.error);
            }
        } catch (error) {
            status.innerHTML = `<div class="alert alert-danger py-2 mb-0"><i class="fas fa-times-circle me-2"></i>Falha: ${escapeHtml(error.message)}</div>`;
        }
    }
    
    // ============ DESTAQUE MATRIZ ============
    function destacarMelhoresMatriz() {
        const tabela = document.getElementById('tabelaMatriz');
        if (!tabela) return;
        
        console.log('[DESTAQUE] Iniciando destaque de melhores valores...');
        
        // 1. Destacar MELHOR PREÇO UNITÁRIO por ITEM (verde forte) - NOVIDADE!
        tabela.querySelectorAll('tbody tr[data-item-id]').forEach(linha => {
            const celulasPreco = linha.querySelectorAll('.celula-preco');
            
            let menorPreco = Infinity, celulaMenorPreco = null;
            celulasPreco.forEach(c => {
                const v = parseFloat(c.dataset.preco) || Infinity;
                if (v > 0 && v < menorPreco) {
                    menorPreco = v;
                    celulaMenorPreco = c;
                }
            });
            
            // Destacar somente o menor preço unitário deste item
            if (celulasPreco.length > 1 && celulaMenorPreco) {
                celulaMenorPreco.classList.add('melhor-preco');
                console.log('[DESTAQUE] Menor preço unitário:', menorPreco, 'na linha', linha.dataset.itemId);
            }
        });
        
        // 2. Destacar MELHOR TOTAL DO FORNECEDOR (verde forte)
        const celulasTotalFornecedor = tabela.querySelectorAll('.celula-total-fornecedor');
        let menorTotalForn = Infinity, celulaMelhorForn = null;
        
        celulasTotalFornecedor.forEach(c => {
            const v = parseFloat(c.dataset.total) || Infinity;
            if (v > 0 && v < menorTotalForn) {
                menorTotalForn = v;
                celulaMelhorForn = c;
            }
        });
        
        if (celulasTotalFornecedor.length > 1 && celulaMelhorForn) {
            celulaMelhorForn.classList.add('melhor-preco');
            console.log('[DESTAQUE] Melhor total do fornecedor:', menorTotalForn);
        }
        
        // 3. Destacar MENOR PRAZO por linha de item (amarelo)
        tabela.querySelectorAll('tbody tr[data-item-id]').forEach(linha => {
            const celulasPrazo = linha.querySelectorAll('.celula-prazo');
            
            let menorPrazo = Infinity, celulaMenorPrazo = null;
            celulasPrazo.forEach(c => {
                const v = parseInt(c.dataset.prazo) || Infinity;
                if (v > 0 && v < menorPrazo) {
                    menorPrazo = v;
                    celulaMenorPrazo = c;
                }
            });
            
            if (celulasPrazo.length > 1 && celulaMenorPrazo) {
                celulaMenorPrazo.classList.add('melhor-prazo');
            }
        });
    }
    
    // ============ VARIAÇÃO PERCENTUAL vs ÚLTIMO PREÇO PAGO ============
    function calcularVariacoesUltimoPreco() {
        const tabela = document.getElementById('tabelaMatriz');
        if (!tabela) return;
        
        tabela.querySelectorAll('tbody tr[data-item-id]').forEach(linha => {
            const ultimoPreco = parseFloat(linha.dataset.ultimoPreco) || 0;
            if (ultimoPreco <= 0) return; // Sem último preço: não exibir indicador
            
            linha.querySelectorAll('.celula-preco').forEach(celula => {
                const precoCotado = parseFloat(celula.dataset.preco) || 0;
                const spanVariacao = celula.querySelector('.variacao-preco');
                if (!spanVariacao) return;
                
                if (precoCotado <= 0) {
                    spanVariacao.textContent = '';
                    spanVariacao.className = 'variacao-preco';
                    return;
                }
                
                const variacao = ((precoCotado - ultimoPreco) / ultimoPreco) * 100;
                
                spanVariacao.className = 'variacao-preco'; // Reset classes
                
                if (Math.abs(variacao) < 0.01) {
                    // Preço igual
                    spanVariacao.textContent = '0%';
                    spanVariacao.classList.add('igual');
                } else if (variacao > 0) {
                    // Preço acima do último
                    spanVariacao.innerHTML = '<i class="fas fa-arrow-up" style="font-size:0.55rem;"></i> +' + variacao.toFixed(1) + '%';
                    spanVariacao.classList.add('acima');
                } else {
                    // Preço abaixo do último
                    spanVariacao.innerHTML = '<i class="fas fa-arrow-down" style="font-size:0.55rem;"></i> ' + variacao.toFixed(1) + '%';
                    spanVariacao.classList.add('abaixo');
                }
                
                spanVariacao.dataset.variacaoCalculada = 'true';
            });
        });
        
        console.log('[VARIAÇÃO] Indicadores de variação vs último preço calculados.');
    }

    // ============ ORDENAÇÃO DINÂMICA DE FORNECEDORES POR COMPETITIVIDADE ============
    function reordenarFornecedoresPorCompetitividade() {
        const tabela = document.getElementById('tabelaMatriz');
        if (!tabela) return;
        
        console.log('[ORDENACAO] Iniciando reordenação de fornecedores...');
        
        // 1. Extrair lista de fornecedores do cabeçalho
        const headerFornecedores = tabela.querySelectorAll('thead tr:first-child .header-fornecedor');
        if (headerFornecedores.length === 0) return;
        
        // 2. Coletar dados de cada fornecedor
        const fornecedoresData = [];
        
        headerFornecedores.forEach((header, index) => {
            const nomeFornecedor = header.textContent.trim();
            let melhoresPrecos = 0;
            let somaTotal = 0;
            let qtdItensValidos = 0;
            
            // Para cada linha de item, verificar se este fornecedor tem o melhor preço
            tabela.querySelectorAll('tbody tr[data-item-id]').forEach(linhaItem => {
                const celulasPreco = linhaItem.querySelectorAll('.celula-preco');
                const celulasSubtotal = linhaItem.querySelectorAll('.celula-subtotal');
                
                if (celulasPreco.length > index) {
                    const celulaForn = celulasPreco[index];
                    const precoForn = parseFloat(celulaForn.dataset.preco) || 0;
                    
                    if (precoForn > 0) {
                        // Verificar se é o melhor preço desta linha
                        let menorPreco = Infinity;
                        celulasPreco.forEach(c => {
                            const p = parseFloat(c.dataset.preco) || 0;
                            if (p > 0 && p < menorPreco) {
                                menorPreco = p;
                            }
                        });
                        
                        // Tolerância de 0.01 para arredondamentos
                        if (Math.abs(precoForn - menorPreco) < 0.01) {
                            melhoresPrecos++;
                        }
                        
                        somaTotal += precoForn;
                        qtdItensValidos++;
                    }
                }
            });
            
            // Adicionar frete ao total
            const celulaTotalFornecedor = tabela.querySelector(`.celula-total-fornecedor[data-forn="${nomeFornecedor}"]`);
            let totalComFrete = somaTotal;
            if (celulaTotalFornecedor) {
                totalComFrete = parseFloat(celulaTotalFornecedor.dataset.total) || somaTotal;
            }
            
            const valorMedio = qtdItensValidos > 0 ? somaTotal / qtdItensValidos : Infinity;
            
            fornecedoresData.push({
                nome: nomeFornecedor,
                indiceOriginal: index,
                melhoresPrecos: melhoresPrecos,
                somaTotal: totalComFrete,
                valorMedio: valorMedio,
                qtdItensValidos: qtdItensValidos
            });
            
            console.log(`[ORDENACAO] ${nomeFornecedor}: ${melhoresPrecos} melhores preços, total=${totalComFrete.toFixed(2)}, média=${valorMedio.toFixed(2)}`);
        });
        
        // 3. Ordenar fornecedores por competitividade
        const fornecedoresOrdenados = fornecedoresData.sort((a, b) => {
            // 1º: Maior quantidade de melhores preços
            if (a.melhoresPrecos !== b.melhoresPrecos) {
                return b.melhoresPrecos - a.melhoresPrecos;
            }
            // 2º: Menor soma total
            if (Math.abs(a.somaTotal - b.somaTotal) > 0.01) {
                return a.somaTotal - b.somaTotal;
            }
            // 3º: Menor valor médio
            return a.valorMedio - b.valorMedio;
        });
        
        // Verificar se a ordem mudou
        const ordemMudou = fornecedoresOrdenados.some((f, i) => f.indiceOriginal !== i);
        
        if (!ordemMudou) {
            console.log('[ORDENACAO] Fornecedores já estão na ordem correta');
            return;
        }
        
        console.log('[ORDENACAO] Reordenando colunas...', fornecedoresOrdenados.map(f => f.nome));
        
        // 4. Reordenar colunas do cabeçalho
        const headerRow1 = tabela.querySelector('thead tr:first-child');
        const headerRow2 = tabela.querySelector('thead tr:nth-child(2)');
        
        // Coletar cabeçalhos da primeira linha (fornecedores)
        const headers1 = Array.from(headerRow1.querySelectorAll('.header-fornecedor'));
        // Coletar cabeçalhos da segunda linha (Preço Unit., Total Item, Prazo, Cond.)
        const headers2 = Array.from(headerRow2.querySelectorAll('.sub-header'));
        
        // Reordenar e reinserir
        fornecedoresOrdenados.forEach((fornData, novoIndex) => {
            const antigoIndex = fornData.indiceOriginal;
            
            // Mover cabeçalho da primeira linha
            headerRow1.appendChild(headers1[antigoIndex]);
            
            // Mover 4 sub-headers correspondentes (Preço Unit., Total Item, Prazo, Cond.)
            for (let i = 0; i < 4; i++) {
                headerRow2.appendChild(headers2[antigoIndex * 4 + i]);
            }
        });
        
        // 5. Reordenar células das linhas de dados
        tabela.querySelectorAll('tbody tr').forEach(linha => {
            if (linha.classList.contains('linha-frete')) {
                // Linha de frete: reordenar células de frete (colspan=4)
                const celulasFrete = Array.from(linha.querySelectorAll('td[data-forn]'));
                fornecedoresOrdenados.forEach((fornData) => {
                    const celulaFrete = celulasFrete.find(c => c.dataset.forn === fornData.nome);
                    if (celulaFrete) {
                        linha.appendChild(celulaFrete);
                    }
                });
            } else if (linha.classList.contains('linha-total-fornecedor')) {
                // Linha de total: reordenar células de total (colspan=4)
                const celulasTotal = Array.from(linha.querySelectorAll('.celula-total-fornecedor'));
                fornecedoresOrdenados.forEach((fornData) => {
                    const celulaTotal = celulasTotal.find(c => c.dataset.forn === fornData.nome);
                    if (celulaTotal) {
                        linha.appendChild(celulaTotal);
                    }
                });
            } else if (linha.dataset.itemId) {
                // Linha de item: reordenar grupos de 4 células por fornecedor
                const todasCelulas = Array.from(linha.querySelectorAll('td'));
                const celulasFixas = todasCelulas.slice(0, 4); // Código, Descrição, Qtd, Último Preço
                const celulasFornecedores = todasCelulas.slice(4); // Células dos fornecedores
                
                // Agrupar células por fornecedor (4 células: preço, total, prazo, cond)
                const gruposPorFornecedor = [];
                for (let i = 0; i < celulasFornecedores.length; i += 4) {
                    gruposPorFornecedor.push(celulasFornecedores.slice(i, i + 4));
                }
                
                // Reordenar grupos
                const gruposOrdenados = fornecedoresOrdenados.map(fornData => 
                    gruposPorFornecedor[fornData.indiceOriginal]
                );
                
                // Limpar linha e reconstruir
                linha.innerHTML = '';
                celulasFixas.forEach(c => linha.appendChild(c));
                gruposOrdenados.forEach(grupo => {
                    if (grupo) {
                        grupo.forEach(c => linha.appendChild(c));
                    }
                });
            }
        });
        
        console.log('[ORDENACAO] Reordenação concluída!');
    }
    
    // ============ ANEXAR ORÇAMENTO ============
    function abrirModalAnexo(btn) {
        const id = btn.dataset.id;
        const nome = btn.dataset.nome;
        document.getElementById('anexoFornecedorId').value = id;
        document.getElementById('anexoFornecedorNome').textContent = nome;
        document.getElementById('inputAnexoArquivo').value = '';
        document.getElementById('previewAnexo').classList.add('d-none');
        new bootstrap.Modal(document.getElementById('modalAnexarOrcamento')).show();
    }
    
    function mostrarPreviewAnexo() {
        const input = document.getElementById('inputAnexoArquivo');
        const preview = document.getElementById('previewAnexo');
        const nomeSpan = document.getElementById('nomeArquivoAnexo');
        
        if (input.files && input.files[0]) {
            nomeSpan.textContent = input.files[0].name;
            preview.classList.remove('d-none');
        } else {
            preview.classList.add('d-none');
        }
    }
    
    async function enviarAnexo() {
        const fornecedorId = document.getElementById('anexoFornecedorId').value;
        const fileInput = document.getElementById('inputAnexoArquivo');
        
        if (!fileInput.files || !fileInput.files[0]) {
            mostrarToast('Selecione um arquivo', 'warning');
            return;
        }
        
        const btn = document.getElementById('btnEnviarAnexo');
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Enviando...';
        
        const formData = new FormData();
        formData.append('arquivo', fileInput.files[0]);
        formData.append('fornecedor_id', fornecedorId);
        
        try {
            const response = await fetch(`/api/cotacao/fornecedor/${fornecedorId}/anexo`, {
                method: 'POST',
                body: formData
            });
            
            const result = await response.json();
            
            if (result.success) {
                mostrarToast('Anexo enviado com sucesso!', 'success');
                bootstrap.Modal.getInstance(document.getElementById('modalAnexarOrcamento')).hide();
                setTimeout(() => location.reload(), 500);
            } else {
                throw new Error(result.error || 'Erro ao enviar anexo');
            }
        } catch (error) {
            mostrarToast('Erro: ' + error.message, 'danger');
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-upload me-1"></i> Enviar Anexo';
        }
    }
    
    // ============ VISUALIZAR ANEXO ============
    function abrirModalVisualizarAnexo(btn) {
        const fornecedorId = btn.dataset.fornecedorId;
        const fornecedorNome = btn.dataset.fornecedorNome;
        
        console.log('[ANEXO] Abrindo visualização para fornecedor:', fornecedorId, fornecedorNome);
        
        // Popular header
        document.getElementById('anexoFornecedorNomeModal').textContent = fornecedorNome;
        
        // Configurar links
        const urlVisualizacao = `/cotacao/anexo/${fornecedorId}`;
        const urlDownload = `/cotacao/anexo/${fornecedorId}/download`;
        
        document.getElementById('linkDownloadAnexo').href = urlDownload;
        document.getElementById('linkAbrirAnexo').href = urlVisualizacao;
        
        // Mostrar loading, esconder iframe e erro
        document.getElementById('loadingAnexo').style.display = 'block';
        document.getElementById('iframeAnexo').style.display = 'none';
        document.getElementById('erroAnexo').classList.add('d-none');
        
        // Abrir modal
        new bootstrap.Modal(document.getElementById('modalVisualizarAnexo')).show();
        
        // Carregar iframe
        const iframe = document.getElementById('iframeAnexo');
        iframe.src = urlVisualizacao;
        
        iframe.onload = function() {
            document.getElementById('loadingAnexo').style.display = 'none';
            iframe.style.display = 'block';
        };
        
        iframe.onerror = function() {
            document.getElementById('loadingAnexo').style.display = 'none';
            document.getElementById('erroAnexo').classList.remove('d-none');
        };
        
        // Timeout para casos onde o iframe não carrega
        setTimeout(() => {
            if (document.getElementById('loadingAnexo').style.display !== 'none') {
                document.getElementById('loadingAnexo').style.display = 'none';
                iframe.style.display = 'block';
            }
        }, 3000);
    }
    
    // ============ MODAL RESPONDER COTAÇÃO ============
    async function abrirModalResponderCotacao(btn) {
        const fornecedorId = btn.dataset.fornecedorId;
        const fornecedorNome = btn.dataset.fornecedorNome;
        const status = btn.dataset.status;
        
        console.log('[RESPONDER] Abrindo modal para fornecedor:', fornecedorId, fornecedorNome);
        
        // Popular header do modal
        document.getElementById('modalFornecedorId').value = fornecedorId;
        document.getElementById('modalFornecedorNome').textContent = fornecedorNome;
        
        // Limpar campos de fornecedor
        document.getElementById('inputFreteFornecedor').value = '';
        document.getElementById('inputCondicaoFornecedor').value = '';
        document.getElementById('inputObsFornecedor').value = '';
        
        // Limpar campo de anexo
        const inputAnexo = document.getElementById('inputAnexoOrcamento');
        if (inputAnexo) {
            inputAnexo.value = '';
        }
        document.getElementById('anexoAtualInfo').classList.add('d-none');
        
        // Mostrar status
        const statusBadge = document.getElementById('modalStatusBadge');
        if (status === 'Respondido') {
            statusBadge.innerHTML = '<div class="alert alert-success py-2"><i class="fas fa-check-circle me-2"></i>Este fornecedor já enviou resposta. Você pode editar os valores abaixo.</div>';
        } else {
            statusBadge.innerHTML = '<div class="alert alert-info py-2"><i class="fas fa-info-circle me-2"></i>Preencha os valores para cada item da cotação.</div>';
        }
        
        // Mostrar loading
        document.getElementById('loadingModal').classList.remove('d-none');
        document.getElementById('tbodyItensModal').innerHTML = '';
        
        // Abrir modal
        new bootstrap.Modal(document.getElementById('modalResponderCotacao')).show();
        
        try {
            // Buscar itens via API
            const data = await apiCall(`/api/cotacao/fornecedor/${fornecedorId}/itens`);
            
            if (data.success) {
                // Popular campos do fornecedor
                if (data.fornecedor) {
                    if (data.fornecedor.frete) {
                        document.getElementById('inputFreteFornecedor').value = formatarMoeda(data.fornecedor.frete);
                    }
                    document.getElementById('inputCondicaoFornecedor').value = data.fornecedor.condicao || '';
                    document.getElementById('inputObsFornecedor').value = data.fornecedor.observacao || '';
                    
                    // Mostrar se existe anexo
                    if (data.fornecedor.arquivo_anexo) {
                        const nomeArquivo = data.fornecedor.arquivo_anexo.split('/').pop();
                        document.getElementById('nomeAnexoAtual').textContent = nomeArquivo;
                        document.getElementById('anexoAtualInfo').classList.remove('d-none');
                    }
                }
                
                renderizarItensModal(data.itens);
            } else {
                throw new Error(data.error);
            }
        } catch (error) {
            console.error('[RESPONDER] Erro:', error);
            document.getElementById('tbodyItensModal').innerHTML = `
                <tr><td colspan="5" class="text-center text-danger py-4">
                    <i class="fas fa-exclamation-triangle me-2"></i>Erro ao carregar itens: ${escapeHtml(error.message)}
                </td></tr>
            `;
        } finally {
            document.getElementById('loadingModal').classList.add('d-none');
        }
    }
    
    function renderizarItensModal(itens) {
        const tbody = document.getElementById('tbodyItensModal');
        
        if (!itens || itens.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted py-4">Nenhum item nesta cotação</td></tr>';
            return;
        }
        
        tbody.innerHTML = itens.map(item => `
            <tr data-item-id="${item.id}">
                <td><small class="text-muted">${escapeHtml(item.cod_produto || '')}</small></td>
                <td><strong>${escapeHtml(item.descricao_produto || '')}</strong></td>
                <td class="text-center">${item.quantidade || 0} ${escapeHtml(item.unidade || 'UN')}</td>
                <td>
                    <input type="text" class="form-control form-control-sm input-preco" 
                           placeholder="0,00" 
                           value="${item.preco_unitario ? formatarMoeda(item.preco_unitario) : ''}"
                           oninput="formatarMoedaInput(this)">
                </td>
                <td>
                    <input type="number" class="form-control form-control-sm input-prazo" 
                           placeholder="0" min="0"
                           value="${item.prazo_entrega || ''}">
                </td>
                <td>
                    <input type="text" class="form-control form-control-sm input-obs-item" 
                           placeholder="Observação do item..."
                           value="${escapeHtml(item.observacao || '')}">
                </td>
            </tr>
        `).join('');
    }
    
    function formatarMoedaInput(input) {
        let valor = input.value;
        // Remove tudo exceto números, vírgula e ponto
        valor = valor.replace(/[^\d.,]/g, '');
        // Limita a 2 casas decimais após vírgula
        const partes = valor.split(',');
        if (partes.length > 2) {
            valor = partes[0] + ',' + partes.slice(1).join('').substring(0, 2);
        } else if (partes.length === 2) {
            valor = partes[0] + ',' + partes[1].substring(0, 2);
        }
        input.value = valor;
    }
    
    async function salvarRespostasModal() {
        const fornecedorId = document.getElementById('modalFornecedorId').value;
        const linhas = document.querySelectorAll('#tbodyItensModal tr[data-item-id]');
        
        // Campos únicos do fornecedor
        const frete = converterParaDecimal(document.getElementById('inputFreteFornecedor').value);
        const condicao = document.getElementById('inputCondicaoFornecedor').value;
        const observacao = document.getElementById('inputObsFornecedor').value;
        
        // Arquivo de anexo (se houver)
        const inputAnexo = document.getElementById('inputAnexoOrcamento');
        const arquivoAnexo = inputAnexo && inputAnexo.files.length > 0 ? inputAnexo.files[0] : null;
        
        const respostas = [];
        let temPreenchido = false;
        
        linhas.forEach(linha => {
            const itemId = linha.dataset.itemId;
            const preco = converterParaDecimal(linha.querySelector('.input-preco').value);
            const prazo = parseInt(linha.querySelector('.input-prazo').value) || 0;
            const obsItem = linha.querySelector('.input-obs-item').value;
            
            if (preco > 0) {
                temPreenchido = true;
            }
            
            respostas.push({
                item_id: parseInt(itemId),
                preco: preco,
                prazo: prazo,
                observacao: obsItem
            });
        });
        
        if (!temPreenchido) {
            mostrarToast('Preencha pelo menos um item com preço', 'warning');
            return;
        }
        
        const btn = document.getElementById('btnSalvarRespostasModal');
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Salvando...';
        
        try {
            // 1. Salvar respostas da cotação
            const result = await apiCall(`/api/cotacao/fornecedor/${fornecedorId}/salvar-respostas`, 'POST', {
                respostas: respostas,
                frete: frete,
                condicao: condicao,
                observacao: observacao
            });
            
            if (!result.success) {
                throw new Error(result.error);
            }
            
            // 2. Se há arquivo, faz upload do anexo
            if (arquivoAnexo) {
                btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Enviando anexo...';
                
                const formData = new FormData();
                formData.append('arquivo', arquivoAnexo);
                
                const uploadResult = await fetch(`/api/cotacao/fornecedor/${fornecedorId}/anexo`, {
                    method: 'POST',
                    body: formData
                });
                const uploadJson = await uploadResult.json();
                
                if (!uploadJson.success) {
                    console.warn('[ANEXO] Erro no upload:', uploadJson.error);
                    mostrarToast('Respostas salvas, mas o anexo falhou: ' + uploadJson.error, 'warning');
                } else {
                    mostrarToast('Respostas e anexo salvos com sucesso!', 'success');
                }
            } else {
                mostrarToast(result.message || 'Respostas salvas com sucesso!', 'success');
            }
            
            bootstrap.Modal.getInstance(document.getElementById('modalResponderCotacao')).hide();
            setTimeout(() => location.reload(), 800);
            
        } catch (error) {
            console.error('[SALVAR RESPOSTAS] Erro:', error);
            mostrarToast('Erro: ' + error.message, 'danger');
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-save me-1"></i> Salvar Respostas';
        }
    }
    
    // ============ TOGGLE SIDEBAR ============
    function toggleSidebar() {
        const sidebar = document.getElementById('sidebar');
        const content = document.getElementById('content');
        const toggleBtn = document.getElementById('sidebarToggle');
        
        sidebar.classList.toggle('collapsed');
        content.classList.toggle('expanded');
        toggleBtn.classList.toggle('collapsed');
        
        localStorage.setItem('sidebarCollapsed', sidebar.classList.contains('collapsed'));
    }
    
    // ============ INICIALIZAÇÃO ============
    document.addEventListener('DOMContentLoaded', function() {
        console.log('[COTAÇÃO] Inicializando módulo...');
        
        // Restaurar estado da sidebar
        const sidebarCollapsed = localStorage.getItem('sidebarCollapsed') === 'true';
        if (sidebarCollapsed) {
            document.getElementById('sidebar').classList.add('collapsed');
            document.getElementById('content').classList.add('expanded');
            document.getElementById('sidebarToggle').classList.add('collapsed');
        }
        
        // Inicializa tooltips do Bootstrap (para observações no comparativo)
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl, {
                html: true,
                trigger: 'hover focus'
            });
        });
        console.log('[COTAÇÃO] Tooltips inicializados:', tooltipTriggerList.length);
        
        // Toggle modo fornecedor
        document.getElementById('btnModoCadastrado').addEventListener('click', function() {
            modoFornecedor = 'cadastrado';
            this.classList.add('active');
            document.getElementById('btnModoManual').classList.remove('active');
            document.getElementById('modoCadastrado').style.display = 'block';
            document.getElementById('modoManual').style.display = 'none';
            limparSelecao();
        });
        
        document.getElementById('btnModoManual').addEventListener('click', function() {
            modoFornecedor = 'manual';
            this.classList.add('active');
            document.getElementById('btnModoCadastrado').classList.remove('active');
            document.getElementById('modoCadastrado').style.display = 'none';
            document.getElementById('modoManual').style.display = 'block';
        });
        
        // Busca fornecedor com debounce
        document.getElementById('buscaFornecedor').addEventListener('input', function() {
            if (timeoutBusca) clearTimeout(timeoutBusca);
            timeoutBusca = setTimeout(() => buscarFornecedores(this.value), 300);
        });
        
        // Limpar busca
        document.getElementById('btnLimparBusca').addEventListener('click', function() {
            document.getElementById('buscaFornecedor').value = '';
            document.getElementById('listaFornecedores').style.display = 'none';
        });
        
        // Limpar todos os selecionados
        document.getElementById('btnLimparTodosSelecionados').addEventListener('click', limparSelecao);
        
        // Adicionar fornecedor
        document.getElementById('btnAdicionarForn').addEventListener('click', adicionarFornecedor);
        
        // Testar conexão
        document.getElementById('btnTestarConexao').addEventListener('click', testarConexaoTOTVS);
        
        // Excluir fornecedor
        document.querySelectorAll('.btn-excluir-forn').forEach(btn => {
            btn.addEventListener('click', function() {
                excluirFornecedor(this.dataset.id, this.dataset.nome);
            });
        });
        
        // Editar fornecedor
        document.querySelectorAll('.btn-editar-forn').forEach(btn => {
            btn.addEventListener('click', function() {
                abrirModalEditarFornecedor(this);
            });
        });
        
        // Salvar edição de fornecedor
        document.getElementById('btnSalvarFornecedor').addEventListener('click', salvarEdicaoFornecedor);
        
        // Editar resposta
        document.querySelectorAll('.btn-editar-resp').forEach(btn => {
            btn.addEventListener('click', function() {
                abrirModalEditarResposta(this);
            });
        });
        
        // Salvar resposta
        document.getElementById('btnSalvarResposta').addEventListener('click', salvarEdicaoResposta);
        
        // Salvar nome
        document.getElementById('btnSalvarNome').addEventListener('click', salvarNomeCotacao);
        
        // Salvar info fornecedor
        document.getElementById('btnSalvarInfoForn').addEventListener('click', salvarInfoFornecedor);
        
        // Status
        document.querySelectorAll('.status-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.status-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                document.getElementById('novoStatusSelecionado').value = this.dataset.status;
            });
        });
        document.getElementById('btnConfirmarStatus').addEventListener('click', alterarStatus);
        
        // Reset modal ao abrir
        document.getElementById('modalFornecedor').addEventListener('show.bs.modal', function() {
            modoFornecedor = 'cadastrado';
            fornecedoresSelecionados.clear();
            document.getElementById('btnModoCadastrado').classList.add('active');
            document.getElementById('btnModoManual').classList.remove('active');
            document.getElementById('modoCadastrado').style.display = 'block';
            document.getElementById('modoManual').style.display = 'none';
            limparSelecao();
            document.getElementById('fornNome').value = '';
            document.getElementById('fornEmail').value = '';
            document.getElementById('fornTelefone').value = '';
        });
        
        // Anexar orçamento
        document.querySelectorAll('.btn-anexar-forn').forEach(btn => {
            btn.addEventListener('click', function() {
                abrirModalAnexo(this);
            });
        });
        
        // Visualizar anexo (NOVO - abre modal com iframe)
        document.querySelectorAll('.btn-visualizar-anexo').forEach(btn => {
            btn.addEventListener('click', function() {
                abrirModalVisualizarAnexo(this);
            });
        });
        
        // Preview do arquivo
        document.getElementById('inputAnexoArquivo').addEventListener('change', mostrarPreviewAnexo);
        
        // Remover arquivo selecionado
        document.getElementById('btnRemoverAnexo').addEventListener('click', function() {
            document.getElementById('inputAnexoArquivo').value = '';
            document.getElementById('previewAnexo').classList.add('d-none');
        });
        
        // Enviar anexo
        document.getElementById('btnEnviarAnexo').addEventListener('click', enviarAnexo);
        
        // Responder/Editar cotação (NOVO MODAL)
        document.querySelectorAll('.btn-responder-cotacao').forEach(btn => {
            btn.addEventListener('click', function() {
                abrirModalResponderCotacao(this);
            });
        });
        
        // Salvar respostas do modal
        document.getElementById('btnSalvarRespostasModal').addEventListener('click', salvarRespostasModal);
        
        // ============ COTAÇÃO EXTERNA VIA JSON ============
        
        // Botões Gerar JSON (legado - mantido para compatibilidade)
        document.querySelectorAll('.btn-gerar-json').forEach(btn => {
            btn.addEventListener('click', function() {
                abrirModalGerarJson(this);
            });
        });
        
        // Destaque matriz
        destacarMelhoresMatriz();
        
        // Calcular variações percentuais vs último preço pago
        calcularVariacoesUltimoPreco();
        
        // Reordenar fornecedores por competitividade
        reordenarFornecedoresPorCompetitividade();
        
        console.log('[COTAÇÃO] Módulo inicializado com sucesso!');
    });
    
    
    // ============ COTAÇÃO EXTERNA VIA JSON ============
    
    function abrirModalGerarJson(btn) {
        const fornecedorId = btn.dataset.fornecedorId;
        const fornecedorNome = btn.dataset.fornecedorNome;
        const fornecedorToken = btn.dataset.token;
        
        // Debug - mostra no console os valores capturados
        console.log('[MODAL] Abrindo modal para fornecedor:', {
            id: fornecedorId,
            nome: fornecedorNome,
            token: fornecedorToken
        });
        
        if (!fornecedorId) {
            console.error('[MODAL] ERRO: fornecedorId está vazio!');
            alert('Erro: ID do fornecedor não encontrado. Recarregue a página.');
            return;
        }
        
        document.getElementById('jsonFornecedorId').value = fornecedorId;
        document.getElementById('jsonFornecedorToken').value = fornecedorToken;
        document.getElementById('jsonFornecedorNome').textContent = fornecedorNome;
        document.getElementById('jsonGeradoInfo').classList.add('d-none');
        document.getElementById('btnGerarJson').disabled = false;
        document.getElementById('btnGerarJson').innerHTML = '<i class="fas fa-file-export me-2"></i> Gerar Arquivo HTML';
        document.getElementById('btnGerarContainer').style.display = 'block';
        
        // Montar link online (interno - rede local)
        const baseUrl = window.location.origin;
        const linkExterno = `${baseUrl}/cotacao/responder/${fornecedorToken}`;
        document.getElementById('linkCotacaoExterna').value = linkExterno;
        document.getElementById('linkNoTexto').textContent = linkExterno;
        
        // Resetar aba de Link Externo (Render)
        document.getElementById('linkRenderContainer').style.display = 'none';
        document.getElementById('textoRenderContainer').style.display = 'none';
        document.getElementById('btnGerarLinkRenderContainer').style.display = 'block';
        const btnRender = document.getElementById('btnGerarLinkRender');
        btnRender.disabled = false;
        btnRender.className = 'btn btn-primary btn-lg';
        btnRender.innerHTML = '<i class="fas fa-cloud-upload-alt me-2"></i> Gerar Link Externo';
        
        // Verificar status do servidor Render
        verificarStatusRender();
        
        new bootstrap.Modal(document.getElementById('modalGerarJson')).show();
    }
    
    function copiarLinkExterno() {
        const link = document.getElementById('linkCotacaoExterna');
        link.select();
        link.setSelectionRange(0, 99999);
        navigator.clipboard.writeText(link.value);
        
        // Feedback visual
        const btn = link.nextElementSibling;
        const iconOriginal = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-check"></i>';
        btn.classList.remove('btn-primary');
        btn.classList.add('btn-success');
        
        setTimeout(() => {
            btn.innerHTML = iconOriginal;
            btn.classList.remove('btn-success');
            btn.classList.add('btn-primary');
        }, 2000);
    }
    
    function copiarTextoLinkOnline() {
        const fornecedorNome = document.getElementById('jsonFornecedorNome').textContent;
        const link = document.getElementById('linkCotacaoExterna').value;
        
        const texto = `Prezado ${fornecedorNome},

Solicitamos cotação para os itens no link abaixo:

${link}

INSTRUÇÕES:
Acesse o link acima, preencha os preços e prazos, e clique em "Enviar Cotação".

Atenciosamente.`;
        
        navigator.clipboard.writeText(texto).then(() => {
            const btn = event.target.closest('button');
            const textoOriginal = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-check me-1"></i>Copiado!';
            setTimeout(() => { btn.innerHTML = textoOriginal; }, 2000);
        });
    }
    
    // ============ FUNÇÕES PARA LINK EXTERNO (RENDER) ============
    
    async function verificarStatusRender() {
        try {
            const response = await fetch('/api/cotacao/externa/status');
            const data = await response.json();
            
            const badge = document.getElementById('statusRenderBadge');
            if (data.online) {
                badge.className = 'badge bg-success';
                badge.innerHTML = '<i class="fas fa-check-circle me-1"></i>Online';
            } else {
                badge.className = 'badge bg-danger';
                badge.innerHTML = '<i class="fas fa-times-circle me-1"></i>Offline';
            }
        } catch (error) {
            const badge = document.getElementById('statusRenderBadge');
            badge.className = 'badge bg-warning';
            badge.innerHTML = '<i class="fas fa-exclamation-triangle me-1"></i>Erro';
        }
    }
    
    async function gerarLinkExterno() {
        const fornecedorId = document.getElementById('jsonFornecedorId').value;
        const btn = document.getElementById('btnGerarLinkRender');
        
        // Validação do fornecedorId
        if (!fornecedorId) {
            mostrarToast('Erro: ID do fornecedor não encontrado', 'danger');
            console.error('[LINK EXTERNO] fornecedorId está vazio ou undefined');
            return;
        }
        
        console.log('[LINK EXTERNO] Gerando link para fornecedor ID:', fornecedorId);
        
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i> Gerando...';
        
        try {
            // Chama endpoint correto: /api/cotacao/fornecedor/<id>/gerar-link-externo
            const response = await fetch(`/api/cotacao/fornecedor/${fornecedorId}/gerar-link-externo`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });
            
            // Verifica se a resposta é válida antes de fazer parse
            const contentType = response.headers.get('content-type');
            if (!contentType || !contentType.includes('application/json')) {
                const text = await response.text();
                console.error('[LINK EXTERNO] Resposta não é JSON:', text.substring(0, 500));
                throw new Error('Servidor retornou resposta inválida (não é JSON)');
            }
            
            const data = await response.json();
            
            if (data.success) {
                // Mostrar link gerado (usa data.link_externo do backend)
                document.getElementById('linkCotacaoRender').value = data.link_externo;
                document.getElementById('linkRenderNoTexto').textContent = data.link_externo;
                document.getElementById('linkRenderContainer').style.display = 'block';
                document.getElementById('textoRenderContainer').style.display = 'block';
                document.getElementById('btnGerarLinkRenderContainer').style.display = 'none';
                
                btn.innerHTML = '<i class="fas fa-check me-2"></i> Link Gerado!';
                btn.className = 'btn btn-success btn-lg';
                
                mostrarToast('Link externo gerado com sucesso!', 'success');
                console.log('[LINK EXTERNO] Token:', data.token);
                console.log('[LINK EXTERNO] URL:', data.link_externo);
            } else {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-cloud-upload-alt me-2"></i> Gerar Link Externo';
                mostrarToast('Erro: ' + (data.error || 'Erro ao gerar link'), 'danger');
            }
        } catch (error) {
            console.error('[LINK EXTERNO] Erro:', error);
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-cloud-upload-alt me-2"></i> Gerar Link Externo';
            mostrarToast('Erro: ' + error.message, 'danger');
        }
    }
    
    function copiarLinkRender() {
        const link = document.getElementById('linkCotacaoRender');
        link.select();
        link.setSelectionRange(0, 99999);
        navigator.clipboard.writeText(link.value);
        
        // Feedback visual
        const btn = link.nextElementSibling;
        const iconOriginal = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-check"></i>';
        btn.classList.remove('btn-primary');
        btn.classList.add('btn-success');
        
        setTimeout(() => {
            btn.innerHTML = iconOriginal;
            btn.classList.remove('btn-success');
            btn.classList.add('btn-primary');
        }, 2000);
        
        mostrarToast('Link copiado!', 'success');
    }
    
    function copiarTextoLinkRender() {
        const fornecedorNome = document.getElementById('jsonFornecedorNome').textContent;
        const link = document.getElementById('linkCotacaoRender').value;
        
        const texto = `Prezado ${fornecedorNome},

Solicitamos cotação para os itens. Acesse o link abaixo:

${link}

INSTRUÇÕES:
- Clique no link acima (funciona em celular ou computador)
- Preencha os preços e prazos de cada item
- Clique em "Enviar Cotação"

Atenciosamente,
Departamento de Compras`;
        
        navigator.clipboard.writeText(texto).then(() => {
            mostrarToast('Texto copiado! Cole no e-mail ou WhatsApp.', 'success');
        }).catch(() => {
            mostrarToast('Erro ao copiar. Copie manualmente.', 'warning');
        });
    }
    
    function copiarInstrucoesFornecedor() {
        const fornecedorNome = document.getElementById('jsonFornecedorNome').textContent;
        const texto = `Prezado ${fornecedorNome},

Segue em anexo solicitação de cotação.

INSTRUÇÕES PARA PREENCHIMENTO:
1. Baixe o arquivo HTML anexo neste e-mail
2. Abra o arquivo no navegador (Chrome, Edge ou Firefox)
3. Preencha os preços, prazos e observações solicitados
4. Clique no botão "Salvar Respostas"
5. Um arquivo JSON será baixado automaticamente
6. Envie esse arquivo JSON de volta respondendo este e-mail

Observação: O arquivo HTML funciona offline, você não precisa de acesso à internet para preencher.

Atenciosamente,
Departamento de Compras`;

        navigator.clipboard.writeText(texto).then(() => {
            mostrarToast('Instruções copiadas! Cole no corpo do e-mail.', 'success');
        }).catch(() => {
            mostrarToast('Erro ao copiar. Copie manualmente.', 'warning');
        });
    }


    // =================== RODADAS DE NEGOCIAÇÃO ===================
    
    let dadosItensNegociacao = [];
    const cotacaoIdNeg = {{ cotacao.id }};
    
    /**
     * Carrega itens do fornecedor selecionado para negociação
     */
    function carregarItensNegociacao() {
        const fornecedorId = document.getElementById('fornecedorNegociacao').value;
        if (!fornecedorId) {
            document.getElementById('containerItensNegociacao').style.display = 'none';
            document.getElementById('btnSalvarNegociacao').disabled = true;
            return;
        }
        
        // Filtrar respostas do fornecedor selecionado
        const respostas = {{ cotacao.respostas|tojson }};
        const itens = {{ cotacao.itens|tojson }};
        
        dadosItensNegociacao = [];
        
        itens.forEach(item => {
            const resposta = respostas.find(r => r.fornecedor_id == fornecedorId && r.item_id == item.id);
            if (resposta) {
                dadosItensNegociacao.push({
                    item_id: item.id,
                    cod_produto: item.cod_produto,
                    descricao: item.descricao_produto,
                    quantidade: item.quantidade,
                    unidade: item.unidade || 'UN',
                    preco_original: resposta.preco_unitario || 0,
                    prazo_original: resposta.prazo_entrega || 0
                });
            }
        });
        
        renderizarTabelaNegociacao();
        document.getElementById('containerItensNegociacao').style.display = 'block';
        document.getElementById('btnSalvarNegociacao').disabled = false;
    }
    
    /**
     * Formata número para exibição em formato BR (vírgula decimal)
     */
    function formatarParaBR(valor) {
        if (valor === null || valor === undefined || isNaN(valor)) return '0,00';
        return parseFloat(valor).toFixed(2).replace('.', ',');
    }
    
    /**
     * Renderiza tabela com itens para negociação
     */
    function renderizarTabelaNegociacao() {
        const tbody = document.getElementById('tabelaItensNegociacao');
        tbody.innerHTML = '';
        
        dadosItensNegociacao.forEach((item, index) => {
            const tr = document.createElement('tr');
            // CORREÇÃO: Usar formato BR (vírgula) desde o início para consistência
            const precoOriginalBR = formatarParaBR(item.preco_original);
            
            tr.innerHTML = `
                <td class="text-center">
                    <input type="checkbox" class="checkbox-item" data-index="${index}" checked>
                </td>
                <td>
                    <strong>${item.cod_produto}</strong><br>
                    <small class="text-muted">${item.descricao}</small>
                </td>
                <td>${item.quantidade} ${item.unidade}</td>
                <td style="background: #e3f2fd20;">R$ ${precoOriginalBR}</td>
                <td style="background: #e3f2fd20;">${item.prazo_original} dias</td>
                <td style="background: #fff3e020;">
                    <input type="number" class="form-control form-control-sm desconto-item" 
                           data-index="${index}" value="0" min="0" max="100" step="0.5"
                           onchange="calcularPrecoComDesconto(${index})" style="width: 70px;">
                </td>
                <td style="background: #e8f5e920;">
                    <input type="text" class="form-control form-control-sm preco-negociado" 
                           data-index="${index}" value="${precoOriginalBR}" 
                           oninput="formatarMoedaModal(this)">
                </td>
                <td style="background: #e8f5e920;">
                    <input type="number" class="form-control form-control-sm prazo-negociado" 
                           data-index="${index}" value="${item.prazo_original}" min="0">
                </td>
            `;
            tbody.appendChild(tr);
        });
    }
    
    /**
     * Calcula preço com desconto aplicado
     */
    function calcularPrecoComDesconto(index) {
        const item = dadosItensNegociacao[index];
        const desconto = parseFloat(document.querySelector(`.desconto-item[data-index="${index}"]`).value) || 0;
        const precoComDesconto = item.preco_original * (1 - desconto / 100);
        
        const inputPreco = document.querySelector(`.preco-negociado[data-index="${index}"]`);
        inputPreco.value = precoComDesconto.toFixed(2).replace('.', ',');
    }
    
    /**
     * Aplica desconto global em todos os itens selecionados
     */
    function aplicarDescontoGlobal() {
        const descontoGlobal = parseFloat(document.getElementById('descontoGlobal').value) || 0;
        
        if (descontoGlobal < 0 || descontoGlobal > 100) {
            mostrarToast('Desconto deve estar entre 0 e 100%', 'warning');
            return;
        }
        
        let aplicados = 0;
        document.querySelectorAll('.checkbox-item:checked').forEach(checkbox => {
            const index = checkbox.dataset.index;
            const item = dadosItensNegociacao[index];
            
            // Atualiza campo de desconto individual
            const inputDesconto = document.querySelector(`.desconto-item[data-index="${index}"]`);
            inputDesconto.value = descontoGlobal;
            
            // Calcula novo preço
            const precoComDesconto = item.preco_original * (1 - descontoGlobal / 100);
            const inputPreco = document.querySelector(`.preco-negociado[data-index="${index}"]`);
            inputPreco.value = precoComDesconto.toFixed(2).replace('.', ',');
            
            aplicados++;
        });
        
        if (aplicados > 0) {
            mostrarToast(`Desconto de ${descontoGlobal}% aplicado em ${aplicados} item(ns)`, 'success');
        } else {
            mostrarToast('Nenhum item selecionado', 'warning');
        }
    }
    
    /**
     * Selecionar/desselecionar todos os itens
     */
    function selecionarTodosItens(checkbox) {
        document.querySelectorAll('.checkbox-item').forEach(cb => {
            cb.checked = checkbox.checked;
        });
    }
    
    /**
     * Salva rodada de negociação
     */
    function salvarRodadaNegociacao() {
        const fornecedorId = document.getElementById('fornecedorNegociacao').value;
        const observacao = document.getElementById('observacaoNegociacao').value;
        const freteStr = document.getElementById('freteNegociacao')?.value || '0';
        const frete = converterParaDecimal(freteStr);
        const anexoInput = document.getElementById('inputAnexoRodada2');
        
        if (!fornecedorId) {
            mostrarToast('Selecione um fornecedor', 'warning');
            return;
        }
        
        const itensNegociados = [];
        let temErro = false;
        
        document.querySelectorAll('.checkbox-item:checked').forEach(checkbox => {
            const index = checkbox.dataset.index;
            const item = dadosItensNegociacao[index];
            
            const precoNegociadoStr = document.querySelector(`.preco-negociado[data-index="${index}"]`).value;
            const prazoNegociado = parseInt(document.querySelector(`.prazo-negociado[data-index="${index}"]`).value) || 0;
            const descontoItem = parseFloat(document.querySelector(`.desconto-item[data-index="${index}"]`).value) || 0;
            
            // CORREÇÃO: Usar função de conversão inteligente
            let precoNegociado = converterParaDecimal(precoNegociadoStr);
            
            // VALIDAÇÃO ANTI-MULTIPLICAÇÃO: Detectar valores absurdos
            // Se o preço negociado for mais de 50x o preço original, provavelmente é erro
            const precoOriginal = item.preco_original || 0;
            if (precoOriginal > 0 && precoNegociado > precoOriginal * 50) {
                console.warn(`[ALERTA] Preço suspeito para ${item.cod_produto}: original=${precoOriginal}, negociado=${precoNegociado}`);
                mostrarToast(`Preço suspeito para ${item.cod_produto}: R$ ${precoNegociado.toFixed(2)} (original: R$ ${precoOriginal.toFixed(2)}). Verifique o valor.`, 'warning');
                temErro = true;
                return;
            }
            
            if (isNaN(precoNegociado) || precoNegociado <= 0) {
                mostrarToast(`Preço inválido para ${item.cod_produto}`, 'danger');
                temErro = true;
                return;
            }
            
            itensNegociados.push({
                item_id: item.item_id,
                preco_original: precoOriginal,
                preco_negociado: precoNegociado,
                prazo_original: item.prazo_original,
                prazo_negociado: prazoNegociado,
                desconto_percentual: descontoItem
            });
        });
        
        if (temErro) return;
        
        if (itensNegociados.length === 0) {
            mostrarToast('Selecione pelo menos um item para negociar', 'warning');
            return;
        }
        
        // Primeiro salva a rodada de negociação
        fetch(`/api/cotacao/${cotacaoIdNeg}/rodada-negociacao`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                fornecedor_id: fornecedorId,
                itens: itensNegociados,
                observacao: observacao,
                frete_negociado: frete
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Se houver frete, atualizar separadamente
                if (frete > 0) {
                    return fetch(`/api/cotacao/${cotacaoIdNeg}/rodada-fornecedor/${fornecedorId}/frete`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ frete_negociado: frete })
                    }).then(() => data);
                }
                return data;
            } else {
                throw new Error(data.error || 'Erro ao salvar negociação');
            }
        })
        .then(data => {
            // Se houver anexo, fazer upload
            if (anexoInput && anexoInput.files && anexoInput.files.length > 0) {
                const formData = new FormData();
                formData.append('arquivo', anexoInput.files[0]);
                formData.append('fornecedor_id', fornecedorId);
                formData.append('rodada', '2');
                
                return fetch(`/api/cotacao/${cotacaoIdNeg}/rodada-negociacao/anexo`, {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(anexoData => {
                    if (anexoData.success) {
                        mostrarToast('Negociação e anexo salvos com sucesso!', 'success');
                    } else {
                        mostrarToast('Negociação salva, mas erro ao salvar anexo: ' + (anexoData.error || 'Erro desconhecido'), 'warning');
                    }
                    return data;
                });
            }
            return data;
        })
        .then(data => {
            mostrarToast(data.message || 'Negociação salva com sucesso', 'success');
            setTimeout(() => location.reload(), 1500);
        })
        .catch(error => {
            console.error('Erro:', error);
            mostrarToast(error.message || 'Erro ao salvar negociação', 'danger');
        });
    }
    
    /**
     * Preview do anexo da rodada 2
     */
    document.getElementById('inputAnexoRodada2')?.addEventListener('change', function() {
        const previewDiv = document.getElementById('previewAnexoRodada2');
        const nomeSpan = document.getElementById('nomeAnexoRodada2');
        
        if (this.files && this.files.length > 0) {
            const file = this.files[0];
            // Verificar tamanho (máx 10MB)
            if (file.size > 10 * 1024 * 1024) {
                mostrarToast('Arquivo muito grande! Máximo 10MB.', 'danger');
                this.value = '';
                previewDiv.style.display = 'none';
                return;
            }
            nomeSpan.textContent = file.name;
            previewDiv.style.display = 'block';
        } else {
            previewDiv.style.display = 'none';
        }
    });
    
    /**
     * Remove anexo da rodada 2
     */
    function removerAnexoRodada2() {
        document.getElementById('inputAnexoRodada2').value = '';
        document.getElementById('previewAnexoRodada2').style.display = 'none';
    }
    
    /**
     * Abre modal para editar rodada individual
     */
    function editarRodadaNegociacao(rodadaId, precoOriginal, precoNegociado, prazo, observacao, desconto) {
        document.getElementById('editRodadaId').value = rodadaId;
        document.getElementById('editPrecoOriginal').value = precoOriginal;
        document.getElementById('editPrecoOriginalDisplay').value = 'R$ ' + precoOriginal.toFixed(2).replace('.', ',');
        document.getElementById('editPrecoNegociado').value = precoNegociado.toFixed(2).replace('.', ',');
        document.getElementById('editPrazoNegociado').value = prazo;
        document.getElementById('editObservacaoNegociacao').value = observacao || '';
        document.getElementById('editDescontoNegociado').value = desconto || 0;
        
        new bootstrap.Modal(document.getElementById('modalEditarRodadaNegociacao')).show();
    }
    
    /**
     * Recalcula preço com desconto no modal de edição
     */
    function recalcularPrecoComDesconto() {
        const precoOriginal = parseFloat(document.getElementById('editPrecoOriginal').value) || 0;
        const desconto = parseFloat(document.getElementById('editDescontoNegociado').value) || 0;
        
        if (precoOriginal > 0 && desconto >= 0) {
            const precoComDesconto = precoOriginal * (1 - desconto / 100);
            document.getElementById('editPrecoNegociado').value = precoComDesconto.toFixed(2).replace('.', ',');
        }
    }
    
    /**
     * Salva edição de rodada individual
     */
    function salvarEdicaoRodada() {
        const rodadaId = document.getElementById('editRodadaId').value;
        const precoStr = document.getElementById('editPrecoNegociado').value;
        const prazo = parseInt(document.getElementById('editPrazoNegociado').value) || 0;
        const observacao = document.getElementById('editObservacaoNegociacao').value;
        const desconto = parseFloat(document.getElementById('editDescontoNegociado').value) || 0;
        
        // CORREÇÃO: Usar função de conversão inteligente
        const preco = converterParaDecimal(precoStr);
        
        // Validar limite de valor (proteger contra multiplicação)
        const precoOriginal = parseFloat(document.getElementById('editPrecoOriginal').value) || 0;
        if (precoOriginal > 0 && preco > precoOriginal * 50) {
            mostrarToast('Preço parece estar incorreto (muito maior que o original). Verifique!', 'warning');
            return;
        }
        
        if (isNaN(preco) || preco <= 0) {
            mostrarToast('Preço inválido', 'danger');
            return;
        }
        
        fetch(`/api/cotacao/rodada/${rodadaId}/editar`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                preco_negociado: preco,
                prazo_negociado: prazo,
                observacao: observacao,
                desconto_percentual: desconto
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                mostrarToast(data.message, 'success');
                setTimeout(() => location.reload(), 1000);
            } else {
                mostrarToast(data.error || 'Erro ao editar', 'danger');
            }
        })
        .catch(error => {
            console.error('Erro:', error);
            mostrarToast('Erro ao editar rodada', 'danger');
        });
    }
    
    /**
     * Excluir uma rodada individual
     */
    function excluirRodadaNegociacao(rodadaId, cotacaoId) {
        if (!confirm('Tem certeza que deseja excluir este item da negociação?')) return;
        
        fetch(`/api/cotacao/rodada/${rodadaId}/excluir`, {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                mostrarToast(data.message, 'success');
                setTimeout(() => location.reload(), 1000);
            } else {
                mostrarToast(data.error || 'Erro ao excluir', 'danger');
            }
        })
        .catch(error => {
            console.error('Erro:', error);
            mostrarToast('Erro ao excluir rodada', 'danger');
        });
    }
    
    /**
     * Excluir todas as rodadas da cotação
     */
    function excluirTodasRodadas(cotacaoId) {
        if (!confirm('Tem certeza que deseja LIMPAR TODA a Rodada 2?\nEsta ação não pode ser desfeita.')) return;
        
        // Pega dados agrupados de fornecedores
        const rodadasAgrupadas = {{ cotacao.rodadas_agrupadas|tojson|safe if cotacao.rodadas_agrupadas else '{"fornecedores":[]}' }};
        
        if (!rodadasAgrupadas.fornecedores || rodadasAgrupadas.fornecedores.length === 0) {
            mostrarToast('Nenhuma rodada para excluir', 'warning');
            return;
        }
        
        // Exclui todos os fornecedores
        let promises = rodadasAgrupadas.fornecedores.map(forn => {
            return fetch(`/api/cotacao/${cotacaoId}/rodada-fornecedor/${forn.fornecedor_id}/excluir`, { method: 'POST' })
                .then(response => response.json());
        });
        
        Promise.all(promises)
            .then(results => {
                const todosOk = results.every(r => r.success);
                if (todosOk) {
                    mostrarToast('Rodada 2 limpa com sucesso', 'success');
                    setTimeout(() => location.reload(), 1000);
                } else {
                    mostrarToast('Erro ao limpar algumas rodadas', 'warning');
                }
            })
            .catch(error => {
                console.error('Erro:', error);
                mostrarToast('Erro ao limpar rodadas', 'danger');
            });
    }
    
    /**
     * Excluir fornecedor específico da rodada 2
     */
    function excluirFornecedorRodada2(cotacaoId, fornecedorId, nomeFornecedor) {
        if (!confirm(`Tem certeza que deseja excluir "${nomeFornecedor}" da Rodada 2?\n\nTodos os itens negociados com este fornecedor serão removidos.`)) return;
        
        fetch(`/api/cotacao/${cotacaoId}/rodada-fornecedor/${fornecedorId}/excluir`, { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    mostrarToast(`${nomeFornecedor} removido da Rodada 2`, 'success');
                    setTimeout(() => location.reload(), 1000);
                } else {
                    mostrarToast(data.error || 'Erro ao excluir fornecedor', 'danger');
                }
            })
            .catch(error => {
                console.error('Erro:', error);
                mostrarToast('Erro ao excluir fornecedor', 'danger');
            });
    }
    
    /**
     * Abrir modal para editar fornecedor na Rodada 2 (frete e desconto)
     */
    function abrirModalEditarFornecedorR2(fornecedorId, nomeFornecedor, freteAtual, descontoMedio) {
        document.getElementById('editR2FornecedorId').value = fornecedorId;
        document.getElementById('editR2FornecedorNome').value = nomeFornecedor;
        document.getElementById('editR2FreteNegociado').value = freteAtual ? freteAtual.toFixed(2).replace('.', ',') : '0,00';
        document.getElementById('editR2DescontoGlobal').value = descontoMedio ? descontoMedio.toFixed(1) : '0';
        
        new bootstrap.Modal(document.getElementById('modalEditarFornecedorR2')).show();
    }
    
    /**
     * Salvar edição do fornecedor na Rodada 2
     */
    function salvarEdicaoFornecedorR2() {
        const fornecedorId = document.getElementById('editR2FornecedorId').value;
        const freteStr = document.getElementById('editR2FreteNegociado').value;
        const descontoGlobal = parseFloat(document.getElementById('editR2DescontoGlobal').value) || 0;
        
        // Converter frete BR para decimal
        const frete = parseFloat(freteStr.replace(/\./g, '').replace(',', '.')) || 0;
        
        // Atualizar frete
        fetch(`/api/cotacao/${COTACAO_ID}/rodada-fornecedor/${fornecedorId}/frete`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ frete_negociado: frete })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Se houver desconto global, aplicar a todos os itens
                if (descontoGlobal > 0) {
                    return aplicarDescontoGlobalFornecedor(fornecedorId, descontoGlobal);
                }
                return { success: true };
            } else {
                throw new Error(data.error || 'Erro ao atualizar frete');
            }
        })
        .then(result => {
            mostrarToast('Fornecedor atualizado com sucesso', 'success');
            bootstrap.Modal.getInstance(document.getElementById('modalEditarFornecedorR2')).hide();
            setTimeout(() => location.reload(), 1000);
        })
        .catch(error => {
            console.error('Erro:', error);
            mostrarToast(error.message || 'Erro ao salvar alterações', 'danger');
        });
    }
    
    /**
     * Aplicar desconto global a todos os itens de um fornecedor
     */
    async function aplicarDescontoGlobalFornecedor(fornecedorId, desconto) {
        // Buscar rodadas do fornecedor e aplicar desconto a cada uma
        const rodadasAgrupadas = {{ cotacao.rodadas_agrupadas|tojson|safe if cotacao.rodadas_agrupadas else '{"fornecedores":[]}' }};
        const fornecedor = rodadasAgrupadas.fornecedores.find(f => f.fornecedor_id == fornecedorId);
        
        if (!fornecedor || !fornecedor.itens) return { success: true };
        
        // Atualizar cada item com o desconto
        for (const item of fornecedor.itens) {
            const precoOriginal = item.preco_unitario_original || 0;
            const precoComDesconto = precoOriginal * (1 - desconto / 100);
            
            await fetch(`/api/cotacao/rodada/${item.id}/editar`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    preco_negociado: precoComDesconto,
                    desconto_percentual: desconto
                })
            });
        }
        
        return { success: true };
    }

    // ============================================================================
    // FUNÇÕES PARA MODAL DE EDIÇÃO COMPLETO (COM ITENS) - RODADA 2
    // ============================================================================
    
    // Variável global para armazenar dados do fornecedor sendo editado
    let dadosFornecedorEditandoR2 = null;
    
    /**
     * Abrir modal completo para editar fornecedor na Rodada 2 (com todos os itens)
     */
    function abrirModalEditarFornecedorR2Completo(fornecedorId, nomeFornecedor, freteAtual) {
        const rodadasAgrupadas = {{ cotacao.rodadas_agrupadas|tojson|safe if cotacao.rodadas_agrupadas else '{"fornecedores":[]}' }};
        const fornecedor = rodadasAgrupadas.fornecedores.find(f => f.fornecedor_id == fornecedorId);
        
        if (!fornecedor) {
            mostrarToast('Fornecedor não encontrado', 'danger');
            return;
        }
        
        // Guardar dados para uso posterior
        dadosFornecedorEditandoR2 = fornecedor;
        
        // Preencher cabeçalho
        document.getElementById('editR2CompletoFornecedorId').value = fornecedorId;
        document.getElementById('editR2CompletoFornecedorNome').value = nomeFornecedor;
        document.getElementById('editR2CompletoFreteNegociado').value = freteAtual ? freteAtual.toFixed(2).replace('.', ',') : '0,00';
        document.getElementById('editR2CompletoDescontoGlobal').value = '';
        
        // Preencher tabela de itens
        const tbody = document.getElementById('tbodyItensEditR2');
        tbody.innerHTML = '';
        
        if (fornecedor.itens && fornecedor.itens.length > 0) {
            fornecedor.itens.forEach((item, index) => {
                // IMPORTANTE: Usar os nomes de campos corretos do backend
                // preco_unitario_original = preço da R1 (primeira rodada)
                // preco_unitario_negociado = preço da R2 (segunda rodada negociada)
                const precoOriginal = item.preco_unitario_original || 0;
                const precoNegociado = item.preco_unitario_negociado || precoOriginal;
                const desconto = item.desconto_percentual || 0;
                const quantidade = item.quantidade || 1;
                const totalItem = precoNegociado * quantidade;
                
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>
                        <strong>${item.nome_item || item.descricao_produto || item.cod_produto || 'Item ' + (index + 1)}</strong>
                        ${item.descricao_produto ? '<br><small class="text-muted">' + item.descricao_produto + '</small>' : ''}
                        <input type="hidden" class="item-id" value="${item.id}">
                        <input type="hidden" class="item-quantidade" value="${quantidade}">
                        <input type="hidden" class="item-preco-original" value="${precoOriginal}">
                    </td>
                    <td class="text-center">${quantidade}</td>
                    <td class="text-end text-muted">${formatarMoedaBR(precoOriginal)}</td>
                    <td>
                        <input type="text" class="form-control form-control-sm text-end item-preco-negociado" 
                               value="${precoNegociado.toFixed(2).replace('.', ',')}"
                               oninput="formatarMoedaModal(this); recalcularTotaisModalCompleto();">
                    </td>
                    <td>
                        <input type="number" class="form-control form-control-sm text-center item-desconto" 
                               value="${desconto.toFixed(1)}" min="0" max="100" step="0.5"
                               onchange="aplicarDescontoItem(this); recalcularTotaisModalCompleto();">
                    </td>
                    <td class="text-end fw-bold item-total">${formatarMoedaBR(totalItem)}</td>
                `;
                tbody.appendChild(tr);
            });
        }
        
        // Calcular e mostrar totais
        recalcularTotaisModalCompleto();
        
        // Mostrar alerta de economia
        document.getElementById('alertEconomiaEditR2').style.display = 'block';
        
        // Abrir modal
        new bootstrap.Modal(document.getElementById('modalEditarFornecedorR2Completo')).show();
    }
    
    /**
     * Aplicar desconto a um item específico (recalcula preço)
     */
    function aplicarDescontoItem(input) {
        const tr = input.closest('tr');
        const precoOriginal = parseFloat(tr.querySelector('.item-preco-original').value) || 0;
        const desconto = parseFloat(input.value) || 0;
        const precoComDesconto = precoOriginal * (1 - desconto / 100);
        
        const inputPreco = tr.querySelector('.item-preco-negociado');
        inputPreco.value = precoComDesconto.toFixed(2).replace('.', ',');
    }
    
    /**
     * Aplicar desconto global a todos os itens no modal
     */
    function aplicarDescontoGlobalCompleto() {
        const desconto = parseFloat(document.getElementById('editR2CompletoDescontoGlobal').value) || 0;
        if (desconto <= 0) {
            mostrarToast('Informe um percentual de desconto válido', 'warning');
            return;
        }
        
        const linhas = document.querySelectorAll('#tbodyItensEditR2 tr');
        linhas.forEach(tr => {
            const inputDesconto = tr.querySelector('.item-desconto');
            inputDesconto.value = desconto.toFixed(1);
            aplicarDescontoItem(inputDesconto);
        });
        
        recalcularTotaisModalCompleto();
        mostrarToast(`Desconto de ${desconto}% aplicado a todos os itens`, 'success');
    }
    
    /**
     * Recalcular totais do modal completo
     */
    function recalcularTotaisModalCompleto() {
        let subtotalItens = 0;
        let totalOriginal = 0;
        
        const linhas = document.querySelectorAll('#tbodyItensEditR2 tr');
        linhas.forEach(tr => {
            const quantidade = parseFloat(tr.querySelector('.item-quantidade').value) || 1;
            const precoOriginal = parseFloat(tr.querySelector('.item-preco-original').value) || 0;
            const precoNegociadoStr = tr.querySelector('.item-preco-negociado').value;
            const precoNegociado = parseFloat(precoNegociadoStr.replace(/\./g, '').replace(',', '.')) || 0;
            
            const totalItem = precoNegociado * quantidade;
            tr.querySelector('.item-total').textContent = formatarMoedaBR(totalItem);
            
            subtotalItens += totalItem;
            totalOriginal += precoOriginal * quantidade;
        });
        
        // Frete
        const freteStr = document.getElementById('editR2CompletoFreteNegociado').value;
        const frete = parseFloat(freteStr.replace(/\./g, '').replace(',', '.')) || 0;
        
        // Frete original (da R1)
        const freteOriginal = dadosFornecedorEditandoR2 ? (dadosFornecedorEditandoR2.frete_original || 0) : 0;
        totalOriginal += freteOriginal;
        
        // Total Geral
        const totalGeral = subtotalItens + frete;
        
        // Economia
        const economia = totalOriginal - totalGeral;
        const economiaPercent = totalOriginal > 0 ? (economia / totalOriginal * 100) : 0;
        
        // Atualizar campos
        document.getElementById('editR2SubtotalItens').textContent = formatarMoedaBR(subtotalItens);
        document.getElementById('editR2ValorFrete').textContent = formatarMoedaBR(frete);
        document.getElementById('editR2TotalGeral').textContent = formatarMoedaBR(totalGeral);
        
        document.getElementById('editR2TotalR1').textContent = formatarMoedaBR(totalOriginal);
        document.getElementById('editR2Economia').textContent = economia > 0 ? '-' + formatarMoedaBR(economia) : formatarMoedaBR(0);
        document.getElementById('editR2EconomiaPercent').textContent = economiaPercent.toFixed(1) + '%';
    }
    
    /**
     * Salvar todas as edições do modal completo
     */
    async function salvarEdicaoFornecedorR2Completo() {
        const fornecedorId = document.getElementById('editR2CompletoFornecedorId').value;
        const freteStr = document.getElementById('editR2CompletoFreteNegociado').value;
        const frete = parseFloat(freteStr.replace(/\./g, '').replace(',', '.')) || 0;
        
        try {
            // Primeiro, salvar o frete
            const freteResponse = await fetch(`/api/cotacao/${COTACAO_ID}/rodada-fornecedor/${fornecedorId}/frete`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ frete_negociado: frete })
            });
            
            if (!freteResponse.ok) throw new Error('Erro ao salvar frete');
            
            // Depois, salvar cada item
            const linhas = document.querySelectorAll('#tbodyItensEditR2 tr');
            for (const tr of linhas) {
                const itemId = tr.querySelector('.item-id').value;
                const precoNegociadoStr = tr.querySelector('.item-preco-negociado').value;
                const precoNegociado = parseFloat(precoNegociadoStr.replace(/\./g, '').replace(',', '.')) || 0;
                const desconto = parseFloat(tr.querySelector('.item-desconto').value) || 0;
                
                const itemResponse = await fetch(`/api/cotacao/rodada/${itemId}/editar`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        preco_negociado: precoNegociado,
                        desconto_percentual: desconto
                    })
                });
                
                if (!itemResponse.ok) {
                    console.warn(`Erro ao salvar item ${itemId}`);
                }
            }
            
            mostrarToast('Todas as alterações foram salvas!', 'success');
            bootstrap.Modal.getInstance(document.getElementById('modalEditarFornecedorR2Completo')).hide();
            setTimeout(() => location.reload(), 1000);
            
        } catch (error) {
            console.error('Erro:', error);
            mostrarToast(error.message || 'Erro ao salvar alterações', 'danger');
        }
    }
    
    /**
     * Formatar valor para moeda BR
     */
    function formatarMoedaBR(valor) {
        return 'R$ ' + valor.toFixed(2).replace('.', ',').replace(/\B(?=(\d{3})+(?!\d))/g, '.');
    }

    // ============================================================================
    // FUNÇÕES PARA BOTÃO "GERAR LINK" SIMPLIFICADO
    // ============================================================================
    
    // Abre modal simplificado de gerar link
    async function abrirModalGerarLinkExterno(btn) {
        const fornecedorId = btn.dataset.fornecedorId;
        const fornecedorNome = btn.dataset.fornecedorNome;
        
        console.log('[GERAR LINK] Abrindo modal para:', fornecedorNome, 'ID:', fornecedorId);
        
        if (!fornecedorId) {
            console.error('[GERAR LINK] ERRO: fornecedorId está vazio!');
            mostrarToast('Erro: ID do fornecedor não encontrado', 'danger');
            return;
        }
        
        // Preenche dados do modal
        document.getElementById('linkExternoFornecedorId').value = fornecedorId;
        document.getElementById('linkExternoFornecedorNome').textContent = fornecedorNome;
        
        // Reseta estados para "carregando"
        document.getElementById('estadoAguardandoGerar').style.display = 'none';
        document.getElementById('estadoGerandoLink').style.display = 'block';
        document.getElementById('estadoLinkGerado').style.display = 'none';
        document.getElementById('estadoErroLink').style.display = 'none';
        
        // Abre modal
        new bootstrap.Modal(document.getElementById('modalGerarJson')).show();
        
        // Esconde botão sincronizar por padrão
        const btnSincContainer = document.getElementById('btnSincronizarContainer');
        if (btnSincContainer) btnSincContainer.style.display = 'none';
        
        // Verifica se já existe link para este fornecedor
        try {
            const response = await fetch(`/api/cotacao/fornecedor/${fornecedorId}/link-externo`);
            const data = await response.json();
            
            console.log('[MODAL LINK] Dados recebidos:', data);
            
            if (data.success && data.tem_link) {
                // Já existe link - mostra direto
                console.log('[GERAR LINK] Link já existe:', data.link_externo);
                console.log('[GERAR LINK] Status Render:', data.status_render);
                console.log('[GERAR LINK] Precisa sincronizar:', data.precisa_sincronizar);
                
                document.getElementById('linkExternoGerado').value = data.link_externo;
                document.getElementById('linkNoTextoSimplificado').textContent = data.link_externo;
                
                document.getElementById('estadoGerandoLink').style.display = 'none';
                document.getElementById('estadoLinkGerado').style.display = 'block';
                
                // Configura mensagem e estilo baseado no status
                const alertDiv = document.querySelector('#estadoLinkGerado .alert-success, #estadoLinkGerado .alert-info, #estadoLinkGerado .alert-warning, #estadoLinkGerado .alert-danger');
                if (alertDiv) {
                    if (data.precisa_sincronizar || data.status_render === 'respondido') {
                        alertDiv.className = 'alert alert-warning mb-4';
                        alertDiv.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i><strong>Cotação já foi respondida!</strong> Clique em "Sincronizar" para importar a resposta.';
                        
                        // Mostra botão de sincronizar
                        if (btnSincContainer) btnSincContainer.style.display = 'block';
                    } else if (data.status_render === 'aguardando') {
                        alertDiv.className = 'alert alert-info mb-4';
                        alertDiv.innerHTML = '<i class="fas fa-clock me-2"></i><strong>Aguardando resposta!</strong> O fornecedor ainda não respondeu a cotação.';
                    } else if (data.status_render === 'nao_existe') {
                        // Token perdido no Render - oferece gerar novo
                        alertDiv.className = 'alert alert-danger mb-4';
                        alertDiv.innerHTML = `
                            <i class="fas fa-exclamation-circle me-2"></i>
                            <strong>Link inválido!</strong> O servidor externo foi reiniciado e o link expirou.
                            <br><small class="text-muted">Este problema ocorre quando o Render hiberna. Gere um novo link abaixo.</small>
                            <div class="mt-3">
                                <button class="btn btn-primary" onclick="gerarLinkExternoSimplificado(true)">
                                    <i class="fas fa-redo me-2"></i> Gerar Novo Link
                                </button>
                            </div>
                        `;
                    } else if (data.status_render === 'expirado') {
                        alertDiv.className = 'alert alert-secondary mb-4';
                        alertDiv.innerHTML = `
                            <i class="fas fa-times-circle me-2"></i><strong>Link expirado!</strong> O prazo para responder a cotação expirou.
                            <div class="mt-3">
                                <button class="btn btn-primary" onclick="gerarLinkExternoSimplificado(true)">
                                    <i class="fas fa-redo me-2"></i> Gerar Novo Link
                                </button>
                            </div>
                        `;
                    } else if (data.status_render === 'erro_conexao') {
                        alertDiv.className = 'alert alert-warning mb-4';
                        alertDiv.innerHTML = `
                            <i class="fas fa-wifi me-2"></i><strong>Erro de conexão!</strong> Não foi possível verificar o status no servidor externo.
                            <br><small class="text-muted">O servidor pode estar hibernando. Tente novamente em alguns segundos.</small>
                        `;
                    } else {
                        alertDiv.className = 'alert alert-success mb-4';
                        alertDiv.innerHTML = '<i class="fas fa-info-circle me-2"></i><strong>Link existente recuperado!</strong>';
                    }
                }
                
                // Atualiza status na tabela
                if (data.status_render) {
                    atualizarStatusFornecedorNaTabela(fornecedorId, data.status_render);
                }
                
            } else {
                // Não existe link - mostra tela para gerar
                document.getElementById('estadoGerandoLink').style.display = 'none';
                document.getElementById('estadoAguardandoGerar').style.display = 'block';
            }
            
        } catch (error) {
            console.error('[GERAR LINK] Erro ao verificar link:', error);
            // Em caso de erro, mostra tela para gerar
            document.getElementById('estadoGerandoLink').style.display = 'none';
            document.getElementById('estadoAguardandoGerar').style.display = 'block';
        }
    }
    
    // Reseta o modal para estado inicial
    function resetarModalLink() {
        document.getElementById('estadoAguardandoGerar').style.display = 'block';
        document.getElementById('estadoGerandoLink').style.display = 'none';
        document.getElementById('estadoLinkGerado').style.display = 'none';
        document.getElementById('estadoErroLink').style.display = 'none';
        
        const btn = document.getElementById('btnGerarLinkExterno');
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-magic me-2"></i> Gerar Link Externo';
        
        // Reseta mensagem de sucesso para padrão
        const alertDiv = document.querySelector('#estadoLinkGerado .alert-success');
        if (alertDiv) {
            alertDiv.innerHTML = '<i class="fas fa-check-circle me-2"></i><strong>Link gerado com sucesso!</strong>';
        }
    }
    
    // Gera link externo (versão simplificada)
    async function gerarLinkExternoSimplificado(forcarNovo = false) {
        const fornecedorId = document.getElementById('linkExternoFornecedorId').value;
        
        if (!fornecedorId) {
            mostrarToast('Erro: ID do fornecedor não encontrado', 'danger');
            return;
        }
        
        console.log('[GERAR LINK] Gerando link para fornecedor ID:', fornecedorId, 'Forçar novo:', forcarNovo);
        
        // Muda para estado "gerando"
        document.getElementById('estadoAguardandoGerar').style.display = 'none';
        document.getElementById('estadoGerandoLink').style.display = 'block';
        document.getElementById('estadoLinkGerado').style.display = 'none';
        document.getElementById('estadoErroLink').style.display = 'none';
        
        try {
            const response = await fetch(`/api/cotacao/fornecedor/${fornecedorId}/gerar-link-externo`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ forcar_novo: forcarNovo })
            });
            
            const data = await response.json();
            
            if (data.success) {
                console.log('[GERAR LINK] Sucesso! Status:', data.status_render);
                
                // Preenche o link gerado
                document.getElementById('linkExternoGerado').value = data.link_externo;
                document.getElementById('linkNoTextoSimplificado').textContent = data.link_externo;
                
                // Muda para estado "link gerado"
                document.getElementById('estadoGerandoLink').style.display = 'none';
                document.getElementById('estadoLinkGerado').style.display = 'block';
                
                // Atualiza mensagem baseado no status
                const alertDiv = document.querySelector('#estadoLinkGerado .alert-success');
                if (alertDiv) {
                    if (data.precisa_sincronizar) {
                        alertDiv.className = 'alert alert-warning mb-4';
                        alertDiv.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i><strong>Cotação já foi respondida!</strong> Clique em "Sincronizar" para importar.';
                    } else if (data.ja_existia && data.status_render === 'aguardando') {
                        alertDiv.className = 'alert alert-info mb-4';
                        alertDiv.innerHTML = '<i class="fas fa-clock me-2"></i><strong>Link ativo!</strong> Aguardando resposta do fornecedor.';
                    } else {
                        alertDiv.className = 'alert alert-success mb-4';
                        alertDiv.innerHTML = '<i class="fas fa-check-circle me-2"></i><strong>Link gerado com sucesso!</strong>';
                    }
                }
                
                // Mostra/esconde botão de sincronizar
                const btnSincronizar = document.getElementById('btnSincronizarResposta');
                if (btnSincronizar) {
                    btnSincronizar.style.display = data.precisa_sincronizar ? 'inline-block' : 'none';
                }
                
                const mensagem = data.precisa_sincronizar 
                    ? 'Cotação respondida! Clique em Sincronizar.' 
                    : (data.ja_existia ? 'Link recuperado!' : 'Link gerado com sucesso!');
                mostrarToast(mensagem, data.precisa_sincronizar ? 'warning' : 'success');
                
                // Atualiza a linha do fornecedor na tabela
                atualizarStatusFornecedorNaTabela(fornecedorId, data.status_render);
                
            } else {
                throw new Error(data.error || 'Erro ao gerar link');
            }
            
        } catch (error) {
            console.error('[GERAR LINK] Erro:', error);
            
            // Muda para estado "erro"
            document.getElementById('estadoGerandoLink').style.display = 'none';
            document.getElementById('estadoErroLink').style.display = 'block';
            document.getElementById('mensagemErroLink').textContent = error.message;
            
            mostrarToast('Erro ao gerar link: ' + error.message, 'danger');
        }
    }
    
    // Atualiza o status do fornecedor na tabela
    function atualizarStatusFornecedorNaTabela(fornecedorId, statusRender) {
        const row = document.getElementById(`row-forn-${fornecedorId}`);
        if (!row) return;
        
        const statusCell = row.querySelector('td:nth-child(3)');
        if (!statusCell) return;
        
        let badge = '';
        switch(statusRender) {
            case 'respondido':
                badge = '<span class="badge bg-warning text-dark"><i class="fas fa-sync me-1"></i>Sincronizar</span>';
                break;
            case 'aguardando':
                badge = '<span class="badge bg-info"><i class="fas fa-clock me-1"></i>Aguardando</span>';
                break;
            case 'expirado':
            case 'nao_existe':
                badge = '<span class="badge bg-secondary"><i class="fas fa-redo me-1"></i>Gerar Novo</span>';
                break;
            default:
                badge = '<span class="badge bg-info"><i class="fas fa-link me-1"></i>Link Gerado</span>';
        }
        statusCell.innerHTML = badge;
    }
    
    // Força geração de novo link (quando expirado/inválido)
    function forcarNovoLink() {
        gerarLinkExternoSimplificado(true);
    }
    
    // Copia o link externo
    function copiarLinkExternoSimplificado() {
        const link = document.getElementById('linkExternoGerado');
        link.select();
        link.setSelectionRange(0, 99999);
        navigator.clipboard.writeText(link.value);
        
        // Feedback visual
        const btn = link.nextElementSibling;
        const iconOriginal = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-check me-1"></i> Copiado!';
        btn.classList.remove('btn-primary');
        btn.classList.add('btn-success');
        
        setTimeout(() => {
            btn.innerHTML = iconOriginal;
            btn.classList.remove('btn-success');
            btn.classList.add('btn-primary');
        }, 2000);
        
        mostrarToast('Link copiado para a área de transferência!', 'success');
    }
    
    // Copia texto completo com link
    function copiarTextoCompleto() {
        const fornecedorNome = document.getElementById('linkExternoFornecedorNome').textContent;
        const link = document.getElementById('linkExternoGerado').value;
        
        const texto = `Prezado ${fornecedorNome},

Solicitamos cotação de preços. Por favor, acesse o link abaixo e preencha os valores:

${link}

INSTRUÇÕES:
• Clique no link acima (funciona em celular ou computador)
• Preencha os preços e prazos de cada item
• Clique em "Enviar Cotação"

Atenciosamente,
Setor de Compras`;

        navigator.clipboard.writeText(texto).then(() => {
            mostrarToast('Texto copiado para a área de transferência!', 'success');
        }).catch(err => {
            console.error('[COPIAR] Erro:', err);
            mostrarToast('Erro ao copiar texto', 'danger');
        });
    }
    
    // Evento de click nos botões de gerar link
    document.addEventListener('DOMContentLoaded', function() {
        // Novo botão simplificado
        document.querySelectorAll('.btn-gerar-link-externo').forEach(btn => {
            btn.addEventListener('click', function() {
                abrirModalGerarLinkExterno(this);
            });
        });
        
        // Botão de importar resposta do Render
        document.querySelectorAll('.btn-importar-render').forEach(btn => {
            btn.addEventListener('click', function() {
                sincronizarRespostaFornecedor(this);
            });
        });
        
        // Mantém compatibilidade com botão antigo (se existir)
        document.querySelectorAll('.btn-gerar-json').forEach(btn => {
            btn.addEventListener('click', function() {
                abrirModalGerarJson(this);
            });
        });
    });
    
    // Sincroniza resposta de um fornecedor específico
    async function sincronizarRespostaFornecedor(btn) {
        const fornecedorId = btn.dataset.fornecedorId;
        const fornecedorNome = btn.dataset.fornecedorNome || 'Fornecedor';
        
        if (!fornecedorId) {
            mostrarToast('Erro: ID do fornecedor não encontrado', 'danger');
            return;
        }
        
        console.log('[SINCRONIZAR] Iniciando para fornecedor:', fornecedorId);
        
        // Mostra loading
        const originalHtml = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        
        try {
            const response = await fetch(`/api/cotacao/fornecedor/${fornecedorId}/importar-resposta-render`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });
            
            const data = await response.json();
            
            if (data.success) {
                mostrarToast(`✅ ${data.message || 'Resposta sincronizada!'}`, 'success');
                // Recarrega após 1.5 segundos
                setTimeout(() => location.reload(), 1500);
            } else {
                // Trata diferentes erros
                if (data.status_render === 'nao_existe' || data.pode_gerar_novo) {
                    mostrarToast(`⚠️ ${data.error}`, 'warning');
                } else if (data.status_render === 'aguardando') {
                    mostrarToast(`⏳ Aguardando resposta do fornecedor`, 'info');
                } else {
                    mostrarToast(`❌ ${data.error || 'Erro ao sincronizar'}`, 'danger');
                }
            }
            
        } catch (error) {
            console.error('[SINCRONIZAR] Erro:', error);
            mostrarToast('❌ Erro de conexão: ' + error.message, 'danger');
        } finally {
            btn.disabled = false;
            btn.innerHTML = originalHtml;
        }
    }
    
    // Sincronizar resposta a partir do modal
    async function sincronizarRespostaDoModal() {
        const fornecedorId = document.getElementById('linkExternoFornecedorId').value;
        
        if (!fornecedorId) {
            mostrarToast('Erro: ID do fornecedor não encontrado', 'danger');
            return;
        }
        
        const btn = document.getElementById('btnSincronizarResposta');
        const originalHtml = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i> Sincronizando...';
        
        try {
            const response = await fetch(`/api/cotacao/fornecedor/${fornecedorId}/importar-resposta-render`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });
            
            const data = await response.json();
            
            if (data.success) {
                mostrarToast(`✅ ${data.message}`, 'success');
                setTimeout(() => location.reload(), 1500);
            } else {
                // Tratamento especial para erros do Render
                if (data.status_render === 'nao_existe' || data.pode_gerar_novo) {
                    // Token expirou ou não existe - oferece gerar novo
                    const alertDiv = document.querySelector('#estadoLinkGerado .alert-success, #estadoLinkGerado .alert-info, #estadoLinkGerado .alert-warning');
                    if (alertDiv) {
                        alertDiv.className = 'alert alert-danger mb-4';
                        alertDiv.innerHTML = `
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <strong>Link Expirado!</strong> ${data.error}
                            <br><br>
                            <button class="btn btn-primary" onclick="gerarLinkExternoSimplificado(true)">
                                <i class="fas fa-redo me-2"></i> Gerar Novo Link
                            </button>
                        `;
                    }
                    // Esconde botão de sincronizar
                    const btnSincContainer = document.getElementById('btnSincronizarContainer');
                    if (btnSincContainer) btnSincContainer.style.display = 'none';
                    
                    mostrarToast(`⚠️ ${data.error}`, 'warning');
                } else if (data.status_render === 'aguardando') {
                    mostrarToast(`ℹ️ ${data.error}`, 'info');
                } else {
                    mostrarToast(`❌ ${data.error}`, 'danger');
                }
            }
            
        } catch (error) {
            mostrarToast('❌ Erro de conexão: ' + error.message, 'danger');
        } finally {
            btn.disabled = false;
            btn.innerHTML = originalHtml;
        }
    }

    // ============================================================================
    // POLLING - SINCRONIZAÇÃO AUTOMÁTICA DE COTAÇÕES EXTERNAS
    // ============================================================================
    // Este sistema verifica a cada 30 segundos se há novas respostas de 
    // fornecedores em cotações externas e atualiza automaticamente a página.
    
    /**
     * ID da cotação atual (para filtrar apenas respostas relevantes)
     */
    const COTACAO_ID_ATUAL = {{ cotacao.id }};
    
    /**
     * Intervalo de polling em milissegundos (30 segundos)
     */
    const POLLING_INTERVAL = 30000;
    
    /**
     * Flag para evitar múltiplas requisições simultâneas
     */
    let pollingEmAndamento = false;
    
    /**
     * Mostra toast de notificação especial para respostas de cotações
     */
    function mostrarToastResposta(fornecedorNome, codigoCotacao) {
        // Cria um toast especial com ícone e animação
        const toastHtml = `
            <div class="toast-resposta-cotacao" id="toastRespostaCotacao">
                <div class="toast-resposta-icon">
                    <i class="fas fa-check-circle"></i>
                </div>
                <div class="toast-resposta-content">
                    <div class="toast-resposta-title">Nova Resposta Recebida!</div>
                    <div class="toast-resposta-message">
                        <strong>${fornecedorNome}</strong> respondeu a cotação
                    </div>
                </div>
                <button class="toast-resposta-close" onclick="fecharToastResposta()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `;
        
        // Remove toast anterior se existir
        const toastExistente = document.getElementById('toastRespostaCotacao');
        if (toastExistente) {
            toastExistente.remove();
        }
        
        // Adiciona o toast ao body
        document.body.insertAdjacentHTML('beforeend', toastHtml);
        
        // Adiciona animação de entrada
        setTimeout(() => {
            const toast = document.getElementById('toastRespostaCotacao');
            if (toast) toast.classList.add('show');
        }, 100);
        
        // Remove automaticamente após 8 segundos
        setTimeout(() => {
            fecharToastResposta();
        }, 8000);
        
        // Toca som de notificação (opcional)
        try {
            const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2teleSkdfpO83NlsQBgqgsXa3oFYLRtcmcbTi14yFlWKvNHJgVowGEyCuM7EdGQ5IVyNvczDhWY3IViFuM/Edmo6IVqJuczDhWo4IFeFuNDDdWw8IVqJuc3EhWs4IFiFt9DDdWw8IVqIuM3FhWs4H1eFt9DDdWw8IVqIuM3FhWs4IFiFt9DEdWw8IVqIuM3FhWs4IFiFt9DDdWw8IVqIuM3FhWs4IFiFt9DEdWw8IVqIuM3Fh2s4IFiFt9DEd2w8IVqIuM3EhWs4IFmGt9DEd2w8IVqIuM3EhWs4IFmGt9DEd2w8IVqIuM3EhWs4');
            audio.volume = 0.3;
            audio.play().catch(() => {}); // Ignora erro se autoplay bloqueado
        } catch (e) {}
    }
    
    /**
     * Fecha o toast de resposta
     */
    function fecharToastResposta() {
        const toast = document.getElementById('toastRespostaCotacao');
        if (toast) {
            toast.classList.remove('show');
            setTimeout(() => toast.remove(), 300);
        }
    }
    
    /**
     * Atualiza a linha do fornecedor na tabela após sincronização
     */
    function atualizarLinhaFornecedor(fornecedorId) {
        const row = document.getElementById(`row-forn-${fornecedorId}`);
        if (!row) return;
        
        // Atualiza badge de status para "Respondido"
        const statusCell = row.querySelector('td:nth-child(3)');
        if (statusCell) {
            statusCell.innerHTML = '<span class="badge bg-success"><i class="fas fa-check me-1"></i>Respondido</span>';
        }
        
        // Adiciona efeito de highlight na linha
        row.classList.add('row-updated');
        setTimeout(() => row.classList.remove('row-updated'), 3000);
    }
    
    /**
     * Função principal de polling
     * Verifica cotações externas respondidas e sincroniza automaticamente
     */
    async function verificarRespostasExternas() {
        // Evita múltiplas requisições simultâneas
        if (pollingEmAndamento) return;
        pollingEmAndamento = true;
        
        try {
            // Busca cotações respondidas não sincronizadas
            const response = await fetch('/api/cotacoes-externas/polling');
            
            if (!response.ok) {
                console.warn('[POLLING] Erro ao buscar respostas:', response.status);
                return;
            }
            
            const data = await response.json();
            
            if (!data.success || !data.respostas || data.respostas.length === 0) {
                return; // Nada para sincronizar
            }
            
            console.log(`[POLLING] ${data.respostas.length} resposta(s) pendente(s) de sincronização`);
            
            // Filtra apenas respostas desta cotação
            const respostasDaCotacao = data.respostas.filter(r => r.cotacao_id === COTACAO_ID_ATUAL);
            
            if (respostasDaCotacao.length === 0) {
                return; // Nenhuma resposta para esta cotação
            }
            
            // Sincroniza cada resposta
            for (const resposta of respostasDaCotacao) {
                try {
                    const syncResponse = await fetch('/api/cotacoes-externas/sincronizar-render', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(resposta)
                    });
                    
                    const syncData = await syncResponse.json();
                    
                    if (syncData.success) {
                        console.log(`[POLLING] Resposta sincronizada: ${resposta.fornecedor_nome}`);
                        
                        // Mostra notificação toast
                        mostrarToastResposta(
                            resposta.fornecedor_nome || 'Fornecedor',
                            '{{ cotacao.codigo }}'
                        );
                        
                        // Atualiza a linha do fornecedor na tabela
                        atualizarLinhaFornecedor(resposta.fornecedor_id);
                        
                        // Agenda reload da página após 3 segundos para mostrar dados atualizados
                        setTimeout(() => {
                            location.reload();
                        }, 3000);
                    }
                } catch (syncError) {
                    console.error('[POLLING] Erro ao sincronizar:', syncError);
                }
            }
            
        } catch (error) {
            console.error('[POLLING] Erro no polling:', error);
        } finally {
            pollingEmAndamento = false;
        }
    }
    
    /**
     * Inicia o sistema de polling
     */
    function iniciarPolling() {
        console.log('[POLLING] Sistema de sincronização automática iniciado');
        console.log(`[POLLING] Verificando a cada ${POLLING_INTERVAL/1000} segundos`);
        console.log(`[POLLING] Monitorando cotação ID: ${COTACAO_ID_ATUAL}`);
        
        // Executa imediatamente na primeira vez
        verificarRespostasExternas();
        
        // Agenda verificações periódicas
        setInterval(verificarRespostasExternas, POLLING_INTERVAL);
    }
    
    // Inicia o polling quando a página carregar
    document.addEventListener('DOMContentLoaded', function() {
        // Pequeno delay para não sobrecarregar o carregamento inicial
        setTimeout(iniciarPolling, 2000);
    });

    </script>
    
    <!-- ESTILOS DO TOAST DE RESPOSTA -->
    <style>
        /* Toast de notificação de resposta de cotação */
        .toast-resposta-cotacao {
            position: fixed;
            top: 20px;
            right: 20px;
            min-width: 320px;
            background: linear-gradient(135deg, #28a745 0%, #218838 100%);
            color: white;
            padding: 16px 20px;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(40, 167, 69, 0.4);
            display: flex;
            align-items: center;
            gap: 14px;
            z-index: 10000;
            transform: translateX(400px);
            opacity: 0;
            transition: all 0.3s ease;
        }
        
        .toast-resposta-cotacao.show {
            transform: translateX(0);
            opacity: 1;
        }
        
        .toast-resposta-icon {
            font-size: 2rem;
            animation: pulseIcon 1s ease infinite;
        }
        
        @keyframes pulseIcon {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        .toast-resposta-content {
            flex: 1;
        }
        
        .toast-resposta-title {
            font-weight: 700;
            font-size: 1rem;
            margin-bottom: 4px;
        }
        
        .toast-resposta-message {
            font-size: 0.875rem;
            opacity: 0.95;
        }
        
        .toast-resposta-close {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }
        
        .toast-resposta-close:hover {
            background: rgba(255,255,255,0.3);
        }
        
        /* Efeito de highlight na linha atualizada */
        .row-updated {
            animation: highlightRow 3s ease;
        }
        
        @keyframes highlightRow {
            0% { background-color: rgba(40, 167, 69, 0.3); }
            100% { background-color: transparent; }
        }
    </style>

<!-- POLLING GLOBAL - Sincronização automática de cotações externas -->
<script src="/static/js/polling_cotacoes.js"></script>
</body>
</html>