<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Avalia√ß√£o de Fornecedores - ISO (PQ021)</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-select@1.14.0-beta3/dist/css/bootstrap-select.min.css" rel="stylesheet">
    
    <style>
        :root {
            --bg-color: #f0f2f5;
            --card-bg: #ffffff;
            --sidebar-bg: #212529;
            --primary-blue: #0d6efd;
            --danger-red: #dc3545;
            --success-green: #198754;
            --warning-yellow: #ffc107;
            --text-primary: #1a1a2e;
            --text-secondary: #6c757d;
            --border-color: #e9ecef;
            --transition: all 0.25s ease;
        }

        * { box-sizing: border-box; }

        /* CAMPOS DE DATA - NORMALIZA√á√ÉO INTELIGENTE */
        .campo-data {
            font-family: 'Consolas', 'Monaco', monospace;
            letter-spacing: 0.5px;
        }
        .campo-data.is-valid {
            border-color: var(--success-green) !important;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 8 8'%3e%3cpath fill='%23198754' d='M2.3 6.73.6 4.53c-.4-1.04.46-1.4 1.1-.8l1.1 1.4 3.4-3.8c.6-.63 1.6-.27 1.2.7l-4 4.6c-.43.5-.8.4-1.1.1z'/%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right calc(0.375em + 0.1875rem) center;
            background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem);
            padding-right: calc(1.5em + 0.75rem);
        }
        .campo-data.is-invalid {
            border-color: var(--danger-red) !important;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 12 12' width='12' height='12' fill='none' stroke='%23dc3545'%3e%3ccircle cx='6' cy='6' r='4.5'/%3e%3cpath stroke-linejoin='round' d='M5.8 3.6h.4L6 6.5z'/%3e%3ccircle cx='6' cy='8.2' r='.6' fill='%23dc3545' stroke='none'/%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right calc(0.375em + 0.1875rem) center;
            background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem);
            padding-right: calc(1.5em + 0.75rem);
        }

        body {
            background-color: var(--bg-color);
            font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
            font-size: 0.875rem;
            overflow-x: hidden;
        }

        /* LAYOUT COM SIDEBAR */
        .wrapper { display: flex; width: 100%; align-items: stretch; }
        
        .sidebar {
            min-width: 250px;
            max-width: 250px;
            background: linear-gradient(180deg, #1a1d21 0%, #212529 100%);
            color: #fff;
            min-height: 100vh;
            transition: var(--transition);
            position: fixed;
            left: 0;
            top: 0;
            z-index: 999;
            box-shadow: 2px 0 8px rgba(0,0,0,0.15);
        }

        .sidebar.collapsed { margin-left: -250px; }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            background: rgba(0,0,0,0.2);
        }
        
        .sidebar .sidebar-header h4 { font-weight: 700; letter-spacing: -0.5px; }

        .sidebar ul.components { padding: 10px 0; }

        .sidebar ul li {
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }

        .sidebar ul li a {
            padding: 12px 20px;
            display: block;
            color: rgba(255,255,255,0.7);
            text-decoration: none;
            transition: var(--transition);
            font-size: 0.9rem;
        }

        .sidebar ul li a:hover { 
            background: rgba(255,255,255,0.05); 
            color: #fff;
            padding-left: 25px;
        }

        .sidebar ul li.active a {
            background: var(--primary-blue);
            color: #fff;
            border-left: 4px solid #fff;
        }

        .sidebar ul li a i { margin-right: 10px; width: 20px; }

        .content {
            width: 100%;
            padding: 20px 30px;
            margin-left: 250px;
            transition: margin-left 0.3s;
            min-height: 100vh;
        }
        
        .content.expanded { margin-left: 0; }

        /* BOT√ÉO TOGGLE SIDEBAR */
        .sidebar-toggle {
            position: fixed;
            top: 72px;
            left: 254px;
            z-index: 998;
            background: transparent;
            color: rgba(108, 117, 125, 0.4);
            border: none;
            border-radius: 4px;
            width: 24px;
            height: 24px;
            cursor: pointer;
            box-shadow: none;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            opacity: 0.5;
        }
        
        .sidebar-toggle:hover { 
            background: rgba(108, 117, 125, 0.15);
            color: var(--text-secondary);
            opacity: 1;
            transform: scale(1.1);
        }
        
        .sidebar-toggle.collapsed { 
            left: 8px; 
            top: 12px;
            opacity: 0.7;
            background: rgba(108, 117, 125, 0.1);
        }

        /* PAGE HEADER */
        .page-header { margin-bottom: 20px; }
        .page-header h4 { font-weight: 700; font-size: 1.4rem; color: var(--text-primary); margin-bottom: 2px; }
        .page-header small { color: var(--text-secondary); font-size: 0.8rem; }

        /* CARDS KPI - DESIGN MODERNO */
        .kpi-card {
            background: linear-gradient(135deg, #ffffff 0%, #fafbfc 100%);
            border-radius: 12px;
            padding: 20px 24px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.06);
            transition: all 0.3s ease;
            border: none;
            position: relative;
            overflow: hidden;
        }

        .kpi-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            border-radius: 12px 0 0 12px;
        }

        .kpi-card:hover { 
            transform: translateY(-4px); 
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }
        
        .kpi-card.danger::before { background: linear-gradient(180deg, #dc3545, #c82333); }
        .kpi-card.success::before { background: linear-gradient(180deg, #198754, #157347); }
        .kpi-card.warning::before { background: linear-gradient(180deg, #ffc107, #e0a800); }
        .kpi-card.primary::before { background: linear-gradient(180deg, #0d6efd, #0b5ed7); }

        .kpi-value {
            font-size: 2.2rem;
            font-weight: 800;
            margin-bottom: 4px;
            letter-spacing: -1px;
        }

        .kpi-label {
            font-size: 0.7rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            font-weight: 700;
            letter-spacing: 0.5px;
        }

        /* TABELA MODERNA */
        .table-container {
            background: white;
            border-radius: 12px;
            padding: 0;
            box-shadow: 0 4px 15px rgba(0,0,0,0.06);
            overflow: hidden;
        }

        .table {
            margin-bottom: 0;
        }

        .table thead th {
            background: linear-gradient(180deg, #f8f9fa 0%, #f1f3f5 100%);
            border-bottom: 2px solid #e9ecef;
            font-weight: 700;
            font-size: 0.7rem;
            text-transform: uppercase;
            color: #495057;
            padding: 10px 12px;
            white-space: nowrap;
            letter-spacing: 0.3px;
        }

        .table tbody td {
            vertical-align: middle;
            padding: 8px 12px;
            font-size: 0.85rem;
            border-bottom: 1px solid #f1f3f5;
        }

        .table tbody tr {
            transition: all 0.2s ease;
        }

        .table tbody tr:hover {
            background-color: rgba(13, 110, 253, 0.04);
        }

        .table tbody tr:last-child td {
            border-bottom: none;
        }

        /* FORNECEDOR LAYOUT COMPACTO */
        .fornecedor-td {
            padding: 6px 12px !important;
        }
        
        .fornecedor-codigo {
            margin-bottom: 2px;
        }

        /* STATUS BADGES */
        .status-badge {
            padding: 5px 12px;
            border-radius: 50px;
            font-size: 0.7rem;
            font-weight: 700;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            letter-spacing: 0.2px;
        }

        .status-valido {
            background: linear-gradient(135deg, #d1e7dd 0%, #c3e0ce 100%);
            color: #0f5132;
        }

        .status-proximo {
            background: linear-gradient(135deg, #fff3cd 0%, #ffe9a6 100%);
            color: #664d03;
        }

        .status-vencido {
            background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
            color: #842029;
        }

        .status-indefinido {
            background: #e9ecef;
            color: #6c757d;
        }

        /* LINHA DA TABELA COLORIDA */
        .row-vencido {
            background: linear-gradient(90deg, rgba(220, 53, 69, 0.08) 0%, rgba(220, 53, 69, 0.02) 100%) !important;
        }

        .row-proximo {
            background: linear-gradient(90deg, rgba(255, 193, 7, 0.12) 0%, rgba(255, 193, 7, 0.03) 100%) !important;
        }

        /* BOT√ïES DE A√á√ÉO COMPACTOS */
        .btn-action {
            padding: 5px 7px;
            font-size: 0.7rem;
            border-radius: 5px;
            transition: all 0.2s ease;
        }

        .btn-action:hover {
            transform: scale(1.08);
        }

        .btn-group-actions {
            display: flex;
            gap: 4px;
            flex-wrap: nowrap;
        }
        
        /* TABELA COMPACTA */
        #tabelaAvaliacoes {
            width: 100%;
        }
        
        #tabelaAvaliacoes td {
            padding: 0.5rem 0.4rem;
            vertical-align: middle;
        }
        
        #tabelaAvaliacoes th {
            padding: 0.6rem 0.4rem;
            font-size: 0.8rem;
            white-space: nowrap;
            background: #f8f9fa;
        }
        
        #tabelaAvaliacoes tbody tr:hover {
            background-color: rgba(13, 110, 253, 0.04);
        }
        
        /* Estilo c√©lula fornecedor - VERTICAL */
        .fornecedor-td {
            padding: 0.5rem 0.4rem !important;
        }
        
        .fornecedor-cell-vertical {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        
        .fornecedor-codigo {
            color: #0d6efd;
            font-weight: 700;
            font-size: 0.8rem;
            font-family: 'Consolas', 'Monaco', monospace;
            letter-spacing: 0.5px;
        }
        
        .fornecedor-nome-linha {
            font-weight: 600;
            font-size: 0.9rem;
            color: #212529;
            line-height: 1.3;
        }
        
        .fornecedor-email-linha {
            color: #6c757d;
            font-size: 0.75rem;
            margin-top: 1px;
        }
        
        .fornecedor-email-linha i {
            font-size: 0.65rem;
        }
        
        /* STATUS BADGES MAIS COMPACTOS */
        .status-badge {
            font-size: 0.85rem;
        }
        
        .status-badge i {
            font-size: 1rem;
        }

        /* MODAL */
        .modal-header {
            background: linear-gradient(135deg, #0d6efd, #0056b3);
            color: white;
            border-radius: 0;
        }

        .modal-header .btn-close {
            filter: brightness(0) invert(1);
        }

        /* DOCUMENTOS - BADGES COMPACTOS */
        .doc-badge {
            display: inline-flex;
            align-items: center;
            gap: 3px;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.65rem;
            font-weight: 600;
            margin: 1px;
        }

        .doc-avaliacao {
            background: #cfe2ff;
            color: #084298;
        }

        .doc-certificado {
            background: #d1e7dd;
            color: #0f5132;
        }
        
        .doc-contrato {
            background: #fff3cd;
            color: #664d03;
        }
        
        .doc-outro {
            background: #e2e3e5;
            color: #41464b;
        }

        /* FILTROS - CARD ELEGANTE */
        .filter-card {
            background: linear-gradient(135deg, #ffffff 0%, #fafbfc 100%);
            border-radius: 12px;
            padding: 18px 24px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.06);
            margin-bottom: 12px;
            border: none;
            position: relative;
        }

        .filter-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: linear-gradient(180deg, #0d6efd, #0b5ed7);
            border-radius: 12px 0 0 12px;
        }

        .form-label-sm {
            font-size: 0.68rem;
            font-weight: 700;
            color: #6c757d;
            text-transform: uppercase;
            margin-bottom: 6px;
            letter-spacing: 0.3px;
        }

        .form-control, .form-select {
            border-radius: 8px;
            border: 1px solid #dee2e6;
            font-size: 0.85rem;
            transition: all 0.2s ease;
        }

        .form-control:focus, .form-select:focus {
            border-color: #86b7fe;
            box-shadow: 0 0 0 3px rgba(13, 110, 253, 0.15);
        }

        /* AUTOCOMPLETE DROPDOWN */
        .autocomplete-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 0 0 8px 8px;
            max-height: 250px;
            overflow-y: auto;
            z-index: 1050;
            display: none;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
        }
        
        .autocomplete-dropdown.show {
            display: block;
        }
        
        .autocomplete-item {
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 1px solid #f1f3f5;
            transition: all 0.15s ease;
        }
        
        .autocomplete-item:last-child {
            border-bottom: none;
        }
        
        .autocomplete-item:hover {
            background: linear-gradient(135deg, #e7f1ff 0%, #f0f7ff 100%);
        }
        
        .autocomplete-item .codigo {
            font-family: monospace;
            font-size: 0.75rem;
            color: #0d6efd;
            font-weight: 600;
        }
        
        .autocomplete-item .nome {
            font-weight: 600;
            color: #1a1a2e;
        }
        
        .autocomplete-item .email {
            font-size: 0.75rem;
            color: #6c757d;
        }
        
        .autocomplete-loading {
            padding: 15px;
            text-align: center;
            color: #6c757d;
        }
        
        .autocomplete-empty {
            padding: 15px;
            text-align: center;
            color: #6c757d;
            font-style: italic;
        }

        /* BARRA DE A√á√ïES - DESIGN CLEAN */
        .action-bar {
            background: linear-gradient(135deg, #ffffff 0%, #fafbfc 100%);
            border-radius: 12px;
            padding: 14px 24px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.06);
            position: relative;
        }

        .action-bar::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: linear-gradient(180deg, #198754, #157347);
            border-radius: 12px 0 0 12px;
        }

        .action-bar .btn {
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.8rem;
            padding: 8px 16px;
            transition: all 0.2s ease;
        }

        .action-bar .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        /* OBSERVA√á√ïES */
        .obs-tooltip {
            max-width: 300px;
            white-space: pre-wrap;
            text-align: left;
        }

        /* ISO BADGE */
        .badge.bg-success {
            background: linear-gradient(135deg, #198754, #157347) !important;
        }
        
        .badge.bg-secondary {
            background: linear-gradient(135deg, #6c757d, #5a6268) !important;
        }

        /* HIST√ìRICO DE E-MAILS */
        .email-history-item {
            border-left: 3px solid var(--primary-blue);
            padding: 10px 15px;
            margin-bottom: 10px;
            background: #f8f9fa;
            border-radius: 0 5px 5px 0;
        }

        .email-history-item.erro {
            border-left-color: var(--danger-red);
        }

        /* SELE√á√ÉO M√öLTIPLA - CHECKBOX */
        .select-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: var(--primary-blue);
        }
        
        .select-checkbox:checked {
            transform: scale(1.1);
        }
        
        /* BARRA DE A√á√ïES EM LOTE */
        .bulk-actions-bar {
            position: fixed;
            bottom: 0;
            left: 250px;
            right: 0;
            background: linear-gradient(135deg, #1a1d21 0%, #2c3136 100%);
            color: white;
            padding: 15px 30px;
            display: none;
            align-items: center;
            justify-content: space-between;
            z-index: 1000;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.3);
            border-top: 3px solid var(--primary-blue);
            animation: slideUp 0.3s ease;
            transition: left 0.3s ease;
        }
        
        /* Quando sidebar est√° colapsada */
        .sidebar.collapsed ~ .bulk-actions-bar,
        .content.expanded ~ .bulk-actions-bar {
            left: 0;
        }
        
        @keyframes slideUp {
            from { transform: translateY(100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .bulk-actions-bar.show {
            display: flex;
        }
        
        .bulk-actions-bar .selection-info {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .bulk-actions-bar .selection-count {
            background: var(--primary-blue);
            color: white;
            padding: 8px 16px;
            border-radius: 50px;
            font-weight: 700;
            font-size: 0.9rem;
        }
        
        .bulk-actions-bar .selection-text {
            font-size: 0.9rem;
            color: rgba(255,255,255,0.9);
        }
        
        .bulk-actions-bar .bulk-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .bulk-actions-bar .btn {
            border-radius: 8px;
            font-weight: 600;
            padding: 10px 20px;
            transition: all 0.2s ease;
        }
        
        .bulk-actions-bar .btn:hover {
            transform: translateY(-2px);
        }
        
        .bulk-actions-bar .btn-cancel {
            background: transparent;
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
        }
        
        .bulk-actions-bar .btn-cancel:hover {
            background: rgba(255,255,255,0.1);
            border-color: rgba(255,255,255,0.5);
        }
        
        /* BADGE DE GRUPO (m√∫ltiplos CNPJs) */
        .badge-grupo {
            background: linear-gradient(135deg, #6f42c1 0%, #5a32a3 100%);
            color: white;
            font-size: 0.65rem;
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: 6px;
            font-weight: 600;
            cursor: help;
        }
        
        /* Linha selecionada */
        tr.row-selected {
            background: rgba(13, 110, 253, 0.08) !important;
            box-shadow: inset 3px 0 0 var(--primary-blue);
        }
        
        tr.row-selected td:first-child {
            position: relative;
        }

        /* TOOLTIP */
        [data-bs-toggle="tooltip"] {
            cursor: pointer;
        }

        /* DROPDOWN DE DOCUMENTOS - DESIGN MELHORADO */
        .dropdown-menu {
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            border: 1px solid rgba(0,0,0,0.1);
            padding: 8px 0;
        }

        .dropdown-item {
            padding: 10px 16px;
            font-size: 0.85rem;
            transition: all 0.2s ease;
            border-radius: 4px;
            margin: 2px 8px;
        }

        .dropdown-item:hover {
            background-color: rgba(13, 110, 253, 0.08);
            transform: translateX(4px);
        }

        .dropdown-item i {
            width: 20px;
            text-align: center;
        }

        .dropdown-divider {
            margin: 8px 0;
            border-color: rgba(0,0,0,0.08);
        }

        /* LOADING */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255,255,255,0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .loading-overlay.active {
            display: flex;
        }

        /* SORTABLE HEADERS */
        .sortable-header {
            cursor: pointer;
            user-select: none;
            position: relative;
            transition: background 0.2s ease;
        }
        .sortable-header:hover {
            background: #e2e6ea !important;
        }
        .sort-indicator {
            display: inline-block;
            margin-left: 4px;
            font-size: 0.65rem;
            color: #adb5bd;
            transition: color 0.2s;
        }
        .sortable-header:hover .sort-indicator {
            color: #495057;
        }
        .sortable-header.sort-asc .sort-indicator .arrow-up,
        .sortable-header.sort-desc .sort-indicator .arrow-down {
            color: #0d6efd;
            font-weight: bold;
        }
        .sortable-header.sort-asc .sort-indicator .arrow-down,
        .sortable-header.sort-desc .sort-indicator .arrow-up {
            color: #dee2e6;
        }

        /* TOAST NOTIFICATIONS */
        .toast-container-custom {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10050;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .toast-custom {
            min-width: 320px;
            max-width: 450px;
            padding: 14px 20px;
            border-radius: 10px;
            color: #fff;
            font-size: 0.9rem;
            font-weight: 500;
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            gap: 10px;
            animation: toastSlideIn 0.35s ease;
            opacity: 1;
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        .toast-custom.toast-success { background: linear-gradient(135deg, #198754, #157347); }
        .toast-custom.toast-error { background: linear-gradient(135deg, #dc3545, #b02a37); }
        .toast-custom.toast-warning { background: linear-gradient(135deg, #ffc107, #e0a800); color: #1a1a2e; }
        .toast-custom.toast-info { background: linear-gradient(135deg, #0dcaf0, #0aa2c0); }
        .toast-custom.toast-hide {
            opacity: 0;
            transform: translateX(40px);
        }
        @keyframes toastSlideIn {
            from { opacity: 0; transform: translateX(40px); }
            to { opacity: 1; transform: translateX(0); }
        }
        .toast-custom .toast-close {
            margin-left: auto;
            background: none;
            border: none;
            color: inherit;
            font-size: 1.1rem;
            cursor: pointer;
            opacity: 0.7;
            padding: 0 4px;
        }
        .toast-custom .toast-close:hover { opacity: 1; }
    </style>
</head>
<body>

<!-- Loading Overlay -->
<div class="loading-overlay" id="loadingOverlay">
    <div class="text-center">
        <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
            <span class="visually-hidden">Carregando...</span>
        </div>
        <p class="mt-2 text-primary fw-bold">Processando...</p>
    </div>
</div>

<!-- Toast Notifications Container -->
<div class="toast-container-custom" id="toastContainer"></div>

<!-- BOT√ÉO TOGGLE SIDEBAR -->
<button class="sidebar-toggle" id="sidebarToggle" onclick="toggleSidebar()">
    <i class="fas fa-bars"></i>
</button>

<div class="wrapper">
    <nav class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h4 class="mb-0"><i class="fas fa-cubes me-2"></i>Polimaquinas</h4>
            <small class="text-muted" style="font-size: 0.75rem;">Portal de Compras</small>
        </div>
        <ul class="list-unstyled components">
            <li><a href="{{ url_for('dashboard') }}"><i class="fas fa-chart-line"></i> Dashboard Financeiro</a></li>
            <li><a href="{{ url_for('status_pedidos') }}"><i class="fas fa-tasks"></i> Status de Pedidos</a></li>
            <li><a href="{{ url_for('performance') }}"><i class="fas fa-tachometer-alt"></i> OTD & Performance</a></li>
            <li><a href="{{ url_for('variacao_preco') }}"><i class="fas fa-balance-scale"></i> Varia√ß√£o de Pre√ßo</a></li>
            <li><a href="{{ url_for('terceiros') }}"><i class="fas fa-industry"></i> Terceiros</a></li>
            <li><a href="{{ url_for('solicitacoes') }}"><i class="fas fa-file-alt"></i> Solicita√ß√µes em Aberto</a></li>
            <li><a href="{{ url_for('cotacoes') }}"><i class="fas fa-file-invoice-dollar"></i> Cota√ß√µes e Or√ßamentos</a></li>
            <li class="active"><a href="{{ url_for('avaliacao_iso') }}"><i class="fas fa-certificate"></i> Avalia√ß√£o ISO (PQ021)</a></li>
        </ul>
    </nav>

    <div class="content" id="content">
        <!-- ============================================== -->
        <!-- 1. T√çTULO DA P√ÅGINA -->
        <!-- ============================================== -->
        <div class="page-header">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h4><i class="fas fa-certificate me-2 text-primary"></i>Avalia√ß√£o ISO de Fornecedores</h4>
                    <small>Controle de avalia√ß√µes e documentos para auditoria ISO (PQ021)</small>
                </div>
                <span class="badge bg-light text-dark border px-3 py-2">
                    <i class="fas fa-user-circle me-1"></i>{{ user }}
                </span>
            </div>
        </div>

        <!-- ============================================== -->
        <!-- 2. KPIs RESUMO -->
        <!-- ============================================== -->
        <div class="row g-3 mb-4">
            <div class="col-md-3">
                <div class="kpi-card primary">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <div class="kpi-value text-primary">{{ kpis.total }}</div>
                            <div class="kpi-label">Total Cadastrados</div>
                        </div>
                        <div class="kpi-icon text-primary opacity-25">
                            <i class="fas fa-building fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="kpi-card success">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <div class="kpi-value text-success">{{ kpis.validos }}</div>
                            <div class="kpi-label">Regulares</div>
                        </div>
                        <div class="kpi-icon text-success opacity-25">
                            <i class="fas fa-check-circle fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="kpi-card warning">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <div class="kpi-value text-warning">{{ kpis.proximos }}</div>
                            <div class="kpi-label">Pr√≥x. Vencimento</div>
                        </div>
                        <div class="kpi-icon text-warning opacity-25">
                            <i class="fas fa-exclamation-triangle fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="kpi-card danger">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <div class="kpi-value text-danger">{{ kpis.vencidos }}</div>
                            <div class="kpi-label">Vencidos</div>
                        </div>
                        <div class="kpi-icon text-danger opacity-25">
                            <i class="fas fa-times-circle fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ============================================== -->
        <!-- 3. FILTROS + A√á√ïES EM LINHA -->
        <!-- ============================================== -->
        <div class="filter-card mb-3">
            <div class="row g-2 align-items-center">
                <!-- Busca por Nome/C√≥digo -->
                <!-- Campo de Busca -->
                <div class="col-12 col-lg-4">
                    <div class="input-group">
                        <span class="input-group-text bg-white border-end-0">
                            <i class="fas fa-search text-muted"></i>
                        </span>
                        <input type="text" class="form-control border-start-0" id="filtroNome" 
                               placeholder="Buscar por nome ou c√≥digo do fornecedor..." 
                               onkeyup="filtrarTabela()">
                    </div>
                </div>
                
                <!-- Filtro Status -->
                <div class="col-6 col-lg-2">
                    <select class="form-select" id="filtroStatus" onchange="filtrarTabela()">
                        <option value="">Status: Todos</option>
                        <option value="valido">‚úÖ Regular</option>
                        <option value="proximo">‚ö†Ô∏è Pr√≥x. Vencimento</option>
                        <option value="vencido">‚ùå Vencido</option>
                    </select>
                </div>
                
                <!-- Filtro ISO -->
                <div class="col-6 col-lg-1">
                    <select class="form-select" id="filtroISO" onchange="filtrarTabela()">
                        <option value="">ISO: Todos</option>
                        <option value="Sim">‚úÖ Sim</option>
                        <option value="Nao">‚ùå N√£o</option>
                    </select>
                </div>
                
                <!-- Bot√µes de A√ß√£o -->
                <div class="col-12 col-lg-5">
                    <div class="d-flex gap-2 justify-content-lg-end justify-content-center flex-wrap">
                        <button class="btn btn-outline-secondary btn-sm" onclick="limparFiltros()" title="Limpar filtros">
                            <i class="fas fa-eraser me-1"></i> Limpar
                        </button>
                        <button class="btn btn-success btn-sm" onclick="abrirModalImportarExcel()" title="Importar fornecedores via Excel">
                            <i class="fas fa-file-excel me-1"></i> Importar Excel
                        </button>
                        <button class="btn btn-primary btn-sm" onclick="abrirModalNovo()">
                            <i class="fas fa-plus me-1"></i> Novo Fornecedor
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ============================================== -->
        <!-- 4. TABELA DE FORNECEDORES -->
        <!-- ============================================== -->
        <div class="table-container">
            <div class="table-responsive">
                <table class="table table-hover mb-0" id="tabelaAvaliacoes">
                    <thead>
                        <tr>
                            <th style="width: 30px;" class="text-center px-1">
                                <input type="checkbox" class="select-checkbox" id="selectAll" 
                                       onchange="toggleSelectAll(this)" title="Selecionar todos">
                            </th>
                            <th style="width: 40%;" class="sortable-header" data-sort="fornecedor" onclick="sortTable('fornecedor')">
                                Fornecedor
                                <span class="sort-indicator"><span class="arrow-up">‚ñ≤</span><span class="arrow-down">‚ñº</span></span>
                            </th>
                            <th style="width: 100px;" class="text-center sortable-header" data-sort="avaliacao" onclick="sortTable('avaliacao')">
                                Avalia√ß√£o
                                <span class="sort-indicator"><span class="arrow-up">‚ñ≤</span><span class="arrow-down">‚ñº</span></span>
                            </th>
                            <th style="width: 100px;" class="text-center sortable-header" data-sort="vencimento" onclick="sortTable('vencimento')">
                                Vencimento
                                <span class="sort-indicator"><span class="arrow-up">‚ñ≤</span><span class="arrow-down">‚ñº</span></span>
                            </th>
                            <th style="width: 80px;" class="text-center sortable-header" data-sort="status" onclick="sortTable('status')">
                                Status
                                <span class="sort-indicator"><span class="arrow-up">‚ñ≤</span><span class="arrow-down">‚ñº</span></span>
                            </th>
                            <th style="width: 60px;" class="text-center">ISO</th>
                            <th style="width: 60px;" class="text-center">Docs</th>
                            <th style="width: 130px;" class="text-center">A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if avaliacoes %}
                            {% for av in avaliacoes %}
                            {# Contar quantos fornecedores t√™m o mesmo nome #}
                            {% set nome_normalizado = av.nome_fornecedor|upper|trim %}
                            {% set count_mesmo_nome = avaliacoes|selectattr('nome_fornecedor')|map('upper')|map('trim')|select('equalto', nome_normalizado)|list|length %}
                            <tr class="{% if av.status == 'vencido' %}row-vencido{% elif av.status == 'proximo' %}row-proximo{% endif %}"
                                data-id="{{ av.id }}"
                                data-status="{{ av.status }}"
                                data-status-order="{% if av.status == 'vencido' %}0{% elif av.status == 'proximo' %}1{% elif av.status == 'valido' %}2{% else %}3{% endif %}"
                                data-dias-restantes="{{ av.dias_restantes if av.dias_restantes is not none else '' }}"
                                data-iso="{{ av.possui_iso }}"
                                data-nome="{{ av.nome_fornecedor|lower }}"
                                data-nome-original="{{ av.nome_fornecedor }}"
                                data-codigo="{{ av.cod_fornecedor|lower }}"
                                data-codigo-original="{{ av.cod_fornecedor }}"
                                data-email="{{ av.email_fornecedor or '' }}"
                                data-observacao="{{ av.observacao or '' }}"
                                data-data-avaliacao="{{ av.data_ultima_avaliacao or '' }}"
                                data-data-vencimento="{{ av.data_vencimento or '' }}">
                                <td class="text-center px-1">
                                    <input type="checkbox" class="select-checkbox row-checkbox" 
                                           data-id="{{ av.id }}"
                                           data-nome="{{ av.nome_fornecedor }}"
                                           data-codigo="{{ av.cod_fornecedor }}"
                                           data-email="{{ av.email_fornecedor or '' }}"
                                           onchange="onRowCheckboxChange(this)">
                                </td>
                                <td class="fornecedor-td py-2">
                                    <div class="fornecedor-codigo mb-1">
                                        <span class="badge bg-primary" style="font-size: 0.7rem; font-family: monospace;">
                                            {{ av.cod_fornecedor }}
                                        </span>
                                        {% if count_mesmo_nome > 1 %}
                                        <span class="badge bg-warning text-dark ms-1" style="font-size: 0.6rem;" title="{{ count_mesmo_nome }} cadastros">
                                            <i class="fas fa-layer-group"></i> {{ count_mesmo_nome }}
                                        </span>
                                        {% endif %}
                                    </div>
                                    <div class="d-flex align-items-center flex-wrap gap-2">
                                        <span class="fw-semibold text-dark" style="font-size: 0.9rem;">{{ av.nome_fornecedor }}</span>
                                        {% if av.email_fornecedor %}
                                        <span class="text-muted small ms-2 ps-2" style="border-left: 1px solid #dee2e6;">
                                            <i class="fas fa-envelope text-secondary me-1" style="font-size: 0.65rem;"></i>
                                            <span style="font-size: 0.75rem;">{{ av.email_fornecedor }}</span>
                                        </span>
                                        {% endif %}
                                    </div>
                                </td>
                                <td class="text-center">
                                    <small>{{ av.data_ultima_avaliacao|formatar_data_br }}</small>
                                </td>
                                <td class="text-center">
                                    <small>{{ av.data_vencimento|formatar_data_br }}</small>
                                </td>
                                <td class="text-center">
                                    {% if av.status == 'valido' %}
                                        <span class="status-badge status-valido" title="Regular - {{ av.dias_restantes }} dias restantes">
                                            <i class="fas fa-check-circle"></i>
                                        </span>
                                    {% elif av.status == 'proximo' %}
                                        {% if av.dias_restantes == 0 %}
                                        <span class="status-badge status-proximo" title="‚ö†Ô∏è VENCE HOJE!">
                                            <i class="fas fa-exclamation-triangle"></i>
                                        </span>
                                        {% else %}
                                        <span class="status-badge status-proximo" title="Aten√ß√£o! Vence em {{ av.dias_restantes }} dia(s)">
                                            <i class="fas fa-exclamation-triangle"></i>
                                        </span>
                                        {% endif %}
                                    {% elif av.status == 'vencido' %}
                                        <span class="status-badge status-vencido" title="‚ùå Vencido h√° {{ (av.dias_restantes * -1) }} dia(s)">
                                            <i class="fas fa-times-circle"></i>
                                        </span>
                                    {% else %}
                                        <span class="status-badge status-indefinido" title="Sem data de vencimento">
                                            <i class="fas fa-question-circle"></i>
                                        </span>
                                    {% endif %}
                                </td>
                                <td class="text-center">
                                    {% if av.possui_iso == 'Sim' %}
                                        <span class="badge bg-success px-2 py-1" style="font-size: 0.65rem;">Sim</span>
                                    {% else %}
                                        <span class="badge bg-secondary px-2 py-1" style="font-size: 0.65rem;">N√£o</span>
                                    {% endif %}
                                </td>
                                <td class="text-center">
                                    {% if av.documentos and av.documentos|length > 0 %}
                                        <button class="btn btn-sm btn-outline-info px-2 py-1" 
                                                onclick="abrirModalDocumentos({{ av.id }}, '{{ av.nome_fornecedor }}')"
                                                title="{{ av.documentos|length }} documento(s) - Clique para gerenciar">
                                            <i class="fas fa-folder-open"></i>
                                            <span class="badge bg-info ms-1" style="font-size: 0.6rem;">{{ av.documentos|length }}</span>
                                        </button>
                                    {% else %}
                                        <button class="btn btn-sm btn-outline-secondary px-2 py-1" 
                                                onclick="abrirModalDocumentos({{ av.id }}, '{{ av.nome_fornecedor }}')"
                                                title="Nenhum documento - Clique para adicionar">
                                            <i class="fas fa-folder"></i>
                                            <span class="badge bg-secondary ms-1" style="font-size: 0.6rem;">0</span>
                                        </button>
                                    {% endif %}
                                </td>
                                <td class="text-center">
                                    <div class="btn-group-actions justify-content-center">
                                        <button class="btn btn-primary btn-action" 
                                                onclick="abrirModalEditar({{ av.id }})"
                                                title="Editar / Documentos">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn btn-warning btn-action text-white" 
                                                onclick="abrirModalEnviarEmail({{ av.id }}, '{{ av.email_fornecedor }}', '{{ av.nome_fornecedor }}', '{{ av.possui_iso }}')"
                                                title="Enviar E-mail">
                                            <i class="fas fa-envelope"></i>
                                        </button>
                                        <button class="btn btn-outline-danger btn-action" 
                                                onclick="confirmarExclusao({{ av.id }}, '{{ av.nome_fornecedor }}')"
                                                title="Excluir">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        {% else %}
                            <tr>
                                <td colspan="8" class="text-center py-5">
                                    <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                                    <p class="text-muted">Nenhuma avalia√ß√£o cadastrada.</p>
                                    <button class="btn btn-primary" onclick="abrirModalNovo()">
                                        <i class="fas fa-plus me-1"></i> Cadastrar Primeiro Fornecedor
                                    </button>
                                </td>
                            </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- BARRA DE A√á√ïES EM LOTE (BULK ACTIONS) -->
<div class="bulk-actions-bar" id="bulkActionsBar">
    <div class="selection-info">
        <span class="selection-count" id="selectionCount">0</span>
        <span class="selection-text">fornecedor(es) selecionado(s)</span>
        <button class="btn btn-sm btn-link text-white-50" onclick="selecionarMesmoNome()" title="Selecionar todos com mesmo nome">
            <i class="fas fa-layer-group me-1"></i> Agrupar por nome
        </button>
    </div>
    <div class="bulk-buttons">
        <button class="btn btn-warning text-white" onclick="abrirModalEmailLote()">
            <i class="fas fa-envelope me-1"></i> Enviar E-mail em Lote
        </button>
        <button class="btn btn-cancel" onclick="limparSelecao()">
            <i class="fas fa-times me-1"></i> Cancelar
        </button>
    </div>
</div>

<!-- MODAL: ENVIAR E-MAIL EM LOTE -->
<div class="modal fade" id="modalEmailLote" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title">
                    <i class="fas fa-envelope me-2"></i>Enviar E-mail em Lote
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Lista de destinat√°rios -->
                <div class="mb-3">
                    <label class="form-label fw-bold">
                        <i class="fas fa-users me-1"></i> Destinat√°rios Selecionados:
                    </label>
                    <div id="listaDestinatariosLote" class="border rounded p-3" style="max-height: 150px; overflow-y: auto; background: #f8f9fa;">
                        <!-- Preenchido via JS -->
                    </div>
                </div>
                
                <!-- Modo de envio -->
                <div class="mb-3">
                    <label class="form-label fw-bold">
                        <i class="fas fa-paper-plane me-1"></i> Modo de Envio:
                    </label>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="modoEnvioLote" id="modoIndividual" value="individual" checked>
                        <label class="form-check-label" for="modoIndividual">
                            <strong>Individual</strong> - Um e-mail separado para cada fornecedor
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="modoEnvioLote" id="modoUnico" value="unico">
                        <label class="form-check-label" for="modoUnico">
                            <strong>E-mail √∫nico</strong> - Todos os destinat√°rios no mesmo e-mail (CC)
                        </label>
                    </div>
                </div>
                
                <hr>
                
                <!-- Tipo de cobran√ßa -->
                <div class="mb-3">
                    <label class="form-label fw-bold">Tipo de Cobran√ßa:</label>
                    <select class="form-select" id="tipoCobrancaLote">
                        <option value="iso">üìã Cobran√ßa de Certificado ISO</option>
                        <option value="avaliacao">üìä Cobran√ßa de Avalia√ß√£o de Fornecedor</option>
                        <option value="documentos">üìÅ Solicita√ß√£o de Documentos</option>
                        <option value="personalizado">‚úèÔ∏è Mensagem Personalizada</option>
                    </select>
                </div>
                
                <!-- Assunto -->
                <div class="mb-3">
                    <label class="form-label fw-bold">Assunto:</label>
                    <input type="text" class="form-control" id="assuntoEmailLote" 
                           value="Solicita√ß√£o de Documentos - Polimaquinas">
                </div>
                
                <!-- Corpo do e-mail -->
                <div class="mb-3">
                    <label class="form-label fw-bold">Mensagem:</label>
                    <textarea class="form-control" id="corpoEmailLote" rows="8">Prezado(a) Fornecedor,

Conforme nosso sistema de qualidade (ISO 9001), solicitamos gentilmente o envio da documenta√ß√£o atualizada referente ao certificado ISO ou avalia√ß√£o de fornecedor.

Por favor, envie os documentos em resposta a este e-mail ou atrav√©s do nosso portal.

Atenciosamente,
Equipe de Compras - Polimaquinas</textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-warning text-white" onclick="enviarEmailsLote()">
                    <i class="fas fa-paper-plane me-1"></i> Enviar E-mails
                </button>
            </div>
        </div>
    </div>
</div>

<!-- MODAL: IMPORTAR AVALIA√á√ÉO ISO VIA EXCEL -->
<div class="modal fade" id="modalImportarExcel" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">
                    <i class="fas fa-file-excel me-2"></i>Importar Avalia√ß√£o ISO via Excel
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Etapa 1: Upload do arquivo -->
                <div id="etapaUploadExcel">
                    <div class="alert alert-info">
                        <h6 class="alert-heading"><i class="fas fa-info-circle me-2"></i>Estrutura esperada do Excel:</h6>
                        <ul class="mb-0 small">
                            <li><strong>Linha 1:</strong> Cabe√ßalho (ser√° ignorada)</li>
                            <li><strong>Coluna A:</strong> Nome do Fornecedor</li>
                            <li><strong>Coluna B:</strong> Data de Avalia√ß√£o</li>
                            <li><strong>Coluna D:</strong> Data de Vencimento</li>
                            <li><strong>Coluna E:</strong> Possui Certificado ISO (Sim/N√£o)</li>
                        </ul>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold">Selecione o arquivo Excel:</label>
                        <input type="file" class="form-control" id="arquivoExcelISO" 
                               accept=".xlsx,.xls" onchange="validarArquivoExcel(this)">
                        <small class="text-muted">Formatos aceitos: .xlsx, .xls</small>
                    </div>
                    
                    <div id="infoArquivoExcel" class="d-none">
                        <div class="card bg-light">
                            <div class="card-body py-2">
                                <i class="fas fa-file-excel text-success me-2"></i>
                                <span id="nomeArquivoExcel"></span>
                                <span class="badge bg-secondary ms-2" id="tamanhoArquivoExcel"></span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Etapa 2: Processando -->
                <div id="etapaProcessandoExcel" class="d-none text-center py-4">
                    <div class="spinner-border text-success" role="status" style="width: 3rem; height: 3rem;">
                        <span class="visually-hidden">Processando...</span>
                    </div>
                    <h5 class="mt-3 text-muted">Processando arquivo...</h5>
                    <p class="text-secondary small">Buscando fornecedores e importando dados. Por favor, aguarde.</p>
                </div>
                
                <!-- Etapa 3: Resultado -->
                <div id="etapaResultadoExcel" class="d-none">
                    <div id="resultadoSucesso" class="d-none">
                        <div class="alert alert-success">
                            <h5><i class="fas fa-check-circle me-2"></i>Importa√ß√£o Conclu√≠da!</h5>
                        </div>
                    </div>
                    
                    <div id="resultadoErro" class="d-none">
                        <div class="alert alert-danger">
                            <h5><i class="fas fa-times-circle me-2"></i>Erro na Importa√ß√£o</h5>
                            <p id="mensagemErroImportacao" class="mb-0"></p>
                        </div>
                    </div>
                    
                    <!-- Estat√≠sticas -->
                    <div id="estatisticasImportacao" class="d-none">
                        <div class="row g-3 mb-3">
                            <div class="col-6 col-md-3">
                                <div class="card text-center border-0 bg-light">
                                    <div class="card-body py-3">
                                        <h3 class="mb-0 text-primary" id="statTotal">0</h3>
                                        <small class="text-muted">Total de Linhas</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-6 col-md-3">
                                <div class="card text-center border-0 bg-success bg-opacity-10">
                                    <div class="card-body py-3">
                                        <h3 class="mb-0 text-success" id="statImportados">0</h3>
                                        <small class="text-muted">Importados</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-6 col-md-3">
                                <div class="card text-center border-0 bg-warning bg-opacity-10">
                                    <div class="card-body py-3">
                                        <h3 class="mb-0 text-warning" id="statExistentes">0</h3>
                                        <small class="text-muted">J√° Existiam</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-6 col-md-3">
                                <div class="card text-center border-0 bg-danger bg-opacity-10">
                                    <div class="card-body py-3">
                                        <h3 class="mb-0 text-danger" id="statNaoEncontrados">0</h3>
                                        <small class="text-muted">N√£o Encontrados</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Lista de n√£o encontrados -->
                        <div id="listaNaoEncontrados" class="d-none">
                            <h6 class="text-danger"><i class="fas fa-exclamation-triangle me-2"></i>Fornecedores n√£o encontrados no TOTVS:</h6>
                            <div class="table-responsive" style="max-height: 200px; overflow-y: auto;">
                                <table class="table table-sm table-striped mb-0">
                                    <thead class="table-light sticky-top">
                                        <tr>
                                            <th style="width: 60px;">Linha</th>
                                            <th>Nome no Excel</th>
                                            <th style="width: 200px;">Motivo</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tbodyNaoEncontrados"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>Fechar
                </button>
                <button type="button" class="btn btn-success" id="btnProcessarExcel" onclick="processarImportacaoExcel()" disabled>
                    <i class="fas fa-upload me-1"></i>Processar Importa√ß√£o
                </button>
                <button type="button" class="btn btn-primary d-none" id="btnNovaImportacao" onclick="resetarModalImportacao()">
                    <i class="fas fa-redo me-1"></i>Nova Importa√ß√£o
                </button>
            </div>
        </div>
    </div>
</div>

<!-- MODAL: NOVO/EDITAR FORNECEDOR -->
<div class="modal fade" id="modalFornecedor" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalFornecedorTitulo">
                    <i class="fas fa-plus-circle me-2"></i>Novo Fornecedor
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="formFornecedor">
                    <input type="hidden" id="avaliacaoId">
                    
                    <!-- BUSCA TOTVS - C√ìDIGO OU NOME -->
                    <div class="card bg-light border-0 mb-3">
                        <div class="card-body py-3">
                            <div class="row g-2 align-items-end">
                                <div class="col-md-3">
                                    <label class="form-label fw-bold mb-1">
                                        <i class="fas fa-barcode me-1"></i>C√≥digo
                                    </label>
                                    <input type="text" class="form-control" id="codFornecedor" 
                                           placeholder="Ex: 000123"
                                           onkeypress="if(event.key === 'Enter') { event.preventDefault(); buscarPorCodigo(); }">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-bold mb-1">
                                        <i class="fas fa-building me-1"></i>Nome do Fornecedor
                                    </label>
                                    <div class="position-relative">
                                        <input type="text" class="form-control" id="nomeFornecedor" 
                                               placeholder="Digite para buscar..."
                                               autocomplete="off"
                                               oninput="buscarFornecedorAutocomplete(this.value)">
                                        <div id="autocompleteFornecedor" class="autocomplete-dropdown"></div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <button type="button" class="btn btn-outline-primary w-100" onclick="buscarPorCodigo()">
                                        <i class="fas fa-search me-1"></i> Buscar
                                    </button>
                                </div>
                            </div>
                            <small class="text-muted d-block mt-2">
                                <i class="fas fa-info-circle me-1"></i>
                                Digite o c√≥digo e pressione Enter, ou busque pelo nome
                            </small>
                        </div>
                    </div>
                    
                    <hr class="my-3">
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">E-mail</label>
                            <input type="email" class="form-control" id="emailFornecedor" placeholder="email@fornecedor.com">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Possui ISO?</label>
                            <select class="form-select" id="possuiISO">
                                <option value="Nao">N√£o</option>
                                <option value="Sim">Sim</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Data da √öltima Avalia√ß√£o</label>
                            <input type="text" class="form-control campo-data" id="dataUltimaAvaliacao" 
                                   placeholder="DD/MM/AAAA" autocomplete="off"
                                   onpaste="handleDataPaste(event)" onblur="normalizarData(this)">
                            <small class="text-muted">Aceita: 08/10/25, 8/10/2025, colar do Excel</small>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Data de Vencimento</label>
                            <input type="text" class="form-control campo-data" id="dataVencimento" 
                                   placeholder="DD/MM/AAAA" autocomplete="off"
                                   onpaste="handleDataPaste(event)" onblur="normalizarData(this)">
                            <small class="text-muted">Geralmente 1 ano ap√≥s a avalia√ß√£o</small>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Observa√ß√£o</label>
                        <textarea class="form-control" id="observacao" rows="2" placeholder="Notas internas sobre este fornecedor..."></textarea>
                    </div>
                    
                    <!-- SE√á√ÉO DE DOCUMENTOS (vis√≠vel sempre) -->
                    <div id="secaoDocumentosModal" style="display: block !important;">
                        <hr class="my-3">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <label class="form-label fw-bold mb-0">
                                <i class="fas fa-folder-open me-2 text-info"></i>Documentos
                            </label>
                            <button type="button" class="btn btn-sm btn-outline-success" onclick="adicionarBlocoDocumento()">
                                <i class="fas fa-plus me-1"></i> Adicionar mais um documento
                            </button>
                        </div>
                        
                        <!-- Container para blocos de documentos din√¢micos -->
                        <div id="containerDocumentosModal">
                            <!-- Bloco 1 - Padr√£o -->
                            <div class="card bg-light border-0 mb-2 bloco-documento" data-index="1">
                                <div class="card-body py-3">
                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                        <span class="badge bg-secondary">Documento #1</span>
                                    </div>
                                    <div class="row g-2">
                                        <div class="col-md-4">
                                            <label class="form-label small fw-bold mb-1">Arquivo</label>
                                            <input type="file" class="form-control form-control-sm arquivo-documento" accept=".pdf,.doc,.docx">
                                            <small class="text-muted">PDF, DOC ou DOCX - M√°x 10MB</small>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label small fw-bold mb-1">Nome <span class="text-muted">(Opcional)</span></label>
                                            <input type="text" class="form-control form-control-sm nome-documento" 
                                                   placeholder="Deixe vazio para usar nome do arquivo">
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label small fw-bold mb-1">Tipo</label>
                                            <select class="form-select form-select-sm tipo-documento">
                                                <option value="relatorio_avaliacao">üìã Relat√≥rio</option>
                                                <option value="iso">üìú Certificado ISO</option>
                                                <option value="contrato">üìù Contrato</option>
                                                <option value="declaracao">üìÑ Declara√ß√£o</option>
                                                <option value="outro">üìé Outro</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="alert alert-info mt-2 mb-2 py-2 px-3" style="font-size: 0.75rem;">
                            <i class="fas fa-info-circle me-1"></i>
                            Os documentos ser√£o salvos automaticamente ao clicar em <strong>Salvar</strong>. 
                            Clique em <strong>"Adicionar mais um documento"</strong> para anexar m√∫ltiplos arquivos.
                        </div>
                        
                        <!-- Lista de documentos existentes (para edi√ß√£o) -->
                        <div id="listaDocumentosModal" class="small">
                            <div class="text-muted text-center py-2">
                                <i class="fas fa-folder-open me-1"></i> Nenhum documento anexado
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="salvarFornecedor()">
                    <i class="fas fa-save me-1"></i> Salvar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- MODAL: UPLOAD DOCUMENTO (mantido para compatibilidade) -->
<div class="modal fade" id="modalUpload" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title"><i class="fas fa-upload me-2"></i>Upload de Documento</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="mb-3">Fornecedor: <strong id="uploadFornecedorNome"></strong></p>
                <input type="hidden" id="uploadAvaliacaoId">
                
                <div class="mb-3">
                    <label class="form-label">Nome do Documento (Opcional)</label>
                    <input type="text" class="form-control" id="nomeDocumento" 
                           placeholder="Ex.: Relat√≥rio de Avalia√ß√£o 2025, ISO 9001 - Atualizada">
                    <small class="text-muted">Se n√£o preencher, ser√° usado o nome do arquivo</small>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">Tipo de Documento *</label>
                    <select class="form-select" id="tipoDocumento">
                        <option value="relatorio_avaliacao">üìã Relat√≥rio de Avalia√ß√£o</option>
                        <option value="iso">üìú Certificado ISO</option>
                        <option value="contrato">üìù Contrato</option>
                        <option value="declaracao">üìÑ Declara√ß√£o</option>
                        <option value="outro">üìé Outro</option>
                    </select>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">Arquivo *</label>
                    <input type="file" class="form-control" id="arquivoUpload" accept=".pdf,.doc,.docx">
                    <small class="text-muted">Formatos aceitos: PDF, DOC, DOCX (Microsoft Word)</small>
                </div>
                
                <div class="alert alert-info small mb-0">
                    <i class="fas fa-info-circle me-1"></i>
                    <strong>Dica:</strong> Fornecedores sem ISO podem anexar o Relat√≥rio de Avalia√ß√£o da Empresa em Word.
                    Fornecedores com ISO podem anexar o certificado e outros documentos complementares.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-success" onclick="enviarDocumento()">
                    <i class="fas fa-save me-1"></i> Salvar Documento
                </button>
            </div>
        </div>
    </div>
</div>

<!-- MODAL: VER DOCUMENTOS (COMPLETO) -->
<div class="modal fade" id="modalDocumentos" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-info text-white py-2">
                <h5 class="modal-title"><i class="fas fa-folder-open me-2"></i>Documentos do Fornecedor</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Cabe√ßalho com nome do fornecedor -->
                <div class="alert alert-light border mb-3 py-2">
                    <div class="d-flex justify-content-between align-items-center">
                        <span><i class="fas fa-building me-2 text-primary"></i><strong id="docsFornecedorNome"></strong></span>
                        <input type="hidden" id="docsAvaliacaoId">
                        <span id="indicadoresDocumentos"></span>
                    </div>
                </div>
                
                <!-- SE√á√ÉO: ADICIONAR NOVO DOCUMENTO -->
                <div class="card border-success mb-3">
                    <div class="card-header bg-success text-white py-2">
                        <i class="fas fa-plus-circle me-2"></i>Adicionar Novo Documento
                    </div>
                    <div class="card-body py-3">
                        <div class="row g-2 align-items-end">
                            <div class="col-md-4">
                                <label class="form-label small fw-bold mb-1">Arquivo *</label>
                                <input type="file" class="form-control form-control-sm" id="arquivoUploadDocs" accept=".pdf,.doc,.docx"
                                       onchange="onFileSelectedDocs(this)">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label small fw-bold mb-1">Nome (opcional)</label>
                                <input type="text" class="form-control form-control-sm" id="nomeDocumentoDocs" placeholder="Nome do documento">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label small fw-bold mb-1">Tipo</label>
                                <select class="form-select form-select-sm" id="tipoDocumentoDocs">
                                    <option value="relatorio_avaliacao">üìã Relat√≥rio</option>
                                    <option value="iso">üìú Certificado ISO</option>
                                    <option value="contrato">üìù Contrato</option>
                                    <option value="declaracao">üìÑ Declara√ß√£o</option>
                                    <option value="outro">üìé Outro</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <button type="button" class="btn btn-success btn-sm w-100" id="btnSalvarDocumento" onclick="enviarDocumentoRapido()">
                                    <i class="fas fa-save me-1"></i> Salvar
                                </button>
                            </div>
                        </div>
                        <!-- File preview before save -->
                        <div id="filePreviewDocs" class="d-none mt-2">
                            <div class="alert alert-light border py-2 px-3 mb-0 d-flex align-items-center gap-2">
                                <i class="fas fa-file" id="filePreviewIcon"></i>
                                <span id="filePreviewName" class="fw-medium" style="font-size: 0.85rem;"></span>
                                <span class="badge bg-secondary" id="filePreviewSize"></span>
                                <button class="btn btn-sm btn-outline-danger ms-auto py-0 px-1" onclick="clearFilePreview()" title="Remover">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                        <small class="text-muted d-block mt-1">PDF, DOC ou DOCX - M√°ximo 10MB. Clique em <strong>Salvar</strong> para confirmar o upload.</small>
                    </div>
                </div>
                
                <!-- SE√á√ÉO: LISTA DE DOCUMENTOS -->
                <div class="card">
                    <div class="card-header bg-light py-2">
                        <i class="fas fa-list me-2"></i>Documentos Cadastrados
                    </div>
                    <div class="card-body p-0">
                        <div id="listaDocumentos">
                            <!-- Preenchido via JavaScript -->
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer py-2">
                <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>

<!-- MODAL: ENVIAR E-MAIL AO FORNECEDOR -->
<div class="modal fade" id="modalEnviarEmail" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-warning">
                <h5 class="modal-title"><i class="fas fa-envelope me-2"></i>Enviar E-mail ao Fornecedor</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="emailAvaliacaoId">
                
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label class="form-label">Fornecedor</label>
                        <input type="text" class="form-control" id="emailFornecedorNome" readonly>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">E-mail do Destinat√°rio *</label>
                        <input type="email" class="form-control" id="emailDestinatario" required>
                    </div>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">Assunto *</label>
                    <input type="text" class="form-control" id="emailAssunto" 
                           value="Solicita√ß√£o de Documenta√ß√£o - Certificado ISO">
                </div>
                
                <div class="mb-3">
                    <label class="form-label">Mensagem *</label>
                    <textarea class="form-control" id="emailMensagem" rows="12" style="font-size: 0.9rem;"></textarea>
                    <small class="text-muted">A mensagem pode ser editada antes do envio</small>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">Anexar Documento (opcional)</label>
                    <input type="file" class="form-control" id="emailAnexo" accept=".pdf,.doc,.docx,.xls,.xlsx">
                    <small class="text-muted">Ex.: Formul√°rio de avalia√ß√£o em branco para preenchimento</small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-warning" onclick="enviarEmailFornecedor()">
                    <i class="fas fa-paper-plane me-1"></i> Enviar E-mail
                </button>
            </div>
        </div>
    </div>
</div>

<!-- MODAL: BUSCAR FORNECEDOR TOTVS -->
<div class="modal fade" id="modalBuscarFornecedor" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-search me-2"></i>Buscar Fornecedor no TOTVS</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <div class="input-group">
                        <input type="text" class="form-control" id="termoBuscaFornecedor" 
                               placeholder="Digite c√≥digo ou nome do fornecedor...">
                        <button class="btn btn-primary" type="button" onclick="executarBuscaFornecedor()">
                            <i class="fas fa-search"></i> Buscar
                        </button>
                    </div>
                </div>
                <div id="resultadosBusca" class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                    <!-- Resultados da busca -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- MODAL VISUALIZAR DOCUMENTO (COM SUPORTE A PDF E WORD) -->
<div class="modal fade" id="modalPreviewDocumento" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-xl">
        <div class="modal-content border-0 shadow">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title"><i class="fas fa-file-alt me-2"></i><span id="previewDocumentoTitulo">Documento</span></h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-0" style="max-height: 80vh; overflow: auto; background: #f5f5f5;">
                <!-- Loading -->
                <div id="previewLoading" class="text-center py-5">
                    <div class="spinner-border text-success" role="status">
                        <span class="visually-hidden">Carregando...</span>
                    </div>
                    <p class="mt-2 text-muted">Carregando documento...</p>
                </div>
                
                <!-- PDF Viewer (iframe) -->
                <iframe id="previewPDF" src="" style="width: 100%; height: 70vh; border: none; display: none;"></iframe>
                
                <!-- Word Viewer (conte√∫do din√¢mico - PDF ou HTML) -->
                <div id="previewWord" style="display: none; width: 100%;">
                    <!-- Conte√∫do ser√° inserido dinamicamente via JavaScript -->
                </div>
                
                <!-- Erro / Formato n√£o suportado -->
                <div id="previewErro" class="text-center py-5 d-none">
                    <i class="fas fa-exclamation-triangle fa-3x text-warning mb-3"></i>
                    <p class="text-muted" id="previewErroMsg">N√£o foi poss√≠vel carregar o documento no navegador.</p>
                </div>
            </div>
            <div class="modal-footer">
                <a id="btnDownloadPreview" href="#" class="btn btn-outline-secondary" download>
                    <i class="fas fa-download me-1"></i> Baixar Arquivo
                </a>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>

<!-- MODAL: OBSERVA√á√ïES DO FORNECEDOR -->
<div class="modal fade" id="modalObservacao" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning">
                <h5 class="modal-title"><i class="fas fa-sticky-note me-2"></i>Observa√ß√µes Internas</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="mb-2"><strong>Fornecedor:</strong> <span id="obsFornecedorNome"></span></p>
                <input type="hidden" id="obsAvaliacaoId">
                
                <div class="mb-3">
                    <label class="form-label">Anota√ß√£o / Observa√ß√£o Interna:</label>
                    <textarea class="form-control" id="obsTexto" rows="5" 
                              placeholder="Digite suas anota√ß√µes sobre este fornecedor...&#10;&#10;Exemplos:&#10;- Fornecedor em processo de regulariza√ß√£o&#10;- Aguardando retorno at√© dia XX&#10;- Empresa pequena, sem ISO"></textarea>
                    <small class="text-muted">Uso interno - n√£o ser√° enviado ao fornecedor</small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-warning" onclick="salvarObservacao()">
                    <i class="fas fa-save me-1"></i> Salvar Observa√ß√£o
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Scripts -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap-select@1.14.0-beta3/dist/js/bootstrap-select.min.js"></script>
<script src="https://cdn.sheetjs.com/xlsx-0.19.1/package/dist/xlsx.full.min.js"></script>

<script>
// ============================================================================
// VARI√ÅVEIS GLOBAIS
// ============================================================================
let modalFornecedor, modalUpload, modalDocumentos, modalEnviarEmail, modalBuscarFornecedor, modalPreviewDocumento, modalObservacao, modalEmailLote;

// Sele√ß√£o m√∫ltipla
let fornecedoresSelecionados = [];

// ============================================================================
// FUN√á√ïES DE NORMALIZA√á√ÉO DE DATA (Suporte a Excel e Ctrl+V)
// ============================================================================

/**
 * Normaliza uma string de data para formato DD/MM/YYYY (padr√£o brasileiro)
 * Aceita: 08/10/2025, 8/10/25, 08-10-2025, 8-10-25, etc.
 * Anos 2 d√≠gitos: 25 ‚Üí 2025, 28 ‚Üí 2028
 */
function normalizarDataString(valor) {
    if (!valor || typeof valor !== 'string') return '';
    
    // Limpar espa√ßos e caracteres estranhos
    valor = valor.trim().replace(/\s+/g, '');
    
    // Se j√° est√° no formato DD/MM/YYYY, validar e retornar
    if (/^\d{2}\/\d{2}\/\d{4}$/.test(valor)) {
        return valor;
    }
    
    // Se est√° no formato YYYY-MM-DD, converter para DD/MM/YYYY
    if (/^\d{4}-\d{2}-\d{2}$/.test(valor)) {
        const [ano, mes, dia] = valor.split('-');
        return `${dia}/${mes}/${ano}`;
    }
    
    // Tentar detectar padr√µes de data
    let dia, mes, ano;
    
    // Formato brasileiro: DD/MM/YYYY ou DD/MM/YY ou D/M/YY ou D/M/YYYY
    // IMPORTANTE: Sempre interpreta como DD/MM (formato brasileiro)
    let match = valor.match(/^(\d{1,2})[\/\-\.](\d{1,2})[\/\-\.](\d{2,4})$/);
    if (match) {
        dia = parseInt(match[1], 10);
        mes = parseInt(match[2], 10);
        ano = parseInt(match[3], 10);
    }
    
    // Formato: YYYY/MM/DD ou YYYY-MM-DD (se come√ßa com 4 d√≠gitos, √© ano primeiro)
    if (!match) {
        match = valor.match(/^(\d{4})[\/\-\.](\d{1,2})[\/\-\.](\d{1,2})$/);
        if (match) {
            ano = parseInt(match[1], 10);
            mes = parseInt(match[2], 10);
            dia = parseInt(match[3], 10);
        }
    }
    
    // Se n√£o encontrou padr√£o v√°lido, retornar vazio
    if (!match || isNaN(dia) || isNaN(mes) || isNaN(ano)) {
        return '';
    }
    
    // Converter ano de 2 d√≠gitos para 4 d√≠gitos
    // Para datas de validade ISO, qualquer ano 2 d√≠gitos deve ser tratado como 2000+
    // Exemplos: 25 ‚Üí 2025, 28 ‚Üí 2028
    if (ano < 100) {
        ano = 2000 + ano;
    }
    
    // Validar ranges b√°sicos
    if (dia < 1 || dia > 31 || mes < 1 || mes > 12 || ano < 1900 || ano > 2100) {
        return '';
    }
    
    // Valida√ß√£o adicional de dias por m√™s
    const diasPorMes = [31, 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31];
    // Ano bissexto
    if ((ano % 4 === 0 && ano % 100 !== 0) || ano % 400 === 0) {
        diasPorMes[1] = 29;
    }
    if (dia > diasPorMes[mes - 1]) {
        return '';
    }
    
    // Formatar para DD/MM/YYYY (padr√£o brasileiro)
    return `${String(dia).padStart(2, '0')}/${String(mes).padStart(2, '0')}/${ano}`;
}

/**
 * Converte data de YYYY-MM-DD para DD/MM/YYYY (exibi√ß√£o)
 * Mantida para compatibilidade
 */
function formatarDataParaExibicao(valor) {
    if (!valor) return '';
    // Se j√° est√° em DD/MM/YYYY
    if (/^\d{2}\/\d{2}\/\d{4}$/.test(valor)) {
        return valor;
    }
    // Se est√° em YYYY-MM-DD
    const match = valor.match(/^(\d{4})-(\d{2})-(\d{2})$/);
    if (match) {
        return `${match[3]}/${match[2]}/${match[1]}`;
    }
    return valor;
}

/**
 * Handler para evento onblur - normaliza a data quando o usu√°rio sai do campo
 */
function normalizarData(input) {
    const valorOriginal = input.value;
    const valorNormalizado = normalizarDataString(valorOriginal);
    
    if (valorNormalizado) {
        // Atualizar com formato ISO para compatibilidade com backend
        input.value = valorNormalizado;
        input.classList.remove('is-invalid');
        input.classList.add('is-valid');
    } else if (valorOriginal.trim() !== '') {
        // Mostrar erro se digitou algo inv√°lido
        input.classList.remove('is-valid');
        input.classList.add('is-invalid');
        // Mostrar tooltip de erro
        input.title = 'Data inv√°lida. Use: DD/MM/AAAA';
    } else {
        // Campo vazio - limpar classes
        input.classList.remove('is-valid', 'is-invalid');
        input.title = '';
    }
}

/**
 * Handler para evento onpaste - permite colar do Excel e normaliza automaticamente
 */
function handleDataPaste(event) {
    // Permitir o paste acontecer normalmente
    setTimeout(() => {
        const input = event.target;
        // Normalizar ap√≥s o paste
        normalizarData(input);
    }, 10);
}

// ============================================================================
// INICIALIZA√á√ÉO
// ============================================================================
document.addEventListener('DOMContentLoaded', function() {
    // Inicializar modais
    modalFornecedor = new bootstrap.Modal(document.getElementById('modalFornecedor'));
    modalUpload = new bootstrap.Modal(document.getElementById('modalUpload'));
    modalDocumentos = new bootstrap.Modal(document.getElementById('modalDocumentos'));
    modalEnviarEmail = new bootstrap.Modal(document.getElementById('modalEnviarEmail'));
    modalBuscarFornecedor = new bootstrap.Modal(document.getElementById('modalBuscarFornecedor'));
    modalPreviewDocumento = new bootstrap.Modal(document.getElementById('modalPreviewDocumento'));
    modalObservacao = new bootstrap.Modal(document.getElementById('modalObservacao'));
    modalEmailLote = new bootstrap.Modal(document.getElementById('modalEmailLote'));
    
    // Inicializar tooltips
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
    
    // Carregar estado da sidebar
    const sidebarState = localStorage.getItem('sidebarCollapsed');
    const bulkBar = document.getElementById('bulkActionsBar');
    if (sidebarState === 'true') {
        document.getElementById('sidebar').classList.add('collapsed');
        document.getElementById('content').classList.add('expanded');
        document.getElementById('sidebarToggle').classList.add('collapsed');
        if (bulkBar) bulkBar.style.left = '0';
    }
    
    // Inicializar sele√ß√£o m√∫ltipla
    atualizarBulkActionsBar();
});

// ============================================================================
// SELE√á√ÉO M√öLTIPLA (BULK SELECTION)
// ============================================================================

// Toggle selecionar todos
function toggleSelectAll(checkbox) {
    const checkboxes = document.querySelectorAll('.row-checkbox');
    const rows = document.querySelectorAll('#tabelaAvaliacoes tbody tr');
    
    checkboxes.forEach((cb, index) => {
        // S√≥ seleciona linhas vis√≠veis
        const row = cb.closest('tr');
        if (row && row.style.display !== 'none') {
            cb.checked = checkbox.checked;
            if (checkbox.checked) {
                row.classList.add('row-selected');
            } else {
                row.classList.remove('row-selected');
            }
        }
    });
    
    atualizarFornecedoresSelecionados();
}

// Quando um checkbox individual muda
function onRowCheckboxChange(checkbox) {
    const row = checkbox.closest('tr');
    if (checkbox.checked) {
        row.classList.add('row-selected');
    } else {
        row.classList.remove('row-selected');
        // Desmarca o "selecionar todos" se algum foi desmarcado
        document.getElementById('selectAll').checked = false;
    }
    
    atualizarFornecedoresSelecionados();
}

// Atualizar array de fornecedores selecionados
function atualizarFornecedoresSelecionados() {
    fornecedoresSelecionados = [];
    const checkboxes = document.querySelectorAll('.row-checkbox:checked');
    
    checkboxes.forEach(cb => {
        fornecedoresSelecionados.push({
            id: cb.dataset.id,
            nome: cb.dataset.nome,
            codigo: cb.dataset.codigo,
            email: cb.dataset.email
        });
    });
    
    atualizarBulkActionsBar();
    
    // Verificar se todos os vis√≠veis est√£o selecionados
    const visibleCheckboxes = document.querySelectorAll('#tabelaAvaliacoes tbody tr:not([style*="display: none"]) .row-checkbox');
    const visibleChecked = document.querySelectorAll('#tabelaAvaliacoes tbody tr:not([style*="display: none"]) .row-checkbox:checked');
    document.getElementById('selectAll').checked = visibleCheckboxes.length > 0 && visibleCheckboxes.length === visibleChecked.length;
}

// Mostrar/ocultar barra de a√ß√µes em lote
function atualizarBulkActionsBar() {
    const bar = document.getElementById('bulkActionsBar');
    const count = document.getElementById('selectionCount');
    
    if (fornecedoresSelecionados.length > 0) {
        bar.classList.add('show');
        count.textContent = fornecedoresSelecionados.length;
    } else {
        bar.classList.remove('show');
    }
}

// Limpar toda a sele√ß√£o
function limparSelecao() {
    document.getElementById('selectAll').checked = false;
    document.querySelectorAll('.row-checkbox').forEach(cb => {
        cb.checked = false;
        cb.closest('tr').classList.remove('row-selected');
    });
    fornecedoresSelecionados = [];
    atualizarBulkActionsBar();
}

// Selecionar todos com mesmo nome (agrupar)
function selecionarMesmoNome() {
    if (fornecedoresSelecionados.length === 0) {
        alert('Selecione pelo menos um fornecedor para agrupar');
        return;
    }
    
    // Pegar os nomes √∫nicos j√° selecionados
    const nomesSelecionados = [...new Set(fornecedoresSelecionados.map(f => f.nome.toUpperCase().trim()))];
    
    // Selecionar todos que t√™m o mesmo nome
    document.querySelectorAll('.row-checkbox').forEach(cb => {
        const nomeCheckbox = cb.dataset.nome.toUpperCase().trim();
        if (nomesSelecionados.includes(nomeCheckbox)) {
            cb.checked = true;
            cb.closest('tr').classList.add('row-selected');
        }
    });
    
    atualizarFornecedoresSelecionados();
    
    // Feedback
    const total = fornecedoresSelecionados.length;
    const grupos = nomesSelecionados.length;
    alert(`${total} fornecedor(es) selecionado(s) em ${grupos} grupo(s)`);
}

// ============================================================================
// E-MAIL EM LOTE
// ============================================================================

function abrirModalEmailLote() {
    if (fornecedoresSelecionados.length === 0) {
        alert('Selecione pelo menos um fornecedor');
        return;
    }
    
    // Verificar se h√° e-mails v√°lidos
    const comEmail = fornecedoresSelecionados.filter(f => f.email && f.email.trim() !== '');
    const semEmail = fornecedoresSelecionados.filter(f => !f.email || f.email.trim() === '');
    
    // Montar lista de destinat√°rios
    let html = '';
    fornecedoresSelecionados.forEach(f => {
        const emailClass = f.email ? 'text-success' : 'text-danger';
        const emailIcon = f.email ? 'fa-check-circle' : 'fa-exclamation-circle';
        const emailText = f.email || 'Sem e-mail cadastrado';
        
        html += `
            <div class="d-flex justify-content-between align-items-center mb-2 pb-2 border-bottom">
                <div>
                    <strong>${f.nome}</strong>
                    <small class="text-muted ms-2">(${f.codigo})</small>
                </div>
                <span class="${emailClass}">
                    <i class="fas ${emailIcon} me-1"></i>
                    ${emailText}
                </span>
            </div>
        `;
    });
    
    // Aviso se houver fornecedores sem e-mail
    if (semEmail.length > 0) {
        html += `
            <div class="alert alert-warning mt-2 mb-0 py-2">
                <i class="fas fa-exclamation-triangle me-1"></i>
                <strong>${semEmail.length}</strong> fornecedor(es) sem e-mail cadastrado ser√£o ignorados.
            </div>
        `;
    }
    
    document.getElementById('listaDestinatariosLote').innerHTML = html;
    
    modalEmailLote.show();
}

async function enviarEmailsLote() {
    const comEmail = fornecedoresSelecionados.filter(f => f.email && f.email.trim() !== '');
    
    if (comEmail.length === 0) {
        alert('Nenhum fornecedor selecionado possui e-mail cadastrado');
        return;
    }
    
    const modo = document.querySelector('input[name="modoEnvioLote"]:checked').value;
    const tipo = document.getElementById('tipoCobrancaLote').value;
    const assunto = document.getElementById('assuntoEmailLote').value.trim();
    const corpo = document.getElementById('corpoEmailLote').value.trim();
    
    if (!assunto || !corpo) {
        alert('Preencha o assunto e a mensagem');
        return;
    }
    
    const confirmMsg = modo === 'individual' 
        ? `Ser√£o enviados ${comEmail.length} e-mails individuais. Continuar?`
        : `Ser√° enviado 1 e-mail com ${comEmail.length} destinat√°rios em c√≥pia. Continuar?`;
    
    if (!confirm(confirmMsg)) return;
    
    showLoading();
    
    try {
        const response = await fetch('/api/avaliacao-iso/enviar-email-lote', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'same-origin',
            body: JSON.stringify({
                fornecedores: comEmail,
                modo: modo,
                tipo: tipo,
                assunto: assunto,
                corpo: corpo
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert(`‚úÖ ${result.message || 'E-mails enviados com sucesso!'}\n\nEnviados: ${result.enviados || comEmail.length}\nErros: ${result.erros || 0}`);
            modalEmailLote.hide();
            limparSelecao();
        } else {
            alert('‚ùå Erro: ' + (result.error || 'Erro ao enviar e-mails'));
        }
    } catch (e) {
        console.error('Erro ao enviar e-mails:', e);
        alert('‚ùå Erro ao enviar e-mails: ' + e.message);
    }
    
    hideLoading();
}

// Atualizar assunto baseado no tipo de cobran√ßa
document.addEventListener('DOMContentLoaded', function() {
    const tipoSelect = document.getElementById('tipoCobrancaLote');
    if (tipoSelect) {
        tipoSelect.addEventListener('change', function() {
            const assuntoInput = document.getElementById('assuntoEmailLote');
            const corpoTextarea = document.getElementById('corpoEmailLote');
            
            switch(this.value) {
                case 'iso':
                    assuntoInput.value = 'Solicita√ß√£o de Certificado ISO - Polimaquinas';
                    corpoTextarea.value = `Prezado(a) Fornecedor,

Conforme nosso sistema de qualidade (ISO 9001), solicitamos gentilmente o envio do certificado ISO atualizado de sua empresa.

Caso n√£o possua certifica√ß√£o ISO, favor enviar declara√ß√£o informando.

Por favor, envie os documentos em resposta a este e-mail ou atrav√©s do nosso portal.

Atenciosamente,
Equipe de Compras - Polimaquinas`;
                    break;
                case 'avaliacao':
                    assuntoInput.value = 'Solicita√ß√£o de Avalia√ß√£o de Fornecedor - Polimaquinas';
                    corpoTextarea.value = `Prezado(a) Fornecedor,

Informamos que seu cadastro junto √† Polimaquinas necessita de atualiza√ß√£o de avalia√ß√£o.

Solicitamos o envio dos seguintes documentos:
- Question√°rio de avalia√ß√£o preenchido
- Documenta√ß√£o complementar

Por favor, envie em resposta a este e-mail ou atrav√©s do nosso portal.

Atenciosamente,
Equipe de Compras - Polimaquinas`;
                    break;
                case 'documentos':
                    assuntoInput.value = 'Solicita√ß√£o de Documentos - Polimaquinas';
                    corpoTextarea.value = `Prezado(a) Fornecedor,

Para atualiza√ß√£o de seu cadastro, solicitamos o envio da documenta√ß√£o necess√°ria.

Por favor, envie em resposta a este e-mail ou atrav√©s do nosso portal.

Atenciosamente,
Equipe de Compras - Polimaquinas`;
                    break;
                case 'personalizado':
                    assuntoInput.value = '';
                    corpoTextarea.value = '';
                    break;
            }
        });
    }
});

// ============================================================================
// SIDEBAR
// ============================================================================
function toggleSidebar() {
    const sidebar = document.getElementById('sidebar');
    const content = document.getElementById('content');
    const toggle = document.getElementById('sidebarToggle');
    const bulkBar = document.getElementById('bulkActionsBar');
    
    sidebar.classList.toggle('collapsed');
    content.classList.toggle('expanded');
    toggle.classList.toggle('collapsed');
    
    // Ajustar barra de a√ß√µes em lote
    if (bulkBar) {
        if (sidebar.classList.contains('collapsed')) {
            bulkBar.style.left = '0';
        } else {
            bulkBar.style.left = '250px';
        }
    }
    
    localStorage.setItem('sidebarCollapsed', sidebar.classList.contains('collapsed'));
}

// ============================================================================
// LOADING
// ============================================================================
function showLoading() {
    document.getElementById('loadingOverlay').classList.add('active');
}

function hideLoading() {
    document.getElementById('loadingOverlay').classList.remove('active');
}

// ============================================================================
// PRESERVA√á√ÉO DE ESTADO (Scroll, Filtros, Ordena√ß√£o)
// ============================================================================
/**
 * Salva o estado atual da p√°gina (scroll, filtros, ordena√ß√£o) no sessionStorage.
 * Chamado antes de qualquer reload para preservar a posi√ß√£o do usu√°rio.
 */
function salvarEstadoAtual() {
    const estado = {
        scrollY: window.scrollY,
        scrollX: window.scrollX,
        filtroNome: document.getElementById('filtroNome')?.value || '',
        filtroStatus: document.getElementById('filtroStatus')?.value || '',
        filtroISO: document.getElementById('filtroISO')?.value || '',
        sortColumn: currentSort.column,
        sortDirection: currentSort.direction,
        timestamp: Date.now()
    };
    sessionStorage.setItem('avaliacaoISO_estado', JSON.stringify(estado));
}

/**
 * Restaura o estado salvo (scroll, filtros, ordena√ß√£o).
 * Chamado automaticamente ao carregar a p√°gina.
 */
function restaurarEstado() {
    try {
        const estadoStr = sessionStorage.getItem('avaliacaoISO_estado');
        if (!estadoStr) return;
        
        const estado = JSON.parse(estadoStr);
        
        // Verificar se o estado √© recente (m√°x 30 segundos)
        if (Date.now() - estado.timestamp > 30000) {
            sessionStorage.removeItem('avaliacaoISO_estado');
            return;
        }
        
        // Restaurar filtros
        if (estado.filtroNome && document.getElementById('filtroNome')) {
            document.getElementById('filtroNome').value = estado.filtroNome;
        }
        if (estado.filtroStatus && document.getElementById('filtroStatus')) {
            document.getElementById('filtroStatus').value = estado.filtroStatus;
        }
        if (estado.filtroISO && document.getElementById('filtroISO')) {
            document.getElementById('filtroISO').value = estado.filtroISO;
        }
        
        // Aplicar filtros se houver algum
        if (estado.filtroNome || estado.filtroStatus || estado.filtroISO) {
            filtrarTabela();
        }
        
        // Restaurar ordena√ß√£o
        if (estado.sortColumn) {
            currentSort.column = estado.sortColumn;
            currentSort.direction = estado.sortDirection === 'asc' ? 'desc' : 'asc'; // Inverter pois sortTable vai inverter novamente
            sortTable(estado.sortColumn);
        }
        
        // Restaurar scroll com pequeno delay para garantir que a p√°gina renderizou
        setTimeout(() => {
            window.scrollTo(estado.scrollX || 0, estado.scrollY || 0);
        }, 100);
        
        // Limpar estado ap√≥s restaurar
        sessionStorage.removeItem('avaliacaoISO_estado');
        
    } catch (e) {
        console.warn('Erro ao restaurar estado:', e);
        sessionStorage.removeItem('avaliacaoISO_estado');
    }
}

/**
 * Faz reload preservando scroll, filtros e ordena√ß√£o.
 * Substitui location.reload() para manter continuidade do fluxo de trabalho.
 */
function reloadPreservandoEstado() {
    salvarEstadoAtual();
    location.reload();
}

/**
 * Faz reload preservando estado ap√≥s um delay (para toasts, etc).
 */
function reloadPreservandoEstadoComDelay(delayMs = 1500) {
    setTimeout(() => {
        salvarEstadoAtual();
        location.reload();
    }, delayMs);
}

// Restaurar estado ao carregar a p√°gina
document.addEventListener('DOMContentLoaded', function() {
    // Pequeno delay para garantir que os elementos est√£o prontos
    setTimeout(restaurarEstado, 50);
});

// ============================================================================
// FILTROS
// ============================================================================
function filtrarTabela() {
    const nome = document.getElementById('filtroNome').value.toLowerCase();
    const status = document.getElementById('filtroStatus').value;
    const iso = document.getElementById('filtroISO').value;
    
    const linhas = document.querySelectorAll('#tabelaAvaliacoes tbody tr');
    
    linhas.forEach(linha => {
        if (linha.querySelector('td[colspan]')) return; // Pular linha "nenhum resultado"
        
        const linhaNome = linha.dataset.nome || '';
        const linhaCodigo = linha.dataset.codigo || '';
        const linhaStatus = linha.dataset.status || '';
        const linhaISO = linha.dataset.iso || '';
        
        let mostrar = true;
        
        if (nome && !linhaNome.includes(nome) && !linhaCodigo.includes(nome)) {
            mostrar = false;
        }
        if (status && linhaStatus !== status) {
            mostrar = false;
        }
        if (iso && linhaISO !== iso) {
            mostrar = false;
        }
        
        linha.style.display = mostrar ? '' : 'none';
    });
}

function limparFiltros() {
    document.getElementById('filtroNome').value = '';
    document.getElementById('filtroStatus').value = '';
    document.getElementById('filtroISO').value = '';
    filtrarTabela();
}

// ============================================================================
// TOAST NOTIFICATIONS (Feedback visual claro)
// ============================================================================
function showToast(message, type = 'success', duration = 4000) {
    const container = document.getElementById('toastContainer');
    if (!container) return;
    
    const icons = {
        success: 'fa-check-circle',
        error: 'fa-times-circle',
        warning: 'fa-exclamation-triangle',
        info: 'fa-info-circle'
    };
    
    const toast = document.createElement('div');
    toast.className = `toast-custom toast-${type}`;
    toast.innerHTML = `
        <i class="fas ${icons[type] || icons.info}" style="font-size: 1.2rem;"></i>
        <span>${message}</span>
        <button class="toast-close" onclick="this.parentElement.remove()">&times;</button>
    `;
    container.appendChild(toast);
    
    setTimeout(() => {
        toast.classList.add('toast-hide');
        setTimeout(() => toast.remove(), 350);
    }, duration);
}

// ============================================================================
// SORTING - Ordena√ß√£o din√¢mica por coluna
// ============================================================================
let currentSort = { column: null, direction: 'asc' };

/**
 * Converte data DD/MM/YYYY para valor num√©rico compar√°vel (YYYYMMDD)
 */
function parseDateToSortValue(dateStr) {
    if (!dateStr || dateStr === '-' || dateStr.trim() === '') return 99999999; // Sem data = vai pro final
    const str = dateStr.trim();
    // Formato DD/MM/YYYY
    const match = str.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
    if (match) {
        return parseInt(match[3]) * 10000 + parseInt(match[2]) * 100 + parseInt(match[1]);
    }
    // Formato YYYY-MM-DD
    const match2 = str.match(/^(\d{4})-(\d{2})-(\d{2})$/);
    if (match2) {
        return parseInt(match2[1]) * 10000 + parseInt(match2[2]) * 100 + parseInt(match2[3]);
    }
    return 99999999;
}

function sortTable(column) {
    const tbody = document.querySelector('#tabelaAvaliacoes tbody');
    const rows = Array.from(tbody.querySelectorAll('tr'));
    
    // Skip if only one "no data" row
    if (rows.length <= 1 && rows[0] && rows[0].querySelector('td[colspan]')) return;
    
    // Toggle direction
    if (currentSort.column === column) {
        currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
    } else {
        currentSort.column = column;
        currentSort.direction = 'asc';
    }
    
    // Update visual indicators on headers
    document.querySelectorAll('.sortable-header').forEach(th => {
        th.classList.remove('sort-asc', 'sort-desc');
    });
    const activeHeader = document.querySelector(`.sortable-header[data-sort="${column}"]`);
    if (activeHeader) {
        activeHeader.classList.add(currentSort.direction === 'asc' ? 'sort-asc' : 'sort-desc');
    }
    
    // Sort rows
    rows.sort((a, b) => {
        let valA, valB;
        
        switch (column) {
            case 'fornecedor':
                valA = (a.dataset.nome || '').toLowerCase();
                valB = (b.dataset.nome || '').toLowerCase();
                return currentSort.direction === 'asc' 
                    ? valA.localeCompare(valB, 'pt-BR') 
                    : valB.localeCompare(valA, 'pt-BR');
            
            case 'avaliacao':
                valA = parseDateToSortValue(a.dataset.dataAvaliacao);
                valB = parseDateToSortValue(b.dataset.dataAvaliacao);
                // First click: most recent first (desc), second: oldest first (asc)
                return currentSort.direction === 'asc' 
                    ? valB - valA  // Mais recente primeiro
                    : valA - valB; // Mais antigo primeiro
            
            case 'vencimento':
                valA = parseDateToSortValue(a.dataset.dataVencimento);
                valB = parseDateToSortValue(b.dataset.dataVencimento);
                // First click: closest to expire first (asc), second: farthest (desc)
                return currentSort.direction === 'asc' 
                    ? valA - valB  // Mais pr√≥ximo de vencer primeiro
                    : valB - valA; // Mais distante primeiro
            
            case 'status':
                valA = parseInt(a.dataset.statusOrder || '3');
                valB = parseInt(b.dataset.statusOrder || '3');
                // First click: vencido > pr√≥ximo > v√°lido > indefinido
                if (valA !== valB) {
                    return currentSort.direction === 'asc' 
                        ? valA - valB 
                        : valB - valA;
                }
                // Tiebreaker: by days remaining
                const diasA = parseInt(a.dataset.diasRestantes) || 0;
                const diasB = parseInt(b.dataset.diasRestantes) || 0;
                return currentSort.direction === 'asc' ? diasA - diasB : diasB - diasA;
            
            default:
                return 0;
        }
    });
    
    // Re-append sorted rows
    rows.forEach(row => tbody.appendChild(row));
}

// ============================================================================
// IMPORTA√á√ÉO EM MASSA VIA EXCEL
// ============================================================================
let modalImportarExcel = null;

function abrirModalImportarExcel() {
    if (!modalImportarExcel) {
        modalImportarExcel = new bootstrap.Modal(document.getElementById('modalImportarExcel'));
    }
    resetarModalImportacao();
    modalImportarExcel.show();
}

function resetarModalImportacao() {
    // Resetar para etapa 1
    document.getElementById('etapaUploadExcel').classList.remove('d-none');
    document.getElementById('etapaProcessandoExcel').classList.add('d-none');
    document.getElementById('etapaResultadoExcel').classList.add('d-none');
    
    // Limpar arquivo
    document.getElementById('arquivoExcelISO').value = '';
    document.getElementById('infoArquivoExcel').classList.add('d-none');
    
    // Resetar bot√µes
    document.getElementById('btnProcessarExcel').disabled = true;
    document.getElementById('btnProcessarExcel').classList.remove('d-none');
    document.getElementById('btnNovaImportacao').classList.add('d-none');
    
    // Limpar resultados
    document.getElementById('resultadoSucesso').classList.add('d-none');
    document.getElementById('resultadoErro').classList.add('d-none');
    document.getElementById('estatisticasImportacao').classList.add('d-none');
    document.getElementById('listaNaoEncontrados').classList.add('d-none');
}

function validarArquivoExcel(input) {
    const arquivo = input.files[0];
    const btnProcessar = document.getElementById('btnProcessarExcel');
    const infoArquivo = document.getElementById('infoArquivoExcel');
    
    if (!arquivo) {
        btnProcessar.disabled = true;
        infoArquivo.classList.add('d-none');
        return;
    }
    
    // Verificar extens√£o
    const extensao = arquivo.name.split('.').pop().toLowerCase();
    if (!['xlsx', 'xls'].includes(extensao)) {
        alert('Formato inv√°lido! Selecione um arquivo Excel (.xlsx ou .xls)');
        input.value = '';
        btnProcessar.disabled = true;
        infoArquivo.classList.add('d-none');
        return;
    }
    
    // Mostrar info do arquivo
    document.getElementById('nomeArquivoExcel').textContent = arquivo.name;
    document.getElementById('tamanhoArquivoExcel').textContent = formatarTamanho(arquivo.size);
    infoArquivo.classList.remove('d-none');
    
    // Habilitar bot√£o
    btnProcessar.disabled = false;
}

function formatarTamanho(bytes) {
    if (bytes < 1024) return bytes + ' B';
    if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
    return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
}

async function processarImportacaoExcel() {
    const arquivo = document.getElementById('arquivoExcelISO').files[0];
    
    if (!arquivo) {
        alert('Selecione um arquivo Excel primeiro!');
        return;
    }
    
    // Confirmar
    if (!confirm(`Deseja processar a importa√ß√£o do arquivo "${arquivo.name}"?\n\nEsta a√ß√£o ir√°:\n- Ler o arquivo Excel\n- Buscar os fornecedores no TOTVS\n- Importar os dados para a Avalia√ß√£o ISO`)) {
        return;
    }
    
    // Mostrar etapa de processamento
    document.getElementById('etapaUploadExcel').classList.add('d-none');
    document.getElementById('etapaProcessandoExcel').classList.remove('d-none');
    document.getElementById('btnProcessarExcel').disabled = true;
    
    try {
        const formData = new FormData();
        formData.append('arquivo', arquivo);
        
        const response = await fetch('/api/avaliacao-iso/importar-excel', {
            method: 'POST',
            credentials: 'same-origin',
            body: formData
        });
        
        const data = await response.json();
        
        // Esconder processamento
        document.getElementById('etapaProcessandoExcel').classList.add('d-none');
        document.getElementById('etapaResultadoExcel').classList.remove('d-none');
        
        if (data.success) {
            // Mostrar sucesso
            document.getElementById('resultadoSucesso').classList.remove('d-none');
            document.getElementById('estatisticasImportacao').classList.remove('d-none');
            
            // Preencher estat√≠sticas
            const r = data.relatorio;
            document.getElementById('statTotal').textContent = r.total_linhas || 0;
            document.getElementById('statImportados').textContent = r.importados || 0;
            document.getElementById('statExistentes').textContent = r.ja_existentes || 0;
            document.getElementById('statNaoEncontrados').textContent = r.nao_encontrados || 0;
            
            // Lista de n√£o encontrados
            if (r.detalhes_nao_encontrados && r.detalhes_nao_encontrados.length > 0) {
                document.getElementById('listaNaoEncontrados').classList.remove('d-none');
                const tbody = document.getElementById('tbodyNaoEncontrados');
                tbody.innerHTML = '';
                
                r.detalhes_nao_encontrados.forEach(item => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td class="text-center">${item.linha}</td>
                        <td>${escapeHtml(item.nome)}</td>
                        <td><small class="text-danger">${escapeHtml(item.motivo)}</small></td>
                    `;
                    tbody.appendChild(tr);
                });
            }
            
            // Se houve importa√ß√µes, recarregar a p√°gina ao fechar (preservando estado)
            if (r.importados > 0) {
                document.getElementById('modalImportarExcel').addEventListener('hidden.bs.modal', function handler() {
                    reloadPreservandoEstado();
                    this.removeEventListener('hidden.bs.modal', handler);
                });
            }
            
        } else {
            // Mostrar erro
            document.getElementById('resultadoErro').classList.remove('d-none');
            document.getElementById('mensagemErroImportacao').textContent = data.error || 'Erro desconhecido na importa√ß√£o.';
        }
        
        // Mostrar bot√£o de nova importa√ß√£o
        document.getElementById('btnProcessarExcel').classList.add('d-none');
        document.getElementById('btnNovaImportacao').classList.remove('d-none');
        
    } catch (e) {
        console.error('[IMPORTACAO EXCEL] Erro:', e);
        
        document.getElementById('etapaProcessandoExcel').classList.add('d-none');
        document.getElementById('etapaResultadoExcel').classList.remove('d-none');
        document.getElementById('resultadoErro').classList.remove('d-none');
        document.getElementById('mensagemErroImportacao').textContent = 'Erro de conex√£o: ' + e.message;
        
        document.getElementById('btnProcessarExcel').classList.add('d-none');
        document.getElementById('btnNovaImportacao').classList.remove('d-none');
    }
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// ============================================================================
// MODAL: NOVO FORNECEDOR
// ============================================================================
let documentosPendentes = []; // Lista de documentos para upload ap√≥s criar fornecedor
let contadorBlocoDocumento = 1; // Contador para IDs √∫nicos dos blocos

function abrirModalNovo() {
    document.getElementById('modalFornecedorTitulo').innerHTML = '<i class="fas fa-plus-circle me-2"></i>Novo Fornecedor';
    document.getElementById('formFornecedor').reset();
    document.getElementById('avaliacaoId').value = '';
    document.getElementById('codFornecedor').readOnly = false;
    
    // Resetar blocos de documentos para apenas 1
    resetarBlocosDocumentos();
    
    // Mostrar se√ß√£o de documentos (upload sempre vis√≠vel)
    document.getElementById('secaoDocumentosModal').classList.remove('d-none');
    
    // Limpar documentos pendentes e lista
    documentosPendentes = [];
    atualizarListaDocumentosPendentes();
    
    modalFornecedor.show();
}

// ============================================================================
// MODAL: EDITAR FORNECEDOR
// ============================================================================
async function abrirModalEditar(id) {
    showLoading();
    try {
        const response = await fetch(`/api/avaliacao-iso/${id}`);
        const data = await response.json();
        
        if (data.success) {
            const av = data.avaliacao;
            document.getElementById('modalFornecedorTitulo').innerHTML = '<i class="fas fa-edit me-2"></i>Editar Fornecedor';
            document.getElementById('avaliacaoId').value = av.id;
            document.getElementById('codFornecedor').value = av.cod_fornecedor;
            document.getElementById('codFornecedor').readOnly = true;
            document.getElementById('nomeFornecedor').value = av.nome_fornecedor || '';
            document.getElementById('emailFornecedor').value = av.email_fornecedor || '';
            document.getElementById('possuiISO').value = av.possui_iso || 'Nao';
            document.getElementById('dataUltimaAvaliacao').value = av.data_ultima_avaliacao || '';
            document.getElementById('dataVencimento').value = av.data_vencimento || '';
            document.getElementById('observacao').value = av.observacao || '';
            
            // Resetar blocos de documentos para apenas 1
            resetarBlocosDocumentos();
            
            // Mostrar se√ß√£o de documentos no modo edi√ß√£o (upload sempre vis√≠vel)
            document.getElementById('secaoDocumentosModal').classList.remove('d-none');
            
            // Carregar lista de documentos
            carregarDocumentosNoModal(av.documentos || []);
            
            modalFornecedor.show();
        } else {
            alert('Erro ao carregar dados: ' + data.error);
        }
    } catch (e) {
        alert('Erro ao carregar dados: ' + e.message);
    }
    hideLoading();
}

// Toggle se√ß√£o de upload no modal (fun√ß√£o mantida para compatibilidade, mas n√£o mais necess√°ria)
function toggleUploadSection() {
    // Campos sempre vis√≠veis agora - fun√ß√£o mantida apenas para compatibilidade
}

// ============================================================================
// GERENCIAMENTO DE BLOCOS DE DOCUMENTOS M√öLTIPLOS
// ============================================================================

// Resetar para apenas 1 bloco de documento (usado ao abrir modal)
function resetarBlocosDocumentos() {
    contadorBlocoDocumento = 1;
    const container = document.getElementById('containerDocumentosModal');
    container.innerHTML = `
        <div class="card bg-light border-0 mb-2 bloco-documento" data-index="1">
            <div class="card-body py-3">
                <div class="d-flex justify-content-between align-items-start mb-2">
                    <span class="badge bg-secondary">Documento #1</span>
                </div>
                <div class="row g-2">
                    <div class="col-md-4">
                        <label class="form-label small fw-bold mb-1">Arquivo</label>
                        <input type="file" class="form-control form-control-sm arquivo-documento" accept=".pdf,.doc,.docx">
                        <small class="text-muted">PDF, DOC ou DOCX - M√°x 10MB</small>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label small fw-bold mb-1">Nome <span class="text-muted">(Opcional)</span></label>
                        <input type="text" class="form-control form-control-sm nome-documento" 
                               placeholder="Deixe vazio para usar nome do arquivo">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label small fw-bold mb-1">Tipo</label>
                        <select class="form-select form-select-sm tipo-documento">
                            <option value="relatorio_avaliacao">üìã Relat√≥rio</option>
                            <option value="iso">üìú Certificado ISO</option>
                            <option value="contrato">üìù Contrato</option>
                            <option value="declaracao">üìÑ Declara√ß√£o</option>
                            <option value="outro">üìé Outro</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
    `;
}

// Adicionar novo bloco de documento
function adicionarBlocoDocumento() {
    contadorBlocoDocumento++;
    const container = document.getElementById('containerDocumentosModal');
    
    const novoBloco = document.createElement('div');
    novoBloco.className = 'card bg-light border-0 mb-2 bloco-documento';
    novoBloco.setAttribute('data-index', contadorBlocoDocumento);
    novoBloco.innerHTML = `
        <div class="card-body py-3">
            <div class="d-flex justify-content-between align-items-start mb-2">
                <span class="badge bg-secondary">Documento #${contadorBlocoDocumento}</span>
                <button type="button" class="btn btn-sm btn-outline-danger py-0 px-2" onclick="removerBlocoDocumento(this)" title="Remover documento">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="row g-2">
                <div class="col-md-4">
                    <label class="form-label small fw-bold mb-1">Arquivo</label>
                    <input type="file" class="form-control form-control-sm arquivo-documento" accept=".pdf,.doc,.docx">
                    <small class="text-muted">PDF, DOC ou DOCX - M√°x 10MB</small>
                </div>
                <div class="col-md-4">
                    <label class="form-label small fw-bold mb-1">Nome <span class="text-muted">(Opcional)</span></label>
                    <input type="text" class="form-control form-control-sm nome-documento" 
                           placeholder="Deixe vazio para usar nome do arquivo">
                </div>
                <div class="col-md-4">
                    <label class="form-label small fw-bold mb-1">Tipo</label>
                    <select class="form-select form-select-sm tipo-documento">
                        <option value="relatorio_avaliacao">üìã Relat√≥rio</option>
                        <option value="iso">üìú Certificado ISO</option>
                        <option value="contrato">üìù Contrato</option>
                        <option value="declaracao">üìÑ Declara√ß√£o</option>
                        <option value="outro">üìé Outro</option>
                    </select>
                </div>
            </div>
        </div>
    `;
    
    container.appendChild(novoBloco);
    
    // Scroll para o novo bloco
    novoBloco.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

// Remover bloco de documento
function removerBlocoDocumento(btn) {
    const bloco = btn.closest('.bloco-documento');
    bloco.remove();
    
    // Renumerar blocos restantes
    renumerarBlocosDocumentos();
}

// Renumerar badges dos blocos ap√≥s remo√ß√£o
function renumerarBlocosDocumentos() {
    const blocos = document.querySelectorAll('#containerDocumentosModal .bloco-documento');
    blocos.forEach((bloco, idx) => {
        const badge = bloco.querySelector('.badge');
        if (badge) {
            badge.textContent = `Documento #${idx + 1}`;
        }
        bloco.setAttribute('data-index', idx + 1);
    });
}

// Coletar todos os documentos dos blocos para upload
function coletarDocumentosDoBlocos() {
    const documentos = [];
    const blocos = document.querySelectorAll('#containerDocumentosModal .bloco-documento');
    
    blocos.forEach(bloco => {
        const arquivo = bloco.querySelector('.arquivo-documento').files[0];
        if (arquivo) {
            let nome = bloco.querySelector('.nome-documento').value.trim();
            const tipo = bloco.querySelector('.tipo-documento').value;
            
            // Se nome n√£o informado, usar nome do arquivo
            if (!nome) {
                nome = arquivo.name.replace(/\.[^/.]+$/, '');
            }
            
            documentos.push({
                nome: nome,
                tipo: tipo,
                arquivo: arquivo
            });
        }
    });
    
    return documentos;
}

// Carregar documentos na lista do modal
function carregarDocumentosNoModal(documentos) {
    const container = document.getElementById('listaDocumentosModal');
    
    if (!documentos || documentos.length === 0) {
        container.innerHTML = `
            <div class="text-muted text-center py-2">
                <i class="fas fa-folder-open me-1"></i> Nenhum documento anexado
            </div>`;
        return;
    }
    
    const tipoIcone = {
        'iso': { icone: 'fa-certificate', cor: 'text-success', label: 'ISO' },
        'certificado_iso': { icone: 'fa-certificate', cor: 'text-success', label: 'ISO' },
        'relatorio_avaliacao': { icone: 'fa-file-alt', cor: 'text-primary', label: 'Relat√≥rio' },
        'avaliacao': { icone: 'fa-file-alt', cor: 'text-primary', label: 'Relat√≥rio' },
        'contrato': { icone: 'fa-file-contract', cor: 'text-warning', label: 'Contrato' },
        'declaracao': { icone: 'fa-file-signature', cor: 'text-info', label: 'Declara√ß√£o' },
        'outro': { icone: 'fa-paperclip', cor: 'text-secondary', label: 'Outro' }
    };
    
    let html = '<div class="list-group list-group-flush">';
    documentos.forEach(doc => {
        const tipo = tipoIcone[doc.tipo_documento] || tipoIcone['outro'];
        html += `
            <div class="list-group-item d-flex justify-content-between align-items-center py-2 px-2">
                <div class="d-flex align-items-center">
                    <i class="fas ${tipo.icone} ${tipo.cor} me-2"></i>
                    <div>
                        <div class="fw-medium" style="font-size: 0.85rem;">${doc.nome_documento || 'Documento'}</div>
                        <small class="text-muted">${tipo.label}</small>
                    </div>
                </div>
                <div class="btn-group btn-group-sm">
                    <a href="${doc.arquivo_url}" target="_blank" class="btn btn-outline-info btn-sm" title="Visualizar">
                        <i class="fas fa-eye"></i>
                    </a>
                    <button class="btn btn-outline-danger btn-sm" onclick="excluirDocumentoDoModal(${doc.id})" title="Excluir">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>`;
    });
    html += '</div>';
    
    container.innerHTML = html;
}

// Enviar documento do modal de edi√ß√£o
async function enviarDocumentoDoModal() {
    const avaliacaoId = document.getElementById('avaliacaoId').value;
    let nome = document.getElementById('nomeDocumentoModal').value.trim();
    const tipo = document.getElementById('tipoDocumentoModal').value;
    const arquivo = document.getElementById('arquivoUploadModal').files[0];
    
    if (!arquivo) {
        alert('Selecione um arquivo para enviar');
        document.getElementById('arquivoUploadModal').focus();
        return;
    }
    
    // Se nome n√£o foi informado, usar nome do arquivo
    if (!nome) {
        nome = arquivo.name.replace(/\.[^/.]+$/, ''); // Remove extens√£o
    }
    
    // Se ainda n√£o tem ID (cria√ß√£o), adicionar √† lista de pendentes
    if (!avaliacaoId) {
        documentosPendentes.push({
            nome: nome,
            tipo: tipo,
            arquivo: arquivo
        });
        
        // Limpar campos
        document.getElementById('nomeDocumentoModal').value = '';
        document.getElementById('arquivoUploadModal').value = '';
        
        // Atualizar lista visual
        atualizarListaDocumentosPendentes();
        
        // Mostrar feedback
        const btn = event.target;
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-check me-1"></i> Adicionado!';
        btn.classList.replace('btn-success', 'btn-info');
        setTimeout(() => {
            btn.innerHTML = originalText;
            btn.classList.replace('btn-info', 'btn-success');
        }, 1500);
        
        return;
    }
    
    // Se tem ID (edi√ß√£o), enviar diretamente
    const formData = new FormData();
    formData.append('nome_documento', nome);
    formData.append('tipo_documento', tipo);
    formData.append('arquivo', arquivo);
    
    showLoading();
    try {
        const response = await fetch(`/api/avaliacao-iso/${avaliacaoId}/upload`, {
            method: 'POST',
            credentials: 'same-origin',
            body: formData
        });
        const data = await response.json();
        
        if (data.success) {
            // Limpar campos
            document.getElementById('nomeDocumentoModal').value = '';
            document.getElementById('arquivoUploadModal').value = '';
            
            // Recarregar dados para atualizar lista
            const resposta = await fetch(`/api/avaliacao-iso/${avaliacaoId}`);
            const dados = await resposta.json();
            if (dados.success) {
                carregarDocumentosNoModal(dados.avaliacao.documentos || []);
            }
            
            // Feedback visual
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-success alert-dismissible fade show mb-0 mt-2';
            alertDiv.innerHTML = `
                <i class="fas fa-check-circle me-2"></i>Documento "${nome}" enviado com sucesso!
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.getElementById('uploadSectionInModal').appendChild(alertDiv);
            setTimeout(() => alertDiv.remove(), 3000);
        } else {
            alert('Erro ao enviar documento: ' + data.error);
        }
    } catch (e) {
        console.error('Erro ao enviar documento:', e);
        alert('Erro ao enviar documento: ' + e.message);
    } finally {
        hideLoading();
    }
}

// Excluir documento do modal
async function excluirDocumentoDoModal(docId) {
    if (!confirm('Deseja excluir este documento?')) return;
    
    const avaliacaoId = document.getElementById('avaliacaoId').value;
    
    showLoading();
    try {
        const response = await fetch(`/api/avaliacao-iso/documento/${docId}/excluir`, {
            method: 'POST',
            credentials: 'same-origin'
        });
        const data = await response.json();
        
        if (data.success) {
            // Recarregar dados
            const resposta = await fetch(`/api/avaliacao-iso/${avaliacaoId}`);
            const dados = await resposta.json();
            if (dados.success) {
                carregarDocumentosNoModal(dados.avaliacao.documentos || []);
            }
        } else {
            alert('Erro: ' + data.error);
        }
    } catch (e) {
        alert('Erro ao excluir: ' + e.message);
    }
    hideLoading();
}

// Atualizar lista visual de documentos pendentes (para cria√ß√£o)
function atualizarListaDocumentosPendentes() {
    const container = document.getElementById('listaDocumentosModal');
    
    if (documentosPendentes.length === 0) {
        container.innerHTML = `
            <div class="text-muted text-center py-2">
                <i class="fas fa-folder-open me-1"></i> Nenhum documento anexado
            </div>`;
        return;
    }
    
    const tipoIcone = {
        'iso': { icone: 'fa-certificate', cor: 'text-success', label: 'ISO' },
        'relatorio_avaliacao': { icone: 'fa-file-alt', cor: 'text-primary', label: 'Relat√≥rio' },
        'contrato': { icone: 'fa-file-contract', cor: 'text-warning', label: 'Contrato' },
        'declaracao': { icone: 'fa-file-signature', cor: 'text-info', label: 'Declara√ß√£o' },
        'outro': { icone: 'fa-paperclip', cor: 'text-secondary', label: 'Outro' }
    };
    
    let html = '<div class="list-group list-group-flush">';
    documentosPendentes.forEach((doc, index) => {
        const tipo = tipoIcone[doc.tipo] || tipoIcone['outro'];
        html += `
            <div class="list-group-item d-flex justify-content-between align-items-center py-2 px-2 bg-light">
                <div class="d-flex align-items-center">
                    <i class="fas ${tipo.icone} ${tipo.cor} me-2"></i>
                    <div>
                        <div class="fw-medium" style="font-size: 0.85rem;">${doc.nome}</div>
                        <small class="text-muted">${tipo.label} - ${doc.arquivo.name}</small>
                    </div>
                </div>
                <button class="btn btn-outline-danger btn-sm" onclick="removerDocumentoPendente(${index})" title="Remover">
                    <i class="fas fa-times"></i>
                </button>
            </div>`;
    });
    html += '</div>';
    html += `<div class="alert alert-info small mt-2 mb-0 py-2">
        <i class="fas fa-info-circle me-1"></i>
        ${documentosPendentes.length} documento(s) ser√£o enviados ao salvar
    </div>`;
    
    container.innerHTML = html;
}

// Remover documento pendente da lista
function removerDocumentoPendente(index) {
    documentosPendentes.splice(index, 1);
    atualizarListaDocumentosPendentes();
}

// ============================================================================
// SALVAR FORNECEDOR
// ============================================================================
async function salvarFornecedor() {
    const id = document.getElementById('avaliacaoId').value;
    
    // Validar datas ANTES de enviar
    const dataUltimaAvalInput = document.getElementById('dataUltimaAvaliacao');
    const dataVencimentoInput = document.getElementById('dataVencimento');
    
    // Verificar se campos de data t√™m classe is-invalid (data inv√°lida)
    if (dataUltimaAvalInput.classList.contains('is-invalid')) {
        alert('A Data da √öltima Avalia√ß√£o √© inv√°lida!\n\nVerifique se a data existe (ex: 29/02 s√≥ existe em anos bissextos).');
        dataUltimaAvalInput.focus();
        return;
    }
    if (dataVencimentoInput.classList.contains('is-invalid')) {
        alert('A Data de Vencimento √© inv√°lida!\n\nVerifique se a data existe (ex: 29/02 s√≥ existe em anos bissextos).');
        dataVencimentoInput.focus();
        return;
    }
    
    // Validar datas manualmente tamb√©m (caso usu√°rio n√£o tenha sa√≠do do campo)
    const dataVencStr = dataVencimentoInput.value.trim();
    if (dataVencStr && !normalizarDataString(dataVencStr)) {
        alert('A Data de Vencimento "' + dataVencStr + '" √© inv√°lida!\n\nVerifique se a data existe (ex: 29/02 s√≥ existe em anos bissextos como 2024, 2028).');
        dataVencimentoInput.focus();
        return;
    }
    
    const dataAvalStr = dataUltimaAvalInput.value.trim();
    if (dataAvalStr && !normalizarDataString(dataAvalStr)) {
        alert('A Data da √öltima Avalia√ß√£o "' + dataAvalStr + '" √© inv√°lida!\n\nVerifique se a data existe.');
        dataUltimaAvalInput.focus();
        return;
    }
    
    const dados = {
        cod_fornecedor: document.getElementById('codFornecedor').value.trim(),
        nome_fornecedor: document.getElementById('nomeFornecedor').value.trim(),
        email_fornecedor: document.getElementById('emailFornecedor').value.trim(),
        possui_iso: document.getElementById('possuiISO').value,
        data_ultima_avaliacao: dataAvalStr ? normalizarDataString(dataAvalStr) : null,
        data_vencimento: dataVencStr ? normalizarDataString(dataVencStr) : null,
        observacao: document.getElementById('observacao').value.trim()
    };
    
    if (!dados.cod_fornecedor || !dados.nome_fornecedor) {
        alert('C√≥digo e nome do fornecedor s√£o obrigat√≥rios!');
        return;
    }
    
    // Coletar TODOS os documentos dos blocos din√¢micos
    const documentosDoBlocos = coletarDocumentosDoBlocos();
    
    // Adicionar documentos dos blocos √† lista de pendentes
    documentosDoBlocos.forEach(doc => {
        documentosPendentes.push(doc);
    });
    
    showLoading();
    try {
        const url = id ? `/api/avaliacao-iso/${id}/atualizar` : '/api/avaliacao-iso/criar';
        const response = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'same-origin',
            body: JSON.stringify(dados)
        });
        const data = await response.json();
        
        if (response.status === 401) {
            alert('Sess√£o expirada. Fa√ßa login novamente.');
            window.location.href = '/login';
            return;
        }
        
        if (data.success) {
            const fornecedorId = id || data.id; // ID do fornecedor (existente ou novo)
            let uploadErros = [];
            let uploadSucessos = 0;
            let tentouUpload = false;
            
            // Se tem documentos pendentes, enviar cada um
            if (documentosPendentes.length > 0) {
                tentouUpload = true;
                console.log(`üì§ Enviando ${documentosPendentes.length} documento(s)...`);
                
                for (const doc of documentosPendentes) {
                    const formData = new FormData();
                    formData.append('nome_documento', doc.nome);
                    formData.append('tipo_documento', doc.tipo);
                    formData.append('arquivo', doc.arquivo);
                    
                    try {
                        const respUpload = await fetch(`/api/avaliacao-iso/${fornecedorId}/upload`, {
                            method: 'POST',
                            credentials: 'same-origin',
                            body: formData
                        });
                        const dataUpload = await respUpload.json();
                        if (dataUpload.success) {
                            uploadSucessos++;
                        } else {
                            uploadErros.push(doc.nome);
                        }
                    } catch (e) {
                        uploadErros.push(doc.nome);
                    }
                }
                
                // Limpar lista
                documentosPendentes = [];
            }
            
            // Fechar modal e mostrar feedback via toast
            modalFornecedor.hide();
            hideLoading();
            
            if (uploadErros.length > 0) {
                showToast(`Fornecedor salvo! ${uploadSucessos} doc(s) enviado(s), ${uploadErros.length} falha(s): ${uploadErros.join(', ')}`, 'warning', 6000);
            } else if (tentouUpload) {
                showToast(`Fornecedor e ${uploadSucessos} documento(s) salvos com sucesso!`, 'success');
            } else {
                showToast(data.message || 'Fornecedor salvo com sucesso!', 'success');
            }
            
            reloadPreservandoEstadoComDelay(1500);
        } else {
            showToast('Erro: ' + (data.error || 'Erro desconhecido'), 'error');
        }
    } catch (e) {
        console.error('Erro ao salvar:', e);
        alert('Erro ao salvar fornecedor: ' + e.message);
    } finally {
        hideLoading();
    }
}

// ============================================================================
// BUSCAR FORNECEDOR NO TOTVS - INLINE (SEM MODAL)
// ============================================================================
let buscaTimeout = null;
let autocompleteAberto = false;

// Busca por c√≥digo (Enter ou clique no bot√£o)
async function buscarPorCodigo() {
    const codigo = document.getElementById('codFornecedor').value.trim();
    if (!codigo) {
        alert('Digite um c√≥digo para buscar');
        return;
    }
    
    showLoading();
    try {
        const response = await fetch(`/api/fornecedores/buscar?termo=${encodeURIComponent(codigo)}`);
        const data = await response.json();
        
        if (data.success && data.fornecedores.length > 0) {
            // Se encontrou exatamente pelo c√≥digo, preenche automaticamente
            const fornecedor = data.fornecedores.find(f => f.codigo === codigo) || data.fornecedores[0];
            preencherFornecedor(fornecedor.codigo, fornecedor.nome, fornecedor.email || '');
        } else {
            alert('Fornecedor n√£o encontrado com o c√≥digo: ' + codigo);
        }
    } catch (e) {
        console.error('Erro na busca:', e);
        alert('Erro ao buscar fornecedor: ' + e.message);
    }
    hideLoading();
}

// Autocomplete por nome
function buscarFornecedorAutocomplete(termo) {
    const dropdown = document.getElementById('autocompleteFornecedor');
    
    // Cancelar busca anterior
    if (buscaTimeout) {
        clearTimeout(buscaTimeout);
    }
    
    // M√≠nimo 2 caracteres
    if (!termo || termo.length < 2) {
        dropdown.classList.remove('show');
        dropdown.innerHTML = '';
        return;
    }
    
    // Debounce de 300ms
    buscaTimeout = setTimeout(async () => {
        dropdown.innerHTML = '<div class="autocomplete-loading"><i class="fas fa-spinner fa-spin me-2"></i>Buscando...</div>';
        dropdown.classList.add('show');
        
        try {
            const response = await fetch(`/api/fornecedores/buscar?termo=${encodeURIComponent(termo)}`);
            const data = await response.json();
            
            if (data.success && data.fornecedores.length > 0) {
                let html = '';
                data.fornecedores.slice(0, 10).forEach(f => {
                    const nomeEscapado = f.nome.replace(/'/g, "\\'").replace(/"/g, '&quot;');
                    const emailEscapado = (f.email || '').replace(/'/g, "\\'");
                    html += `
                        <div class="autocomplete-item" onclick="preencherFornecedor('${f.codigo}', '${nomeEscapado}', '${emailEscapado}')">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <span class="codigo">${f.codigo}</span>
                                    <span class="nome ms-2">${f.nome}</span>
                                </div>
                            </div>
                            ${f.email ? `<div class="email"><i class="fas fa-envelope me-1"></i>${f.email}</div>` : ''}
                        </div>
                    `;
                });
                if (data.fornecedores.length > 10) {
                    html += `<div class="autocomplete-empty">... e mais ${data.fornecedores.length - 10} resultados</div>`;
                }
                dropdown.innerHTML = html;
            } else {
                dropdown.innerHTML = '<div class="autocomplete-empty">Nenhum fornecedor encontrado</div>';
            }
        } catch (e) {
            dropdown.innerHTML = `<div class="autocomplete-empty text-danger">Erro: ${e.message}</div>`;
        }
    }, 300);
}

// Preencher dados do fornecedor selecionado
function preencherFornecedor(codigo, nome, email) {
    document.getElementById('codFornecedor').value = codigo;
    document.getElementById('nomeFornecedor').value = nome;
    document.getElementById('emailFornecedor').value = email || '';
    
    // Fechar autocomplete
    const dropdown = document.getElementById('autocompleteFornecedor');
    dropdown.classList.remove('show');
    dropdown.innerHTML = '';
}

// Fechar autocomplete ao clicar fora
document.addEventListener('click', function(e) {
    const dropdown = document.getElementById('autocompleteFornecedor');
    const input = document.getElementById('nomeFornecedor');
    if (dropdown && !dropdown.contains(e.target) && e.target !== input) {
        dropdown.classList.remove('show');
    }
});

// Mant√©m compatibilidade com fun√ß√£o antiga (caso seja chamada)
function buscarFornecedor() {
    buscarPorCodigo();
}

function selecionarFornecedor(codigo, nome, email) {
    preencherFornecedor(codigo, nome, email);
    if (typeof modalBuscarFornecedor !== 'undefined') {
        modalBuscarFornecedor.hide();
    }
}

// ============================================================================
// UPLOAD DE DOCUMENTO
// ============================================================================
function abrirModalUpload(id, nome) {
    document.getElementById('uploadAvaliacaoId').value = id;
    document.getElementById('uploadFornecedorNome').textContent = nome;
    document.getElementById('arquivoUpload').value = '';
    document.getElementById('tipoDocumento').value = 'relatorio_avaliacao';
    document.getElementById('nomeDocumento').value = '';
    modalUpload.show();
}

// Abrir upload a partir do modal de documentos
function abrirUploadDoModal() {
    const id = document.getElementById('docsAvaliacaoId').value;
    const nome = document.getElementById('docsFornecedorNome').textContent;
    modalDocumentos.hide();
    setTimeout(() => abrirModalUpload(id, nome), 300);
}

async function enviarDocumento() {
    const avaliacaoId = document.getElementById('uploadAvaliacaoId').value;
    const tipoDocumento = document.getElementById('tipoDocumento').value;
    let nomeDocumento = document.getElementById('nomeDocumento').value.trim();
    const arquivo = document.getElementById('arquivoUpload').files[0];
    
    if (!arquivo) {
        showToast('Selecione um arquivo para enviar', 'warning');
        return;
    }
    
    const extensoesPermitidas = ['.pdf', '.doc', '.docx'];
    const extensao = arquivo.name.toLowerCase().substring(arquivo.name.lastIndexOf('.'));
    if (!extensoesPermitidas.includes(extensao)) {
        showToast('Apenas arquivos PDF, DOC ou DOCX s√£o permitidos', 'error');
        return;
    }
    
    // Validate file size
    if (arquivo.size > 10 * 1024 * 1024) {
        showToast('Arquivo muito grande! M√°ximo permitido: 10MB', 'error');
        return;
    }
    
    // Auto-preencher nome se vazio
    if (!nomeDocumento) {
        nomeDocumento = arquivo.name.replace(/\.[^/.]+$/, '');
    }
    
    const formData = new FormData();
    formData.append('arquivo', arquivo);
    formData.append('tipo_documento', tipoDocumento);
    formData.append('nome_documento', nomeDocumento);
    
    showLoading();
    try {
        const response = await fetch(`/api/avaliacao-iso/${avaliacaoId}/upload`, {
            method: 'POST',
            credentials: 'same-origin',
            body: formData
        });
        const data = await response.json();
        
        if (data.success) {
            hideLoading();
            modalUpload.hide();
            showToast(`Documento "${nomeDocumento}" salvo com sucesso!`, 'success');
            reloadPreservandoEstadoComDelay(1500);
        } else {
            showToast('Erro ao salvar: ' + data.error, 'error');
        }
    } catch (e) {
        showToast('Erro ao salvar: ' + e.message, 'error');
    } finally {
        hideLoading();
    }
}

// ============================================================================
// VER DOCUMENTOS - SIMPLIFICADO
// ============================================================================
async function abrirModalDocumentos(id, nome) {
    document.getElementById('docsFornecedorNome').textContent = nome;
    document.getElementById('docsAvaliacaoId').value = id;
    document.getElementById('listaDocumentos').innerHTML = '<div class="text-center py-3"><div class="spinner-border spinner-border-sm"></div> Carregando...</div>';
    document.getElementById('indicadoresDocumentos').innerHTML = '';
    
    // Limpar campos de upload
    document.getElementById('arquivoUploadDocs').value = '';
    document.getElementById('nomeDocumentoDocs').value = '';
    document.getElementById('tipoDocumentoDocs').value = 'relatorio_avaliacao';
    
    modalDocumentos.show();
    
    try {
        const response = await fetch(`/api/avaliacao-iso/${id}`, { credentials: 'same-origin' });
        const data = await response.json();
        
        if (data.success && data.avaliacao.documentos && data.avaliacao.documentos.length > 0) {
            const docs = data.avaliacao.documentos;
            
            // Badge com total
            document.getElementById('indicadoresDocumentos').innerHTML = `<span class="badge bg-info">${docs.length} documento(s)</span>`;
            
            // Lista de documentos SIMPLES e DIRETA
            let html = '<div class="list-group list-group-flush">';
            
            docs.forEach(doc => {
                const extensao = doc.extensao || doc.nome_original.split('.').pop().toLowerCase();
                const nomeExibir = doc.nome_documento || doc.nome_original;
                const tipoInfo = getTipoDocumentoInfo(doc.tipo_documento);
                
                // √çcone do arquivo
                let icone = '<i class="fas fa-file text-secondary"></i>';
                if (extensao === 'pdf') icone = '<i class="fas fa-file-pdf text-danger"></i>';
                else if (['doc', 'docx'].includes(extensao)) icone = '<i class="fas fa-file-word text-primary"></i>';
                
                html += `
                <div class="list-group-item d-flex justify-content-between align-items-center py-2">
                    <div class="d-flex align-items-center gap-2">
                        ${icone}
                        <div>
                            <div class="fw-medium" style="font-size: 0.85rem;">${nomeExibir}</div>
                            <small class="text-muted">${tipoInfo.label} ‚Ä¢ .${extensao}</small>
                        </div>
                    </div>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-info" 
                                onclick="visualizarDocumento(${doc.id}, '${extensao}', '${nomeExibir.replace(/'/g, "\\'")}')"
                                title="Visualizar">
                            <i class="fas fa-eye"></i>
                        </button>
                        <a href="/api/avaliacao-iso/documento/${doc.id}/download" 
                           class="btn btn-outline-primary" download title="Baixar">
                            <i class="fas fa-download"></i>
                        </a>
                        <button class="btn btn-outline-danger" onclick="excluirDocumentoRapido(${doc.id})" title="Excluir">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>`;
            });
            
            html += '</div>';
            document.getElementById('listaDocumentos').innerHTML = html;
        } else {
            document.getElementById('indicadoresDocumentos').innerHTML = '<span class="badge bg-secondary">0 documentos</span>';
            document.getElementById('listaDocumentos').innerHTML = `
                <div class="text-center py-4 text-muted">
                    <i class="fas fa-folder-open fa-2x mb-2"></i>
                    <p class="mb-0">Nenhum documento cadastrado.</p>
                    <small>Use o formul√°rio acima para adicionar.</small>
                </div>`;
        }
    } catch (e) {
        document.getElementById('listaDocumentos').innerHTML = `<div class="text-center py-3 text-danger"><i class="fas fa-exclamation-circle me-2"></i>Erro: ${e.message}</div>`;
    }
}

// Upload r√°pido direto do modal de documentos
// File preview before upload
function onFileSelectedDocs(input) {
    const preview = document.getElementById('filePreviewDocs');
    if (input.files && input.files[0]) {
        const file = input.files[0];
        const ext = file.name.split('.').pop().toLowerCase();
        const iconMap = { pdf: 'fa-file-pdf text-danger', doc: 'fa-file-word text-primary', docx: 'fa-file-word text-primary' };
        document.getElementById('filePreviewIcon').className = `fas ${iconMap[ext] || 'fa-file text-secondary'}`;
        document.getElementById('filePreviewName').textContent = file.name;
        document.getElementById('filePreviewSize').textContent = formatarTamanho(file.size);
        preview.classList.remove('d-none');
    } else {
        preview.classList.add('d-none');
    }
}

function clearFilePreview() {
    document.getElementById('arquivoUploadDocs').value = '';
    document.getElementById('filePreviewDocs').classList.add('d-none');
}

async function enviarDocumentoRapido() {
    const avaliacaoId = document.getElementById('docsAvaliacaoId').value;
    const arquivo = document.getElementById('arquivoUploadDocs').files[0];
    let nomeDocumento = document.getElementById('nomeDocumentoDocs').value.trim();
    const tipoDocumento = document.getElementById('tipoDocumentoDocs').value;
    
    if (!arquivo) {
        showToast('Selecione um arquivo para enviar', 'warning');
        document.getElementById('arquivoUploadDocs').focus();
        return;
    }
    
    // Validate file size (10MB max)
    if (arquivo.size > 10 * 1024 * 1024) {
        showToast('Arquivo muito grande! M√°ximo permitido: 10MB', 'error');
        return;
    }
    
    const extensoesPermitidas = ['.pdf', '.doc', '.docx'];
    const extensao = arquivo.name.toLowerCase().substring(arquivo.name.lastIndexOf('.'));
    if (!extensoesPermitidas.includes(extensao)) {
        showToast('Apenas arquivos PDF, DOC ou DOCX s√£o permitidos', 'error');
        return;
    }
    
    // Auto-preencher nome se vazio
    if (!nomeDocumento) {
        nomeDocumento = arquivo.name.replace(/\.[^/.]+$/, '');
    }
    
    const formData = new FormData();
    formData.append('arquivo', arquivo);
    formData.append('tipo_documento', tipoDocumento);
    formData.append('nome_documento', nomeDocumento);
    
    // Desabilitar bot√£o e mostrar progresso
    const btn = event.target.closest('button') || event.target;
    const originalHtml = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Salvando...';
    
    try {
        const response = await fetch(`/api/avaliacao-iso/${avaliacaoId}/upload`, {
            method: 'POST',
            credentials: 'same-origin',
            body: formData
        });
        const data = await response.json();
        
        if (data.success) {
            // Limpar campos
            document.getElementById('arquivoUploadDocs').value = '';
            document.getElementById('nomeDocumentoDocs').value = '';
            
            // Feedback visual claro de sucesso
            showToast(`Documento "${nomeDocumento}" salvo com sucesso!`, 'success');
            
            // Recarregar lista de documentos (sem recarregar p√°gina)
            const nome = document.getElementById('docsFornecedorNome').textContent;
            await abrirModalDocumentos(avaliacaoId, nome);
            
            // Mostrar confirma√ß√£o no bot√£o
            btn.innerHTML = '<i class="fas fa-check me-1"></i> Salvo!';
            btn.classList.replace('btn-success', 'btn-outline-success');
            setTimeout(() => {
                btn.innerHTML = originalHtml;
                btn.classList.replace('btn-outline-success', 'btn-success');
                btn.disabled = false;
            }, 2000);
        } else {
            showToast('Erro ao salvar documento: ' + data.error, 'error');
            btn.innerHTML = originalHtml;
            btn.disabled = false;
        }
    } catch (e) {
        showToast('Erro ao salvar documento: ' + e.message, 'error');
        btn.innerHTML = originalHtml;
        btn.disabled = false;
    }
}

// Excluir documento r√°pido (sem confirma√ß√£o extra)
async function excluirDocumentoRapido(docId) {
    if (!confirm('Deseja excluir este documento?')) return;
    
    try {
        const response = await fetch(`/api/avaliacao-iso/documento/${docId}/excluir`, {
            method: 'POST',
            credentials: 'same-origin'
        });
        const data = await response.json();
        
        if (data.success) {
            // Recarregar lista
            const id = document.getElementById('docsAvaliacaoId').value;
            const nome = document.getElementById('docsFornecedorNome').textContent;
            await abrirModalDocumentos(id, nome);
        } else {
            alert('‚ùå Erro: ' + data.error);
        }
    } catch (e) {
        alert('‚ùå Erro: ' + e.message);
    }
}

// Fun√ß√µes auxiliares
function getTipoDocumentoInfo(tipo) {
    const tipos = {
        'iso': { label: 'üìú ISO', class: 'bg-success' },
        'certificado_iso': { label: 'üìú ISO', class: 'bg-success' },
        'relatorio_avaliacao': { label: 'üìã Relat√≥rio', class: 'bg-primary' },
        'avaliacao': { label: 'üìã Relat√≥rio', class: 'bg-primary' },
        'contrato': { label: 'üìù Contrato', class: 'bg-warning text-dark' },
        'declaracao': { label: 'üìÑ Declara√ß√£o', class: 'bg-info' },
        'outro': { label: 'üìé Outro', class: 'bg-secondary' }
    };
    return tipos[tipo] || tipos['outro'];
}

function getExtensaoIcon(ext) {
    const icons = {
        'pdf': '<i class="fas fa-file-pdf fa-2x text-danger"></i>',
        'doc': '<i class="fas fa-file-word fa-2x text-primary"></i>',
        'docx': '<i class="fas fa-file-word fa-2x text-primary"></i>'
    };
    return icons[ext] || '<i class="fas fa-file fa-2x text-secondary"></i>';
}

function formatarTamanho(bytes) {
    if (!bytes) return '-';
    if (bytes < 1024) return bytes + ' B';
    if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
    return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
}

// ============================================================================
// VISUALIZAR DOCUMENTO (PDF E WORD COM PR√âVIA)
// ============================================================================
function visualizarDocumento(docId, extensao, nomeDocumento) {
    const ext = (extensao || '').toLowerCase();
    console.log('[PREVIEW] Abrindo visualiza√ß√£o:', docId, ext, nomeDocumento);
    
    // Popular header
    document.getElementById('previewDocumentoTitulo').textContent = nomeDocumento || 'Documento';
    
    // Configurar links
    const urlDownload = `/api/avaliacao-iso/documento/${docId}/download`;
    document.getElementById('btnDownloadPreview').href = urlDownload;
    
    const linkExterno = document.getElementById('linkAbrirExterno');
    if (linkExterno) linkExterno.href = urlDownload;
    
    // Reset - esconder tudo, mostrar loading
    const previewLoading = document.getElementById('previewLoading');
    const previewPDF = document.getElementById('previewPDF');
    const previewWord = document.getElementById('previewWord');
    const previewWordContent = document.getElementById('previewWordContent');
    const previewErro = document.getElementById('previewErro');
    
    previewLoading.style.display = 'block';
    previewPDF.style.display = 'none';
    previewPDF.src = '';
    previewWord.style.display = 'none';
    if (previewWordContent) previewWordContent.innerHTML = '';
    previewErro.classList.add('d-none');
    
    // Abrir modal
    new bootstrap.Modal(document.getElementById('modalPreviewDocumento')).show();
    
    // Tratar por tipo de arquivo
    if (ext === 'pdf') {
        // PDF: usar iframe direto
        carregarPreviewPDF(docId);
    } else if (ext === 'doc' || ext === 'docx') {
        // Word: converter para HTML via API
        carregarPreviewWord(docId);
    } else {
        // Outros formatos: mostrar mensagem
        previewLoading.style.display = 'none';
        document.getElementById('previewErroMsg').textContent = 
            `Formato .${ext} n√£o suportado para pr√©-visualiza√ß√£o. Use o bot√£o Baixar.`;
        previewErro.classList.remove('d-none');
    }
}

// Preview de PDF via iframe
function carregarPreviewPDF(docId) {
    const urlPreview = `/api/avaliacao-iso/documento/${docId}/preview`;
    const previewLoading = document.getElementById('previewLoading');
    const previewPDF = document.getElementById('previewPDF');
    const previewErro = document.getElementById('previewErro');
    
    previewPDF.src = urlPreview;
    
    previewPDF.onload = function() {
        previewLoading.style.display = 'none';
        previewPDF.style.display = 'block';
    };
    
    previewPDF.onerror = function() {
        previewLoading.style.display = 'none';
        previewErro.classList.remove('d-none');
    };
    
    // Timeout de seguran√ßa
    setTimeout(() => {
        if (previewLoading.style.display !== 'none') {
            previewLoading.style.display = 'none';
            previewPDF.style.display = 'block';
        }
    }, 3000);
}

// Preview de Word - NUNCA for√ßa download, SEMPRE mostra pr√©via interna
// Estrat√©gia: 1) Tentar PDF  2) Extrair HTML  3) Fallback textual

// Preview de Word - Visualiza√ß√£o SEMPRE interna
async function carregarPreviewWord(docId) {
    const previewLoading = document.getElementById('previewLoading');
    const previewPDF = document.getElementById('previewPDF');
    const previewWord = document.getElementById('previewWord');
    const previewErro = document.getElementById('previewErro');
    
    try {
        console.log('[PREVIEW WORD] Iniciando visualiza√ß√£o do documento', docId);
        
        // ESTRAT√âGIA 1: Tentar convers√£o PDF primeiro
        const pdfOk = await tentarPreviewPDF(docId);
        if (pdfOk) {
            console.log('[PREVIEW WORD] PDF carregado com sucesso!');
            return;
        }
        
        // ESTRAT√âGIA 2: Extrair conte√∫do como HTML
        console.log('[PREVIEW WORD] PDF n√£o dispon√≠vel, extraindo HTML...');
        await carregarPreviewWordHTML(docId);
        
    } catch (e) {
        console.error('[PREVIEW WORD] Erro geral:', e);
        // ESTRAT√âGIA 3: Mostrar mensagem de erro (SEM download)
        mostrarErroVisualizacao(docId, e.message);
    }
}

// Tentar carregar como PDF
async function tentarPreviewPDF(docId) {
    return new Promise((resolve) => {
        const previewLoading = document.getElementById('previewLoading');
        const previewWord = document.getElementById('previewWord');
        
        const urlPreviewPDF = `/api/avaliacao-iso/documento/${docId}/preview-pdf`;
        
        // Testar se API retorna PDF v√°lido
        fetch(urlPreviewPDF, { method: 'HEAD' })
            .then(response => {
                const contentType = response.headers.get('content-type') || '';
                
                if (response.ok && contentType.includes('application/pdf')) {
                    // PDF dispon√≠vel - criar iframe
                    const iframe = document.createElement('iframe');
                    iframe.src = urlPreviewPDF;
                    iframe.style.cssText = 'width: 100%; height: 70vh; border: none;';
                    
                    iframe.onload = () => {
                        previewLoading.style.display = 'none';
                        previewWord.innerHTML = '';
                        previewWord.appendChild(iframe);
                        previewWord.style.display = 'block';
                        resolve(true);
                    };
                    
                    iframe.onerror = () => resolve(false);
                    
                    // Timeout de seguran√ßa
                    setTimeout(() => {
                        if (previewLoading.style.display !== 'none') {
                            resolve(false);
                        }
                    }, 8000);
                } else {
                    resolve(false);
                }
            })
            .catch(() => resolve(false));
    });
}

// Carregar preview como HTML extra√≠do
async function carregarPreviewWordHTML(docId) {
    const previewLoading = document.getElementById('previewLoading');
    const previewWord = document.getElementById('previewWord');
    
    try {
        const response = await fetch(`/api/avaliacao-iso/documento/${docId}/preview-html`);
        const data = await response.json();
        
        previewLoading.style.display = 'none';
        
        if (data.success && data.html) {
            // Verificar se √© um PDF convertido (retorna URL do iframe diretamente)
            if (data.html.startsWith('__PDF_IFRAME__')) {
                const pdfUrl = data.html.replace('__PDF_IFRAME__', '');
                previewWord.innerHTML = `
                    <iframe src="${pdfUrl}" 
                            style="width: 100%; height: 70vh; border: none;"
                            title="Pr√©via do documento">
                    </iframe>
                `;
            } else {
                // Renderizar HTML extra√≠do com header
                previewWord.innerHTML = `
                    <div style="background: #f8f9fa; border-radius: 8px; overflow: hidden;">
                        <div style="background: linear-gradient(135deg, #2b5876 0%, #4e4376 100%); color: white; padding: 10px 15px; display: flex; align-items: center; justify-content: space-between;">
                            <div>
                                <i class="fas fa-file-word me-2"></i>
                                <strong>${data.nome || 'Documento Word'}</strong>
                            </div>
                            <div class="d-flex gap-2 align-items-center">
                                <span class="badge bg-light text-dark">
                                    <i class="fas fa-eye me-1"></i>Pr√©via do documento
                                </span>
                                <a href="/api/avaliacao-iso/documento/${docId}/download" 
                                   class="btn btn-sm btn-outline-light" download title="Baixar original">
                                    <i class="fas fa-download"></i>
                                </a>
                            </div>
                        </div>
                        <div style="background: white; padding: 20px; max-height: 65vh; overflow-y: auto;">
                            ${data.html}
                        </div>
                    </div>
                `;
            }
        } else {
            // Erro na extra√ß√£o - mostrar mensagem amig√°vel (SEM download)
            mostrarErroVisualizacao(docId, data.error || 'N√£o foi poss√≠vel extrair o conte√∫do');
        }
        
        previewWord.style.display = 'block';
        
    } catch (e) {
        console.error('[PREVIEW HTML] Erro:', e);
        mostrarErroVisualizacao(docId, e.message);
    }
}

// Mostrar erro de visualiza√ß√£o - oferece download como fallback
function mostrarErroVisualizacao(docId, mensagem) {
    const previewLoading = document.getElementById('previewLoading');
    const previewWord = document.getElementById('previewWord');
    
    previewLoading.style.display = 'none';
    
    previewWord.innerHTML = `
        <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; 
                    min-height: 50vh; background: #f8f9fa; border-radius: 8px; padding: 40px; text-align: center;">
            <div style="background: white; padding: 40px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); max-width: 500px;">
                <i class="fas fa-file-word fa-4x text-primary mb-3" style="opacity: 0.7;"></i>
                <h5 class="mb-3" style="color: #333;">Documento Word</h5>
                <div class="alert alert-info mb-3" style="font-size: 14px;">
                    <i class="fas fa-info-circle me-2"></i>
                    A pr√©-visualiza√ß√£o deste documento n√£o est√° dispon√≠vel no momento.
                </div>
                <a href="/api/avaliacao-iso/documento/${docId}/download" 
                   class="btn btn-primary mb-2" download>
                    <i class="fas fa-download me-2"></i> Baixar Documento
                </a>
                <p class="text-muted small mb-0 mt-2">
                    <i class="fas fa-lightbulb me-1"></i>
                    O documento ser√° aberto no Microsoft Word ou visualizador compat√≠vel.
                </p>
            </div>
        </div>
    `;
    previewWord.style.display = 'block';
}

// Limpar modal ao fechar
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('modalPreviewDocumento').addEventListener('hidden.bs.modal', function() {
        // Resetar iframe PDF
        document.getElementById('previewPDF').src = '';
        document.getElementById('previewPDF').style.display = 'none';
        
        // Resetar container Word
        const previewWord = document.getElementById('previewWord');
        if (previewWord) {
            previewWord.style.display = 'none';
            previewWord.innerHTML = '';
        }
        
        // Mostrar loading para pr√≥xima abertura
        document.getElementById('previewLoading').style.display = 'block';
        
        // Esconder erro
        document.getElementById('previewErro').classList.add('d-none');
    });
});

async function excluirDocumento(docId) {
    if (!confirm('Tem certeza que deseja excluir este documento?')) return;
    
    showLoading();
    try {
        const response = await fetch(`/api/avaliacao-iso/documento/${docId}/excluir`, { 
            method: 'POST',
            credentials: 'same-origin'
        });
        const data = await response.json();
        
        if (data.success) {
            showToast(data.message, 'success');
            reloadPreservandoEstadoComDelay(1500);
        } else {
            alert('Erro: ' + data.error);
        }
    } catch (e) {
        alert('Erro: ' + e.message);
    }
    hideLoading();
}

// ============================================================================
// ENVIAR E-MAIL AO FORNECEDOR (Nova implementa√ß√£o)
// ============================================================================
function abrirModalEnviarEmail(id, email, nome, possuiISO) {
    document.getElementById('emailAvaliacaoId').value = id;
    document.getElementById('emailFornecedorNome').value = nome;
    document.getElementById('emailDestinatario').value = email || '';
    document.getElementById('emailAnexo').value = '';
    
    // Gerar mensagem inteligente baseada no campo "Possui ISO"
    const hora = new Date().getHours();
    const saudacao = hora < 12 ? 'Bom dia' : (hora < 18 ? 'Boa tarde' : 'Boa noite');
    
    let mensagem = '';
    
    // Mensagem √∫nica e neutra - aplic√°vel a fornecedores com ou sem ISO
    // Solicita apenas o certificado ISO, sem mencionar preenchimento de relat√≥rios
    mensagem = `${saudacao}, tudo bem?

Para manter nosso cadastro de fornecedores atualizado e em conformidade com nosso sistema de gest√£o da qualidade, solicitamos que nos envie o certificado ISO atualizado (ISO 9001, ISO 14001 ou outro, caso possua).

Caso sua empresa n√£o possua certifica√ß√£o ISO no momento, favor desconsiderar esta solicita√ß√£o.

Permanecemos √† disposi√ß√£o para qualquer d√∫vida.

Atenciosamente,
Departamento de Compras
Polim√°quinas`;
    
    document.getElementById('emailMensagem').value = mensagem;
    modalEnviarEmail.show();
}

async function enviarEmailFornecedor() {
    const avaliacaoId = document.getElementById('emailAvaliacaoId').value;
    const destinatario = document.getElementById('emailDestinatario').value.trim();
    const assunto = document.getElementById('emailAssunto').value.trim();
    const mensagem = document.getElementById('emailMensagem').value.trim();
    const anexo = document.getElementById('emailAnexo').files[0];
    
    if (!destinatario) {
        alert('E-mail do destinat√°rio √© obrigat√≥rio!');
        return;
    }
    
    if (!assunto) {
        alert('Assunto √© obrigat√≥rio!');
        return;
    }
    
    if (!mensagem) {
        alert('Mensagem √© obrigat√≥ria!');
        return;
    }
    
    if (!confirm(`Enviar e-mail para:\n${destinatario}\n\nConfirmar?`)) {
        return;
    }
    
    const formData = new FormData();
    formData.append('email_destinatario', destinatario);
    formData.append('assunto', assunto);
    formData.append('mensagem', mensagem);
    if (anexo) {
        formData.append('anexo', anexo);
    }
    
    showLoading();
    try {
        const response = await fetch(`/api/avaliacao-iso/${avaliacaoId}/enviar-email`, {
            method: 'POST',
            credentials: 'same-origin',
            body: formData
        });
        const data = await response.json();
        
        if (data.success) {
            alert(data.message || 'E-mail enviado com sucesso!');
            modalEnviarEmail.hide();
        } else {
            alert('Erro: ' + (data.error || 'Erro ao enviar e-mail'));
        }
    } catch (e) {
        console.error('Erro ao enviar e-mail:', e);
        alert('Erro ao enviar e-mail: ' + e.message);
    } finally {
        hideLoading();
    }
}

// ============================================================================
// EXCLUIR AVALIA√á√ÉO
// ============================================================================
async function confirmarExclusao(id, nome) {
    if (!confirm(`Tem certeza que deseja EXCLUIR a avalia√ß√£o de:\n\n${nome}\n\nEsta a√ß√£o n√£o pode ser desfeita!`)) {
        return;
    }
    
    showLoading();
    try {
        const response = await fetch(`/api/avaliacao-iso/${id}/excluir`, { method: 'POST' });
        const data = await response.json();
        
        if (data.success) {
            showToast(data.message, 'success');
            reloadPreservandoEstadoComDelay(1500);
        } else {
            alert('Erro: ' + data.error);
        }
    } catch (e) {
        alert('Erro: ' + e.message);
    }
    hideLoading();
}

// ============================================================================
// OBSERVA√á√ïES / BLOCO DE NOTAS
// ============================================================================
function abrirModalObservacao(id, nome, observacao) {
    document.getElementById('obsAvaliacaoId').value = id;
    document.getElementById('obsFornecedorNome').textContent = nome;
    document.getElementById('obsTexto').value = observacao || '';
    modalObservacao.show();
}

// Event listener para bot√µes de observa√ß√£o (usando data attributes)
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.btn-observacao').forEach(btn => {
        btn.addEventListener('click', function() {
            const id = this.dataset.id;
            const nome = this.dataset.nome;
            const obs = this.dataset.obs || '';
            abrirModalObservacao(id, nome, obs);
        });
    });
});

async function salvarObservacao() {
    const id = document.getElementById('obsAvaliacaoId').value;
    const observacao = document.getElementById('obsTexto').value.trim();
    
    showLoading();
    try {
        const response = await fetch(`/api/avaliacao-iso/${id}/observacao`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'same-origin',
            body: JSON.stringify({ observacao: observacao })
        });
        const data = await response.json();
        
        if (data.success) {
            modalObservacao.hide();
            showToast('Observa√ß√£o salva com sucesso!', 'success');
            reloadPreservandoEstadoComDelay(1500);
        } else {
            alert('Erro: ' + data.error);
        }
    } catch (e) {
        alert('Erro ao salvar observa√ß√£o: ' + e.message);
    }
    hideLoading();
}

// ============================================================================
// EXPORTAR EXCEL
// ============================================================================
function exportarExcel() {
    const table = document.getElementById('tabelaAvaliacoes');
    const rows = table.querySelectorAll('tbody tr:not([style*="display: none"])');
    
    if (rows.length === 0 || rows[0].querySelector('td[colspan]')) {
        alert('N√£o h√° dados para exportar');
        return;
    }
    
    const data = [];
    
    // Cabe√ßalho atualizado com Observa√ß√µes
    data.push(['C√≥digo', 'Fornecedor', 'E-mail', '√öltima Avalia√ß√£o', 'Vencimento', 'Status', 'Possui ISO', 'Observa√ß√µes']);
    
    // Dados - pegar observa√ß√£o do atributo data-observacao
    rows.forEach(row => {
        const cells = row.querySelectorAll('td');
        if (cells.length < 9) return; // Pular linhas inv√°lidas
        
        const observacao = row.dataset.observacao || '';
        const rowData = [
            cells[0].textContent.trim(),
            cells[1].querySelector('strong')?.textContent.trim() || '',
            cells[1].querySelector('small')?.textContent.replace(/[üìß\s]/g, '').trim() || '',
            cells[2].textContent.trim(),
            cells[3].textContent.trim(),
            cells[4].textContent.trim(),
            cells[5].textContent.trim(),
            observacao
        ];
        data.push(rowData);
    });
    
    // Criar workbook
    const ws = XLSX.utils.aoa_to_sheet(data);
    
    // Ajustar largura das colunas
    ws['!cols'] = [
        { wch: 12 },  // C√≥digo
        { wch: 40 },  // Fornecedor
        { wch: 30 },  // E-mail
        { wch: 15 },  // √öltima Avalia√ß√£o
        { wch: 12 },  // Vencimento
        { wch: 12 },  // Status
        { wch: 10 },  // Possui ISO
        { wch: 50 }   // Observa√ß√µes
    ];
    
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Avalia√ß√£o ISO');
    
    // Download
    const dataAtual = new Date().toISOString().slice(0, 10);
    XLSX.writeFile(wb, `Avaliacao_ISO_PQ021_${dataAtual}.xlsx`);
}

// ==================== LIMPAR TODOS ====================
async function confirmarLimparTodos() {
    const totalRegistros = {{ avaliacoes|length }};
    
    if (totalRegistros === 0) {
        alert('N√£o h√° registros para apagar.');
        return;
    }
    
    // Dupla confirma√ß√£o para seguran√ßa
    if (!confirm(`‚ö†Ô∏è ATEN√á√ÉO!\n\nVoc√™ est√° prestes a APAGAR TODOS os ${totalRegistros} fornecedores cadastrados.\n\nEsta a√ß√£o N√ÉO pode ser desfeita!\n\nDeseja continuar?`)) {
        return;
    }
    
    // Segunda confirma√ß√£o
    const confirmacao = prompt(`Para confirmar, digite "APAGAR" (em mai√∫sculas):`);
    if (confirmacao !== 'APAGAR') {
        alert('Opera√ß√£o cancelada.');
        return;
    }
    
    showLoading();
    
    try {
        const response = await fetch('/api/avaliacao-iso/limpar-todos', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });
        
        const result = await response.json();
        
        if (result.success) {
            showToast(`${result.excluidos} registros foram apagados com sucesso!`, 'success');
            reloadPreservandoEstadoComDelay(1500);
        } else {
            alert('Erro: ' + result.error);
        }
    } catch (err) {
        alert('Erro ao limpar registros: ' + err.message);
    }
    
    hideLoading();
}

// ==================== CONFIRMAR IMPORTA√á√ÉO ====================
async function confirmarImportacao() {
    if (dadosParaImportar.length === 0) {
        alert('Nenhum dado para importar');
        return;
    }
    
    if (!confirm(`Confirma a importa√ß√£o de ${dadosParaImportar.length} fornecedores?\n\nFornecedores j√° existentes ser√£o ignorados.`)) {
        return;
    }
    
    showLoading();
    
    try {
        const response = await fetch('/api/avaliacao-iso/importar-excel', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ fornecedores: dadosParaImportar })
        });
        
        const result = await response.json();
        
        if (result.success) {
            let mensagem = `Importa√ß√£o conclu√≠da!\n\n‚úÖ Importados: ${result.importados}\n‚ö†Ô∏è Ignorados (j√° existem): ${result.ignorados}\n‚ùå Erros: ${result.erros}`;
            
            // Exibir avisos de datas inv√°lidas ou outros problemas
            if (result.avisos && result.avisos.length > 0) {
                mensagem += `\n\nüìã Avisos (${result.avisos.length}):`;
                // Mostrar at√© 5 avisos no alert
                const maxAvisos = Math.min(result.avisos.length, 5);
                for (let i = 0; i < maxAvisos; i++) {
                    mensagem += `\n‚Ä¢ ${result.avisos[i]}`;
                }
                if (result.avisos.length > maxAvisos) {
                    mensagem += `\n... e mais ${result.avisos.length - maxAvisos} avisos (ver console)`;
                    console.warn('[IMPORTA√á√ÉO ISO] Todos os avisos:', result.avisos);
                }
            }
            
            alert(mensagem);
            modalImportarExcel.hide();
            reloadPreservandoEstado();
        } else {
            alert('Erro na importa√ß√£o: ' + result.error);
        }
    } catch (err) {
        alert('Erro na importa√ß√£o: ' + err.message);
    }
    
    hideLoading();
}
</script>

</body>
</html>
