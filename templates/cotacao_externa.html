<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cotação Externa - {{ dados.cotacao.codigo }}</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        :root {
            --primary-color: #0d6efd;
            --success-color: #198754;
            --bg-light: #f8f9fa;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .main-container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .card-cotacao {
            background: white;
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        
        .card-header-custom {
            background: linear-gradient(135deg, #1a1d21 0%, #212529 100%);
            color: white;
            padding: 24px 30px;
        }
        
        .card-header-custom h1 {
            margin: 0;
            font-size: 1.5rem;
            font-weight: 600;
        }
        
        .card-header-custom .badge {
            font-size: 0.85rem;
            padding: 6px 12px;
        }
        
        .card-body-custom {
            padding: 30px;
        }
        
        .info-section {
            background: var(--bg-light);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .info-section h6 {
            color: #6c757d;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 15px;
        }
        
        .info-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px dashed #dee2e6;
        }
        
        .info-item:last-child {
            border-bottom: none;
        }
        
        .info-label {
            color: #6c757d;
            font-size: 0.85rem;
        }
        
        .info-value {
            font-weight: 600;
            color: #212529;
        }
        
        .table-itens {
            margin-top: 20px;
        }
        
        .table-itens thead th {
            background: #f8f9fa;
            font-weight: 600;
            font-size: 0.8rem;
            text-transform: uppercase;
            color: #6c757d;
            border-bottom: 2px solid #dee2e6;
        }
        
        .table-itens tbody tr {
            transition: background 0.2s;
        }
        
        .table-itens tbody tr:hover {
            background: #f8f9fa;
        }
        
        .input-preco, .input-prazo {
            width: 120px;
            text-align: right;
            border: 1px solid #ced4da;
            border-radius: 6px;
            padding: 8px 12px;
            font-size: 0.9rem;
        }
        
        .input-preco:focus, .input-prazo:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(13, 110, 253, 0.15);
            outline: none;
        }
        
        .input-obs-item {
            width: 100%;
            border: 1px solid #ced4da;
            border-radius: 6px;
            padding: 6px 10px;
            font-size: 0.85rem;
        }
        
        .section-geral {
            background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
            border-radius: 10px;
            padding: 25px;
            margin-top: 30px;
        }
        
        .section-geral h5 {
            color: #1a1d21;
            margin-bottom: 20px;
        }
        
        .btn-enviar {
            padding: 15px 40px;
            font-size: 1.1rem;
            font-weight: 600;
            border-radius: 10px;
            transition: all 0.3s;
        }
        
        .btn-enviar:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(25, 135, 84, 0.3);
        }
        
        .btn-download-json {
            padding: 12px 25px;
            font-weight: 500;
        }
        
        .footer-info {
            text-align: center;
            padding: 20px;
            color: rgba(255,255,255,0.8);
            font-size: 0.85rem;
        }
        
        .alert-instrucoes {
            border-left: 4px solid var(--primary-color);
        }
        
        .upload-area {
            border: 2px dashed #ced4da;
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            background: #fafafa;
            transition: all 0.3s;
            cursor: pointer;
        }
        
        .upload-area:hover {
            border-color: var(--primary-color);
            background: #f0f7ff;
        }
        
        .upload-area.dragover {
            border-color: var(--success-color);
            background: #e8f5e9;
        }
        
        /* Responsivo */
        @media (max-width: 768px) {
            .main-container {
                padding: 10px;
            }
            
            .card-body-custom {
                padding: 15px;
            }
            
            .input-preco, .input-prazo {
                width: 100%;
            }
            
            .table-responsive {
                font-size: 0.85rem;
            }
        }
    </style>
</head>
<body>
    <div class="main-container">
        <!-- Cabeçalho -->
        <div class="card-cotacao mb-4">
            <div class="card-header-custom">
                <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                    <div>
                        <h1><i class="fas fa-file-invoice me-2"></i>Solicitação de Cotação</h1>
                        <span class="text-white-50">Código: {{ dados.cotacao.codigo }}</span>
                    </div>
                    <span class="badge bg-primary">
                        <i class="fas fa-clock me-1"></i>Aguardando Resposta
                    </span>
                </div>
            </div>
            
            <div class="card-body-custom">
                <!-- Alertas e Instruções -->
                <div class="alert alert-info alert-instrucoes mb-4">
                    <h6 class="alert-heading"><i class="fas fa-info-circle me-2"></i>Instruções para Preenchimento</h6>
                    <ul class="mb-0 small">
                        <li>Preencha o <strong>preço unitário</strong> de cada item em Reais (R$)</li>
                        <li>Informe o <strong>prazo de entrega</strong> em dias úteis</li>
                        <li>Se houver <strong>frete</strong>, informe o valor total na seção abaixo</li>
                        <li>Após preencher, clique em <strong>"Enviar Cotação"</strong> ou baixe o JSON para envio manual</li>
                    </ul>
                </div>
                
                <!-- Informações do Fornecedor -->
                <div class="info-section">
                    <h6><i class="fas fa-building me-2"></i>Dados do Fornecedor</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="info-item">
                                <span class="info-label">Razão Social:</span>
                                <span class="info-value">{{ dados.fornecedor.nome }}</span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="info-item">
                                <span class="info-label">Email:</span>
                                <span class="info-value">{{ dados.fornecedor.email or '-' }}</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                {% if dados.cotacao.informacao_fornecedor %}
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>Informação Importante:</strong> {{ dados.cotacao.informacao_fornecedor }}
                </div>
                {% endif %}
                
                <!-- Tabela de Itens -->
                <h5 class="mb-3"><i class="fas fa-list me-2"></i>Itens para Cotação</h5>
                
                <div class="table-responsive">
                    <table class="table table-itens" id="tabelaItens">
                        <thead>
                            <tr>
                                <th style="width: 80px;">Código</th>
                                <th>Descrição</th>
                                <th style="width: 80px;">Qtd</th>
                                <th style="width: 130px;">Preço Unit. (R$)</th>
                                <th style="width: 100px;">Prazo (dias)</th>
                                <th>Observação</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in dados.itens %}
                            <tr data-item-id="{{ item.id }}">
                                <td class="small text-muted">{{ item.codigo_produto or item.numero_sc }}</td>
                                <td>
                                    <strong>{{ item.descricao }}</strong>
                                    {% if item.observacao %}
                                    <br><small class="text-muted">{{ item.observacao }}</small>
                                    {% endif %}
                                </td>
                                <td class="text-center fw-bold">{{ item.quantidade }} {{ item.unidade }}</td>
                                <td>
                                    <input type="text" 
                                           class="input-preco" 
                                           id="preco_{{ item.id }}"
                                           placeholder="0,00"
                                           oninput="formatarMoeda(this)">
                                </td>
                                <td>
                                    <input type="number" 
                                           class="input-prazo" 
                                           id="prazo_{{ item.id }}"
                                           placeholder="0"
                                           min="0">
                                </td>
                                <td>
                                    <input type="text" 
                                           class="input-obs-item" 
                                           id="obs_{{ item.id }}"
                                           placeholder="Observação do item...">
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                <!-- Campos Gerais da Cotação -->
                <div class="section-geral">
                    <h5><i class="fas fa-truck me-2"></i>Informações Gerais da Cotação</h5>
                    
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label class="form-label fw-bold">Frete Total (R$)</label>
                            <input type="text" 
                                   class="form-control" 
                                   id="freteTotal"
                                   placeholder="0,00"
                                   oninput="formatarMoeda(this)">
                            <small class="text-muted">Deixe em branco se incluso no preço</small>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label fw-bold">Condição de Pagamento</label>
                            <input type="text" 
                                   class="form-control" 
                                   id="condicaoPagamento"
                                   placeholder="Ex: 28 DDL, 30/60/90...">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label fw-bold">Validade da Proposta</label>
                            <input type="text" 
                                   class="form-control" 
                                   id="validadeProposta"
                                   placeholder="Ex: 15 dias">
                        </div>
                        <div class="col-12">
                            <label class="form-label fw-bold">Observações Gerais</label>
                            <textarea class="form-control" 
                                      id="observacaoGeral"
                                      rows="3"
                                      placeholder="Informações adicionais, restrições, etc..."></textarea>
                        </div>
                    </div>
                </div>
                
                <!-- Ações -->
                <div class="d-flex justify-content-between align-items-center flex-wrap gap-3 mt-4 pt-3 border-top">
                    <div>
                        <button type="button" class="btn btn-outline-secondary btn-download-json" onclick="baixarJSONPreenchido()">
                            <i class="fas fa-download me-2"></i>Baixar JSON
                        </button>
                        <small class="d-block text-muted mt-1">Para envio manual via email</small>
                    </div>
                    
                    <button type="button" class="btn btn-success btn-enviar" onclick="enviarCotacao()">
                        <i class="fas fa-paper-plane me-2"></i>Enviar Cotação
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Área de Upload (alternativa) -->
        <div class="card-cotacao mb-4">
            <div class="card-body-custom">
                <h5 class="mb-3"><i class="fas fa-upload me-2"></i>Já possui o JSON preenchido?</h5>
                <p class="text-muted small">Se você já preencheu o arquivo JSON anteriormente, pode fazer upload diretamente:</p>
                
                <div class="upload-area" id="uploadArea" onclick="document.getElementById('inputArquivoJson').click()">
                    <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                    <p class="mb-0">Arraste o arquivo JSON aqui ou <strong>clique para selecionar</strong></p>
                    <input type="file" id="inputArquivoJson" accept=".json" style="display: none" onchange="handleFileUpload(this)">
                </div>
                <div id="uploadStatus" class="mt-3"></div>
            </div>
        </div>
        
        <!-- Footer -->
        <div class="footer-info">
            <p class="mb-1">
                <i class="fas fa-shield-alt me-1"></i>
                Cotação segura - Token: <code>{{ dados.token[:12] }}...</code>
            </p>
            <p class="mb-0">
                Sistema de Cotações - © {{ ano_atual }} - Todos os direitos reservados
            </p>
        </div>
    </div>
    
    <!-- Toast de Notificação -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3">
        <div id="toastNotificacao" class="toast" role="alert">
            <div class="toast-header">
                <i class="fas fa-info-circle me-2" id="toastIcon"></i>
                <strong class="me-auto" id="toastTitulo">Notificação</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
            </div>
            <div class="toast-body" id="toastMensagem"></div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Dados originais da cotação (carregados do servidor)
        const dadosCotacao = {{ dados|tojson }};
        
        /**
         * Formata input como moeda brasileira
         */
        function formatarMoeda(input) {
            let value = input.value.replace(/\D/g, '');
            if (value === '') {
                input.value = '';
                return;
            }
            value = (parseInt(value) / 100).toFixed(2);
            input.value = value.replace('.', ',').replace(/\B(?=(\d{3})+(?!\d))/g, '.');
        }
        
        /**
         * Converte string formatada para número
         */
        function converterParaNumero(valor) {
            if (!valor || valor === '') return null;
            return parseFloat(valor.replace(/\./g, '').replace(',', '.'));
        }
        
        /**
         * Coleta todas as respostas do formulário
         */
        function coletarRespostas() {
            const itens = dadosCotacao.itens.map(item => {
                const preco = converterParaNumero(document.getElementById(`preco_${item.id}`).value);
                const prazo = parseInt(document.getElementById(`prazo_${item.id}`).value) || null;
                const obs = document.getElementById(`obs_${item.id}`).value || null;
                
                return {
                    ...item,
                    resposta: {
                        preco_unitario: preco,
                        prazo_entrega_dias: prazo,
                        observacao: obs
                    }
                };
            });
            
            const respostaGeral = {
                frete_total: converterParaNumero(document.getElementById('freteTotal').value),
                condicao_pagamento: document.getElementById('condicaoPagamento').value || null,
                validade_proposta: document.getElementById('validadeProposta').value || null,
                observacao_geral: document.getElementById('observacaoGeral').value || null,
                data_resposta: new Date().toISOString()
            };
            
            return {
                ...dadosCotacao,
                itens: itens,
                resposta_geral: respostaGeral,
                data_preenchimento: new Date().toISOString()
            };
        }
        
        /**
         * Valida se pelo menos um item foi preenchido
         */
        function validarPreenchimento() {
            const itens = dadosCotacao.itens;
            let temPreenchido = false;
            
            for (const item of itens) {
                const preco = document.getElementById(`preco_${item.id}`).value;
                if (preco && preco !== '') {
                    temPreenchido = true;
                    break;
                }
            }
            
            if (!temPreenchido) {
                mostrarToast('Atenção', 'Preencha o preço de pelo menos um item antes de enviar.', 'warning');
                return false;
            }
            
            return true;
        }
        
        /**
         * Baixa o JSON preenchido para envio manual
         */
        function baixarJSONPreenchido() {
            if (!validarPreenchimento()) return;
            
            const dados = coletarRespostas();
            const blob = new Blob([JSON.stringify(dados, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `resposta_${dadosCotacao.cotacao.codigo}_${dadosCotacao.fornecedor.nome.replace(/\s+/g, '_')}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            mostrarToast('Sucesso', 'JSON baixado! Envie o arquivo por email para o comprador.', 'success');
        }
        
        /**
         * Envia a cotação diretamente (se conectado à rede interna)
         */
        async function enviarCotacao() {
            if (!validarPreenchimento()) return;
            
            const dados = coletarRespostas();
            
            // Desabilita botão durante envio
            const btn = document.querySelector('.btn-enviar');
            const textoOriginal = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Enviando...';
            
            try {
                const response = await fetch(`/api/cotacao/externa/responder/${dadosCotacao.token}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(dados)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    mostrarToast('Sucesso!', result.message || 'Cotação enviada com sucesso!', 'success');
                    
                    // Mostra mensagem de confirmação
                    setTimeout(() => {
                        document.querySelector('.card-cotacao').innerHTML = `
                            <div class="card-body-custom text-center py-5">
                                <i class="fas fa-check-circle fa-5x text-success mb-4"></i>
                                <h2>Cotação Enviada com Sucesso!</h2>
                                <p class="text-muted">Sua proposta foi recebida e será analisada pelo comprador.</p>
                                <p><strong>Código da Cotação:</strong> ${dadosCotacao.cotacao.codigo}</p>
                                <p class="small text-muted">Você pode fechar esta página.</p>
                            </div>
                        `;
                    }, 1500);
                } else {
                    mostrarToast('Erro', result.error || 'Erro ao enviar cotação', 'danger');
                    btn.disabled = false;
                    btn.innerHTML = textoOriginal;
                }
            } catch (error) {
                console.error('Erro:', error);
                
                // Se falhar conexão, sugere download do JSON
                mostrarToast('Atenção', 'Não foi possível conectar ao servidor. Baixe o JSON e envie por email.', 'warning');
                btn.disabled = false;
                btn.innerHTML = textoOriginal;
            }
        }
        
        /**
         * Drag & Drop para upload de JSON
         */
        const uploadArea = document.getElementById('uploadArea');
        
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });
        
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFileUpload({ files: files });
            }
        });
        
        /**
         * Processa upload de arquivo JSON
         */
        function handleFileUpload(input) {
            const file = input.files[0];
            if (!file) return;
            
            if (!file.name.endsWith('.json')) {
                mostrarToast('Erro', 'Por favor, selecione um arquivo JSON', 'danger');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const dados = JSON.parse(e.target.result);
                    
                    // Valida se é o mesmo token
                    if (dados.token !== dadosCotacao.token) {
                        mostrarToast('Erro', 'Este JSON não corresponde a esta cotação', 'danger');
                        return;
                    }
                    
                    // Preenche os campos com os dados do JSON
                    preencherFormularioComJSON(dados);
                    mostrarToast('Sucesso', 'Dados carregados do JSON!', 'success');
                    
                } catch (error) {
                    mostrarToast('Erro', 'Arquivo JSON inválido', 'danger');
                }
            };
            reader.readAsText(file);
        }
        
        /**
         * Preenche o formulário com dados de um JSON carregado
         */
        function preencherFormularioComJSON(dados) {
            // Preenche itens
            dados.itens.forEach(item => {
                const resposta = item.resposta || {};
                
                if (resposta.preco_unitario) {
                    const inputPreco = document.getElementById(`preco_${item.id}`);
                    inputPreco.value = resposta.preco_unitario.toFixed(2).replace('.', ',');
                }
                
                if (resposta.prazo_entrega_dias) {
                    document.getElementById(`prazo_${item.id}`).value = resposta.prazo_entrega_dias;
                }
                
                if (resposta.observacao) {
                    document.getElementById(`obs_${item.id}`).value = resposta.observacao;
                }
            });
            
            // Preenche campos gerais
            const geral = dados.resposta_geral || {};
            
            if (geral.frete_total) {
                document.getElementById('freteTotal').value = geral.frete_total.toFixed(2).replace('.', ',');
            }
            
            if (geral.condicao_pagamento) {
                document.getElementById('condicaoPagamento').value = geral.condicao_pagamento;
            }
            
            if (geral.validade_proposta) {
                document.getElementById('validadeProposta').value = geral.validade_proposta;
            }
            
            if (geral.observacao_geral) {
                document.getElementById('observacaoGeral').value = geral.observacao_geral;
            }
        }
        
        /**
         * Mostra toast de notificação
         */
        function mostrarToast(titulo, mensagem, tipo = 'info') {
            const toast = document.getElementById('toastNotificacao');
            const toastTitulo = document.getElementById('toastTitulo');
            const toastMensagem = document.getElementById('toastMensagem');
            const toastIcon = document.getElementById('toastIcon');
            
            toastTitulo.textContent = titulo;
            toastMensagem.textContent = mensagem;
            
            // Define ícone e cor baseado no tipo
            toast.classList.remove('text-bg-success', 'text-bg-danger', 'text-bg-warning', 'text-bg-info');
            
            if (tipo === 'success') {
                toast.classList.add('text-bg-success');
                toastIcon.className = 'fas fa-check-circle me-2';
            } else if (tipo === 'danger') {
                toast.classList.add('text-bg-danger');
                toastIcon.className = 'fas fa-times-circle me-2';
            } else if (tipo === 'warning') {
                toast.classList.add('text-bg-warning');
                toastIcon.className = 'fas fa-exclamation-triangle me-2';
            } else {
                toast.classList.add('text-bg-info');
                toastIcon.className = 'fas fa-info-circle me-2';
            }
            
            new bootstrap.Toast(toast, { delay: 5000 }).show();
        }
    </script>
</body>
</html>
