<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Varia√ß√£o de Pre√ßo - An√°lise Estrat√©gica</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.14.0-beta2/css/bootstrap-select.min.css">
    <!-- Estilos customizados para dropdowns mensais -->
    
    <style>
        :root {
            --bg-color: #f0f2f5;
            --card-bg: #ffffff;
            --primary-blue: #0d6efd;
            --text-primary: #1a1a2e;
            --text-secondary: #6c757d;
            --border-color: #e9ecef;
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.08);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.08);
            --radius-sm: 6px;
            --radius-md: 10px;
            --transition: all 0.25s ease;
            --saving-color: #198754;
            --inflation-color: #dc3545;
            --cost-avoidance-color: #0d6efd;
            --primeira-compra-color: #6c757d;
        }

        * { box-sizing: border-box; }

        body {
            background-color: var(--bg-color);
            font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, 'Roboto', sans-serif;
            font-size: 0.875rem;
            color: var(--text-primary);
            overflow-x: hidden;
            line-height: 1.5;
        }

        .wrapper { display: flex; width: 100%; align-items: stretch; }
        
        .sidebar {
            min-width: 250px;
            max-width: 250px;
            background: linear-gradient(180deg, #1a1d21 0%, #212529 100%);
            color: #fff;
            min-height: 100vh;
            transition: var(--transition);
            position: fixed;
            top: 0;
            left: 0;
            z-index: 1000;
            overflow-y: auto;
        }
        
        .sidebar.collapsed { margin-left: -250px; }
        
        .sidebar .sidebar-header {
            padding: 24px 20px;
            background: rgba(0,0,0,0.2);
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .sidebar .sidebar-header h4 { font-weight: 700; letter-spacing: -0.5px; }
        .sidebar ul.components { padding: 16px 0; }
        .sidebar ul li { padding: 0; border-bottom: 1px solid rgba(255,255,255,0.05); }
        
        .sidebar ul li a {
            color: rgba(255,255,255,0.7);
            padding: 14px 20px;
            display: flex;
            align-items: center;
            text-decoration: none;
            transition: var(--transition);
            font-weight: 500;
            font-size: 0.9rem;
        }
        
        .sidebar ul li a i { width: 20px; margin-right: 12px; text-align: center; }
        .sidebar ul li a:hover { color: #fff; background: rgba(255,255,255,0.08); padding-left: 24px; }
        .sidebar ul li.active > a { color: #fff; background: var(--primary-blue); border-left: 4px solid #fff; }

        .content {
            width: 100%;
            padding: 24px 28px;
            margin-left: 250px;
            transition: margin-left 0.3s;
            min-height: 100vh;
        }
        
        .content.expanded { margin-left: 0; }

        /* BOT√ÉO TOGGLE SIDEBAR (Ultra Discreto) */
        .sidebar-toggle {
            position: fixed;
            top: 72px;
            left: 254px;
            z-index: 998;
            background: transparent;
            color: rgba(108, 117, 125, 0.4);
            border: none;
            border-radius: 4px;
            width: 24px;
            height: 24px;
            cursor: pointer;
            box-shadow: none;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            opacity: 0.5;
        }
        
        .sidebar-toggle:hover { 
            background: rgba(108, 117, 125, 0.15);
            color: var(--text-secondary);
            opacity: 1;
            transform: scale(1.1);
        }
        
        .sidebar-toggle.collapsed { 
            left: 8px; 
            top: 12px;
            opacity: 0.7;
            background: rgba(108, 117, 125, 0.1);
        }
        
        .sidebar-toggle.collapsed:hover {
            opacity: 1;
            background: rgba(108, 117, 125, 0.2);
        }

        .page-header { margin-bottom: 24px; }
        .page-header h4 { font-weight: 700; font-size: 1.5rem; color: var(--text-primary); margin-bottom: 4px; }
        .page-header small { color: var(--text-secondary); font-size: 0.85rem; }

        .filter-card {
            background: var(--card-bg);
            border-radius: var(--radius-md);
            padding: 20px;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
            margin-bottom: 24px;
        }

        .form-label-sm {
            font-weight: 600;
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-bottom: 4px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Padroniza√ß√£o visual do Bootstrap Select */
        .bootstrap-select > .dropdown-toggle {
            border: 1px solid var(--border-color) !important;
            background-color: #fff !important;
            height: calc(1.5em + 0.5rem + 2px) !important;
            padding: 0.25rem 0.5rem !important;
            font-size: 0.875rem !important;
            border-radius: var(--radius-sm) !important;
        }
        
        .bootstrap-select > .dropdown-toggle:focus {
            border-color: var(--primary-blue) !important;
            box-shadow: 0 0 0 3px rgba(13, 110, 253, 0.15) !important;
        }

        .form-control, .form-select { 
            border-radius: var(--radius-sm); 
            border: 1px solid var(--border-color); 
            font-size: 0.875rem; 
        }
        
        .form-control:focus, .form-select:focus { 
            border-color: var(--primary-blue); 
            box-shadow: 0 0 0 3px rgba(13, 110, 253, 0.15); 
        }

        .kpi-card {
            background: var(--card-bg);
            border-radius: var(--radius-md);
            padding: 20px 16px;
            text-align: center;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
            height: 100%;
            border-left: 4px solid transparent;
            transition: var(--transition);
            position: relative;
        }

        .kpi-card:hover { transform: translateY(-4px); box-shadow: var(--shadow-md); }
        .kpi-card.border-green { border-left-color: var(--saving-color); }
        .kpi-card.border-red { border-left-color: var(--inflation-color); }
        .kpi-card.border-blue { border-left-color: var(--cost-avoidance-color); }
        .kpi-card.border-gray { border-left-color: var(--primeira-compra-color); }
        .kpi-card.border-purple { border-left-color: #6f42c1; }

        .kpi-value { font-size: 1.5rem; font-weight: 800; color: var(--text-primary); margin-bottom: 4px; letter-spacing: -1px; }
        .kpi-value.text-saving { color: var(--saving-color); }
        .kpi-value.text-inflation { color: var(--inflation-color); }
        .kpi-value.text-positive { color: var(--saving-color); }
        .kpi-value.text-negative { color: var(--inflation-color); }
        
        .kpi-label { font-size: 0.68rem; text-transform: uppercase; color: var(--text-secondary); letter-spacing: 0.6px; font-weight: 600; }
        .kpi-subtitle { font-size: 0.72rem; color: var(--text-secondary); margin-top: 6px; }
        .kpi-icon { font-size: 1.8rem; opacity: 0.15; position: absolute; top: 12px; right: 12px; }

        /* =====================================================
           TOOLTIP INFORMATIVO - EXPLICA√á√ÉO CONTEXTUAL
           ===================================================== */
        .info-tooltip {
            position: relative;
            cursor: help;
        }
        
        .info-tooltip .tooltip-content {
            visibility: hidden;
            opacity: 0;
            position: absolute;
            z-index: 9999;
            bottom: calc(100% + 10px);
            left: 50%;
            transform: translateX(-50%);
            width: 320px;
            background: linear-gradient(135deg, #1a1d21 0%, #2d3238 100%);
            color: #fff;
            padding: 16px;
            border-radius: 10px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            font-size: 0.75rem;
            line-height: 1.5;
            text-align: left;
            transition: all 0.3s ease;
            pointer-events: none;
        }
        
        .info-tooltip .tooltip-content::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 8px solid transparent;
            border-top-color: #2d3238;
        }
        
        .info-tooltip:hover .tooltip-content {
            visibility: visible;
            opacity: 1;
            pointer-events: auto;
        }
        
        .tooltip-section {
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255,255,255,0.15);
        }
        
        .tooltip-section:last-child {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }
        
        .tooltip-title {
            font-weight: 700;
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .tooltip-title.conceito { color: #60a5fa; }
        .tooltip-title.calculo { color: #34d399; }
        .tooltip-title.origem { color: #fbbf24; }
        
        .tooltip-text {
            color: rgba(255,255,255,0.9);
            font-size: 0.72rem;
        }
        
        .kpi-card .info-badge {
            position: absolute;
            top: 8px;
            left: 8px;
            font-size: 0.65rem;
            color: var(--text-secondary);
            opacity: 0.6;
            transition: opacity 0.2s;
        }
        
        .kpi-card:hover .info-badge {
            opacity: 1;
            color: var(--primary-blue);
        }
        
        .chart-header .info-tooltip .tooltip-content {
            left: 0;
            transform: translateX(0);
        }
        
        .chart-header .info-tooltip .tooltip-content::after {
            left: 30px;
        }

        .chart-card {
            background: var(--card-bg);
            border-radius: var(--radius-md);
            padding: 24px;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
            height: 420px;
            position: relative;
            display: flex;
            flex-direction: column;
        }
        
        .chart-header {
            font-size: 1rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 20px;
            padding-bottom: 14px;
            border-bottom: 2px solid var(--border-color);
            flex-shrink: 0;
            display: flex;
            align-items: center;
        }
        
        .chart-header i { color: var(--primary-blue); }

        .chart-container {
            position: relative;
            flex: 1;
            min-height: 0;
            width: 100%;
        }

        .chart-container canvas {
            max-height: 100%;
            width: 100% !important;
        }

        .table-card {
            background: var(--card-bg);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
            overflow: hidden;
        }

        .table-card .card-title {
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--text-primary);
            padding: 16px 20px;
            margin-bottom: 0;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .table-responsive {
            max-height: 550px;
            overflow-y: auto;
        }

        .table {
            margin-bottom: 0;
            font-size: 0.78rem;
        }

        .table th {
            background: #f8f9fa;
            position: sticky;
            top: 0;
            z-index: 10;
            font-weight: 600;
            font-size: 0.68rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-secondary);
            border-bottom: 2px solid var(--border-color);
            padding: 10px 8px;
            white-space: nowrap;
        }

        .table td {
            padding: 8px;
            vertical-align: middle;
            border-bottom: 1px solid var(--border-color);
        }

        .table tbody tr:hover {
            background-color: rgba(13, 110, 253, 0.04);
        }

        .badge-saving {
            background-color: rgba(25, 135, 84, 0.15);
            color: var(--saving-color);
            font-weight: 600;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.72rem;
        }

        .badge-inflation {
            background-color: rgba(220, 53, 69, 0.15);
            color: var(--inflation-color);
            font-weight: 600;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.72rem;
        }

        .badge-cost-avoidance {
            background-color: rgba(13, 110, 253, 0.15);
            color: var(--cost-avoidance-color);
            font-weight: 600;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.72rem;
        }

        .badge-primeira-compra {
            background-color: rgba(108, 117, 125, 0.15);
            color: var(--primeira-compra-color);
            font-weight: 600;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.72rem;
        }

        .badge-antiga {
            background-color: rgba(255, 193, 7, 0.2);
            color: #856404;
            font-size: 0.65rem;
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: 4px;
        }

        .valor-saving { color: var(--saving-color); font-weight: 600; }
        .valor-inflation { color: var(--inflation-color); font-weight: 600; }
        .valor-neutral { color: var(--text-secondary); }
        .valor-na { color: var(--primeira-compra-color); font-style: italic; }

        .legend-box {
            background: var(--card-bg);
            border-radius: var(--radius-sm);
            padding: 12px 16px;
            border: 1px solid var(--border-color);
            margin-bottom: 16px;
        }
        
        .legend-item {
            display: inline-flex;
            align-items: center;
            margin-right: 20px;
            font-size: 0.75rem;
        }
        
        .legend-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 6px;
        }
        
        .legend-dot.saving { background: var(--saving-color); }
        .legend-dot.inflation { background: var(--inflation-color); }
        .legend-dot.cost-avoidance { background: var(--cost-avoidance-color); }
        .legend-dot.primeira-compra { background: var(--primeira-compra-color); }

        @media (max-width: 992px) {
            .sidebar { margin-left: -250px; }
            .sidebar.active { margin-left: 0; }
            .content { margin-left: 0; }
            .sidebar-toggle { 
                left: 8px; 
                top: 12px;
                opacity: 0.7;
                background: rgba(108, 117, 125, 0.1);
            }
        }

        /* SISTEMA DE ANOTA√á√ïES */
        .btn-anotacao {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            transition: all 0.2s;
            font-size: 0.8rem;
        }
        
        .btn-anotacao:hover {
            background: rgba(13, 110, 253, 0.1);
            color: var(--primary-blue);
        }
        
        .btn-anotacao.has-note {
            background: #ffc107;
            border-radius: 4px;
            padding: 6px 10px;
        }
        
        .btn-anotacao.has-note:hover {
            background: #ffb300;
        }
        
        .btn-anotacao.has-note i,
        .btn-anotacao.has-note i::before {
            color: #1a1a2e !important;
            animation: pulse 2s infinite;
        }
        
        .btn-anotacao.has-note:hover i,
        .btn-anotacao.has-note:hover i::before {
            color: #000 !important;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .modal-anotacao .modal-header {
            background: linear-gradient(135deg, #ffc107, #ffb300);
            color: #1a1a2e;
            border-radius: var(--radius-md) var(--radius-md) 0 0;
        }
        
        .modal-anotacao .modal-header .btn-close {
            filter: brightness(0.2);
        }
        
        .modal-anotacao .modal-body {
            padding: 24px;
        }
        
        .modal-anotacao textarea {
            resize: vertical;
            min-height: 120px;
        }
        
        .modal-anotacao .pedido-info {
            background: #f8f9fa;
            border-radius: var(--radius-sm);
            padding: 12px;
            margin-bottom: 16px;
            font-size: 0.8rem;
        }
        
        .modal-anotacao .pedido-info strong {
            color: #ffc107;
        }
        
        .btn-delete-note {
            color: var(--inflation-color);
        }
        
        .btn-delete-note:hover {
            background: rgba(220, 53, 69, 0.1);
        }

        /* Varia√ß√£o percentual */
        .variacao-percent {
            font-size: 0.65rem;
            display: block;
            margin-top: 2px;
            opacity: 0.85;
        }

        /* ========================================
           SPINNER GLOBAL
        ======================================== */
        .spinner-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.6);
            z-index: 9997;
            display: none;
        }
        .spinner-backdrop.active { display: block; }
        
        .spinner-global {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 9998;
            display: none;
        }
        .spinner-global.active { display: block; }
        
        .spinner-global .spinner-box {
            background: white;
            padding: 24px 32px;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            gap: 16px;
        }
        
        .spinner-global .spinner-circle {
            width: 32px;
            height: 32px;
            border: 3px solid #e9ecef;
            border-top-color: var(--primary-blue);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .spinner-global .spinner-text {
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--text-primary);
        }
    </style>
</head>
<body>
    <!-- Spinner Global de Carregamento -->
    <div class="spinner-backdrop" id="spinnerBackdrop"></div>
    <div class="spinner-global" id="spinnerGlobal">
        <div class="spinner-box">
            <div class="spinner-circle"></div>
            <span class="spinner-text" id="spinnerText">Carregando...</span>
        </div>
    </div>

    <div class="wrapper">
        <!-- SIDEBAR -->
        <nav id="sidebar" class="sidebar">
            <div class="sidebar-header">
                <h4 class="mb-0"><i class="fas fa-cubes me-2"></i>Polimaquinas</h4>
                <small class="text-muted" style="font-size: 0.75rem;">Portal de Compras</small>
            </div>
            <ul class="list-unstyled components">
                <li><a href="{{ url_for('dashboard') }}"><i class="fas fa-chart-line"></i> Dashboard Financeiro</a></li>
                <li><a href="{{ url_for('status_pedidos') }}"><i class="fas fa-tasks"></i> Status de Pedidos</a></li>
                <li><a href="{{ url_for('performance') }}"><i class="fas fa-tachometer-alt"></i> OTD & Performance</a></li>
                <li class="active"><a href="{{ url_for('variacao_preco') }}"><i class="fas fa-balance-scale"></i> Varia√ß√£o de Pre√ßo</a></li>
                <li><a href="{{ url_for('terceiros') }}"><i class="fas fa-industry"></i> Terceiros</a></li>
                <li><a href="{{ url_for('solicitacoes') }}"><i class="fas fa-file-alt"></i> Solicita√ß√µes em Aberto</a></li>
                <li><a href="{{ url_for('cotacoes') }}"><i class="fas fa-file-invoice-dollar"></i> Cota√ß√µes e Or√ßamentos</a></li>
                <li><a href="{{ url_for('avaliacao_iso') }}"><i class="fas fa-certificate"></i> Avalia√ß√£o ISO (PQ021)</a></li>
            </ul>
        </nav>

        <!-- TOGGLE BUTTON -->
        <button class="sidebar-toggle" id="sidebarToggle"><i class="fas fa-bars"></i></button>

        <!-- CONTE√öDO PRINCIPAL -->
        <div class="content" id="content">
            <div class="page-header d-flex justify-content-between align-items-center">
                <div>
                    <h4><i class="fas fa-balance-scale text-primary me-2"></i>Varia√ß√£o de Pre√ßo</h4>
                    <small>An√°lise Par-a-Par: Saving, Inflation & Cost Avoidance</small>
                </div>
                <div>
                    <span class="badge bg-secondary">{{ total_items }} itens √∫nicos</span>
                    <a href="{{ url_for('limpar_cache_variacao') }}" class="btn btn-outline-warning btn-sm ms-2" title="Atualizar dados do banco">
                        <i class="fas fa-sync-alt"></i>
                    </a>
                </div>
            </div>

            <!-- ERRO -->
            {% if erro %}
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle me-2"></i>{{ erro }}
            </div>
            {% endif %}

            <!-- FILTROS -->
            <div class="filter-card">
                <form method="POST" class="row g-2 align-items-end">
                    <div class="col-md-1">
                        <label class="form-label-sm">PER√çODO - DE:</label>
                        <select name="data_inicio" class="form-control form-control-sm" id="selectDataInicio">
                        </select>
                    </div>
                    <div class="col-md-1">
                        <label class="form-label-sm">AT√â:</label>
                        <select name="data_fim" class="form-control form-control-sm" id="selectDataFim">
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label-sm">FORNECEDORES</label>
                        <select class="selectpicker form-control" name="fornecedores" multiple data-live-search="true" data-actions-box="true" data-selected-text-format="count > 2" title="Selecione...">
                            {% for f in fornecedores %}
                            <option value="{{ f }}" {% if f in fornecedores_selecionados %}selected{% endif %}>{{ f }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label-sm">BUSCA <small class="text-primary">(AN√ÅLISE)</small></label>
                        <div class="input-group input-group-sm">
                            <span class="input-group-text"><i class="fas fa-search"></i></span>
                            <input type="text" class="form-control" name="busca_geral" placeholder="Produto, Pedido" value="{{ busca_geral|default('') }}">
                        </div>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label-sm">COMPRADOR</label>
                        <select name="comprador" class="form-select form-select-sm">
                            <option value="Todos">Todos</option>
                            {% for comp in compradores %}
                            <option value="{{ comp }}" {% if comp == comprador_selecionado %}selected{% endif %}>{{ comp }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-1">
                        <label class="form-label-sm">TIPO</label>
                        <select name="tipo_produto" class="form-select form-select-sm">
                            <option value="Todos">Todos</option>
                            {% for tipo in tipos_produto %}
                            <option value="{{ tipo }}" {% if tipo == tipo_selecionado %}selected{% endif %}>{{ tipo }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label-sm">CLASSIFICA√á√ÉO</label>
                        <select name="classificacao" class="form-select form-select-sm">
                            <option value="Todos" {% if classificacao_selecionada == 'Todos' %}selected{% endif %}>Todos</option>
                            <option value="Saving" {% if classificacao_selecionada == 'Saving' %}selected{% endif %}>üü¢ Saving</option>
                            <option value="Inflation" {% if classificacao_selecionada == 'Inflation' %}selected{% endif %}>üî¥ Inflation</option>
                            <option value="Cost Avoidance" {% if classificacao_selecionada == 'Cost Avoidance' %}selected{% endif %}>üîµ Cost Avoidance</option>
                            <option value="Primeira Compra" {% if classificacao_selecionada == 'Primeira Compra' %}selected{% endif %}>‚ö™ 1¬™ Compra</option>
                        </select>
                    </div>
                    <div class="col-md-1">
                        <label class="form-label-sm">&nbsp;</label>
                        <div class="d-flex gap-1">
                            <button type="submit" class="btn btn-primary btn-sm" title="Filtrar"><i class="fas fa-filter"></i></button>
                            <a href="{{ url_for('limpar_cache_variacao') }}" class="btn btn-outline-secondary btn-sm" title="Limpar filtros"><i class="fas fa-eraser"></i></a>
                        </div>
                    </div>
                </form>
            </div>
            
            <!-- INDICADOR DE MODO -->
            {% if modo_analitico %}
            <div class="alert alert-info d-flex align-items-center mb-3" role="alert">
                <i class="fas fa-microscope fa-lg me-3"></i>
                <div>
                    <strong>Modo An√°lise Profunda (Notas Fiscais)</strong> ‚Äî 
                    {% if produto_analisado %}
                    Analisando: <strong>{{ produto_analisado.descricao }}</strong> ({{ produto_analisado.total_compras }} NFs encontradas)
                    {% else %}
                    Exibindo todas as notas fiscais do per√≠odo para os itens encontrados
                    {% endif %}
                    <br><small class="text-muted">Limpe o campo "Busca" para voltar √† vis√£o consolidada | Valores baseados em Notas Fiscais faturadas</small>
                </div>
            </div>
            {% else %}
            <div class="alert alert-light border d-flex align-items-center mb-3" role="alert">
                <i class="fas fa-chart-pie fa-lg me-3 text-primary"></i>
                <div>
                    <strong>Vis√£o Consolidada (Notas Fiscais)</strong> ‚Äî Uma linha por produto (NF mais recente comparada com anterior)
                    <br><small class="text-muted">Use o campo "Busca" para an√°lise hist√≥rica detalhada de um item espec√≠fico | Valores baseados em pre√ßos faturados</small>
                </div>
            </div>
            {% endif %}

            <!-- KPIs -->
            {% if modo_analitico %}
            <!-- KPIs MODO ANAL√çTICO (foco no item pesquisado) -->
            <div class="row g-3 mb-4">
                <div class="col-md-2">
                    <div class="kpi-card border-secondary info-tooltip">
                        <i class="fas fa-info-circle info-badge"></i>
                        <div class="tooltip-content">
                            <div class="tooltip-section">
                                <div class="tooltip-title conceito"><i class="fas fa-lightbulb"></i> CONCEITO</div>
                                <div class="tooltip-text">Quantidade total de notas fiscais de entrada (ENFs) v√°lidas encontradas para o item pesquisado no per√≠odo selecionado. Cada NF representa um evento de compra efetivado.</div>
                            </div>
                            <div class="tooltip-section">
                                <div class="tooltip-title calculo"><i class="fas fa-calculator"></i> L√ìGICA DE C√ÅLCULO</div>
                                <div class="tooltip-text">Contagem simples de ENFs distintas que atendem aos filtros aplicados (per√≠odo, fornecedor, produto). Apenas NFs vinculadas a pedidos de compra s√£o consideradas.</div>
                            </div>
                            <div class="tooltip-section">
                                <div class="tooltip-title origem"><i class="fas fa-database"></i> ORIGEM DOS DADOS</div>
                                <div class="tooltip-text">SQL Server ‚Üí ERP TOTVS ‚Üí Tabela SD1010 (Itens de NF de Entrada). Granularidade: Nota Fiscal.</div>
                            </div>
                        </div>
                        <i class="fas fa-shopping-cart kpi-icon text-secondary"></i>
                        <div class="kpi-value text-secondary">{{ count_compras|default(0) }}</div>
                        <div class="kpi-label">Total de NFs</div>
                        <div class="kpi-subtitle">no per√≠odo filtrado</div>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="kpi-card border-green info-tooltip">
                        <i class="fas fa-info-circle info-badge"></i>
                        <div class="tooltip-content">
                            <div class="tooltip-section">
                                <div class="tooltip-title conceito"><i class="fas fa-lightbulb"></i> CONCEITO</div>
                                <div class="tooltip-text">Saving representa a economia real obtida quando o pre√ßo unit√°rio faturado na NF atual √© MENOR que o pre√ßo da NF imediatamente anterior do mesmo produto.</div>
                            </div>
                            <div class="tooltip-section">
                                <div class="tooltip-title calculo"><i class="fas fa-calculator"></i> L√ìGICA DE C√ÅLCULO</div>
                                <div class="tooltip-text">Valor: Œ£ (Pre√ßo Anterior - Pre√ßo Atual) √ó Qtd. Representa a economia financeira obtida em rela√ß√£o ao que pagar√≠amos mantendo pre√ßos anteriores.</div>
                            </div>
                            <div class="tooltip-section">
                                <div class="tooltip-title origem"><i class="fas fa-database"></i> ORIGEM DOS DADOS</div>
                                <div class="tooltip-text">SQL Server ‚Üí ERP TOTVS ‚Üí SD1010 (D1_VUNIT, D1_QUANT). Compara√ß√£o par-a-par entre NFs consecutivas do mesmo produto.</div>
                            </div>
                        </div>
                        <i class="fas fa-arrow-down kpi-icon" style="color: var(--saving-color);"></i>
                        <div class="kpi-value text-saving">R$ {{ "{:,.2f}".format(total_pago_menos|default(0)).replace(",", "X").replace(".", ",").replace("X", ".") }}</div>
                        <div class="kpi-label">Economia (Saving)</div>
                        <div class="kpi-subtitle">{{ count_saving|default(0) }} compras</div>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="kpi-card border-red info-tooltip">
                        <i class="fas fa-info-circle info-badge"></i>
                        <div class="tooltip-content">
                            <div class="tooltip-section">
                                <div class="tooltip-title conceito"><i class="fas fa-lightbulb"></i> CONCEITO</div>
                                <div class="tooltip-text">Inflation representa o aumento de custo quando o pre√ßo unit√°rio faturado na NF atual √© MAIOR que o pre√ßo da NF imediatamente anterior do mesmo produto.</div>
                            </div>
                            <div class="tooltip-section">
                                <div class="tooltip-title calculo"><i class="fas fa-calculator"></i> L√ìGICA DE C√ÅLCULO</div>
                                <div class="tooltip-text">Valor: Œ£ (Pre√ßo Atual - Pre√ßo Anterior) √ó Qtd. Representa o aumento de custo em rela√ß√£o ao que pag√°vamos antes.</div>
                            </div>
                            <div class="tooltip-section">
                                <div class="tooltip-title origem"><i class="fas fa-database"></i> ORIGEM DOS DADOS</div>
                                <div class="tooltip-text">SQL Server ‚Üí ERP TOTVS ‚Üí SD1010 (D1_VUNIT, D1_QUANT). Compara√ß√£o par-a-par entre NFs consecutivas do mesmo produto.</div>
                            </div>
                        </div>
                        <i class="fas fa-arrow-up kpi-icon" style="color: var(--inflation-color);"></i>
                        <div class="kpi-value text-inflation">R$ {{ "{:,.2f}".format(total_pago_mais|default(0)).replace(",", "X").replace(".", ",").replace("X", ".") }}</div>
                        <div class="kpi-label">Aumento (Inflation)</div>
                        <div class="kpi-subtitle">{{ count_inflacao|default(0) }} compras</div>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="kpi-card {% if saldo_liquido >= 0 %}border-green{% else %}border-red{% endif %} info-tooltip">
                        <i class="fas fa-info-circle info-badge"></i>
                        <div class="tooltip-content">
                            <div class="tooltip-section">
                                <div class="tooltip-title conceito"><i class="fas fa-lightbulb"></i> CONCEITO</div>
                                <div class="tooltip-text">Saldo L√≠quido √© o resultado financeiro final: diferen√ßa entre economia (Saving) e aumento (Inflation). Positivo = economia l√≠quida; Negativo = preju√≠zo l√≠quido.</div>
                            </div>
                            <div class="tooltip-section">
                                <div class="tooltip-title calculo"><i class="fas fa-calculator"></i> L√ìGICA DE C√ÅLCULO</div>
                                <div class="tooltip-text">Saldo = Total Saving - Total Inflation. Representa o resultado financeiro l√≠quido do per√≠odo.</div>
                            </div>
                            <div class="tooltip-section">
                                <div class="tooltip-title origem"><i class="fas fa-database"></i> ORIGEM DOS DADOS</div>
                                <div class="tooltip-text">C√°lculo derivado dos indicadores Saving e Inflation. Base: NFs do ERP TOTVS (SD1010).</div>
                            </div>
                        </div>
                        <i class="fas fa-balance-scale kpi-icon {% if saldo_liquido >= 0 %}text-success{% else %}text-danger{% endif %}"></i>
                        <div class="kpi-value {% if saldo_liquido >= 0 %}text-success{% else %}text-danger{% endif %}">
                            R$ {{ "{:,.2f}".format(saldo_liquido|default(0)|abs).replace(",", "X").replace(".", ",").replace("X", ".") }}
                        </div>
                        <div class="kpi-label">Saldo L√≠quido</div>
                        <div class="kpi-subtitle">{% if saldo_liquido >= 0 %}economia l√≠quida{% else %}aumento l√≠quido{% endif %}</div>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="kpi-card border-blue info-tooltip">
                        <i class="fas fa-info-circle info-badge"></i>
                        <div class="tooltip-content">
                            <div class="tooltip-section">
                                <div class="tooltip-title conceito"><i class="fas fa-lightbulb"></i> CONCEITO</div>
                                <div class="tooltip-text">Cost Avoidance indica compras onde o pre√ßo foi MANTIDO em rela√ß√£o √† NF anterior. Representa prote√ß√£o contra aumentos de pre√ßo e estabilidade de custos.</div>
                            </div>
                            <div class="tooltip-section">
                                <div class="tooltip-title calculo"><i class="fas fa-calculator"></i> L√ìGICA DE C√ÅLCULO</div>
                                <div class="tooltip-text">Contagem de NFs onde Pre√ßo Atual = Pre√ßo Anterior (varia√ß√£o zero). N√£o h√° impacto financeiro imediato, mas indica negocia√ß√£o bem-sucedida.</div>
                            </div>
                            <div class="tooltip-section">
                                <div class="tooltip-title origem"><i class="fas fa-database"></i> ORIGEM DOS DADOS</div>
                                <div class="tooltip-text">SQL Server ‚Üí ERP TOTVS ‚Üí SD1010 (D1_VUNIT). Compara√ß√£o par-a-par entre NFs consecutivas.</div>
                            </div>
                        </div>
                        <i class="fas fa-shield-alt kpi-icon" style="color: var(--cost-avoidance-color);"></i>
                        <div class="kpi-value" style="color: var(--cost-avoidance-color);">R$ {{ "{:,.2f}".format(valor_cost_avoidance|default(0)).replace(",", "X").replace(".", ",").replace("X", ".") }}</div>
                        <div class="kpi-label">Cost Avoidance</div>
                        <div class="kpi-subtitle">{{ count_cost_avoidance|default(0) }} pre√ßos mantidos</div>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="kpi-card border-purple info-tooltip">
                        <i class="fas fa-info-circle info-badge"></i>
                        <div class="tooltip-content">
                            <div class="tooltip-section">
                                <div class="tooltip-title conceito"><i class="fas fa-lightbulb"></i> CONCEITO</div>
                                <div class="tooltip-text">Cost Avoidance Acumulado representa a economia continuada gerada por manter pre√ßos est√°veis. Se um pre√ßo foi reduzido e mantido nas compras seguintes, o benef√≠cio se acumula.</div>
                            </div>
                            <div class="tooltip-section">
                                <div class="tooltip-title calculo"><i class="fas fa-calculator"></i> L√ìGICA DE C√ÅLCULO</div>
                                <div class="tooltip-text">Soma de: (Menor Pre√ßo Hist√≥rico Anterior - Pre√ßo Atual) √ó Quantidade, para NFs com pre√ßo mantido abaixo do pico hist√≥rico. Benef√≠cio recorrente de negocia√ß√µes passadas.</div>
                            </div>
                            <div class="tooltip-section">
                                <div class="tooltip-title origem"><i class="fas fa-database"></i> ORIGEM DOS DADOS</div>
                                <div class="tooltip-text">SQL Server ‚Üí ERP TOTVS ‚Üí SD1010. An√°lise hist√≥rica completa de pre√ßos por produto.</div>
                            </div>
                        </div>
                        <i class="fas fa-trophy kpi-icon" style="color: #6f42c1;"></i>
                        <div class="kpi-value" style="color: #6f42c1;">R$ {{ "{:,.2f}".format(cost_avoidance_acumulado|default(0)).replace(",", "X").replace(".", ",").replace("X", ".") }}</div>
                        <div class="kpi-label">C.A. Acumulado</div>
                        <div class="kpi-subtitle">economia continuada</div>
                    </div>
                </div>
            </div>
            {% else %}
            <!-- KPIs MODO EXECUTIVO (vis√£o consolidada) -->
            <div class="row g-3 mb-4">
                <div class="col-md-3">
                    <div class="kpi-card border-green info-tooltip">
                        <i class="fas fa-info-circle info-badge"></i>
                        <div class="tooltip-content">
                            <div class="tooltip-section">
                                <div class="tooltip-title conceito"><i class="fas fa-lightbulb"></i> CONCEITO</div>
                                <div class="tooltip-text">Saving consolidado: soma de todas as economias obtidas quando o pre√ßo faturado foi MENOR que o pre√ßo anterior. Representa ganhos reais de negocia√ß√£o.</div>
                            </div>
                            <div class="tooltip-section">
                                <div class="tooltip-title calculo"><i class="fas fa-calculator"></i> L√ìGICA DE C√ÅLCULO</div>
                                <div class="tooltip-text">Valor: Œ£ (Pre√ßo Anterior - Pre√ßo Atual) √ó Qtd. Representa a economia financeira em rela√ß√£o ao que pagar√≠amos mantendo pre√ßos anteriores.</div>
                            </div>
                            <div class="tooltip-section">
                                <div class="tooltip-title origem"><i class="fas fa-database"></i> ORIGEM DOS DADOS</div>
                                <div class="tooltip-text">SQL Server ‚Üí ERP TOTVS ‚Üí SD1010. Vis√£o consolidada por produto (NF mais recente vs anterior).</div>
                            </div>
                        </div>
                        <i class="fas fa-arrow-down kpi-icon" style="color: var(--saving-color);"></i>
                        <div class="kpi-value text-saving">R$ {{ "{:,.2f}".format(total_pago_menos|default(0)).replace(",", "X").replace(".", ",").replace("X", ".") }}</div>
                        <div class="kpi-label">Economia (Saving)</div>
                        <div class="kpi-subtitle">{{ count_saving|default(0) }} compras</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="kpi-card border-red info-tooltip">
                        <i class="fas fa-info-circle info-badge"></i>
                        <div class="tooltip-content">
                            <div class="tooltip-section">
                                <div class="tooltip-title conceito"><i class="fas fa-lightbulb"></i> CONCEITO</div>
                                <div class="tooltip-text">Inflation consolidado: soma de todos os aumentos de custo quando o pre√ßo faturado foi MAIOR que o pre√ßo anterior. Representa press√£o inflacion√°ria.</div>
                            </div>
                            <div class="tooltip-section">
                                <div class="tooltip-title calculo"><i class="fas fa-calculator"></i> L√ìGICA DE C√ÅLCULO</div>
                                <div class="tooltip-text">Valor: Œ£ (Pre√ßo Atual - Pre√ßo Anterior) √ó Qtd. Representa o aumento de custo em rela√ß√£o ao que pag√°vamos antes.</div>
                            </div>
                            <div class="tooltip-section">
                                <div class="tooltip-title origem"><i class="fas fa-database"></i> ORIGEM DOS DADOS</div>
                                <div class="tooltip-text">SQL Server ‚Üí ERP TOTVS ‚Üí SD1010. Vis√£o consolidada por produto (NF mais recente vs anterior).</div>
                            </div>
                        </div>
                        <i class="fas fa-arrow-up kpi-icon" style="color: var(--inflation-color);"></i>
                        <div class="kpi-value text-inflation">R$ {{ "{:,.2f}".format(total_pago_mais|default(0)).replace(",", "X").replace(".", ",").replace("X", ".") }}</div>
                        <div class="kpi-label">Aumento (Inflation)</div>
                        <div class="kpi-subtitle">{{ count_inflacao|default(0) }} compras</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="kpi-card {% if saldo_liquido >= 0 %}border-green{% else %}border-red{% endif %} info-tooltip">
                        <i class="fas fa-info-circle info-badge"></i>
                        <div class="tooltip-content">
                            <div class="tooltip-section">
                                <div class="tooltip-title conceito"><i class="fas fa-lightbulb"></i> CONCEITO</div>
                                <div class="tooltip-text">Saldo L√≠quido: resultado financeiro final do per√≠odo. Diferen√ßa entre economia total (Saving) e aumento total (Inflation).</div>
                            </div>
                            <div class="tooltip-section">
                                <div class="tooltip-title calculo"><i class="fas fa-calculator"></i> L√ìGICA DE C√ÅLCULO</div>
                                <div class="tooltip-text">Saldo = Total Saving - Total Inflation. Representa o resultado financeiro l√≠quido do per√≠odo.</div>
                            </div>
                            <div class="tooltip-section">
                                <div class="tooltip-title origem"><i class="fas fa-database"></i> ORIGEM DOS DADOS</div>
                                <div class="tooltip-text">C√°lculo derivado. Base: NFs do ERP TOTVS (SD1010) consolidadas por produto.</div>
                            </div>
                        </div>
                        <i class="fas fa-balance-scale kpi-icon {% if saldo_liquido >= 0 %}text-success{% else %}text-danger{% endif %}"></i>
                        <div class="kpi-value {% if saldo_liquido >= 0 %}text-success{% else %}text-danger{% endif %}">
                            R$ {{ "{:,.2f}".format(saldo_liquido|default(0)|abs).replace(",", "X").replace(".", ",").replace("X", ".") }}
                        </div>
                        <div class="kpi-label">Saldo L√≠quido</div>
                        <div class="kpi-subtitle">{% if saldo_liquido >= 0 %}economia l√≠quida{% else %}aumento l√≠quido{% endif %}</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="kpi-card border-blue info-tooltip">
                        <i class="fas fa-info-circle info-badge"></i>
                        <div class="tooltip-content">
                            <div class="tooltip-section">
                                <div class="tooltip-title conceito"><i class="fas fa-lightbulb"></i> CONCEITO</div>
                                <div class="tooltip-text">Cost Avoidance: quantidade de itens onde o pre√ßo foi MANTIDO igual ao anterior. Indica estabilidade de custos e negocia√ß√£o preventiva.</div>
                            </div>
                            <div class="tooltip-section">
                                <div class="tooltip-title calculo"><i class="fas fa-calculator"></i> L√ìGICA DE C√ÅLCULO</div>
                                <div class="tooltip-text">Contagem de produtos onde Pre√ßo Atual = Pre√ßo Anterior (varia√ß√£o = 0%). Sem impacto financeiro imediato, mas protege contra aumentos.</div>
                            </div>
                            <div class="tooltip-section">
                                <div class="tooltip-title origem"><i class="fas fa-database"></i> ORIGEM DOS DADOS</div>
                                <div class="tooltip-text">SQL Server ‚Üí ERP TOTVS ‚Üí SD1010. Compara√ß√£o NF atual vs NF anterior por produto.</div>
                            </div>
                        </div>
                        <i class="fas fa-shield-alt kpi-icon" style="color: var(--cost-avoidance-color);"></i>
                        <div class="kpi-value" style="color: var(--cost-avoidance-color);">
                            R$ {{ "{:,.2f}".format(valor_cost_avoidance|default(0)).replace(",", "X").replace(".", ",").replace("X", ".") }}
                        </div>
                        <div class="kpi-label">Cost Avoidance</div>
                        <div class="kpi-subtitle">{{ count_cost_avoidance|default(0) }} pre√ßos mantidos</div>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- GR√ÅFICO DE EVOLU√á√ÉO (APENAS MODO ANAL√çTICO) -->
            {% if modo_analitico %}
            <div class="row g-4 mb-4">
                <div class="col-12">
                    <div class="chart-card">
                        <div class="chart-header info-tooltip">
                            <i class="fas fa-chart-line me-2"></i>Evolu√ß√£o Hist√≥rica de Pre√ßo
                            {% if produto_analisado %}
                            <small class="text-muted ms-2">‚Äî {{ produto_analisado.descricao }}</small>
                            {% endif %}
                            <i class="fas fa-info-circle ms-2 text-secondary" style="font-size: 0.8rem; opacity: 0.6;"></i>
                            <div class="tooltip-content">
                                <div class="tooltip-section">
                                    <div class="tooltip-title conceito"><i class="fas fa-lightbulb"></i> CONCEITO</div>
                                    <div class="tooltip-text">Linha do tempo mostrando a evolu√ß√£o do pre√ßo unit√°rio faturado do produto ao longo das notas fiscais recebidas. Permite visualizar tend√™ncias e sazonalidades.</div>
                                </div>
                                <div class="tooltip-section">
                                    <div class="tooltip-title calculo"><i class="fas fa-calculator"></i> L√ìGICA DE C√ÅLCULO</div>
                                    <div class="tooltip-text">Cada ponto representa o pre√ßo unit√°rio (D1_VUNIT) de uma NF, plotado na data de digita√ß√£o (D1_DTDIGIT). Ordenado cronologicamente.</div>
                                </div>
                                <div class="tooltip-section">
                                    <div class="tooltip-title origem"><i class="fas fa-database"></i> ORIGEM DOS DADOS</div>
                                    <div class="tooltip-text">SQL Server ‚Üí ERP TOTVS ‚Üí SD1010 (D1_VUNIT, D1_DTDIGIT). Apenas NFs com pedido associado. Tooltip mostra NF, pedido e pre√ßo.</div>
                                </div>
                            </div>
                        </div>
                        <div class="chart-container" style="height: 300px;">
                            <canvas id="chartEvolucao"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            {% else %}
            <!-- GR√ÅFICOS MODO EXECUTIVO -->
            <div class="row g-4 mb-4">
                <div class="col-md-6">
                    <div class="chart-card">
                        <div class="chart-header info-tooltip">
                            <i class="fas fa-user-tie me-2"></i>Impacto Financeiro por Comprador
                            <i class="fas fa-info-circle ms-2 text-secondary" style="font-size: 0.8rem; opacity: 0.6;"></i>
                            <div class="tooltip-content">
                                <div class="tooltip-section">
                                    <div class="tooltip-title conceito"><i class="fas fa-lightbulb"></i> CONCEITO</div>
                                    <div class="tooltip-text">Distribui√ß√£o do impacto financeiro (Saving vs Inflation) por comprador respons√°vel. Permite identificar performance individual do time de compras.</div>
                                </div>
                                <div class="tooltip-section">
                                    <div class="tooltip-title calculo"><i class="fas fa-calculator"></i> L√ìGICA DE C√ÅLCULO</div>
                                    <div class="tooltip-text">Agrupa impactos financeiros por comprador (definido no cadastro do fornecedor). Barras verdes = economia; Barras vermelhas = aumento.</div>
                                </div>
                                <div class="tooltip-section">
                                    <div class="tooltip-title origem"><i class="fas fa-database"></i> ORIGEM DOS DADOS</div>
                                    <div class="tooltip-text">SQL Server ‚Üí ERP TOTVS ‚Üí SD1010 + SA2010 (A2_X_COMPR). Comprador vinculado ao fornecedor da NF.</div>
                                </div>
                            </div>
                        </div>
                        <div class="chart-container">
                            <canvas id="chartComprador"></canvas>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="chart-card">
                        <div class="chart-header info-tooltip">
                            <i class="fas fa-calendar-alt me-2"></i>Evolu√ß√£o Mensal
                            <i class="fas fa-info-circle ms-2 text-secondary" style="font-size: 0.8rem; opacity: 0.6;"></i>
                            <div class="tooltip-content">
                                <div class="tooltip-section">
                                    <div class="tooltip-title conceito"><i class="fas fa-lightbulb"></i> CONCEITO</div>
                                    <div class="tooltip-text">Evolu√ß√£o mensal do impacto financeiro total. Mostra tend√™ncia ao longo dos meses, permitindo identificar sazonalidades e per√≠odos cr√≠ticos.</div>
                                </div>
                                <div class="tooltip-section">
                                    <div class="tooltip-title calculo"><i class="fas fa-calculator"></i> L√ìGICA DE C√ÅLCULO</div>
                                    <div class="tooltip-text">Agrupa impactos por m√™s de emiss√£o da NF (D1_DTDIGIT). Valores positivos = economia mensal; Valores negativos = aumento mensal.</div>
                                </div>
                                <div class="tooltip-section">
                                    <div class="tooltip-title origem"><i class="fas fa-database"></i> ORIGEM DOS DADOS</div>
                                    <div class="tooltip-text">SQL Server ‚Üí ERP TOTVS ‚Üí SD1010. Agrega√ß√£o mensal de impactos financeiros calculados.</div>
                                </div>
                            </div>
                        </div>
                        <div class="chart-container">
                            <canvas id="chartMensal"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- TABELA -->
            <div class="table-card">
                <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
                    <div class="card-title info-tooltip mb-0 d-flex align-items-center">
                        <i class="fas fa-table me-2"></i>
                        {% if modo_analitico %}
                        Hist√≥rico de Notas Fiscais
                        {% else %}
                        Detalhamento - Varia√ß√£o de Pre√ßos (NFs)
                        {% endif %}
                        <span class="badge bg-secondary ms-2">{{ items|length }} registros</span>
                        <i class="fas fa-info-circle ms-2 text-secondary" style="font-size: 0.75rem; opacity: 0.6;"></i>
                        <div class="tooltip-content" style="left: 0; transform: none;">
                            <div class="tooltip-section">
                                <div class="tooltip-title conceito"><i class="fas fa-lightbulb"></i> CONCEITO</div>
                                <div class="tooltip-text">{% if modo_analitico %}Lista detalhada de todas as NFs do produto pesquisado, com hist√≥rico completo de varia√ß√µes de pre√ßo e rastreabilidade pedido-NF.{% else %}Vis√£o consolidada por produto: mostra a NF mais recente vs a anterior, com classifica√ß√£o e impacto financeiro.{% endif %}</div>
                            </div>
                            <div class="tooltip-section">
                                <div class="tooltip-title calculo"><i class="fas fa-calculator"></i> L√ìGICA DE C√ÅLCULO</div>
                                <div class="tooltip-text">Cada linha representa uma NF com pedido associado. Varia√ß√£o = (Pre√ßo Atual - Pre√ßo Anterior) / Pre√ßo Anterior √ó 100. Impacto = Diferen√ßa √ó Quantidade.</div>
                            </div>
                            <div class="tooltip-section">
                                <div class="tooltip-title origem"><i class="fas fa-database"></i> ORIGEM DOS DADOS</div>
                                <div class="tooltip-text">SQL Server ‚Üí ERP TOTVS ‚Üí SD1010 (Itens NF) + D1_PEDIDO (Pedido Origem). Apenas NFs vinculadas a pedidos de compra. Governan√ßa: NFs sem pedido s√£o exclu√≠das.</div>
                            </div>
                        </div>
                    </div>
                    <div class="d-flex gap-2 me-3">
                        <button class="btn btn-sm btn-outline-info" onclick="gerenciarAnotacoes()" title="Ver/Gerenciar todas as anota√ß√µes">
                            <i class="fas fa-clipboard-list"></i> <span class="d-none d-md-inline">Gerenciar Anota√ß√µes</span>
                        </button>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover" id="tabelaVariacao">
                        <thead>
                            <tr>
                                {% if modo_analitico %}
                                <th class="sortable" onclick="sortTable('tabelaVariacao', 0, 'text')">NF <i class="fas fa-sort"></i></th>
                                <th class="sortable" onclick="sortTable('tabelaVariacao', 1, 'text')">Pedido <i class="fas fa-sort"></i></th>
                                <th class="sortable" onclick="sortTable('tabelaVariacao', 2, 'date')">Data <i class="fas fa-sort"></i></th>
                                <th class="sortable" onclick="sortTable('tabelaVariacao', 3, 'text')">Produto <i class="fas fa-sort"></i></th>
                                <th class="text-end sortable" onclick="sortTable('tabelaVariacao', 4, 'number')">Qtd <i class="fas fa-sort"></i></th>
                                <th class="text-end sortable" onclick="sortTable('tabelaVariacao', 5, 'number')">Pre√ßo Unit. <i class="fas fa-sort"></i></th>
                                <th class="text-end sortable" onclick="sortTable('tabelaVariacao', 6, 'number')">Pre√ßo Anterior <i class="fas fa-sort"></i></th>
                                <th class="text-end sortable" onclick="sortTable('tabelaVariacao', 7, 'number')">Varia√ß√£o <i class="fas fa-sort"></i></th>
                                <th class="text-center sortable" onclick="sortTable('tabelaVariacao', 8, 'text')">Classifica√ß√£o <i class="fas fa-sort"></i></th>
                                <th class="text-end sortable" onclick="sortTable('tabelaVariacao', 9, 'number')">Impacto (R$) <i class="fas fa-sort"></i></th>
                                <th class="text-center">Anota√ß√£o</th>
                                {% else %}
                                <th class="sortable" onclick="sortTable('tabelaVariacao', 0, 'text')">NF <i class="fas fa-sort"></i></th>
                                <th class="sortable" onclick="sortTable('tabelaVariacao', 1, 'text')">Pedido <i class="fas fa-sort"></i></th>
                                <th class="sortable" onclick="sortTable('tabelaVariacao', 2, 'date')">Data <i class="fas fa-sort"></i></th>
                                <th class="sortable" onclick="sortTable('tabelaVariacao', 3, 'text')">Produto <i class="fas fa-sort"></i></th>
                                <th class="sortable" onclick="sortTable('tabelaVariacao', 4, 'text')">Fornecedor <i class="fas fa-sort"></i></th>
                                <th class="text-end sortable" onclick="sortTable('tabelaVariacao', 5, 'number')">Qtd <i class="fas fa-sort"></i></th>
                                <th class="text-end sortable" onclick="sortTable('tabelaVariacao', 6, 'number')">Pre√ßo Unit. <i class="fas fa-sort"></i></th>
                                <th class="text-end sortable" onclick="sortTable('tabelaVariacao', 7, 'number')">Pre√ßo Anterior <i class="fas fa-sort"></i></th>
                                <th class="text-end sortable" onclick="sortTable('tabelaVariacao', 8, 'number')">Varia√ß√£o <i class="fas fa-sort"></i></th>
                                <th class="text-center sortable" onclick="sortTable('tabelaVariacao', 9, 'text')">Classifica√ß√£o <i class="fas fa-sort"></i></th>
                                <th class="text-end sortable" onclick="sortTable('tabelaVariacao', 10, 'number')">Impacto (R$) <i class="fas fa-sort"></i></th>
                                <th class="text-center">Anota√ß√£o</th>
                                {% endif %}
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in items %}
                            <tr>
                                {% if modo_analitico %}
                                <td>
                                    <span class="badge bg-primary text-white">{{ item.NumeroNota }}</span>
                                </td>
                                <td>
                                    <small class="text-muted">{{ item.NumeroPedido }}</small>
                                </td>
                                <td>{{ item.DataEmissao }}</td>
                                <td title="{{ item.DescricaoProduto }}">
                                    <small class="text-muted">{{ item.CodProduto }}</small><br>
                                    {{ item.DescricaoProduto[:35] }}...
                                </td>
                                <td class="text-end">{{ "{:,.0f}".format(item.QtdPedida).replace(",", ".") }}</td>
                                <td class="text-end fw-bold">R$ {{ "{:,.2f}".format(item.PrecoUnitarioAtual).replace(",", "X").replace(".", ",").replace("X", ".") }}</td>
                                <td class="text-end">
                                    {% if item.PrecoUnitarioAnterior %}
                                        R$ {{ "{:,.2f}".format(item.PrecoUnitarioAnterior).replace(",", "X").replace(".", ",").replace("X", ".") }}
                                        {% if item.NotaAnterior %}
                                        <br><small class="text-muted">NF {{ item.NotaAnterior }}</small>
                                        {% endif %}
                                    {% else %}
                                        <span class="valor-na">‚Äî</span>
                                    {% endif %}
                                </td>
                                <td class="text-end {% if item.Classificacao == 'Saving' %}text-success{% elif item.Classificacao == 'Inflation' %}text-danger{% endif %}">
                                    {% if item.PrecoUnitarioAnterior %}
                                        {% set diff = item.PrecoUnitarioAtual - item.PrecoUnitarioAnterior %}
                                        {% set percent = ((item.PrecoUnitarioAtual - item.PrecoUnitarioAnterior) / item.PrecoUnitarioAnterior * 100) if item.PrecoUnitarioAnterior != 0 else 0 %}
                                        {% if diff < 0 %}
                                        <i class="fas fa-arrow-down me-1"></i>R$ {{ "{:,.2f}".format(diff|abs).replace(",", "X").replace(".", ",").replace("X", ".") }}
                                        <span class="variacao-percent">{{ "{:,.2f}".format(percent|abs).replace(",", "X").replace(".", ",").replace("X", ".") }}%</span>
                                        {% elif diff > 0 %}
                                        <i class="fas fa-arrow-up me-1"></i>R$ {{ "{:,.2f}".format(diff).replace(",", "X").replace(".", ",").replace("X", ".") }}
                                        <span class="variacao-percent">+{{ "{:,.2f}".format(percent).replace(",", "X").replace(".", ",").replace("X", ".") }}%</span>
                                        {% else %}
                                        <i class="fas fa-equals me-1"></i>R$ 0,00
                                        <span class="variacao-percent">0,00%</span>
                                        {% endif %}
                                    {% else %}
                                        <span class="valor-na">‚Äî</span>
                                    {% endif %}
                                </td>
                                {% else %}
                                <!-- MODO EXECUTIVO: Colunas padronizadas com modo anal√≠tico -->
                                <td>
                                    <span class="badge bg-primary text-white">{{ item.NumeroNota }}</span>
                                </td>
                                <td>
                                    <small class="text-muted">{{ item.NumeroPedido }}</small>
                                </td>
                                <td>{{ item.DataEmissao }}</td>
                                <td title="{{ item.DescricaoProduto }}">
                                    <small class="text-muted">{{ item.CodProduto }}</small><br>
                                    {{ item.DescricaoProduto[:35] }}...
                                </td>
                                <td title="{{ item.FornecedorAtual }}">
                                    <small class="text-muted">{{ item.CodFornecedor }}</small><br>
                                    {{ item.FornecedorAtual[:22] }}{% if item.FornecedorAtual|length > 22 %}...{% endif %}
                                </td>
                                <td class="text-end">{{ "{:,.0f}".format(item.QtdPedida).replace(",", ".") }}</td>
                                <td class="text-end fw-bold">R$ {{ "{:,.2f}".format(item.PrecoUnitarioAtual).replace(",", "X").replace(".", ",").replace("X", ".") }}</td>
                                <td class="text-end">
                                    {% if item.PrecoUnitarioAnterior %}
                                        R$ {{ "{:,.2f}".format(item.PrecoUnitarioAnterior).replace(",", "X").replace(".", ",").replace("X", ".") }}
                                        {% if item.NotaAnterior %}
                                        <br><small class="text-muted">NF {{ item.NotaAnterior }}</small>
                                        {% endif %}
                                        {% if item.CompraAntiga %}
                                        <span class="badge-antiga" title="Mais de 2 anos"><i class="fas fa-clock"></i></span>
                                        {% endif %}
                                    {% else %}
                                        <span class="valor-na">‚Äî</span>
                                    {% endif %}
                                </td>
                                <td class="text-end {% if item.Classificacao == 'Saving' %}text-success{% elif item.Classificacao == 'Inflation' %}text-danger{% endif %}">
                                    {% if item.PrecoUnitarioAnterior %}
                                        {% set diff = item.PrecoUnitarioAtual - item.PrecoUnitarioAnterior %}
                                        {% set percent = ((item.PrecoUnitarioAtual - item.PrecoUnitarioAnterior) / item.PrecoUnitarioAnterior * 100) if item.PrecoUnitarioAnterior != 0 else 0 %}
                                        {% if diff < 0 %}
                                        <i class="fas fa-arrow-down me-1"></i>R$ {{ "{:,.2f}".format(diff|abs).replace(",", "X").replace(".", ",").replace("X", ".") }}
                                        <span class="variacao-percent">{{ "{:,.2f}".format(percent|abs).replace(",", "X").replace(".", ",").replace("X", ".") }}%</span>
                                        {% elif diff > 0 %}
                                        <i class="fas fa-arrow-up me-1"></i>R$ {{ "{:,.2f}".format(diff).replace(",", "X").replace(".", ",").replace("X", ".") }}
                                        <span class="variacao-percent">+{{ "{:,.2f}".format(percent).replace(",", "X").replace(".", ",").replace("X", ".") }}%</span>
                                        {% else %}
                                        <i class="fas fa-equals me-1"></i>R$ 0,00
                                        <span class="variacao-percent">0,00%</span>
                                        {% endif %}
                                    {% else %}
                                        <span class="valor-na">‚Äî</span>
                                    {% endif %}
                                </td>
                                {% endif %}
                                <td class="text-center">
                                    {% if item.Classificacao == 'Saving' %}
                                    <span class="badge badge-saving"><i class="fas fa-arrow-down me-1"></i>Saving</span>
                                    {% elif item.Classificacao == 'Inflation' %}
                                    <span class="badge badge-inflation"><i class="fas fa-arrow-up me-1"></i>Inflation</span>
                                    {% elif item.Classificacao == 'Cost Avoidance' %}
                                    <span class="badge badge-cost-avoidance"><i class="fas fa-equals me-1"></i>Cost Avoidance</span>
                                    {% else %}
                                    <span class="badge badge-primeira-compra"><i class="fas fa-plus me-1"></i>1¬™ Compra</span>
                                    {% endif %}
                                </td>
                                <td class="text-end {% if item.Classificacao == 'Saving' %}valor-saving{% elif item.Classificacao == 'Inflation' %}valor-inflation{% elif item.Classificacao == 'Primeira Compra' %}valor-na{% else %}valor-neutral{% endif %}">
                                    {% if item.ImpactoFinanceiro is not none %}
                                        {% if item.Classificacao == 'Saving' %}
                                        <i class="fas fa-arrow-down me-1"></i>
                                        {% elif item.Classificacao == 'Inflation' %}
                                        <i class="fas fa-arrow-up me-1"></i>
                                        {% endif %}
                                        R$ {{ "{:,.2f}".format(item.ImpactoFinanceiro|abs).replace(",", "X").replace(".", ",").replace("X", ".") }}
                                    {% else %}
                                        <span class="valor-na">N/A</span>
                                    {% endif %}
                                </td>
                                <td class="text-center">
                                    <button class="btn-anotacao" 
                                            data-pedido="{{ item.NumeroPedido }}"
                                            data-nota="{{ item.NumeroNota }}"
                                            data-codproduto="{{ item.CodProduto }}"
                                            data-produto="{{ item.DescricaoProduto }}"
                                            data-data="{{ item.DataEmissao }}"
                                            onclick="abrirModalAnotacaoBtn(this)"
                                            id="btn-nota-{{ item.NumeroPedido }}-{{ item.NumeroNota }}-{{ item.CodProduto }}"
                                            title="Adicionar/Editar Anota√ß√£o">
                                        <i class="far fa-sticky-note"></i>
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

        </div>
    </div>

    <!-- MODAL DE ANOTA√á√ÉO -->
    <div class="modal fade modal-anotacao" id="modalAnotacao" tabindex="-1" aria-labelledby="modalAnotacaoLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalAnotacaoLabel">
                        <i class="fas fa-sticky-note me-2"></i>Anota√ß√£o / Justificativa
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                </div>
                <div class="modal-body">
                    <div class="pedido-info">
                        <div><strong>Pedido:</strong> <span id="infoPedido"></span></div>
                        <div><strong>NF:</strong> <span id="infoNota"></span></div>
                        <div><strong>Produto:</strong> <span id="infoProduto"></span></div>
                        <div><strong>Data:</strong> <span id="infoData"></span></div>
                    </div>
                    <div class="mb-3">
                        <label for="textoAnotacao" class="form-label">Anota√ß√£o:</label>
                        <textarea class="form-control" id="textoAnotacao" rows="4" 
                                  placeholder="Digite sua justificativa ou anota√ß√£o sobre este pedido..."></textarea>
                    </div>
                    <input type="hidden" id="anotacaoPedido">
                    <input type="hidden" id="anotacaoNota">
                    <input type="hidden" id="anotacaoCodProduto">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-danger btn-delete-note" onclick="apagarAnotacao()" title="Apagar anota√ß√£o">
                        <i class="fas fa-trash-alt me-1"></i>Apagar
                    </button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="salvarAnotacao()">
                        <i class="fas fa-save me-1"></i>Salvar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL DE GERENCIAMENTO DE ANOTA√á√ïES -->
    <div class="modal fade" id="modalGerenciarAnotacoes" tabindex="-1" aria-labelledby="modalGerenciarLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title" id="modalGerenciarLabel">
                        <i class="fas fa-clipboard-list me-2"></i>Gerenciar Anota√ß√µes - Sistema Universal
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info d-flex justify-content-between align-items-center">
                        <div>
                            <i class="fas fa-cloud me-2"></i>
                            <strong>Anota√ß√µes no servidor:</strong> <span id="totalAnotacoes">0</span>
                        </div>
                        <button class="btn btn-sm btn-primary" onclick="atualizarAnotacoesServidor()" title="Atualizar do servidor">
                            <i class="fas fa-sync-alt me-1"></i>Atualizar
                        </button>
                    </div>
                    
                    <!-- √Årea para recuperar anota√ß√µes antigas do LocalStorage -->
                    <div class="alert alert-warning" id="alertaLocalStorage" style="display: none;">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                <strong>Anota√ß√µes antigas encontradas!</strong>
                                <br><small>Existem <span id="qtdLocalStorage">0</span> anota√ß√µes salvas neste navegador que ainda n√£o foram migradas para o servidor.</small>
                            </div>
                            <button class="btn btn-sm btn-warning" onclick="migrarLocalStorageParaServidor()">
                                <i class="fas fa-cloud-upload-alt me-1"></i>Migrar para Servidor
                            </button>
                        </div>
                    </div>
                    
                    <div class="alert alert-success">
                        <i class="fas fa-check-circle me-2"></i>
                        <strong>Sistema Universal:</strong> As anota√ß√µes s√£o salvas no servidor e compartilhadas automaticamente entre todos os usu√°rios. 
                        Qualquer anota√ß√£o feita por qualquer pessoa ser√° vis√≠vel para todos.
                    </div>
                    <div id="listaAnotacoes">
                        <div class="text-center py-3">
                            <div class="spinner-border text-info" role="status">
                                <span class="visually-hidden">Carregando...</span>
                            </div>
                            <p class="mt-2 text-muted">Carregando anota√ß√µes do servidor...</p>
                        </div>
                    </div>
                </div>
                <div class="modal-footer justify-content-between">
                    <div>
                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="verificarLocalStorage()" title="Verificar se h√° anota√ß√µes antigas neste navegador">
                            <i class="fas fa-search me-1"></i>Verificar Navegador Antigo
                        </button>
                    </div>
                    <div class="d-flex gap-2">
                        <button type="button" class="btn btn-success" onclick="exportarAnotacoes()">
                            <i class="fas fa-download me-1"></i>Exportar JSON
                        </button>
                        <button type="button" class="btn btn-warning" onclick="importarAnotacoes()">
                            <i class="fas fa-upload me-1"></i>Importar JSON
                        </button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <input type="file" id="fileInputAnotacoes" style="display:none" accept=".json">

    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.14.0-beta2/js/bootstrap-select.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0/dist/chartjs-plugin-datalabels.min.js"></script>
    <script>
        // ========================================
        // INICIALIZA√á√ÉO DOS DROPDOWNS MENSAIS
        // ========================================
        (function() {
            const meses = [
                'Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun',
                'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'
            ];
            
            const dataAtual = new Date();
            const anoAtual = dataAtual.getFullYear();
            
            // Fun√ß√£o para obter √∫ltimo dia do m√™s
            function ultimoDiaMes(ano, mes) {
                return new Date(ano, mes + 1, 0).getDate();
            }
            
            // Gerar op√ß√µes
            const opcoesInicio = [];
            const opcoesFim = [];
            for (let ano = anoAtual - 2; ano <= anoAtual + 1; ano++) {
                for (let mes = 0; mes < 12; mes++) {
                    const valorInicio = `${ano}-${String(mes + 1).padStart(2, '0')}-01`;
                    const ultimoDia = ultimoDiaMes(ano, mes);
                    const valorFim = `${ano}-${String(mes + 1).padStart(2, '0')}-${String(ultimoDia).padStart(2, '0')}`;
                    const texto = `${meses[mes]}/${ano}`;
                    opcoesInicio.push({ valor: valorInicio, texto });
                    opcoesFim.push({ valor: valorFim, texto });
                }
            }
            
            function preencherSelectInicio(selectId, valorInicial) {
                const select = document.getElementById(selectId);
                if (!select) return;
                select.innerHTML = '';
                opcoesInicio.forEach(opt => {
                    const option = document.createElement('option');
                    option.value = opt.valor;
                    option.textContent = opt.texto;
                    select.appendChild(option);
                });
                if (valorInicial) {
                    const partes = valorInicial.split('-');
                    select.value = `${partes[0]}-${partes[1]}-01`;
                } else {
                    select.value = `${anoAtual}-01-01`;
                }
            }
            
            function preencherSelectFim(selectId, valorInicial) {
                const select = document.getElementById(selectId);
                if (!select) return;
                select.innerHTML = '';
                opcoesFim.forEach(opt => {
                    const option = document.createElement('option');
                    option.value = opt.valor;
                    option.textContent = opt.texto;
                    select.appendChild(option);
                });
                if (valorInicial) {
                    const partes = valorInicial.split('-');
                    const ano = parseInt(partes[0]);
                    const mes = parseInt(partes[1]) - 1;
                    const ultimoDia = ultimoDiaMes(ano, mes);
                    select.value = `${partes[0]}-${partes[1]}-${String(ultimoDia).padStart(2, '0')}`;
                } else {
                    select.value = `${anoAtual}-12-31`;
                }
            }
            
            preencherSelectInicio('selectDataInicio', '{{ data_inicio }}');
            preencherSelectFim('selectDataFim', '{{ data_fim }}');
        })();
    </script>
    
    <script>
        // Inicializar bootstrap-select
        $(document).ready(function() {
            $('.selectpicker').selectpicker();
        });
        
        const sidebarToggle = document.getElementById('sidebarToggle');
        const sidebar = document.getElementById('sidebar');
        const content = document.getElementById('content');

        sidebarToggle.addEventListener('click', () => {
            sidebar.classList.toggle('collapsed');
            content.classList.toggle('expanded');
            sidebarToggle.classList.toggle('collapsed');
        });

        const chartCompradorData = {{ chart_compradores | tojson | safe }};
        const chartMensalData = {{ chart_meses | tojson | safe }};
        const chartEvolucaoData = {{ chart_evolucao | tojson | safe }};
        const modoAnalitico = {{ 'true' if modo_analitico else 'false' }};

        function formatCurrency(value) {
            const absValue = Math.abs(value);
            if (absValue >= 1000000) {
                return 'R$ ' + (value / 1000000).toFixed(1).replace('.', ',') + 'M';
            } else if (absValue >= 1000) {
                return 'R$ ' + (value / 1000).toFixed(1).replace('.', ',') + 'K';
            }
            return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value);
        }

        function formatCurrencyFull(value) {
            return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value);
        }

        function getBarColors(valores) {
            return valores.map(v => v < 0 ? 'rgba(25, 135, 84, 0.85)' : 'rgba(220, 53, 69, 0.85)');
        }

        function getBorderColors(valores) {
            return valores.map(v => v < 0 ? 'rgba(25, 135, 84, 1)' : 'rgba(220, 53, 69, 1)');
        }

        function formatMonth(label) {
            const months = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
            const parts = label.split('-');
            if (parts.length === 2) {
                const monthIndex = parseInt(parts[1]) - 1;
                const year = parts[0].slice(-2);
                return months[monthIndex] + '/' + year;
            }
            return label;
        }
        
        // GR√ÅFICO DE EVOLU√á√ÉO (MODO ANAL√çTICO)
        if (modoAnalitico && chartEvolucaoData && chartEvolucaoData.labels && chartEvolucaoData.labels.length > 0) {
            const ctxEvolucao = document.getElementById('chartEvolucao');
            if (ctxEvolucao) {
                new Chart(ctxEvolucao.getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: chartEvolucaoData.labels,
                        datasets: [{
                            label: 'Pre√ßo Unit√°rio',
                            data: chartEvolucaoData.precos,
                            borderColor: 'rgba(13, 110, 253, 1)',
                            backgroundColor: 'rgba(13, 110, 253, 0.1)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.3,
                            pointRadius: 6,
                            pointBackgroundColor: 'rgba(13, 110, 253, 1)',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2,
                            pointHoverRadius: 8
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        layout: {
                            padding: {
                                top: 50,
                                right: 20,
                                bottom: 15,
                                left: 15
                            }
                        },
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    title: function(context) {
                                        const idx = context[0].dataIndex;
                                        return 'Data: ' + chartEvolucaoData.labels[idx];
                                    },
                                    label: function(context) {
                                        const idx = context.dataIndex;
                                        return [
                                            'Pre√ßo: ' + formatCurrencyFull(context.raw),
                                            'NF: ' + (chartEvolucaoData.notas ? chartEvolucaoData.notas[idx] : 'N/A'),
                                            'Pedido: ' + chartEvolucaoData.pedidos[idx]
                                        ];
                                    }
                                }
                            },
                            datalabels: {
                                display: true,
                                anchor: 'end',
                                align: 'top',
                                color: '#333',
                                font: { weight: 'bold', size: 10 },
                                formatter: function(value) {
                                    return formatCurrency(value);
                                },
                                clip: false,
                                offset: 8
                            }
                        },
                        scales: {
                            x: {
                                grid: { display: false }
                            },
                            y: {
                                beginAtZero: false,
                                afterDataLimits: function(scale) {
                                    scale.max = scale.max * 1.15;
                                },
                                ticks: {
                                    callback: function(value) { return formatCurrency(value); }
                                }
                            }
                        }
                    },
                    plugins: [ChartDataLabels]
                });
            }
        }

        // Gr√°fico por Comprador (MODO EXECUTIVO)
        if (!modoAnalitico && chartCompradorData && chartCompradorData.labels && chartCompradorData.labels.length > 0) {
            const ctxComprador = document.getElementById('chartComprador');
            if (ctxComprador) {
                new Chart(ctxComprador.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: chartCompradorData.labels,
                    datasets: [
                        {
                            label: 'Economia (Saving)',
                            data: chartCompradorData.saving,
                            backgroundColor: 'rgba(25, 135, 84, 0.85)',
                            borderColor: 'rgba(25, 135, 84, 1)',
                            borderWidth: 1,
                            borderRadius: 3
                        },
                        {
                            label: 'Pago a Mais (Inflation)',
                            data: chartCompradorData.inflation,
                            backgroundColor: 'rgba(220, 53, 69, 0.85)',
                            borderColor: 'rgba(220, 53, 69, 1)',
                            borderWidth: 1,
                            borderRadius: 3
                        },
                        {
                            label: 'Cost Avoidance',
                            data: chartCompradorData.cost_avoidance,
                            backgroundColor: 'rgba(13, 110, 253, 0.85)',
                            borderColor: 'rgba(13, 110, 253, 1)',
                            borderWidth: 1,
                            borderRadius: 3
                        }
                    ]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    layout: { padding: { right: 70 } },
                    plugins: {
                        legend: { 
                            display: true,
                            position: 'top',
                            labels: { boxWidth: 12, padding: 8, font: { size: 10 } }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + formatCurrencyFull(context.raw);
                                }
                            }
                        },
                        datalabels: {
                            display: true,
                            anchor: 'end',
                            align: 'right',
                            offset: 4,
                            color: '#333',
                            font: { weight: 'bold', size: 9 },
                            formatter: function(value) {
                                if (value === 0 || value === null) return '';
                                const absVal = Math.abs(value);
                                if (absVal >= 1000000) return (value/1000000).toFixed(1) + 'M';
                                if (absVal >= 1000) return (value/1000).toFixed(0) + 'k';
                                return value.toFixed(0);
                            }
                        }
                    },
                    scales: {
                        x: { 
                            display: false,
                            type: 'logarithmic',
                            stacked: false
                        },
                        y: { 
                            stacked: false,
                            grid: { display: false }
                        }
                    }
                },
                plugins: [ChartDataLabels]
            });
            }
        }

        // Gr√°fico por M√™s (MODO EXECUTIVO)
        if (!modoAnalitico && chartMensalData && chartMensalData.labels && chartMensalData.labels.length > 0) {
            const ctxMensal = document.getElementById('chartMensal');
            if (ctxMensal) {
                const labelsFormatadas = chartMensalData.labels.map(formatMonth);
            
                new Chart(ctxMensal.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: labelsFormatadas,
                    datasets: [
                        {
                            label: 'Economia (Saving)',
                            data: chartMensalData.saving,
                            backgroundColor: 'rgba(25, 135, 84, 0.85)',
                            borderColor: 'rgba(25, 135, 84, 1)',
                            borderWidth: 1,
                            borderRadius: 3
                        },
                        {
                            label: 'Pago a Mais (Inflation)',
                            data: chartMensalData.inflation,
                            backgroundColor: 'rgba(220, 53, 69, 0.85)',
                            borderColor: 'rgba(220, 53, 69, 1)',
                            borderWidth: 1,
                            borderRadius: 3
                        },
                        {
                            label: 'Cost Avoidance',
                            data: chartMensalData.cost_avoidance,
                            backgroundColor: 'rgba(13, 110, 253, 0.85)',
                            borderColor: 'rgba(13, 110, 253, 1)',
                            borderWidth: 1,
                            borderRadius: 3
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    layout: { padding: { top: 30 } },
                    plugins: {
                        legend: { 
                            display: true,
                            position: 'top',
                            labels: { boxWidth: 12, padding: 8, font: { size: 10 } }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + formatCurrencyFull(context.raw);
                                }
                            }
                        },
                        datalabels: {
                            display: true,
                            anchor: 'end',
                            align: 'top',
                            offset: 2,
                            color: '#333',
                            font: { weight: 'bold', size: 8 },
                            formatter: function(value) {
                                if (value === 0 || value === null) return '';
                                const absVal = Math.abs(value);
                                if (absVal >= 1000000) return (value/1000000).toFixed(1) + 'M';
                                if (absVal >= 1000) return (value/1000).toFixed(0) + 'k';
                                return value.toFixed(0);
                            }
                        }
                    },
                    scales: {
                        x: { 
                            stacked: false,
                            grid: { display: false }
                        },
                        y: { 
                            display: false,
                            type: 'logarithmic',
                            stacked: false
                        }
                    }
                },
                plugins: [ChartDataLabels]
                });
            }
        }

        // =====================================================
        // SISTEMA DE ANOTA√á√ïES - SERVIDOR (UNIVERSAL)
        // =====================================================
        // Anota√ß√µes s√£o salvas no servidor, compartilhadas entre todos os usu√°rios
        let anotacoesCache = {};
        
        async function getAnotacoes() {
            try {
                const response = await fetch('/api/anotacoes');
                const data = await response.json();
                if (data.success) {
                    // Converte formato do servidor para formato simples (chave: texto)
                    anotacoesCache = {};
                    for (const [chave, valor] of Object.entries(data.anotacoes)) {
                        anotacoesCache[chave] = typeof valor === 'object' ? valor.texto : valor;
                    }
                    return anotacoesCache;
                }
            } catch (error) {
                console.error('Erro ao carregar anota√ß√µes:', error);
            }
            return {};
        }
        
        async function saveAnotacao(chave, texto) {
            try {
                const response = await fetch('/api/anotacoes', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ chave, texto })
                });
                const data = await response.json();
                return data.success;
            } catch (error) {
                console.error('Erro ao salvar anota√ß√£o:', error);
                return false;
            }
        }
        
        function getChaveAnotacao(pedido, nota, codProduto) {
            return `${pedido}_${nota}_${codProduto}`;
        }
        
        // Fun√ß√£o wrapper que l√™ os data attributes do bot√£o
        function abrirModalAnotacaoBtn(btn) {
            const pedido = btn.dataset.pedido;
            const nota = btn.dataset.nota;
            const codProduto = btn.dataset.codproduto;
            const produto = btn.dataset.produto;
            const data = btn.dataset.data;
            abrirModalAnotacao(pedido, nota, codProduto, produto, data);
        }
        
        async function abrirModalAnotacao(pedido, nota, codProduto, produto, data) {
            // Preencher informa√ß√µes
            document.getElementById('infoPedido').textContent = pedido;
            document.getElementById('infoNota').textContent = nota;
            document.getElementById('infoProduto').textContent = `${codProduto} - ${produto}`;
            document.getElementById('infoData').textContent = data;
            
            // Guardar refer√™ncias
            document.getElementById('anotacaoPedido').value = pedido;
            document.getElementById('anotacaoNota').value = nota;
            document.getElementById('anotacaoCodProduto').value = codProduto;
            
            // Carregar anota√ß√£o existente do servidor
            const anotacoes = await getAnotacoes();
            const chave = getChaveAnotacao(pedido, nota, codProduto);
            const anotacaoExistente = anotacoes[chave] || '';
            document.getElementById('textoAnotacao').value = anotacaoExistente;
            
            // Abrir modal
            const modal = new bootstrap.Modal(document.getElementById('modalAnotacao'));
            modal.show();
        }
        
        async function salvarAnotacao() {
            const pedido = document.getElementById('anotacaoPedido').value;
            const nota = document.getElementById('anotacaoNota').value;
            const codProduto = document.getElementById('anotacaoCodProduto').value;
            const texto = document.getElementById('textoAnotacao').value.trim();
            
            const chave = getChaveAnotacao(pedido, nota, codProduto);
            
            const sucesso = await saveAnotacao(chave, texto);
            
            if (sucesso) {
                atualizarVisualAnotacao(pedido, nota, codProduto, texto);
                bootstrap.Modal.getInstance(document.getElementById('modalAnotacao')).hide();
                mostrarToast(texto ? 'Anota√ß√£o salva com sucesso!' : 'Anota√ß√£o removida.');
            } else {
                mostrarToast('Erro ao salvar anota√ß√£o!', 'danger');
            }
        }
        
        async function apagarAnotacao() {
            const pedido = document.getElementById('anotacaoPedido').value;
            const nota = document.getElementById('anotacaoNota').value;
            const codProduto = document.getElementById('anotacaoCodProduto').value;
            
            if (confirm('Tem certeza que deseja apagar esta anota√ß√£o?')) {
                const chave = getChaveAnotacao(pedido, nota, codProduto);
                
                const sucesso = await saveAnotacao(chave, '');
                
                if (sucesso) {
                    atualizarVisualAnotacao(pedido, nota, codProduto, '');
                    bootstrap.Modal.getInstance(document.getElementById('modalAnotacao')).hide();
                    mostrarToast('Anota√ß√£o apagada.');
                } else {
                    mostrarToast('Erro ao apagar anota√ß√£o!', 'danger');
                }
            }
        }
        
        function atualizarVisualAnotacao(pedido, nota, codProduto, texto) {
            // Tentar com ID direto
            let btn = document.getElementById(`btn-nota-${pedido}-${nota}-${codProduto}`);
            
            // Fallback: buscar por data attributes se ID n√£o funcionar
            if (!btn) {
                const botoes = document.querySelectorAll('.btn-anotacao');
                for (const b of botoes) {
                    if (b.dataset.pedido === pedido && 
                        b.dataset.nota === nota && 
                        b.dataset.codproduto === codProduto) {
                        btn = b;
                        break;
                    }
                }
            }
            
            if (btn) {
                if (texto) {
                    btn.classList.add('has-note');
                    btn.querySelector('i').className = 'fas fa-sticky-note';
                    btn.title = 'Editar Anota√ß√£o - ' + texto.substring(0, 50) + (texto.length > 50 ? '...' : '');
                } else {
                    btn.classList.remove('has-note');
                    btn.querySelector('i').className = 'far fa-sticky-note';
                    btn.title = 'Adicionar Anota√ß√£o';
                }
            } else {
                console.warn(`Bot√£o n√£o encontrado: Pedido=${pedido}, Nota=${nota}, Produto=${codProduto}`);
            }
        }
        
        function mostrarToast(mensagem, tipo = 'success') {
            // Criar toast din√¢mico
            let bgClass, icon;
            switch(tipo) {
                case 'danger':
                    bgClass = 'text-bg-danger';
                    icon = 'fa-exclamation-circle';
                    break;
                case 'info':
                    bgClass = 'text-bg-info';
                    icon = 'fa-info-circle';
                    break;
                default:
                    bgClass = 'text-bg-success';
                    icon = 'fa-check-circle';
            }
            
            const toastHtml = `
                <div class="toast-container position-fixed bottom-0 end-0 p-3">
                    <div class="toast align-items-center ${bgClass} border-0" role="alert">
                        <div class="d-flex">
                            <div class="toast-body">
                                <i class="fas ${icon} me-2"></i>${mensagem}
                            </div>
                            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                        </div>
                    </div>
                </div>
            `;
            
            const container = document.createElement('div');
            container.innerHTML = toastHtml;
            document.body.appendChild(container);
            
            const toastEl = container.querySelector('.toast');
            const toast = new bootstrap.Toast(toastEl, { delay: 2500 });
            toast.show();
            
            toastEl.addEventListener('hidden.bs.toast', () => {
                container.remove();
            });
        }
        
        // Carregar anota√ß√µes ao iniciar a p√°gina
        async function carregarAnotacoesExistentes() {
            const anotacoes = await getAnotacoes();
            let contador = 0;
            
            for (const [chave, texto] of Object.entries(anotacoes)) {
                const partes = chave.split('_');
                if (partes.length >= 3) {
                    const pedido = partes[0];
                    const nota = partes[1];
                    const codProduto = partes.slice(2).join('_'); // Caso o codProduto tenha underscore
                    atualizarVisualAnotacao(pedido, nota, codProduto, texto);
                    contador++;
                }
            }
            
            // Debug: mostrar quantas anota√ß√µes foram carregadas no console
            if (contador > 0) {
                console.log(`‚úÖ ${contador} anota√ß√µes carregadas do servidor`);
            } else {
                console.log('‚ö†Ô∏è Nenhuma anota√ß√£o encontrada no servidor');
            }
        }
        
        // Executar ao carregar a p√°gina
        document.addEventListener('DOMContentLoaded', carregarAnotacoesExistentes);

        // =====================================================
        // GERENCIAMENTO DE ANOTA√á√ïES
        // =====================================================
        
        // Fun√ß√£o para atualizar anota√ß√µes do servidor (bot√£o Atualizar)
        async function atualizarAnotacoesServidor() {
            mostrarToast('Atualizando anota√ß√µes do servidor...', 'info');
            
            // Recarrega anota√ß√µes do servidor
            await carregarAnotacoesExistentes();
            
            // Atualiza a lista no modal se estiver aberto
            const modal = document.getElementById('modalGerenciarAnotacoes');
            if (modal.classList.contains('show')) {
                await carregarListaAnotacoesModal();
            }
            
            mostrarToast('Anota√ß√µes atualizadas com sucesso!');
        }
        
        // Fun√ß√£o auxiliar para carregar lista de anota√ß√µes no modal
        async function carregarListaAnotacoesModal() {
            const lista = document.getElementById('listaAnotacoes');
            
            // Mostra loading
            lista.innerHTML = `
                <div class="text-center py-3">
                    <div class="spinner-border text-info" role="status">
                        <span class="visually-hidden">Carregando...</span>
                    </div>
                    <p class="mt-2 text-muted">Carregando anota√ß√µes do servidor...</p>
                </div>
            `;
            
            try {
                const response = await fetch('/api/anotacoes');
                const data = await response.json();
                
                if (!data.success) {
                    throw new Error('Erro na resposta do servidor');
                }
                
                const anotacoesCompletas = data.anotacoes || {};
                const totalAnotacoes = Object.keys(anotacoesCompletas).filter(k => {
                    const v = anotacoesCompletas[k];
                    return (typeof v === 'object' ? v.texto : v);
                }).length;
                
                document.getElementById('totalAnotacoes').textContent = totalAnotacoes;
                
                if (totalAnotacoes === 0) {
                    lista.innerHTML = '<div class="alert alert-warning"><i class="fas fa-exclamation-triangle me-2"></i>Nenhuma anota√ß√£o salva no servidor.</div>';
                    return;
                }
                
                let html = '<div class="list-group">';
                
                for (const [chave, valor] of Object.entries(anotacoesCompletas)) {
                    const partes = chave.split('_');
                    const pedido = partes[0];
                    const nota = partes[1];
                    const codProduto = partes.slice(2).join('_');
                    
                    // Extrair dados (pode ser objeto ou string)
                    const texto = typeof valor === 'object' ? valor.texto : valor;
                    const usuario = typeof valor === 'object' ? (valor.usuario || 'Desconhecido') : 'Desconhecido';
                    const dataAnotacao = typeof valor === 'object' ? (valor.data || '') : '';
                    
                    if (!texto) continue; // Pular anota√ß√µes vazias
                    
                    html += `
                        <div class="list-group-item">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <h6 class="mb-1">
                                        <span class="badge bg-primary me-1">Pedido: ${pedido}</span>
                                        <span class="badge bg-success me-1">NF: ${nota}</span>
                                        <span class="badge bg-info">${codProduto}</span>
                                    </h6>
                                    <p class="mb-1">${texto}</p>
                                    <small class="text-muted">
                                        <i class="fas fa-user me-1"></i><strong>${usuario}</strong>
                                        ${dataAnotacao ? `<span class="ms-3"><i class="fas fa-clock me-1"></i>${dataAnotacao}</span>` : ''}
                                    </small>
                                </div>
                                <button class="btn btn-sm btn-outline-danger ms-2" onclick="removerAnotacaoLista('${chave}')" title="Excluir">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    `;
                }
                
                html += '</div>';
                lista.innerHTML = html;
                
            } catch (error) {
                console.error('Erro ao carregar anota√ß√µes:', error);
                lista.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>Erro ao carregar anota√ß√µes do servidor.</strong>
                        <br><small>Verifique sua conex√£o e clique em "Atualizar" para tentar novamente.</small>
                    </div>
                `;
            }
        }
        
        async function gerenciarAnotacoes() {
            // Abre o modal primeiro
            const modal = new bootstrap.Modal(document.getElementById('modalGerenciarAnotacoes'));
            modal.show();
            
            // Carrega as anota√ß√µes
            await carregarListaAnotacoesModal();
        }
        
        async function removerAnotacaoLista(chave) {
            if (confirm('Tem certeza que deseja excluir esta anota√ß√£o?')) {
                const sucesso = await saveAnotacao(chave, '');
                
                if (sucesso) {
                    // Atualizar visual na tabela
                    const partes = chave.split('_');
                    const pedido = partes[0];
                    const nota = partes[1];
                    const codProduto = partes.slice(2).join('_');
                    atualizarVisualAnotacao(pedido, nota, codProduto, '');
                    
                    // Recarregar lista no modal
                    await carregarListaAnotacoesModal();
                    mostrarToast('Anota√ß√£o exclu√≠da!');
                } else {
                    mostrarToast('Erro ao excluir anota√ß√£o!', 'danger');
                }
            }
        }
        
        async function exportarAnotacoes() {
            try {
                const response = await fetch('/api/anotacoes/exportar');
                const data = await response.json();
                
                const dataStr = JSON.stringify(data.anotacoes, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `anotacoes_variacao_${new Date().toISOString().split('T')[0]}.json`;
                link.click();
                
                URL.revokeObjectURL(url);
                mostrarToast('Anota√ß√µes exportadas com sucesso!');
            } catch (error) {
                mostrarToast('Erro ao exportar anota√ß√µes!', 'danger');
            }
        }
        
        function importarAnotacoes() {
            const fileInput = document.getElementById('fileInputAnotacoes');
            
            fileInput.onchange = async function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = async function(event) {
                    try {
                        const importedData = JSON.parse(event.target.result);
                        
                        if (confirm(`Deseja importar ${Object.keys(importedData).length} anota√ß√µes? As anota√ß√µes existentes ser√£o mescladas.`)) {
                            const response = await fetch('/api/anotacoes/importar', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ anotacoes: importedData })
                            });
                            
                            const result = await response.json();
                            
                            if (result.success) {
                                await carregarAnotacoesExistentes();
                                gerenciarAnotacoes();
                                mostrarToast(`${result.importadas} anota√ß√µes importadas com sucesso!`);
                            } else {
                                mostrarToast('Erro ao importar anota√ß√µes!', 'danger');
                            }
                        }
                    } catch (error) {
                        alert('Erro ao importar arquivo. Verifique se o formato JSON est√° correto.');
                    }
                };
                reader.readAsText(file);
            };
            
            fileInput.click();
        }
        
        // ========================================
        // MIGRA√á√ÉO DO LOCALSTORAGE (NAVEGADOR ANTIGO)
        // ========================================
        function verificarLocalStorage() {
            const alertaDiv = document.getElementById('alertaLocalStorage');
            const qtdSpan = document.getElementById('qtdLocalStorage');
            
            // Verificar se existe dados no localStorage
            const dadosAntigos = localStorage.getItem('variacao_anotacoes');
            
            if (dadosAntigos) {
                try {
                    const anotacoes = JSON.parse(dadosAntigos);
                    const quantidade = Object.keys(anotacoes).length;
                    
                    if (quantidade > 0) {
                        qtdSpan.textContent = quantidade;
                        alertaDiv.style.display = 'block';
                        mostrarToast(`Encontradas ${quantidade} anota√ß√µes no navegador antigo!`, 'info');
                    } else {
                        alertaDiv.style.display = 'none';
                        mostrarToast('Nenhuma anota√ß√£o encontrada no navegador.', 'warning');
                    }
                } catch (e) {
                    alertaDiv.style.display = 'none';
                    mostrarToast('Erro ao ler dados do navegador.', 'danger');
                }
            } else {
                alertaDiv.style.display = 'none';
                mostrarToast('Nenhuma anota√ß√£o antiga encontrada neste navegador.', 'warning');
            }
        }
        
        async function migrarLocalStorageParaServidor() {
            const dadosAntigos = localStorage.getItem('variacao_anotacoes');
            
            if (!dadosAntigos) {
                mostrarToast('Nenhuma anota√ß√£o para migrar.', 'warning');
                return;
            }
            
            try {
                const anotacoes = JSON.parse(dadosAntigos);
                const quantidade = Object.keys(anotacoes).length;
                
                if (quantidade === 0) {
                    mostrarToast('Nenhuma anota√ß√£o para migrar.', 'warning');
                    return;
                }
                
                if (!confirm(`Deseja migrar ${quantidade} anota√ß√µes do navegador antigo para o servidor?\n\nIsso permitir√° que todos vejam essas anota√ß√µes.`)) {
                    return;
                }
                
                mostrarSpinner('Migrando anota√ß√µes...');
                
                const response = await fetch('/api/anotacoes/importar', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ anotacoes: anotacoes })
                });
                
                const result = await response.json();
                
                esconderSpinner();
                
                if (result.success) {
                    // Perguntar se quer limpar o localStorage
                    if (confirm(`${result.importadas} anota√ß√µes migradas com sucesso!\n\nDeseja remover as anota√ß√µes antigas do navegador?\n(Recomendado para evitar duplica√ß√£o)`)) {
                        localStorage.removeItem('variacao_anotacoes');
                    }
                    
                    // Esconder o alerta e recarregar
                    document.getElementById('alertaLocalStorage').style.display = 'none';
                    await carregarAnotacoesExistentes();
                    gerenciarAnotacoes();
                    mostrarToast(`${result.importadas} anota√ß√µes migradas para o servidor!`);
                } else {
                    mostrarToast('Erro ao migrar anota√ß√µes!', 'danger');
                }
            } catch (error) {
                esconderSpinner();
                console.error('Erro na migra√ß√£o:', error);
                mostrarToast('Erro ao migrar anota√ß√µes!', 'danger');
            }
        }

        // ========================================
        // SPINNER GLOBAL
        // ========================================
        let spinnerTimeout = null;
        let activeRequests = 0;
        
        function mostrarSpinner(texto = 'Carregando...') {
            activeRequests++;
            const spinnerText = document.getElementById('spinnerText');
            if (spinnerText) spinnerText.textContent = texto;
            
            if (spinnerTimeout === null) {
                spinnerTimeout = setTimeout(() => {
                    document.getElementById('spinnerBackdrop').classList.add('active');
                    document.getElementById('spinnerGlobal').classList.add('active');
                }, 500);
            }
        }
        
        function esconderSpinner() {
            activeRequests = Math.max(0, activeRequests - 1);
            
            if (activeRequests === 0) {
                if (spinnerTimeout) {
                    clearTimeout(spinnerTimeout);
                    spinnerTimeout = null;
                }
                document.getElementById('spinnerBackdrop').classList.remove('active');
                document.getElementById('spinnerGlobal').classList.remove('active');
            }
        }
        
        // Interceptar fetch para mostrar spinner automaticamente
        const originalFetch = window.fetch;
        window.fetch = function(...args) {
            mostrarSpinner();
            
            return originalFetch.apply(this, args)
                .then(response => {
                    esconderSpinner();
                    return response;
                })
                .catch(error => {
                    esconderSpinner();
                    throw error;
                });
        };
        
        // Mostrar spinner para submiss√µes de formul√°rio
        document.addEventListener('submit', function(e) {
            if (e.target.tagName === 'FORM') {
                mostrarSpinner('Aplicando filtros...');
            }
        });
    </script>
</body>
</html>
